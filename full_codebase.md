# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ ADMIN_USERS_IMPLEMENTATION.md
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CompanyUsersTable.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ collapsible.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}

```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `ADMIN_USERS_IMPLEMENTATION.md`
```md
# Documentaci√≥n: Implementaci√≥n de Vista Expandible de Usuarios por Empresa

## Objetivo Completado

Se ha implementado exitosamente la funcionalidad para expandir la tabla "Usuarios por Empresa" en el panel de administraci√≥n, permitiendo ver una lista detallada de usuarios de cada empresa con informaci√≥n completa como nombre, email, fecha de creaci√≥n, roles y estado.

## Archivos Modificados

### 1. `lib/api.ts`
**Cambios realizados:**
- ‚úÖ Agregada interfaz `UserAdminResponse` con campos extendidos:
  - `id`, `email`, `name`, `company_id`, `is_active`, `created_at`, `roles`
- ‚úÖ Agregada funci√≥n `getUsersByCompany(companyId: string, auth: AuthHeaders, limit?: number, offset?: number)`
- ‚úÖ Eliminada funci√≥n duplicada para evitar conflictos

**Funcionalidad:**
- Permite obtener usuarios filtrados por empresa con autenticaci√≥n y paginaci√≥n
- Mantiene consistencia con el patr√≥n de AuthHeaders usado en el resto de la aplicaci√≥n

### 2. `components/admin/AdminStats.tsx`
**Cambios realizados:**
- ‚úÖ Agregado import del componente `CompanyUsersTable`
- ‚úÖ Agregados imports de `Collapsible`, `ChevronDown`, `ChevronRight` y `Button`
- ‚úÖ Agregado estado local `expandedCompanies` para manejar empresas expandidas
- ‚úÖ Implementada funci√≥n `toggleCompanyExpansion()` para controlar expansi√≥n
- ‚úÖ Convertida tabla simple en tabla expandible con filas clickeables
- ‚úÖ Agregada columna adicional para iconos de expansi√≥n
- ‚úÖ Implementado patr√≥n Fragment para renderizar filas expandibles

**UX/UI Implementada:**
- Filas clickeables con hover effect
- Iconos chevron que indican estado (expandido/colapsado)
- Dise√±o responsive manteniendo funcionalidad en pantallas peque√±as
- √Årea expandida con fondo diferenciado para separar contenido
- Descripci√≥n actualizada explicando la nueva funcionalidad

### 3. `components/admin/CompanyUsersTable.tsx`
**Cambios realizados:**
- ‚úÖ Actualizado para usar `getUsersByCompany` con par√°metros de autenticaci√≥n
- ‚úÖ Agregado import de `useAuth` para obtener headers de autenticaci√≥n
- ‚úÖ Mejorada gesti√≥n de estados de carga, error y datos vac√≠os
- ‚úÖ Implementado dise√±o mejorado para estado "sin usuarios"
- ‚úÖ Agregado contador de usuarios encontrados
- ‚úÖ Mejorados estilos de tabla y badges
- ‚úÖ Implementada localizaci√≥n espa√±ola para fechas
- ‚úÖ Agregados estilos personalizados para badges de estado

**UX/UI Mejorada:**
- Estado vac√≠o con icono y mensaje centrado
- Contador din√°mico de usuarios con pluralizaci√≥n correcta
- Badges con colores sem√°nticos (verde para activo, roles diferenciados)
- Tabla responsive con mejor espaciado
- Traducci√≥n de roles (admin ‚Üí Administrador)

### 4. `components/ui/collapsible.tsx` (Nuevo)
**Agregado:**
- ‚úÖ Componente Collapsible de shadcn/ui instalado
- Permite funcionalidad de expansi√≥n/colapso nativa de Radix UI

## Caracter√≠sticas Implementadas

### ‚úÖ **Funcionalidades Core**
1. **Tabla Expandible**: Cada fila de empresa es clickeable para expandir/colapsar
2. **Vista Detallada de Usuarios**: Muestra nombre, email, fecha de creaci√≥n, roles y estado
3. **Indicadores Visuales**: Iconos chevron que muestran estado de expansi√≥n
4. **Responsive Design**: Funciona correctamente en dispositivos m√≥viles y desktop
5. **Estados de Carga**: Skeleton loaders mientras cargan los datos
6. **Manejo de Errores**: Alertas claras para errores de carga

### ‚úÖ **Mejoras UX/UI**
1. **Hover Effects**: Filas con efecto hover para indicar interactividad
2. **Colores Sem√°nticos**: Verde para usuarios activos, rojo para administradores
3. **Estado Vac√≠o Mejorado**: Icono y mensaje cuando no hay usuarios
4. **Contador Din√°mico**: Muestra n√∫mero de usuarios con pluralizaci√≥n
5. **Tipograf√≠a Diferenciada**: Fuentes monospace para emails, emphasis en nombres
6. **Localizaci√≥n**: Fechas en formato espa√±ol (DD/MM/YYYY)

### ‚úÖ **Seguridad y Autenticaci√≥n**
1. **Headers de Autenticaci√≥n**: Uso correcto de X-User-ID y X-Company-ID
2. **Validaci√≥n de Permisos**: Solo administradores pueden acceder
3. **Gesti√≥n de Sesi√≥n**: Manejo correcto de tokens y estados de autenticaci√≥n

## Patr√≥n de Implementaci√≥n

### Estructura de Estados
```typescript
// AdminStats.tsx
const [expandedCompanies, setExpandedCompanies] = useState<Set<string>>(new Set());

// CompanyUsersTable.tsx  
const [users, setUsers] = useState<UserAdminResponse[] | null>(null);
const [isLoading, setIsLoading] = useState(true);
const [error, setError] = useState<string | null>(null);
```

### Flujo de Interacci√≥n
1. Usuario hace clic en fila de empresa
2. Se toggle el estado de expansi√≥n en `expandedCompanies`
3. Si se expande, se renderiza `CompanyUsersTable` 
4. El componente hijo hace llamada API para obtener usuarios
5. Se muestra loading, error o datos seg√∫n corresponda

### Patr√≥n de API
```typescript
// Llamada autenticada con headers requeridos
const authHeaders: AuthHeaders = {
  'X-User-ID': user.userId,
  'X-Company-ID': user.companyId
};
const users = await getUsersByCompany(companyId, authHeaders);
```

## Beneficios Implementados

### üéØ **Para Administradores**
- Vista completa de usuarios por empresa en una sola interfaz
- Acceso r√°pido a informaci√≥n detallada sin navegaci√≥n adicional
- Identificaci√≥n r√°pida de roles y estados de usuarios
- Informaci√≥n de contacto (emails) accesible

### üé® **Experiencia de Usuario**
- Interfaz intuitiva con indicadores visuales claros
- Carga progresiva de datos (lazy loading de usuarios)
- Feedback inmediato de interacciones
- Dise√±o consistente con el resto de la aplicaci√≥n

### üõ°Ô∏è **Seguridad**
- No se muestran contrase√±as en texto plano (cumple con buenas pr√°cticas)
- Autenticaci√≥n y autorizaci√≥n correcta en todas las llamadas
- Filtrado de datos por tenant (company_id)

## Estado de Contrase√±as

**Decisi√≥n de Seguridad:** 
Las contrase√±as NO se muestran en la interfaz siguiendo mejores pr√°cticas de seguridad. En su lugar, el sistema muestra informaci√≥n relevante como roles, estado de activaci√≥n y fechas de creaci√≥n que son suficientes para la gesti√≥n administrativa.

## Pr√≥ximos Pasos Recomendados

### üîÆ **Futuras Mejoras**
1. **Paginaci√≥n**: Implementar paginaci√≥n en `CompanyUsersTable` para empresas con muchos usuarios
2. **Filtros**: Agregar filtros por rol, estado activo, fechas
3. **Acciones**: Botones para activar/desactivar usuarios, cambiar roles
4. **Exportaci√≥n**: Funcionalidad para exportar lista de usuarios
5. **B√∫squeda**: Campo de b√∫squeda por nombre o email dentro de empresa

### üéØ **Optimizaciones**
1. **Caching**: Implementar cache de usuarios para evitar llamadas repetitivas
2. **Virtualizaci√≥n**: Para empresas con miles de usuarios
3. **Animaciones**: Transiciones suaves en expansi√≥n/colapso

## Conclusi√≥n

La implementaci√≥n cumple completamente con los objetivos establecidos, proporcionando una experiencia de administraci√≥n robusta, segura y user-friendly. El dise√±o expandible permite una navegaci√≥n eficiente de la informaci√≥n sin sobrecargar la interfaz inicial, manteniendo la usabilidad y el rendimiento.

La arquitectura implementada es escalable y mantiene la consistencia con los patrones existentes en la aplicaci√≥n, facilitando futuras expansiones y mantenimiento.

```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            // Acceder al viewport DOM element de forma m√°s robusta
            const viewport = scrollAreaRef.current.querySelector('[data-radix-scroll-area-viewport]') as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else {
                // Fallback si querySelector falla (menos probable con la estructura de shadcn)
                const scrollElement = scrollAreaRef.current as HTMLElement;
                if (scrollElement?.scrollTo) {
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100);
                    return () => clearTimeout(timeoutId);
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = {
          id: `client-user-${Date.now()}`,
          role: 'user',
          content: text,
          created_at: new Date().toISOString(),
          user: user ? { name: user.name, email: user.email } : undefined
        };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        // Contenedor ra√≠z de la p√°gina, ocupa toda la altura y es un flex container.
        // Se elimina el padding global de aqu√≠, se aplicar√° internamente.
        <div className="flex flex-col h-full bg-background">
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}
                    // El panel de chat debe ser flex, ocupar altura y manejar su overflow
                    className="flex flex-col h-full min-h-0 relative overflow-hidden" 
                >
                    {/* Bot√≥n para toggle del panel de fuentes */}
                    <div className="absolute top-1 right-1 z-20 p-2">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                            {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                        </Button>
                    </div>
                    {/* ScrollArea para los mensajes. flex-1 y min-h-0 son cruciales aqu√≠. */}
                    <ScrollArea className="flex-1 min-h-0" ref={scrollAreaRef}>
                        {/* Div interno para aplicar padding a los mensajes */}
                        <div className="px-4 py-6 sm:px-6">
                            {renderChatContent()}
                        </div>
                    </ScrollArea>
                    {/* Contenedor del ChatInput, fijo abajo y con padding. */}
                    <div className="border-t border-border/60 px-4 py-3 sm:px-6 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* Panel de fuentes. h-full y overflow-hidden para que maneje su propio scroll */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders, getDocumentStats, DocumentStatsResponse } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  const [stats, setStats] = useState<DocumentStatsResponse | null>(null);
  const [isLoadingStats, setIsLoadingStats] = useState(false);
  const [statsError, setStatsError] = useState<string | null>(null);

  const authHeadersForChildren: AuthHeaders | null = useMemo(() => {
    if (user?.userId && user?.companyId) {
      return {
        'X-User-ID': user.userId,
        'X-Company-ID': user.companyId,
      };
    }
    return null;
  }, [user?.userId, user?.companyId]);

  // Fetch stats from backend
  useEffect(() => {
    if (!authHeadersForChildren) return;
    setIsLoadingStats(true);
    setStatsError(null);
    getDocumentStats(authHeadersForChildren)
      .then(setStats)
      .catch((err) => {
        setStatsError(err?.message || 'Error al obtener estad√≠sticas');
        setStats(null);
      })
      .finally(() => setIsLoadingStats(false));
  }, [authHeadersForChildren]);

  // Mantener fetchDocuments para la lista de documentos
  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas del backend o fallback local ---
  const totalDocs = stats?.total_documents ?? documents.length;
  const totalChunks = stats?.total_chunks ?? documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);
  const statusCounts = stats?.by_status ?? documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-8 w-16" /> : <span className="text-2xl font-bold text-primary">{totalDocs}</span>}
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-12" /> : <span className="text-xl font-semibold text-foreground">{totalChunks}</span>}
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>}
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>}
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>}
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>}
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Mostrar error de stats si ocurre */}
        {statsError && (
          <Alert variant="destructive" className="mt-2">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al obtener estad√≠sticas</AlertTitle>
            <AlertDescription>{statsError}</AlertDescription>
          </Alert>
        )}
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2} className="flex flex-col"> {/* Panel principal ahora es flex-col */}
                  <Header />
                  {/* Main ahora tiene flex-1, min-h-0 y overflow-hidden para que el contenido del chat se ajuste */}
                  <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col">
                      {children}
                  </main>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */

/* Scrollbar bonito para listas de archivos en uploader */
.pretty-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: hsl(var(--muted)) hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar {
  width: 7px;
  background: hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar-thumb {
  background: hsl(var(--muted));
  border-radius: 6px;
}
.pretty-scrollbar::-webkit-scrollbar-track {
  background: hsl(var(--background));
  border-radius: 6px;
}
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}

/* Estilos personalizados para renderizado de Markdown mejorado */
.markdown-content {
  line-height: 1.6;
}

.markdown-content p {
  margin-bottom: 0.75rem;
}

.markdown-content p:last-child {
  margin-bottom: 0;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
  font-weight: 600;
  line-height: 1.3;
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
}

.markdown-content h1:first-child,
.markdown-content h2:first-child,
.markdown-content h3:first-child {
  margin-top: 0;
}

.markdown-content code {
  font-size: 0.875rem;
  font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
  background-color: hsl(var(--muted));
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  font-weight: 500;
}

.markdown-content pre {
  background-color: hsl(var(--muted));
  padding: 1rem;
  border-radius: 0.5rem;
  overflow-x: auto;
  margin: 1rem 0;
}

.markdown-content pre code {
  background-color: transparent;
  padding: 0;
  font-size: 0.875rem;
  font-weight: 400;
}

.markdown-content blockquote {
  border-left: 4px solid hsl(var(--border));
  padding-left: 1rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  margin: 1rem 0;
  font-style: italic;
  color: hsl(var(--muted-foreground));
  background-color: hsla(var(--muted-foreground), 0.05);
  border-radius: 0 0.25rem 0.25rem 0;
}

.markdown-content ul,
.markdown-content ol {
  margin: 0.75rem 0;
  padding-left: 1.5rem;
}

.markdown-content ul {
  list-style-type: disc;
}

.markdown-content ol {
  list-style-type: decimal;
}

.markdown-content li {
  margin: 0.25rem 0;
  line-height: 1.6;
}

.markdown-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
  border: 1px solid hsl(var(--border));
  border-radius: 0.5rem;
  overflow: hidden;
}

.markdown-content th,
.markdown-content td {
  border: 1px solid hsl(var(--border));
  padding: 0.75rem;
  text-align: left;
}

.markdown-content th {
  background-color: hsl(var(--muted));
  font-weight: 600;
}

.markdown-content a {
  color: hsl(var(--primary));
  text-decoration: underline;
  text-underline-offset: 2px;
}

.markdown-content a:hover {
  color: hsl(var(--primary));
  opacity: 0.8;
}

.markdown-content strong {
  font-weight: 600;
}

.markdown-content em {
  font-style: italic;
}

/* Estilos espec√≠ficos para mensajes de usuario (fondo oscuro) */
.user-message .markdown-content code {
  background-color: hsla(var(--primary-foreground), 0.1);
  color: var(--primary-foreground);
}

.user-message .markdown-content pre {
  background-color: hsla(var(--primary-foreground), 0.1);
}

.user-message .markdown-content blockquote {
  border-left-color: hsla(var(--primary-foreground), 0.3);
  color: hsla(var(--primary-foreground), 0.9);
  background-color: hsla(var(--primary-foreground), 0.05);
}

.user-message .markdown-content th {
  background-color: hsla(var(--primary-foreground), 0.1);
}

.user-message .markdown-content th,
.user-message .markdown-content td {
  border-color: hsla(var(--primary-foreground), 0.3);
}

.user-message .markdown-content table {
  border-color: hsla(var(--primary-foreground), 0.3);
}

/* Animaciones suaves para transiciones */
.markdown-content {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(0.5rem);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, ChevronDown, ChevronRight } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { Button } from '@/components/ui/button';
import CompanyUsersTable from './CompanyUsersTable';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [expandedCompanies, setExpandedCompanies] = useState<Set<string>>(new Set());

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  // Funci√≥n para toggle del estado expandido de una empresa
  const toggleCompanyExpansion = (companyId: string) => {
    const newExpanded = new Set(expandedCompanies);
    if (newExpanded.has(companyId)) {
      newExpanded.delete(companyId);
    } else {
      newExpanded.add(companyId);
    }
    setExpandedCompanies(newExpanded);
  };

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>      {/* Tabla de Usuarios por Empresa con Expandible */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa. Haz clic en una empresa para ver sus usuarios.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[40%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
                <TableHead className="w-[50px]"></TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                    <TableCell><Skeleton className="h-4 w-4" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <React.Fragment key={company.company_id}>
                    <TableRow className="cursor-pointer hover:bg-muted/50" onClick={() => toggleCompanyExpansion(company.company_id)}>
                      <TableCell className="font-medium">
                        {company.name || `Empresa ${company.company_id.substring(0, 6)}`}
                      </TableCell>
                      <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">
                        {company.company_id}
                      </TableCell>
                      <TableCell className="text-right font-medium">
                        {company.user_count}
                      </TableCell>
                      <TableCell>
                        <Button variant="ghost" size="sm" className="h-6 w-6 p-0">
                          {expandedCompanies.has(company.company_id) ? (
                            <ChevronDown className="h-4 w-4" />
                          ) : (
                            <ChevronRight className="h-4 w-4" />
                          )}
                        </Button>
                      </TableCell>
                    </TableRow>
                    {expandedCompanies.has(company.company_id) && (
                      <TableRow>
                        <TableCell colSpan={4} className="p-0">
                          <div className="bg-muted/20 p-4 border-t">
                            <h4 className="font-medium mb-3 text-sm">
                              Usuarios de {company.name || `Empresa ${company.company_id.substring(0, 6)}`}
                            </h4>
                            <CompanyUsersTable companyId={company.company_id} />
                          </div>
                        </TableCell>
                      </TableRow>
                    )}
                  </React.Fragment>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={4} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\admin\CompanyUsersTable.tsx`
```tsx
// File: components/admin/CompanyUsersTable.tsx
"use client";

import React, { useEffect, useState } from 'react';
import { getUsersByCompany, UserAdminResponse, AuthHeaders } from '@/lib/api';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';
import { AlertCircle, Users } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';

interface CompanyUsersTableProps {
  companyId: string;
}

export default function CompanyUsersTable({ companyId }: CompanyUsersTableProps) {
  const { user } = useAuth();
  const [users, setUsers] = useState<UserAdminResponse[] | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let mounted = true;
    setIsLoading(true);
    setError(null);
    
    const fetchUsers = async () => {
      if (!user?.userId || !user?.companyId) {
        if (mounted) {
          setError('No se pudo verificar la autenticaci√≥n');
          setIsLoading(false);
        }
        return;
      }

      const authHeaders: AuthHeaders = {
        'X-User-ID': user.userId,
        'X-Company-ID': user.companyId
      };

      try {
        const data = await getUsersByCompany(companyId, authHeaders);
        if (mounted) setUsers(data);
      } catch (err: any) {
        if (mounted) setError(err.message || 'Error al cargar usuarios.');
      } finally {
        if (mounted) setIsLoading(false);
      }
    };

    fetchUsers();
    return () => { mounted = false; };
  }, [companyId, user?.userId, user?.companyId]);

  if (isLoading) {
    return (
      <div className="p-2">
        {[...Array(2)].map((_, i) => (
          <div key={i} className="flex space-x-2 mb-2">
            <Skeleton className="h-4 w-32" />
            <Skeleton className="h-4 w-40" />
            <Skeleton className="h-4 w-24" />
            <Skeleton className="h-4 w-16" />
          </div>
        ))}
      </div>
    );
  }

  if (error) {
    return (
      <Alert variant="destructive" className="my-2">
        <AlertCircle className="h-4 w-4" />
        <AlertTitle>Error</AlertTitle>
        <AlertDescription>{error}</AlertDescription>
      </Alert>
    );
  }
  if (!users || users.length === 0) {
    return (
      <div className="text-muted-foreground text-sm p-4 text-center border rounded-lg bg-muted/30">
        <Users className="h-8 w-8 mx-auto mb-2 opacity-50" />
        <p>No hay usuarios en esta empresa.</p>
      </div>
    );
  }
  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between text-sm text-muted-foreground">
        <span>{users.length} usuario{users.length !== 1 ? 's' : ''} encontrado{users.length !== 1 ? 's' : ''}</span>
      </div>
      <div className="overflow-x-auto">
        <Table>
          <TableHeader>
            <TableRow className="border-muted">
              <TableHead className="font-semibold">Nombre</TableHead>
              <TableHead className="font-semibold">Email</TableHead>
              <TableHead className="font-semibold">Fecha de creaci√≥n</TableHead>
              <TableHead className="font-semibold">Roles</TableHead>
              <TableHead className="font-semibold">Estado</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {users.map((user) => (
              <TableRow key={user.id} className="border-muted/50">
                <TableCell className="font-medium">
                  {user.name || <span className="italic text-muted-foreground">Sin nombre</span>}
                </TableCell>
                <TableCell className="font-mono text-xs text-muted-foreground">
                  {user.email}
                </TableCell>
                <TableCell className="text-sm">
                  {user.created_at ? new Date(user.created_at).toLocaleDateString('es-ES') : '-'}
                </TableCell>
                <TableCell>
                  {user.roles && user.roles.length > 0 ? (
                    <div className="flex flex-wrap gap-1">
                      {user.roles.map((role) => (
                        <Badge 
                          key={role} 
                          variant={role === 'admin' ? 'destructive' : 'secondary'} 
                          className="text-xs"
                        >
                          {role === 'admin' ? 'Administrador' : 'Usuario'}
                        </Badge>
                      ))}
                    </div>
                  ) : (
                    <Badge variant="outline" className="text-xs">Usuario</Badge>
                  )}
                </TableCell>
                <TableCell>
                  {user.is_active ? (
                    <Badge variant="secondary" className="bg-green-100 text-green-800 border-green-200 hover:bg-green-200 text-xs">
                      Activo
                    </Badge>
                  ) : (
                    <Badge variant="outline" className="text-xs">Inactivo</Badge>
                  )}
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
}

```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { Components } from 'react-markdown';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
  user?: { name?: string | null; email?: string | null }; // Para inicial de avatar
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  // Handler para copiar el mensaje al portapapeles y mostrar feedback
  const [copied, setCopied] = React.useState(false);
  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(message.content);
    } catch (err) {
      // fallback: select and copy
      const textarea = document.createElement('textarea');
      textarea.value = message.content;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
    setCopied(true);
    setTimeout(() => setCopied(false), 1200);
  };

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Renderizado optimizado del contenido Markdown */}
         <div className={cn(
           "markdown-content prose max-w-none break-words",
           isUser 
             ? "user-message prose-sm prose-invert prose-p:leading-relaxed prose-headings:text-primary-foreground prose-strong:text-primary-foreground"
             : "prose-sm dark:prose-invert prose-p:leading-relaxed prose-headings:text-foreground prose-strong:text-foreground"
         )}>
            <Markdown 
              remarkPlugins={[remarkGfm]}
              components={{
                // Personalizar el renderizado de elementos espec√≠ficos
                p: ({ children }) => <p className="mb-3 last:mb-0 leading-relaxed">{children}</p>,
                ul: ({ children }) => <ul className="my-3 space-y-1 pl-6">{children}</ul>,
                ol: ({ children }) => <ol className="my-3 space-y-1 pl-6">{children}</ol>,
                li: ({ children }) => <li className="leading-relaxed">{children}</li>,
                blockquote: ({ children }) => (
                  <blockquote className={cn(
                    "border-l-4 pl-4 py-2 my-4 italic rounded-r",
                    isUser 
                      ? "border-primary-foreground/30 text-primary-foreground/90 bg-primary-foreground/5"
                      : "border-border/50 text-muted-foreground bg-muted/30"
                  )}>
                    {children}
                  </blockquote>
                ),
                code: ({ children, className, ...props }) => {
                  const isInlineCode = !className?.includes('language-');
                  if (isInlineCode) {
                    return (
                      <code 
                        className={cn(
                          "px-1.5 py-0.5 text-sm font-mono rounded font-medium",
                          isUser 
                            ? "bg-primary-foreground/10 text-primary-foreground"
                            : "bg-muted text-foreground"
                        )}
                        {...props}
                      >
                        {children}
                      </code>
                    );
                  }
                  return (
                    <code 
                      className={cn(
                        "block p-4 text-sm font-mono rounded-lg overflow-x-auto my-4 font-normal",
                        isUser 
                          ? "bg-primary-foreground/10 text-primary-foreground"
                          : "bg-muted text-foreground",
                        className
                      )}
                      {...props}
                    >
                      {children}
                    </code>
                  );
                },
                pre: ({ children }) => (
                  <pre className="p-0 bg-transparent overflow-visible my-0">
                    {children}
                  </pre>
                ),
                table: ({ children }) => (
                  <div className="overflow-x-auto my-4">
                    <table className={cn(
                      "min-w-full border-collapse rounded-lg overflow-hidden",
                      isUser 
                        ? "border border-primary-foreground/30"
                        : "border border-border"
                    )}>
                      {children}
                    </table>
                  </div>
                ),
                th: ({ children }) => (
                  <th className={cn(
                    "px-3 py-2 font-semibold text-left",
                    isUser 
                      ? "border border-primary-foreground/30 bg-primary-foreground/10"
                      : "border border-border bg-muted"
                  )}>
                    {children}
                  </th>
                ),
                td: ({ children }) => (
                  <td className={cn(
                    "px-3 py-2",
                    isUser 
                      ? "border border-primary-foreground/30"
                      : "border border-border"
                  )}>
                    {children}
                  </td>
                ),
                h1: ({ children }) => (
                  <h1 className="text-xl font-bold mb-3 mt-4 first:mt-0 leading-tight">{children}</h1>
                ),
                h2: ({ children }) => (
                  <h2 className="text-lg font-semibold mb-2 mt-4 first:mt-0 leading-tight">{children}</h2>
                ),
                h3: ({ children }) => (
                  <h3 className="text-base font-medium mb-2 mt-3 first:mt-0 leading-tight">{children}</h3>
                ),
                h4: ({ children }) => (
                  <h4 className="text-sm font-medium mb-2 mt-3 first:mt-0 leading-tight">{children}</h4>
                ),
                strong: ({ children }) => (
                  <strong className="font-semibold">{children}</strong>
                ),
                em: ({ children }) => (
                  <em className="italic">{children}</em>
                ),
                a: ({ children, href, ...props }) => (
                  <a 
                    href={href} 
                    className={cn(
                      "underline underline-offset-2 transition-colors",
                      isUser 
                        ? "text-primary-foreground hover:text-primary-foreground/80"
                        : "text-primary hover:text-primary/80"
                    )}
                    target="_blank" 
                    rel="noopener noreferrer"
                    {...props}
                  >
                    {children}
                  </a>
                ),
                hr: () => (
                  <hr className={cn(
                    "my-4 border-0 h-px",
                    isUser 
                      ? "bg-primary-foreground/30"
                      : "bg-border"
                  )} />
                ),
              } as Components}
            >
                {message.content}
            </Markdown>
         </div>

         {/* Bot√≥n copiar tiny debajo del mensaje */}
         <div className="flex justify-end mt-2">
           <Button
             variant="ghost"
             size="icon"
             className="h-6 w-6 p-0 text-muted-foreground hover:text-primary/90 focus:outline-none focus:ring-1 focus:ring-primary/50"
             style={{ fontSize: 12 }}
             title="Copiar respuesta"
             aria-label="Copiar respuesta"
             onClick={handleCopy}
           >
             <svg width="14" height="14" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
               <rect x="7" y="7" width="9" height="9" rx="2" stroke="currentColor" strokeWidth="1.5"/>
               <rect x="4" y="4" width="9" height="9" rx="2" stroke="currentColor" strokeWidth="1.5" fill="none"/>
             </svg>
           </Button>
           {copied && (
             <span className="ml-2 text-xs text-primary-foreground bg-primary/80 rounded px-2 py-0.5 shadow animate-fade-in">Copiado</span>
           )}
         </div>

         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40 animate-fade-in">
                <p className="text-xs font-semibold text-muted-foreground mb-2 tracking-wide uppercase">Fuentes utilizadas:</p>
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5">
                  {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}` } delayDuration={150}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="outline"
                            size="icon"
                            className="rounded-full px-0 py-0 text-xs font-mono font-semibold h-7 w-7 flex items-center justify-center border-primary/60 hover:border-primary"
                            tabIndex={0}
                            aria-label={`Ver fuente ${index + 1}: ${doc.cita_tag || doc.file_name || 'Detalles'}`}
                            onClick={e => e.preventDefault()} 
                          >
                            {index + 1}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="center" className="max-w-xs text-xs">
                          <div className="font-semibold mb-1 truncate flex items-center gap-1">
                            <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                            {doc.file_name || doc.cita_tag || (doc.id ? `Fragmento ${typeof doc.id === 'string' ? doc.id.substring(0, 8) : ''}` : 'Fragmento')}
                          </div>
                          <div className="text-muted-foreground text-[11px] mb-1.5 break-all">
                            ID Doc: {doc.document_id && typeof doc.document_id === 'string' ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id && typeof doc.id === 'string' ? doc.id.substring(0, 8) : ''}...
                          </div>
                          {doc.score != null && (
                            <div className="font-medium text-muted-foreground text-[11px]">
                              Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                            </div>
                          )}
                          <div className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                            Vista previa:
                            <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}</span>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
             {/* Inicial segura del usuario */}
             {(() => {
               const name = message.user?.name;
               const email = message.user?.email;
               let base = name ?? email ?? 'U';
               if (base == null) base = 'U';
               base = typeof base === 'string' ? base : String(base);
               const initial = base.length > 0 ? base.substring(0, 1).toUpperCase() : 'U';
               return initial;
             })()}
           </AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5 group" title={`Relevancia: ${score.toFixed(3)} / 1.0`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-4 w-4 transition-colors",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400 group-hover:text-yellow-500 group-hover:fill-yellow-500" 
                  : "text-gray-300 fill-gray-200 dark:text-gray-600 dark:fill-gray-700" 
              )}
            />
          ))}
          <span className="ml-1 text-[10px] text-muted-foreground font-mono">{score.toFixed(2)}</span>
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col bg-background"> 
            <div className="sticky top-0 z-20 border-b bg-background/95 px-4 py-3 flex flex-col gap-0.5 shadow-sm"> 
                <div className="flex items-center gap-2">
                  <FileText className="h-5 w-5 text-primary" />
                  <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                </div>
                <span className="text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
            </div>

            <ScrollArea className="flex-1 min-h-0">
                <div className="p-3 space-y-3"> 
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card/95 hover:bg-accent/10",
                                    "border border-border/70 hover:border-primary/60 hover:shadow-lg focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || doc.cita_tag || 'documento'}`}
                            >
                                <CardContent className="p-0">
                                    <div className="flex items-center gap-2 px-3 pt-3">
                                        <span className="flex-shrink-0 h-6 w-6 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border border-border/60">
                                            {index + 1}
                                        </span>
                                        <div className="flex-1 min-w-0">
                                            <span className="block font-medium text-foreground/95 truncate text-sm" title={doc.file_name || doc.cita_tag || (doc.id && typeof doc.id === 'string' ? `Fragmento ${doc.id.substring(0, 8)}` : 'Fragmento')}>
                                                {doc.file_name || doc.cita_tag || (doc.id && typeof doc.id === 'string' ? `Fragmento ${doc.id.substring(0, 8)}` : 'Fragmento')}
                                            </span>
                                            <span className="block text-[11px] text-muted-foreground truncate">
                                                ID Doc: {doc.document_id && typeof doc.document_id === 'string' ? doc.document_id.substring(0, 8) : 'N/A'} / Frag: {doc.id && typeof doc.id === 'string' ? doc.id.substring(0, 8) : ''}
                                            </span>
                                        </div>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed px-10 pb-2 pt-1">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id ? `${selectedDoc.document_id.substring(0,12)}...` : 'N/D'}</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || selectedDoc.content_preview || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name || selectedDoc.file_name === "None"}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {(selectedDoc.file_name && selectedDoc.file_name !== "None") ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Archivos Excel - A√±adido para soporte de hojas de c√°lculo
  'application/vnd.ms-excel': ['.xls'],
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          {/* Contador de archivos y scroll */}
          <div className="flex items-center justify-between mb-1 px-1">
            <span className="text-xs text-muted-foreground">Archivos seleccionados: <b>{files.length}</b></span>
            {files.length > 10 && (
              <span className="text-[10px] text-muted-foreground">Desplaza para ver todos</span>
            )}
          </div>
          <div className="max-h-80 overflow-y-auto space-y-1 pr-1 pretty-scrollbar border rounded-md bg-background/80">
            {files.map(file => (
              <div key={file.name} className="py-1.5 px-2 border border-border/60 rounded flex items-center justify-between gap-2 bg-muted/40 shadow-sm min-h-[38px]">
                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-4 w-4 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-xs font-medium truncate max-w-[180px]" title={file.name}>{file.name}</span>
                    <span className="text-[10px] text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1 py-0 px-1 text-[9px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-3.5 w-3.5" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-20 bg-background pt-3 pb-1 flex justify-end border-t mt-2">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full text-lg font-semibold shadow-lg transition-all duration-150 focus-visible:ring-2 focus-visible:ring-primary/70 focus-visible:ring-offset-2 border-2 border-primary bg-primary text-primary-foreground hover:bg-primary/90 hover:scale-[1.03] active:scale-100 active:bg-primary/80 animate-bounce-once"
              style={{ letterSpacing: '0.01em' }}
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : (
                <>
                  <span className="drop-shadow-sm tracking-wide">Subir y Procesar Archivos</span>
                  <span className="ml-2 px-2 py-0.5 rounded-full bg-primary-foreground/20 text-primary-foreground text-xs font-bold border border-primary-foreground/30">{files.length}</span>
                </>
              )}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\collapsible.tsx`
```tsx
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  )
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  )
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent }

```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            // Acceder al viewport DOM element de forma m√°s robusta
            const viewport = scrollAreaRef.current.querySelector('[data-radix-scroll-area-viewport]') as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else {
                // Fallback si querySelector falla (menos probable con la estructura de shadcn)
                const scrollElement = scrollAreaRef.current as HTMLElement;
                if (scrollElement?.scrollTo) {
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100);
                    return () => clearTimeout(timeoutId);
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        // Contenedor ra√≠z de la p√°gina, ocupa toda la altura y es un flex container.
        // Se elimina el padding global de aqu√≠, se aplicar√° internamente.
        <div className="flex flex-col h-full bg-background">
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}
                    // El panel de chat debe ser flex, ocupar altura y manejar su overflow
                    className="flex flex-col h-full min-h-0 relative overflow-hidden" 
                >
                    {/* Bot√≥n para toggle del panel de fuentes */}
                    <div className="absolute top-1 right-1 z-20 p-2">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                            {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                        </Button>
                    </div>
                    {/* ScrollArea para los mensajes. flex-1 y min-h-0 son cruciales aqu√≠. */}
                    <ScrollArea className="flex-1 min-h-0" ref={scrollAreaRef}>
                        {/* Div interno para aplicar padding a los mensajes */}
                        <div className="px-4 py-6 sm:px-6">
                            {renderChatContent()}
                        </div>
                    </ScrollArea>
                    {/* Contenedor del ChatInput, fijo abajo y con padding. */}
                    <div className="border-t border-border/60 px-4 py-3 sm:px-6 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* Panel de fuentes. h-full y overflow-hidden para que maneje su propio scroll */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders, getDocumentStats, DocumentStatsResponse } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  const [stats, setStats] = useState<DocumentStatsResponse | null>(null);
  const [isLoadingStats, setIsLoadingStats] = useState(false);
  const [statsError, setStatsError] = useState<string | null>(null);

  const authHeadersForChildren: AuthHeaders | null = useMemo(() => {
    if (user?.userId && user?.companyId) {
      return {
        'X-User-ID': user.userId,
        'X-Company-ID': user.companyId,
      };
    }
    return null;
  }, [user?.userId, user?.companyId]);

  // Fetch stats from backend
  useEffect(() => {
    if (!authHeadersForChildren) return;
    setIsLoadingStats(true);
    setStatsError(null);
    getDocumentStats(authHeadersForChildren)
      .then(setStats)
      .catch((err) => {
        setStatsError(err?.message || 'Error al obtener estad√≠sticas');
        setStats(null);
      })
      .finally(() => setIsLoadingStats(false));
  }, [authHeadersForChildren]);

  // Mantener fetchDocuments para la lista de documentos
  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas del backend o fallback local ---
  const totalDocs = stats?.total_documents ?? documents.length;
  const totalChunks = stats?.total_chunks ?? documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);
  const statusCounts = stats?.by_status ?? documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-8 w-16" /> : <span className="text-2xl font-bold text-primary">{totalDocs}</span>}
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-12" /> : <span className="text-xl font-semibold text-foreground">{totalChunks}</span>}
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>}
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>}
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>}
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>}
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Mostrar error de stats si ocurre */}
        {statsError && (
          <Alert variant="destructive" className="mt-2">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al obtener estad√≠sticas</AlertTitle>
            <AlertDescription>{statsError}</AlertDescription>
          </Alert>
        )}
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2} className="flex flex-col"> {/* Panel principal ahora es flex-col */}
                  <Header />
                  {/* Main ahora tiene flex-1, min-h-0 y overflow-hidden para que el contenido del chat se ajuste */}
                  <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col">
                      {children}
                  </main>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */

/* Scrollbar bonito para listas de archivos en uploader */
.pretty-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: hsl(var(--muted)) hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar {
  width: 7px;
  background: hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar-thumb {
  background: hsl(var(--muted));
  border-radius: 6px;
}
.pretty-scrollbar::-webkit-scrollbar-track {
  background: hsl(var(--background));
  border-radius: 6px;
}
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}

/* Estilos personalizados para renderizado de Markdown mejorado */
.markdown-content {
  line-height: 1.6;
}

.markdown-content p {
  margin-bottom: 0.75rem;
}

.markdown-content p:last-child {
  margin-bottom: 0;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
  font-weight: 600;
  line-height: 1.3;
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
}

.markdown-content h1:first-child,
.markdown-content h2:first-child,
.markdown-content h3:first-child {
  margin-top: 0;
}

.markdown-content code {
  font-size: 0.875rem;
  font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
  background-color: hsl(var(--muted));
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  font-weight: 500;
}

.markdown-content pre {
  background-color: hsl(var(--muted));
  padding: 1rem;
  border-radius: 0.5rem;
  overflow-x: auto;
  margin: 1rem 0;
}

.markdown-content pre code {
  background-color: transparent;
  padding: 0;
  font-size: 0.875rem;
  font-weight: 400;
}

.markdown-content blockquote {
  border-left: 4px solid hsl(var(--border));
  padding-left: 1rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  margin: 1rem 0;
  font-style: italic;
  color: hsl(var(--muted-foreground));
  background-color: hsla(var(--muted-foreground), 0.05);
  border-radius: 0 0.25rem 0.25rem 0;
}

.markdown-content ul,
.markdown-content ol {
  margin: 0.75rem 0;
  padding-left: 1.5rem;
}

.markdown-content ul {
  list-style-type: disc;
}

.markdown-content ol {
  list-style-type: decimal;
}

.markdown-content li {
  margin: 0.25rem 0;
  line-height: 1.6;
}

.markdown-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
  border: 1px solid hsl(var(--border));
  border-radius: 0.5rem;
  overflow: hidden;
}

.markdown-content th,
.markdown-content td {
  border: 1px solid hsl(var(--border));
  padding: 0.75rem;
  text-align: left;
}

.markdown-content th {
  background-color: hsl(var(--muted));
  font-weight: 600;
}

.markdown-content a {
  color: hsl(var(--primary));
  text-decoration: underline;
  text-underline-offset: 2px;
}

.markdown-content a:hover {
  color: hsl(var(--primary));
  opacity: 0.8;
}

.markdown-content strong {
  font-weight: 600;
}

.markdown-content em {
  font-style: italic;
}

/* Estilos espec√≠ficos para mensajes de usuario (fondo oscuro) */
.user-message .markdown-content code {
  background-color: hsla(var(--primary-foreground), 0.1);
  color: var(--primary-foreground);
}

.user-message .markdown-content pre {
  background-color: hsla(var(--primary-foreground), 0.1);
}

.user-message .markdown-content blockquote {
  border-left-color: hsla(var(--primary-foreground), 0.3);
  color: hsla(var(--primary-foreground), 0.9);
  background-color: hsla(var(--primary-foreground), 0.05);
}

.user-message .markdown-content th {
  background-color: hsla(var(--primary-foreground), 0.1);
}

.user-message .markdown-content th,
.user-message .markdown-content td {
  border-color: hsla(var(--primary-foreground), 0.3);
}

.user-message .markdown-content table {
  border-color: hsla(var(--primary-foreground), 0.3);
}

/* Animaciones suaves para transiciones */
.markdown-content {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(0.5rem);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { Components } from 'react-markdown';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >         {/* Renderizado optimizado del contenido Markdown */}
         <div className={cn(
           "markdown-content prose max-w-none break-words",
           isUser 
             ? "user-message prose-sm prose-invert prose-p:leading-relaxed prose-headings:text-primary-foreground prose-strong:text-primary-foreground"
             : "prose-sm dark:prose-invert prose-p:leading-relaxed prose-headings:text-foreground prose-strong:text-foreground"
         )}>
            <Markdown 
              remarkPlugins={[remarkGfm]}
              components={{
                // Personalizar el renderizado de elementos espec√≠ficos
                p: ({ children }) => <p className="mb-3 last:mb-0 leading-relaxed">{children}</p>,
                ul: ({ children }) => <ul className="my-3 space-y-1 pl-6">{children}</ul>,
                ol: ({ children }) => <ol className="my-3 space-y-1 pl-6">{children}</ol>,
                li: ({ children }) => <li className="leading-relaxed">{children}</li>,
                blockquote: ({ children }) => (
                  <blockquote className={cn(
                    "border-l-4 pl-4 py-2 my-4 italic rounded-r",
                    isUser 
                      ? "border-primary-foreground/30 text-primary-foreground/90 bg-primary-foreground/5"
                      : "border-border/50 text-muted-foreground bg-muted/30"
                  )}>
                    {children}
                  </blockquote>
                ),
                code: ({ children, className, ...props }) => {
                  const isInlineCode = !className?.includes('language-');
                  if (isInlineCode) {
                    return (
                      <code 
                        className={cn(
                          "px-1.5 py-0.5 text-sm font-mono rounded font-medium",
                          isUser 
                            ? "bg-primary-foreground/10 text-primary-foreground"
                            : "bg-muted text-foreground"
                        )}
                        {...props}
                      >
                        {children}
                      </code>
                    );
                  }
                  return (
                    <code 
                      className={cn(
                        "block p-4 text-sm font-mono rounded-lg overflow-x-auto my-4 font-normal",
                        isUser 
                          ? "bg-primary-foreground/10 text-primary-foreground"
                          : "bg-muted text-foreground",
                        className
                      )}
                      {...props}
                    >
                      {children}
                    </code>
                  );
                },
                pre: ({ children }) => (
                  <pre className="p-0 bg-transparent overflow-visible my-0">
                    {children}
                  </pre>
                ),
                table: ({ children }) => (
                  <div className="overflow-x-auto my-4">
                    <table className={cn(
                      "min-w-full border-collapse rounded-lg overflow-hidden",
                      isUser 
                        ? "border border-primary-foreground/30"
                        : "border border-border"
                    )}>
                      {children}
                    </table>
                  </div>
                ),
                th: ({ children }) => (
                  <th className={cn(
                    "px-3 py-2 font-semibold text-left",
                    isUser 
                      ? "border border-primary-foreground/30 bg-primary-foreground/10"
                      : "border border-border bg-muted"
                  )}>
                    {children}
                  </th>
                ),
                td: ({ children }) => (
                  <td className={cn(
                    "px-3 py-2",
                    isUser 
                      ? "border border-primary-foreground/30"
                      : "border border-border"
                  )}>
                    {children}
                  </td>
                ),
                h1: ({ children }) => (
                  <h1 className="text-xl font-bold mb-3 mt-4 first:mt-0 leading-tight">{children}</h1>
                ),
                h2: ({ children }) => (
                  <h2 className="text-lg font-semibold mb-2 mt-4 first:mt-0 leading-tight">{children}</h2>
                ),
                h3: ({ children }) => (
                  <h3 className="text-base font-medium mb-2 mt-3 first:mt-0 leading-tight">{children}</h3>
                ),
                h4: ({ children }) => (
                  <h4 className="text-sm font-medium mb-2 mt-3 first:mt-0 leading-tight">{children}</h4>
                ),
                strong: ({ children }) => (
                  <strong className="font-semibold">{children}</strong>
                ),
                em: ({ children }) => (
                  <em className="italic">{children}</em>
                ),
                a: ({ children, href, ...props }) => (
                  <a 
                    href={href} 
                    className={cn(
                      "underline underline-offset-2 transition-colors",
                      isUser 
                        ? "text-primary-foreground hover:text-primary-foreground/80"
                        : "text-primary hover:text-primary/80"
                    )}
                    target="_blank" 
                    rel="noopener noreferrer"
                    {...props}
                  >
                    {children}
                  </a>
                ),
                hr: () => (
                  <hr className={cn(
                    "my-4 border-0 h-px",
                    isUser 
                      ? "bg-primary-foreground/30"
                      : "bg-border"
                  )} />
                ),
              } as Components}
            >
                {message.content}
            </Markdown>
         </div>

         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40 animate-fade-in">
                <p className="text-xs font-semibold text-muted-foreground mb-2 tracking-wide uppercase">Fuentes utilizadas:</p>
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5">
                  {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}` } delayDuration={150}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="outline"
                            size="icon"
                            className="rounded-full px-0 py-0 text-xs font-mono font-semibold h-7 w-7 flex items-center justify-center border-primary/60 hover:border-primary"
                            tabIndex={0}
                            aria-label={`Ver fuente ${index + 1}: ${doc.cita_tag || doc.file_name || 'Detalles'}`}
                            // El panel de fuentes principal se encarga de abrir el modal, este solo muestra tooltip.
                            // Si se quisiera que estos botones tambi√©n abran el modal, se necesitar√≠a pasar
                            // la funci√≥n para abrir el modal y el documento seleccionado a este componente.
                            onClick={e => e.preventDefault()} 
                          >
                            {index + 1}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="center" className="max-w-xs text-xs">
                          <div className="font-semibold mb-1 truncate flex items-center gap-1">
                            <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                            {doc.file_name || doc.cita_tag || `Fragmento ${doc.id?.substring(0, 8)}`}
                          </div>
                          <div className="text-muted-foreground text-[11px] mb-1.5 break-all">
                            ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                          </div>
                          {doc.score != null && (
                            <div className="font-medium text-muted-foreground text-[11px]">
                              Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                            </div>
                          )}
                          <div className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                            Vista previa:
                            <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}</span>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5 group" title={`Relevancia: ${score.toFixed(3)} / 1.0`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-4 w-4 transition-colors",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400 group-hover:text-yellow-500 group-hover:fill-yellow-500" 
                  : "text-gray-300 fill-gray-200 dark:text-gray-600 dark:fill-gray-700" 
              )}
            />
          ))}
          <span className="ml-1 text-[10px] text-muted-foreground font-mono">{score.toFixed(2)}</span>
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col bg-background"> 
            <div className="sticky top-0 z-20 border-b bg-background/95 px-4 py-3 flex flex-col gap-0.5 shadow-sm"> 
                <div className="flex items-center gap-2">
                  <FileText className="h-5 w-5 text-primary" />
                  <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                </div>
                <span className="text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
            </div>

            <ScrollArea className="flex-1 min-h-0">
                <div className="p-3 space-y-3"> 
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card/95 hover:bg-accent/10",
                                    "border border-border/70 hover:border-primary/60 hover:shadow-lg focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || doc.cita_tag || 'documento'}`}
                            >
                                <CardContent className="p-0">
                                    <div className="flex items-center gap-2 px-3 pt-3">
                                        <span className="flex-shrink-0 h-6 w-6 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border border-border/60">
                                            {index + 1}
                                        </span>
                                        <div className="flex-1 min-w-0">
                                            <span className="block font-medium text-foreground/95 truncate text-sm" title={doc.file_name || doc.cita_tag || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || doc.cita_tag || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                            <span className="block text-[11px] text-muted-foreground truncate">
                                                ID Doc: {doc.document_id?.substring(0, 8) ?? 'N/A'} / Frag: {doc.id.substring(0, 8)}
                                            </span>
                                        </div>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed px-10 pb-2 pt-1">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id ? `${selectedDoc.document_id.substring(0,12)}...` : 'N/D'}</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || selectedDoc.content_preview || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name || selectedDoc.file_name === "None"}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {(selectedDoc.file_name && selectedDoc.file_name !== "None") ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          {/* Contador de archivos y scroll */}
          <div className="flex items-center justify-between mb-1 px-1">
            <span className="text-xs text-muted-foreground">Archivos seleccionados: <b>{files.length}</b></span>
            {files.length > 10 && (
              <span className="text-[10px] text-muted-foreground">Desplaza para ver todos</span>
            )}
          </div>
          <div className="max-h-80 overflow-y-auto space-y-1 pr-1 pretty-scrollbar border rounded-md bg-background/80">
            {files.map(file => (
              <div key={file.name} className="py-1.5 px-2 border border-border/60 rounded flex items-center justify-between gap-2 bg-muted/40 shadow-sm min-h-[38px]">
                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-4 w-4 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-xs font-medium truncate max-w-[180px]" title={file.name}>{file.name}</span>
                    <span className="text-[10px] text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1 py-0 px-1 text-[9px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-3.5 w-3.5" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-20 bg-background pt-3 pb-1 flex justify-end border-t mt-2">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full"
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : `Subir y Procesar Archivos (${files.length})`}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            // Acceder al viewport DOM element de forma m√°s robusta
            const viewport = scrollAreaRef.current.querySelector('[data-radix-scroll-area-viewport]') as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else {
                // Fallback si querySelector falla (menos probable con la estructura de shadcn)
                const scrollElement = scrollAreaRef.current as HTMLElement;
                if (scrollElement?.scrollTo) {
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100);
                    return () => clearTimeout(timeoutId);
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        // Contenedor ra√≠z de la p√°gina, ocupa toda la altura y es un flex container.
        // Se elimina el padding global de aqu√≠, se aplicar√° internamente.
        <div className="flex flex-col h-full bg-background">
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}
                    // El panel de chat debe ser flex, ocupar altura y manejar su overflow
                    className="flex flex-col h-full min-h-0 relative overflow-hidden" 
                >
                    {/* Bot√≥n para toggle del panel de fuentes */}
                    <div className="absolute top-1 right-1 z-20 p-2">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                            {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                        </Button>
                    </div>
                    {/* ScrollArea para los mensajes. flex-1 y min-h-0 son cruciales aqu√≠. */}
                    <ScrollArea className="flex-1 min-h-0" ref={scrollAreaRef}>
                        {/* Div interno para aplicar padding a los mensajes */}
                        <div className="px-4 py-6 sm:px-6">
                            {renderChatContent()}
                        </div>
                    </ScrollArea>
                    {/* Contenedor del ChatInput, fijo abajo y con padding. */}
                    <div className="border-t border-border/60 px-4 py-3 sm:px-6 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* Panel de fuentes. h-full y overflow-hidden para que maneje su propio scroll */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders, getDocumentStats, DocumentStatsResponse } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  const [stats, setStats] = useState<DocumentStatsResponse | null>(null);
  const [isLoadingStats, setIsLoadingStats] = useState(false);
  const [statsError, setStatsError] = useState<string | null>(null);

  const authHeadersForChildren: AuthHeaders | null = useMemo(() => {
    if (user?.userId && user?.companyId) {
      return {
        'X-User-ID': user.userId,
        'X-Company-ID': user.companyId,
      };
    }
    return null;
  }, [user?.userId, user?.companyId]);

  // Fetch stats from backend
  useEffect(() => {
    if (!authHeadersForChildren) return;
    setIsLoadingStats(true);
    setStatsError(null);
    getDocumentStats(authHeadersForChildren)
      .then(setStats)
      .catch((err) => {
        setStatsError(err?.message || 'Error al obtener estad√≠sticas');
        setStats(null);
      })
      .finally(() => setIsLoadingStats(false));
  }, [authHeadersForChildren]);

  // Mantener fetchDocuments para la lista de documentos
  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas del backend o fallback local ---
  const totalDocs = stats?.total_documents ?? documents.length;
  const totalChunks = stats?.total_chunks ?? documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);
  const statusCounts = stats?.by_status ?? documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-8 w-16" /> : <span className="text-2xl font-bold text-primary">{totalDocs}</span>}
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-12" /> : <span className="text-xl font-semibold text-foreground">{totalChunks}</span>}
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>}
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>}
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>}
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>}
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Mostrar error de stats si ocurre */}
        {statsError && (
          <Alert variant="destructive" className="mt-2">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al obtener estad√≠sticas</AlertTitle>
            <AlertDescription>{statsError}</AlertDescription>
          </Alert>
        )}
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2} className="flex flex-col"> {/* Panel principal ahora es flex-col */}
                  <Header />
                  {/* Main ahora tiene flex-1, min-h-0 y overflow-hidden para que el contenido del chat se ajuste */}
                  <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col">
                      {children}
                  </main>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */

/* Scrollbar bonito para listas de archivos en uploader */
.pretty-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: hsl(var(--muted)) hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar {
  width: 7px;
  background: hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar-thumb {
  background: hsl(var(--muted));
  border-radius: 6px;
}
.pretty-scrollbar::-webkit-scrollbar-track {
  background: hsl(var(--background));
  border-radius: 6px;
}
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* FLAG_LLM: Aplicar clases prose al div contenedor del Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40 animate-fade-in">
                <p className="text-xs font-semibold text-muted-foreground mb-2 tracking-wide uppercase">Fuentes utilizadas:</p>
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5">
                  {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}` } delayDuration={150}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="outline"
                            size="icon"
                            className="rounded-full px-0 py-0 text-xs font-mono font-semibold h-7 w-7 flex items-center justify-center border-primary/60 hover:border-primary"
                            tabIndex={0}
                            aria-label={`Ver fuente ${index + 1}: ${doc.cita_tag || doc.file_name || 'Detalles'}`}
                            // El panel de fuentes principal se encarga de abrir el modal, este solo muestra tooltip.
                            // Si se quisiera que estos botones tambi√©n abran el modal, se necesitar√≠a pasar
                            // la funci√≥n para abrir el modal y el documento seleccionado a este componente.
                            onClick={e => e.preventDefault()} 
                          >
                            {index + 1}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="center" className="max-w-xs text-xs">
                          <div className="font-semibold mb-1 truncate flex items-center gap-1">
                            <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                            {doc.file_name || doc.cita_tag || `Fragmento ${doc.id?.substring(0, 8)}`}
                          </div>
                          <div className="text-muted-foreground text-[11px] mb-1.5 break-all">
                            ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                          </div>
                          {doc.score != null && (
                            <div className="font-medium text-muted-foreground text-[11px]">
                              Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                            </div>
                          )}
                          <div className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                            Vista previa:
                            <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}</span>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5 group" title={`Relevancia: ${score.toFixed(3)} / 1.0`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-4 w-4 transition-colors",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400 group-hover:text-yellow-500 group-hover:fill-yellow-500" 
                  : "text-gray-300 fill-gray-200 dark:text-gray-600 dark:fill-gray-700" 
              )}
            />
          ))}
          <span className="ml-1 text-[10px] text-muted-foreground font-mono">{score.toFixed(2)}</span>
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col bg-background"> 
            <div className="sticky top-0 z-20 border-b bg-background/95 px-4 py-3 flex flex-col gap-0.5 shadow-sm"> 
                <div className="flex items-center gap-2">
                  <FileText className="h-5 w-5 text-primary" />
                  <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                </div>
                <span className="text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
            </div>

            <ScrollArea className="flex-1 min-h-0">
                <div className="p-3 space-y-3"> 
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card/95 hover:bg-accent/10",
                                    "border border-border/70 hover:border-primary/60 hover:shadow-lg focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || doc.cita_tag || 'documento'}`}
                            >
                                <CardContent className="p-0">
                                    <div className="flex items-center gap-2 px-3 pt-3">
                                        <span className="flex-shrink-0 h-6 w-6 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border border-border/60">
                                            {index + 1}
                                        </span>
                                        <div className="flex-1 min-w-0">
                                            <span className="block font-medium text-foreground/95 truncate text-sm" title={doc.file_name || doc.cita_tag || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || doc.cita_tag || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                            <span className="block text-[11px] text-muted-foreground truncate">
                                                ID Doc: {doc.document_id?.substring(0, 8) ?? 'N/A'} / Frag: {doc.id.substring(0, 8)}
                                            </span>
                                        </div>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed px-10 pb-2 pt-1">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id ? `${selectedDoc.document_id.substring(0,12)}...` : 'N/D'}</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || selectedDoc.content_preview || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name || selectedDoc.file_name === "None"}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {(selectedDoc.file_name && selectedDoc.file_name !== "None") ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          {/* Contador de archivos y scroll */}
          <div className="flex items-center justify-between mb-1 px-1">
            <span className="text-xs text-muted-foreground">Archivos seleccionados: <b>{files.length}</b></span>
            {files.length > 10 && (
              <span className="text-[10px] text-muted-foreground">Desplaza para ver todos</span>
            )}
          </div>
          <div className="max-h-80 overflow-y-auto space-y-1 pr-1 pretty-scrollbar border rounded-md bg-background/80">
            {files.map(file => (
              <div key={file.name} className="py-1.5 px-2 border border-border/60 rounded flex items-center justify-between gap-2 bg-muted/40 shadow-sm min-h-[38px]">
                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-4 w-4 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-xs font-medium truncate max-w-[180px]" title={file.name}>{file.name}</span>
                    <span className="text-[10px] text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1 py-0 px-1 text-[9px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-3.5 w-3.5" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-20 bg-background pt-3 pb-1 flex justify-end border-t mt-2">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full"
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : `Subir y Procesar Archivos (${files.length})`}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            const viewport = scrollAreaRef.current?.viewport as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else { 
                const scrollElement = scrollAreaRef.current as HTMLElement; 
                if (scrollElement?.scrollTo) { 
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100); 
                    return () => clearTimeout(timeoutId); 
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any); // Mapeo para fuentes de panel derecho
            const assistantMessage: Message = { 
                id: `client-assistant-${Date.now()}`, 
                role: 'assistant', 
                content: response.answer, 
                // Usar el mapeo especial para fuentes del mensaje que pueden tener estructura diferente
                sources: mapApiSourcesToFrontend(response.retrieved_documents as any[]), // Mapeo para fuentes de mensaje
                created_at: new Date().toISOString() 
            };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(response.retrieved_documents || []); // Panel usa datos directos
            lastDocsRef.current = response.retrieved_documents || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        // FLAG_LLM: Asegurar que este div ocupe toda la altura (h-full) que le da el AppLayout
        // y que sea un contenedor flex vertical.
        <div className="flex flex-col h-full bg-background">
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}>
                    {/* Contenedor Interno del Panel de Chat: flex, h-full, flex-col, relative, overflow-hidden */}
                    <div className="flex h-full flex-col relative overflow-hidden">
                         <div className="absolute top-1 right-1 z-20 p-2"> {/* Padding para que el bot√≥n no pegue al borde */}
                             <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                             </Button>
                        </div>
                        {/* ScrollArea con flex-1 para que ocupe el espacio vertical */}
                        <ScrollArea className="flex-1" ref={scrollAreaRef}>
                             <div className="px-4 py-6 sm:px-6"> {/* Padding para contenido de mensajes */}
                                {renderChatContent()}
                             </div>
                        </ScrollArea>
                        {/* Contenedor de Input fijo abajo */}
                        <div className="border-t border-border/60 px-4 py-3 sm:px-6 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                             <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                           {/* Asegurar que RetrievedDocumentsPanel tambi√©n maneje su scroll interno */}
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders, getDocumentStats, DocumentStatsResponse } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  const [stats, setStats] = useState<DocumentStatsResponse | null>(null);
  const [isLoadingStats, setIsLoadingStats] = useState(false);
  const [statsError, setStatsError] = useState<string | null>(null);

  const authHeadersForChildren: AuthHeaders | null = useMemo(() => {
    if (user?.userId && user?.companyId) {
      return {
        'X-User-ID': user.userId,
        'X-Company-ID': user.companyId,
      };
    }
    return null;
  }, [user?.userId, user?.companyId]);

  // Fetch stats from backend
  useEffect(() => {
    if (!authHeadersForChildren) return;
    setIsLoadingStats(true);
    setStatsError(null);
    getDocumentStats(authHeadersForChildren)
      .then(setStats)
      .catch((err) => {
        setStatsError(err?.message || 'Error al obtener estad√≠sticas');
        setStats(null);
      })
      .finally(() => setIsLoadingStats(false));
  }, [authHeadersForChildren]);

  // Mantener fetchDocuments para la lista de documentos
  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas del backend o fallback local ---
  const totalDocs = stats?.total_documents ?? documents.length;
  const totalChunks = stats?.total_chunks ?? documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);
  const statusCounts = stats?.by_status ?? documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-8 w-16" /> : <span className="text-2xl font-bold text-primary">{totalDocs}</span>}
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-12" /> : <span className="text-xl font-semibold text-foreground">{totalChunks}</span>}
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>}
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>}
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>}
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>}
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Mostrar error de stats si ocurre */}
        {statsError && (
          <Alert variant="destructive" className="mt-2">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al obtener estad√≠sticas</AlertTitle>
            <AlertDescription>{statsError}</AlertDescription>
          </Alert>
        )}
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      {/* Solo mostrar Header si NO estamos en /chat ni subrutas */}
                      {!(pathname.startsWith('/chat')) && <Header />}
                      {/* Main debe tener overflow:hidden y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col"> {/* overflow-hidden y min-h-0 para scroll interno */}
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */

/* Scrollbar bonito para listas de archivos en uploader */
.pretty-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: hsl(var(--muted)) hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar {
  width: 7px;
  background: hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar-thumb {
  background: hsl(var(--muted));
  border-radius: 6px;
}
.pretty-scrollbar::-webkit-scrollbar-track {
  background: hsl(var(--background));
  border-radius: 6px;
}
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40 animate-fade-in">
                <p className="text-xs font-semibold text-muted-foreground mb-2 tracking-wide uppercase">Fuentes utilizadas:</p>
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5">
                  {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}` } delayDuration={150}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="outline"
                            size="icon"
                            className="rounded-full px-0 py-0 text-xs font-mono font-semibold h-7 w-7 flex items-center justify-center border-primary/60 hover:border-primary"
                            tabIndex={0}
                            aria-label={`Ver fuente ${index + 1}: ${doc.cita_tag || doc.file_name || 'Detalles'}`}
                            onClick={e => e.preventDefault()} // Prevenir cualquier acci√≥n de navegaci√≥n por defecto
                          >
                            {index + 1}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="center" className="max-w-xs text-xs">
                          <div className="font-semibold mb-1 truncate flex items-center gap-1">
                            <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                            {doc.file_name || doc.cita_tag || `Fragmento ${doc.id?.substring(0, 8)}`}
                          </div>
                          <div className="text-muted-foreground text-[11px] mb-1.5 break-all">
                            ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                          </div>
                          {doc.score != null && (
                            <div className="font-medium text-muted-foreground text-[11px]">
                              Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                            </div>
                          )}
                          <div className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                            Vista previa:
                            <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}</span>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
  showMeta?: boolean; 
}

export function RetrievedDocumentsPanel({ documents, isLoading, showMeta }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5 group" title={`Relevancia: ${score.toFixed(3)} / 1.0`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-4 w-4 transition-colors",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400 group-hover:text-yellow-500 group-hover:fill-yellow-500" 
                  : "text-gray-300 fill-gray-200 dark:text-gray-600 dark:fill-gray-700" 
              )}
            />
          ))}
          <span className="ml-1 text-[10px] text-muted-foreground font-mono">{score.toFixed(2)}</span>
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col bg-background">
            <div className="sticky top-0 z-20 border-b bg-background/95 px-6 py-3 flex flex-col gap-0.5 shadow-sm">
                <div className="flex items-center gap-2">
                  <FileText className="h-5 w-5 text-primary" />
                  <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                </div>
                <span className="text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
            </div>

            <ScrollArea className="flex-1 min-h-0">
                <div className="p-4 space-y-3">
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card/95 hover:bg-accent/10",
                                    "border border-border/70 hover:border-primary/60 hover:shadow-lg focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || doc.cita_tag || 'documento'}`}
                            >
                                <CardContent className="p-0">
                                    <div className="flex items-center gap-2 px-3 pt-3">
                                        <span className="flex-shrink-0 h-6 w-6 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border border-border/60">
                                            {index + 1}
                                        </span>
                                        <div className="flex-1 min-w-0">
                                            <span className="block font-medium text-foreground/95 truncate text-sm" title={doc.file_name || doc.cita_tag || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || doc.cita_tag || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                            <span className="block text-[11px] text-muted-foreground truncate">
                                                ID Doc: {doc.document_id?.substring(0, 8) ?? 'N/A'} / Frag: {doc.id.substring(0, 8)}
                                            </span>
                                        </div>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed px-10 pb-2 pt-1">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || selectedDoc.cita_tag || selectedDoc.document_id || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id ? `${selectedDoc.document_id.substring(0,12)}...` : 'N/D'}</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {showMeta && selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name || selectedDoc.file_name === "None"}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {(selectedDoc.file_name && selectedDoc.file_name !== "None") ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          {/* Contador de archivos y scroll */}
          <div className="flex items-center justify-between mb-1 px-1">
            <span className="text-xs text-muted-foreground">Archivos seleccionados: <b>{files.length}</b></span>
            {files.length > 10 && (
              <span className="text-[10px] text-muted-foreground">Desplaza para ver todos</span>
            )}
          </div>
          <div className="max-h-80 overflow-y-auto space-y-1 pr-1 pretty-scrollbar border rounded-md bg-background/80">
            {files.map(file => (
              <div key={file.name} className="py-1.5 px-2 border border-border/60 rounded flex items-center justify-between gap-2 bg-muted/40 shadow-sm min-h-[38px]">
                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-4 w-4 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-xs font-medium truncate max-w-[180px]" title={file.name}>{file.name}</span>
                    <span className="text-[10px] text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1 py-0 px-1 text-[9px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-3.5 w-3.5" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-20 bg-background pt-3 pb-1 flex justify-end border-t mt-2">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full"
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : `Subir y Procesar Archivos (${files.length})`}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import SnakeAnimation from '@/components/animations/snakeanimation';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    // Scroll to bottom on send and receive
    useEffect(() => {
        if (!isLoadingHistory && messages.length > 0) {
            let scrollTarget = null;
            // Try to get the Radix ScrollArea viewport
            if (scrollAreaRef.current) {
                // Radix exposes the viewport as a child node with data-slot="scroll-area-viewport"
                if (scrollAreaRef.current.querySelector) {
                    scrollTarget = scrollAreaRef.current.querySelector('[data-slot="scroll-area-viewport"]');
                }
                // fallback: try ref itself
                if (!scrollTarget && scrollAreaRef.current.scrollTo) {
                    scrollTarget = scrollAreaRef.current;
                }
            }
            if (scrollTarget && scrollTarget.scrollTo) {
                const timeoutId = setTimeout(() => {
                    scrollTarget.scrollTo({ top: scrollTarget.scrollHeight, behavior: 'smooth' });
                }, 100);
                return () => clearTimeout(timeoutId);
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return (
          <div className="space-y-6">
            {messages.map((message) => (
              <ChatMessage key={message.id} message={message} />
            ))}
            {isSending && (
              <div className="flex w-full items-start gap-3 pr-10 sm:pr-16">
                <div className="skeleton-thinking-avatar skeleton animate-pulse flex items-center justify-center">
                  <span className="sr-only">Assistant typing</span>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" fill="currentColor" className="text-primary/60" /></svg>
                </div>
                <div className="skeleton-thinking-text flex-1 pt-1.5">
                  <div className="skeleton-thinking-line skeleton animate-pulse w-32 mb-1" />
                  <div className="skeleton-thinking-line skeleton animate-pulse w-24" />
                  <div className="flex gap-1 mt-2">
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '0ms' }} />
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '120ms' }} />
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '240ms' }} />
                  </div>
                </div>
              </div>
            )}
          </div>
        );
    };

    return (
        // El chat y el panel de fuentes ocupan toda la pantalla, cada uno con su propio scroll
        <div className="flex flex-col h-screen w-full bg-background min-h-0">
            <ResizablePanelGroup direction="horizontal" className="flex-1 h-full w-full overflow-hidden min-h-0">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100} className="h-full min-h-0">
                    <div className="flex h-full flex-col relative overflow-hidden min-h-0">
                        <div className="absolute top-1 right-1 z-20">
                            <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            </Button>
                        </div>
                        {/* Chat window con su propio scroll */}
                        <div className="flex flex-col flex-1 min-h-0 h-0 relative">
                            <ScrollArea className="flex-1 min-h-0 h-0 w-full" ref={scrollAreaRef}>
                                <div className="px-3 py-4 sm:px-4 sm:py-5 min-h-full">{/* Padding interno para mensajes */}
                                    {renderChatContent()}
                                </div>
                            </ScrollArea>
                            <div className="border-t border-border/60 px-3 py-3 sm:px-4 sm:py-4 bg-background/95 backdrop-blur-sm shadow-sm shrink-0 z-10 relative">
                                <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                            </div>
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* Panel de fuentes relevante con scroll propio y mejor UI/UX */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden bg-muted/60 border-l border-border/60 shadow-inner">
                            <div className="flex flex-col h-full">
                                <div className="px-4 py-3 border-b border-border/40 bg-background/80 sticky top-0 z-10 flex items-center gap-2">
                                    <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                                    <span className="ml-auto text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
                                </div>
                                <ScrollArea className="flex-1 h-full w-full">
                                    <RetrievedDocumentsPanel 
                                        documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} 
                                        isLoading={isSending}
                                        showMeta // Nueva prop para mostrar metadatos y formato mejorado
                                    />
                                </ScrollArea>
                            </div>
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders, getDocumentStats, DocumentStatsResponse } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  const [stats, setStats] = useState<DocumentStatsResponse | null>(null);
  const [isLoadingStats, setIsLoadingStats] = useState(false);
  const [statsError, setStatsError] = useState<string | null>(null);

  const authHeadersForChildren: AuthHeaders | null = useMemo(() => {
    if (user?.userId && user?.companyId) {
      return {
        'X-User-ID': user.userId,
        'X-Company-ID': user.companyId,
      };
    }
    return null;
  }, [user?.userId, user?.companyId]);

  // Fetch stats from backend
  useEffect(() => {
    if (!authHeadersForChildren) return;
    setIsLoadingStats(true);
    setStatsError(null);
    getDocumentStats(authHeadersForChildren)
      .then(setStats)
      .catch((err) => {
        setStatsError(err?.message || 'Error al obtener estad√≠sticas');
        setStats(null);
      })
      .finally(() => setIsLoadingStats(false));
  }, [authHeadersForChildren]);

  // Mantener fetchDocuments para la lista de documentos
  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas del backend o fallback local ---
  const totalDocs = stats?.total_documents ?? documents.length;
  const totalChunks = stats?.total_chunks ?? documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);
  const statusCounts = stats?.by_status ?? documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-8 w-16" /> : <span className="text-2xl font-bold text-primary">{totalDocs}</span>}
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-12" /> : <span className="text-xl font-semibold text-foreground">{totalChunks}</span>}
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>}
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>}
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>}
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              {isLoadingStats ? <Skeleton className="h-6 w-10" /> : <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>}
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Mostrar error de stats si ocurre */}
        {statsError && (
          <Alert variant="destructive" className="mt-2">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al obtener estad√≠sticas</AlertTitle>
            <AlertDescription>{statsError}</AlertDescription>
          </Alert>
        )}
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      {/* Solo mostrar Header si NO estamos en /chat ni subrutas */}
                      {!(pathname.startsWith('/chat')) && <Header />}
                      {/* Main debe tener overflow:hidden y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col"> {/* overflow-hidden y min-h-0 para scroll interno */}
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */

/* Scrollbar bonito para listas de archivos en uploader */
.pretty-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: hsl(var(--muted)) hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar {
  width: 7px;
  background: hsl(var(--background));
}
.pretty-scrollbar::-webkit-scrollbar-thumb {
  background: hsl(var(--muted));
  border-radius: 6px;
}
.pretty-scrollbar::-webkit-scrollbar-track {
  background: hsl(var(--background));
  border-radius: 6px;
}
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx (REFACTORIZADO - Fuentes mejoradas)
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText, CircleDot } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"
// import { Badge } from '@/components/ui/badge'; // Badge ya no se usa para fuentes

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Contenido Markdown */}
         {/* Asegurar que prose tenga los estilos correctos definidos en tailwind.config y globals.css */}
         {/* FLAG_LLM: Aplicar prose al div exterior, no al componente Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {/* Secci√≥n de Fuentes (UI Mejorada) */}
         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40 animate-fade-in">
                <p className="text-xs font-semibold text-muted-foreground mb-2 tracking-wide uppercase">Fuentes utilizadas:</p>
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5">
                  {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}` } delayDuration={150}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="outline"
                            size="icon"
                            className="rounded-full px-0 py-0 text-xs font-mono font-semibold h-7 w-7 flex items-center justify-center border-primary/60 hover:border-primary"
                            tabIndex={0}
                            aria-label={`Ver fuente ${index + 1}`}
                            onClick={e => e.preventDefault()}
                          >
                            {index + 1}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="center" className="max-w-xs text-xs">
                          <div className="font-semibold mb-1 truncate flex items-center gap-1">
                            <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                            {doc.file_name || `Fragmento ${doc.id?.substring(0, 8)}`}
                          </div>
                          <div className="text-muted-foreground text-[11px] mb-1.5 break-all">
                            ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                          </div>
                          {doc.score != null && (
                            <div className="font-medium text-muted-foreground text-[11px]">
                              Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                            </div>
                          )}
                          <div className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                            Vista previa:
                            <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}</span>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
  showMeta?: boolean; // Permite mostrar metadatos y formato extendido
}

export function RetrievedDocumentsPanel({ documents, isLoading, showMeta }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    // Las estrellas representan la relevancia del fragmento respecto a la consulta (score de 0 a 1, 5 estrellas m√°ximo)
    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5 group" title={`Relevancia: ${score.toFixed(3)} / 1.0`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-4 w-4 transition-colors",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400 group-hover:text-yellow-500 group-hover:fill-yellow-500" 
                  : "text-gray-300 fill-gray-200 dark:text-gray-600 dark:fill-gray-700" 
              )}
            />
          ))}
          <span className="ml-1 text-[10px] text-muted-foreground font-mono">{score.toFixed(2)}</span>
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col bg-background">
            {/* Header sticky mejorado, sin overlapping */}
            <div className="sticky top-0 z-20 border-b bg-background/95 px-6 py-3 flex flex-col gap-0.5 shadow-sm">
                <div className="flex items-center gap-2">
                  <FileText className="h-5 w-5 text-primary" />
                  <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                </div>
                <span className="text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
            </div>

            <ScrollArea className="flex-1 min-h-0">
                <div className="p-4 space-y-3">
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card/95 hover:bg-accent/10",
                                    "border border-border/70 hover:border-primary/60 hover:shadow-lg focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || 'documento'}`}
                            >
                                <CardContent className="p-0">
                                    <div className="flex items-center gap-2 px-3 pt-3">
                                        <span className="flex-shrink-0 h-6 w-6 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border border-border/60">
                                            {index + 1}
                                        </span>
                                        <div className="flex-1 min-w-0">
                                            <span className="block font-medium text-foreground/95 truncate text-sm" title={doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}>{doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}</span>
                                            <span className="block text-[11px] text-muted-foreground truncate">ID: {doc.document_id?.substring(0, 8) ?? doc.id.substring(0, 8)}...</span>
                                        </div>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed px-10 pb-2 pt-1">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id?.substring(0,12) || 'N/D'}...</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {showMeta && selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {selectedDoc.file_name ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          {/* Contador de archivos y scroll */}
          <div className="flex items-center justify-between mb-1 px-1">
            <span className="text-xs text-muted-foreground">Archivos seleccionados: <b>{files.length}</b></span>
            {files.length > 10 && (
              <span className="text-[10px] text-muted-foreground">Desplaza para ver todos</span>
            )}
          </div>
          <div className="max-h-80 overflow-y-auto space-y-1 pr-1 pretty-scrollbar border rounded-md bg-background/80">
            {files.map(file => (
              <div key={file.name} className="py-1.5 px-2 border border-border/60 rounded flex items-center justify-between gap-2 bg-muted/40 shadow-sm min-h-[38px]">
                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-4 w-4 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-xs font-medium truncate max-w-[180px]" title={file.name}>{file.name}</span>
                    <span className="text-[10px] text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1 py-0 px-1 text-[9px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-3.5 w-3.5" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-20 bg-background pt-3 pb-1 flex justify-end border-t mt-2">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full"
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : `Subir y Procesar Archivos (${files.length})`}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import SnakeAnimation from '@/components/animations/snakeanimation';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    // Scroll to bottom on send and receive
    useEffect(() => {
        if (!isLoadingHistory && messages.length > 0) {
            let scrollTarget = null;
            // Try to get the Radix ScrollArea viewport
            if (scrollAreaRef.current) {
                // Radix exposes the viewport as a child node with data-slot="scroll-area-viewport"
                if (scrollAreaRef.current.querySelector) {
                    scrollTarget = scrollAreaRef.current.querySelector('[data-slot="scroll-area-viewport"]');
                }
                // fallback: try ref itself
                if (!scrollTarget && scrollAreaRef.current.scrollTo) {
                    scrollTarget = scrollAreaRef.current;
                }
            }
            if (scrollTarget && scrollTarget.scrollTo) {
                const timeoutId = setTimeout(() => {
                    scrollTarget.scrollTo({ top: scrollTarget.scrollHeight, behavior: 'smooth' });
                }, 100);
                return () => clearTimeout(timeoutId);
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return (
          <div className="space-y-6">
            {messages.map((message) => (
              <ChatMessage key={message.id} message={message} />
            ))}
            {isSending && (
              <div className="flex w-full items-start gap-3 pr-10 sm:pr-16">
                <div className="skeleton-thinking-avatar skeleton animate-pulse flex items-center justify-center">
                  <span className="sr-only">Assistant typing</span>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" fill="currentColor" className="text-primary/60" /></svg>
                </div>
                <div className="skeleton-thinking-text flex-1 pt-1.5">
                  <div className="skeleton-thinking-line skeleton animate-pulse w-32 mb-1" />
                  <div className="skeleton-thinking-line skeleton animate-pulse w-24" />
                  <div className="flex gap-1 mt-2">
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '0ms' }} />
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '120ms' }} />
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '240ms' }} />
                  </div>
                </div>
              </div>
            )}
          </div>
        );
    };

    return (
        // El chat y el panel de fuentes ocupan toda la pantalla, cada uno con su propio scroll
        <div className="flex flex-col h-screen w-full bg-background min-h-0">
            <ResizablePanelGroup direction="horizontal" className="flex-1 h-full w-full overflow-hidden min-h-0">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100} className="h-full min-h-0">
                    <div className="flex h-full flex-col relative overflow-hidden min-h-0">
                        <div className="absolute top-1 right-1 z-20">
                            <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            </Button>
                        </div>
                        {/* Chat window con su propio scroll */}
                        <div className="flex flex-col flex-1 min-h-0 h-0 relative">
                            <ScrollArea className="flex-1 min-h-0 h-0 w-full" ref={scrollAreaRef}>
                                <div className="px-3 py-4 sm:px-4 sm:py-5 min-h-full">{/* Padding interno para mensajes */}
                                    {renderChatContent()}
                                </div>
                            </ScrollArea>
                            <div className="border-t border-border/60 px-3 py-3 sm:px-4 sm:py-4 bg-background/95 backdrop-blur-sm shadow-sm shrink-0 z-10 relative">
                                <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                            </div>
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* Panel de fuentes relevante con scroll propio y mejor UI/UX */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden bg-muted/60 border-l border-border/60 shadow-inner">
                            <div className="flex flex-col h-full">
                                <div className="px-4 py-3 border-b border-border/40 bg-background/80 sticky top-0 z-10 flex items-center gap-2">
                                    <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                                    <span className="ml-auto text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
                                </div>
                                <ScrollArea className="flex-1 h-full w-full">
                                    <RetrievedDocumentsPanel 
                                        documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} 
                                        isLoading={isSending}
                                        showMeta // Nueva prop para mostrar metadatos y formato mejorado
                                    />
                                </ScrollArea>
                            </div>
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  const authHeadersForChildren: AuthHeaders | null = user?.userId && user?.companyId ? {
    'X-User-ID': user.userId,
    'X-Company-ID': user.companyId,
  } : null;

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas locales (solo frontend) ---
  const totalDocs = documents.length;
  const statusCounts = documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);
  const totalChunks = documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-2xl font-bold text-primary">{totalDocs}</span>
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-foreground">{totalChunks}</span>
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      {/* Solo mostrar Header si NO estamos en /chat ni subrutas */}
                      {!(pathname.startsWith('/chat')) && <Header />}
                      {/* Main debe tener overflow:hidden y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col"> {/* overflow-hidden y min-h-0 para scroll interno */}
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx (REFACTORIZADO - Fuentes mejoradas)
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText, CircleDot } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"
// import { Badge } from '@/components/ui/badge'; // Badge ya no se usa para fuentes

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Contenido Markdown */}
         {/* Asegurar que prose tenga los estilos correctos definidos en tailwind.config y globals.css */}
         {/* FLAG_LLM: Aplicar prose al div exterior, no al componente Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {/* Secci√≥n de Fuentes (UI Mejorada) */}
         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40 animate-fade-in">
                <p className="text-xs font-semibold text-muted-foreground mb-2 tracking-wide uppercase">Fuentes utilizadas:</p>
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5">
                  {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}` } delayDuration={150}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="outline"
                            size="icon"
                            className="rounded-full px-0 py-0 text-xs font-mono font-semibold h-7 w-7 flex items-center justify-center border-primary/60 hover:border-primary"
                            tabIndex={0}
                            aria-label={`Ver fuente ${index + 1}`}
                            onClick={e => e.preventDefault()}
                          >
                            {index + 1}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="center" className="max-w-xs text-xs">
                          <div className="font-semibold mb-1 truncate flex items-center gap-1">
                            <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                            {doc.file_name || `Fragmento ${doc.id?.substring(0, 8)}`}
                          </div>
                          <div className="text-muted-foreground text-[11px] mb-1.5 break-all">
                            ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                          </div>
                          {doc.score != null && (
                            <div className="font-medium text-muted-foreground text-[11px]">
                              Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                            </div>
                          )}
                          <div className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                            Vista previa:
                            <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}</span>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
  showMeta?: boolean; // Permite mostrar metadatos y formato extendido
}

export function RetrievedDocumentsPanel({ documents, isLoading, showMeta }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    // Las estrellas representan la relevancia del fragmento respecto a la consulta (score de 0 a 1, 5 estrellas m√°ximo)
    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5 group" title={`Relevancia: ${score.toFixed(3)} / 1.0`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-4 w-4 transition-colors",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400 group-hover:text-yellow-500 group-hover:fill-yellow-500" 
                  : "text-gray-300 fill-gray-200 dark:text-gray-600 dark:fill-gray-700" 
              )}
            />
          ))}
          <span className="ml-1 text-[10px] text-muted-foreground font-mono">{score.toFixed(2)}</span>
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col bg-background">
            {/* Header sticky mejorado, sin overlapping */}
            <div className="sticky top-0 z-20 border-b bg-background/95 px-6 py-3 flex flex-col gap-0.5 shadow-sm">
                <div className="flex items-center gap-2">
                  <FileText className="h-5 w-5 text-primary" />
                  <span className="font-semibold text-base text-foreground">Fuentes Relevantes</span>
                </div>
                <span className="text-xs text-muted-foreground">Documentos utilizados para generar la respuesta.</span>
            </div>

            <ScrollArea className="flex-1 min-h-0">
                <div className="p-4 space-y-3">
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card/95 hover:bg-accent/10",
                                    "border border-border/70 hover:border-primary/60 hover:shadow-lg focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || 'documento'}`}
                            >
                                <CardContent className="p-0">
                                    <div className="flex items-center gap-2 px-3 pt-3">
                                        <span className="flex-shrink-0 h-6 w-6 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border border-border/60">
                                            {index + 1}
                                        </span>
                                        <div className="flex-1 min-w-0">
                                            <span className="block font-medium text-foreground/95 truncate text-sm" title={doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}>{doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}</span>
                                            <span className="block text-[11px] text-muted-foreground truncate">ID: {doc.document_id?.substring(0, 8) ?? doc.id.substring(0, 8)}...</span>
                                        </div>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed px-10 pb-2 pt-1">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id?.substring(0,12) || 'N/D'}...</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {showMeta && selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {selectedDoc.file_name ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          <div className="max-h-56 overflow-y-auto space-y-2 pr-1">
            {files.map(file => (
              <div key={file.name} className="p-3 border rounded-lg flex items-center justify-between space-x-3 bg-muted/40 shadow-sm">
                <div className="flex items-center space-x-3 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-5 w-5 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-sm font-medium truncate" title={file.name}>{file.name}</span>
                    <span className="text-xs text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1.5 py-0 px-1.5 text-[10px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-10 bg-background pt-3 pb-1 flex justify-end">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full"
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : 'Subir y Procesar Archivos'}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; 
import { Skeleton } from '@/components/ui/skeleton';
import SnakeAnimation from '@/components/animations/snakeanimation';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); 
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); 
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); 
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            const viewport = scrollAreaRef.current?.viewport as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else { 
                const scrollElement = scrollAreaRef.current as HTMLElement; 
                if (scrollElement?.scrollTo) { 
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100); 
                    return () => clearTimeout(timeoutId); 
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return (
          <div className="space-y-6">
            {messages.map((message) => (
              <ChatMessage key={message.id} message={message} />
            ))}
            {isSending && (
              <div className="flex w-full items-start gap-3 pr-10 sm:pr-16">
                <div className="skeleton-thinking-avatar skeleton animate-pulse flex items-center justify-center">
                  <span className="sr-only">Assistant typing</span>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" fill="currentColor" className="text-primary/60" /></svg>
                </div>
                <div className="skeleton-thinking-text flex-1 pt-1.5">
                  <div className="skeleton-thinking-line skeleton animate-pulse w-32 mb-1" />
                  <div className="skeleton-thinking-line skeleton animate-pulse w-24" />
                  <div className="flex gap-1 mt-2">
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '0ms' }} />
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '120ms' }} />
                    <span className="inline-block h-2 w-2 rounded-full bg-muted-foreground/60 animate-bounce" style={{ animationDelay: '240ms' }} />
                  </div>
                </div>
              </div>
            )}
          </div>
        );
    };

    return (
        // El chat y el panel de fuentes ocupan toda la pantalla, cada uno con su propio scroll
        <div className="flex flex-col h-screen w-full bg-background min-h-0">
            <ResizablePanelGroup direction="horizontal" className="flex-1 h-full w-full overflow-hidden min-h-0">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100} className="h-full min-h-0">
                    <div className="flex h-full flex-col relative overflow-hidden min-h-0">
                        <div className="absolute top-1 right-1 z-20">
                            <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            </Button>
                        </div>
                        {/* Chat window con su propio scroll */}
                        <div className="flex flex-col flex-1 min-h-0 h-0 relative">
                            <ScrollArea className="flex-1 min-h-0 h-0 w-full" ref={scrollAreaRef}>
                                <div className="px-3 py-4 sm:px-4 sm:py-5 min-h-full">{/* Padding interno para mensajes */}
                                    {renderChatContent()}
                                </div>
                            </ScrollArea>
                            <div className="border-t border-border/60 px-3 py-3 sm:px-4 sm:py-4 bg-background/95 backdrop-blur-sm shadow-sm shrink-0 z-10 relative">
                                <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                            </div>
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* Panel de fuentes relevante con scroll propio */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                            <div className="flex flex-col h-full">
                                <ScrollArea className="flex-1 h-full w-full">
                                    <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                                </ScrollArea>
                            </div>
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  const authHeadersForChildren: AuthHeaders | null = user?.userId && user?.companyId ? {
    'X-User-ID': user.userId,
    'X-Company-ID': user.companyId,
  } : null;

  if (isAuthLoading) {
    return (
      <div className="p-6 lg:p-8 space-y-8">
        <Skeleton className="h-10 w-1/3 mb-6" />
        <Skeleton className="h-64 rounded-xl mb-8" />
        <Skeleton className="h-10 w-1/4 mb-4" />
        <Skeleton className="h-80 rounded-xl" />
      </div>
    );
  }

  // --- Estad√≠sticas locales (solo frontend) ---
  const totalDocs = documents.length;
  const statusCounts = documents.reduce((acc, doc) => {
    acc[doc.status] = (acc[doc.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);
  const totalChunks = documents.reduce((acc, doc) => acc + (doc.milvus_chunk_count ?? doc.chunk_count ?? 0), 0);

  return (
    <div className="p-4 sm:p-6 lg:p-8 flex flex-col gap-6 min-h-[80vh]">
      {/* Grid principal: estad√≠sticas y subida a la izquierda, resumen y uploader a la derecha */}
      <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        {/* Columna izquierda: estad√≠sticas y resumen */}
        <div className="flex flex-col gap-4 justify-between">
          {/* Estad√≠sticas visuales */}
          <div className="flex flex-wrap gap-4 items-center justify-start">
            {/* Tarjeta de total documentos */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-2xl font-bold text-primary">{totalDocs}</span>
              <span className="text-xs text-muted-foreground font-medium">Documentos</span>
            </div>
            {/* Tarjeta de chunks */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-foreground">{totalChunks}</span>
              <span className="text-xs text-muted-foreground font-medium">Chunks</span>
            </div>
            {/* Tarjeta de procesados */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-green-600">{statusCounts['processed'] || 0}</span>
              <span className="text-xs text-green-700 font-medium">Procesados</span>
            </div>
            {/* Tarjeta de en cola */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-blue-600">{statusCounts['uploaded'] || 0}</span>
              <span className="text-xs text-blue-700 font-medium">En Cola</span>
            </div>
            {/* Tarjeta de procesando */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-orange-600">{statusCounts['processing'] || 0}</span>
              <span className="text-xs text-orange-700 font-medium">Procesando</span>
            </div>
            {/* Tarjeta de error */}
            <div className="flex flex-col items-center justify-center bg-card border rounded-lg shadow-sm px-4 py-3 min-w-[120px]">
              <span className="text-xl font-semibold text-red-600">{statusCounts['error'] || 0}</span>
              <span className="text-xs text-red-700 font-medium">Error</span>
            </div>
          </div>
        </div>
        {/* Columna derecha: uploader en caja flotante */}
        <div className="flex flex-col items-center justify-center h-full">
          <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <div className="flex items-center gap-2 mb-2">
              <UploadCloud className="h-6 w-6 text-primary" />
              <span className="font-semibold text-lg">Subir Nuevo Documento</span>
            </div>
            <span className="text-xs text-muted-foreground mb-2">(Arrastra, selecciona o pega archivos)</span>
            {authHeadersForChildren ? (
              <FileUploader
                authHeaders={authHeadersForChildren}
                onUploadFile={uploadFile}
                isUploading={isUploading}
                uploadError={uploadError}
                clearUploadStatus={clearUploadStatus}
              />
            ) : (
              <Alert variant="default" className="bg-muted/50 mt-2 w-full">
                <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                <AlertDescription className="text-xs text-muted-foreground">
                  Inicia sesi√≥n para poder subir nuevos documentos.
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
      </div>

      <Separator />

      {/* Documentos gestionados */}
      <div className="flex-1 min-h-0 w-full max-w-none flex flex-col gap-4">
        <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
          <List className="h-6 w-6" /> Documentos Gestionados
        </h2>
        {documentsError && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Error al Cargar Documentos</AlertTitle>
            <AlertDescription>
              {documentsError}
              <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
            </AlertDescription>
          </Alert>
        )}
        {isLoadingDocuments && documents.length === 0 && !documentsError && (
          <div className="space-y-2 pt-2 border rounded-lg p-4">
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
            <Skeleton className="h-12 w-full rounded-md" />
          </div>
        )}
        {/* Scroll para la tabla de documentos, sticky header y bulk bar */}
        {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
          <div className="h-full min-h-0 flex-1 flex flex-col">
            <div className="flex-1 min-h-0">
              <DocumentStatusList
                documents={documents}
                authHeaders={authHeadersForChildren}
                onRetrySuccess={handleRetrySuccess}
                fetchMore={fetchMore}
                hasMore={hasMore}
                refreshDocument={refreshDocument}
                onDeleteSuccess={handleDeleteSuccess}
                isLoading={isLoadingDocuments}
              />
            </div>
          </div>
        )}
        {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
          <Alert variant="default" className="bg-muted/50 mt-2">
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
            <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
            <AlertDescription className="text-xs text-muted-foreground">
              Inicia sesi√≥n para ver y administrar tus documentos.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      {/* Solo mostrar Header si NO estamos en /chat ni subrutas */}
                      {!(pathname.startsWith('/chat')) && <Header />}
                      {/* Main debe tener overflow:hidden y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-hidden min-h-0 flex flex-col"> {/* overflow-hidden y min-h-0 para scroll interno */}
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* Custom: Asegura que el bot√≥n de borrar chat siempre sea visible en historial, incluso en sidebar colapsado */
.chat-history-delete-btn {
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */

/* ChatGPT-style typing indicator (dots) and assistant skeleton */
.skeleton-thinking-avatar {
  height: 2rem;
  width: 2rem;
  border-radius: 9999px;
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}
.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.skeleton-thinking-line {
  height: 0.875rem;
  border-radius: 0.375rem;
  background-color: hsl(var(--accent));
}
.skeleton-thinking-line-short {
  width: 4rem;
}
@keyframes bounce {
  0%, 80%, 100% { transform: scale(1); opacity: 0.7; }
  40% { transform: scale(1.3); opacity: 1; }
}
.animate-bounce {
  animation: bounce 1.2s infinite both;
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-8 gap-2">
                    <History className="h-12 w-12 mb-2 opacity-40"/>
                    <p className="text-base font-semibold mb-1">No tienes chats previos</p>
                    <p className="text-xs mb-2">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                    <Button variant="outline" size="sm" onClick={() => router.push('/chat')}>
                        Nuevo Chat
                    </Button>
                </div>
            );
        }

        return (
            <div className="flex flex-col gap-2">
                {chats.map((chat) => {
                    const isActive = pathname === `/chat/${chat.id}`;
                    // Eliminar el prefijo "Chat: " si existe en el t√≠tulo
                    let displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
                    if (displayTitle.toLowerCase().startsWith('chat:')) {
                        displayTitle = displayTitle.replace(/^chat:\s*/i, '');
                    }
                    const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    return (
                        <div
                            key={chat.id}
                            className={cn(
                                'relative flex items-center group w-full bg-card border shadow-sm rounded-lg px-3 py-2 transition hover:shadow-md',
                                isActive ? 'ring-2 ring-primary/40 border-primary/40' : 'border-border',
                            )}
                        >
                            <div className="flex flex-1 min-w-0 items-center gap-2 text-left relative">
                                <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                                    <a
                                        className={cn(
                                            'flex flex-1 min-w-0 items-center gap-2',
                                            isActive ? 'text-primary font-semibold' : 'text-foreground/80 hover:text-foreground',
                                        )}
                                        title={displayTitle}
                                        style={{ minWidth: 0 }}
                                    >
                                        <MessageSquareText className="h-4 w-4 flex-shrink-0 opacity-80" />
                                        <div className="flex flex-col flex-1 min-w-0">
                                            <span className="truncate font-medium max-w-[12rem] sm:max-w-[16rem] md:max-w-[20rem]" title={displayTitle}>{displayTitle}</span>
                                            <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                                        </div>
                                    </a>
                                </Link>
                    <div className="flex-shrink-0 flex items-center ml-2 opacity-100">
                        <AlertDialogTrigger asChild>
                            <Button
                                variant="ghost" size="icon"
                                className={cn(
                                    'h-8 w-8 p-0 rounded-full border border-transparent transition',
                                    'text-muted-foreground hover:text-destructive hover:bg-destructive/10',
                                    'chat-history-delete-btn',
                                    isDeleting && chatToDelete?.id === chat.id ? 'opacity-50 cursor-not-allowed' : ''
                                )}
                                onClick={(e) => openDeleteConfirmation(chat, e)}
                                aria-label={`Eliminar chat: ${displayTitle}`}
                                disabled={isDeleting && chatToDelete?.id === chat.id}
                                tabIndex={0}
                            >
                                {isDeleting && chatToDelete?.id === chat.id ? (
                                    <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                ) : (
                                    <Trash2 className="h-4 w-4" />
                                )}
                            </Button>
                        </AlertDialogTrigger>
                    </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                {/* Header del historial */}
                <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1 bg-background/80 backdrop-blur-sm">
                    <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                        Historial
                    </h3>
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-muted-foreground hover:text-foreground"
                        onClick={() => fetchChatHistory(true)}
                        disabled={isLoading || isAuthLoading}
                        title="Actualizar historial"
                    >
                        <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                        <span className="sr-only">Actualizar Historial</span>
                    </Button>
                </div>
                {/* ScrollArea para el contenido */}
                <ScrollArea className="flex-1 min-h-0 px-0 py-1">
                    <div className="flex flex-col gap-2 p-1">
                        {renderContent()}
                    </div>
                </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{(chatToDelete?.title && chatToDelete?.title.toLowerCase().startsWith('chat:') ? chatToDelete?.title.replace(/^chat:\s*/i, '') : chatToDelete?.title) || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx (REFACTORIZADO - Fuentes mejoradas)
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, AlertTriangle, FileText, CircleDot } from 'lucide-react';
import AtenexLogo from '@/components/icons/atenex-logo';
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"
// import { Badge } from '@/components/ui/badge'; // Badge ya no se usa para fuentes

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <AtenexLogo className="h-5 w-5 text-primary" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Contenido Markdown */}
         {/* Asegurar que prose tenga los estilos correctos definidos en tailwind.config y globals.css */}
         {/* FLAG_LLM: Aplicar prose al div exterior, no al componente Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {/* Secci√≥n de Fuentes (REDISE√ëADA) */}
         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40">
                <p className="text-xs font-medium text-muted-foreground mb-2">Fuentes:</p>
                {/* Usar flex-wrap para las fuentes */}
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5"> {/* Ajuste de gap */}
                 {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}`} delayDuration={150}>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                {/* Bot√≥n peque√±o con n√∫mero */}
                                <Button
                                    variant="outline"
                                    size="sm" // Bot√≥n m√°s peque√±o
                                    className="h-6 w-6 px-1 py-0 rounded-full border-dashed hover:border-solid hover:bg-accent/50 cursor-default flex items-center justify-center focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                    onClick={(e) => {e.preventDefault();}} // No hacer nada en click, solo tooltip
                                    tabIndex={0} // Make it focusable
                                    aria-label={`Fuente ${index + 1}: ${doc.file_name || 'Detalles'}`}
                                >
                                    {/* N√∫mero de fuente */}
                                    <span className="text-xs font-mono text-muted-foreground">{index + 1}</span>
                                </Button>
                            </TooltipTrigger>
                            {/* Tooltip mejorado con fondo popover */}
                            <TooltipContent
                                side="bottom"
                                className="max-w-xs text-xs p-2 shadow-lg bg-popover text-popover-foreground" // Asegura fondo popover
                                sideOffset={4}
                            >
                                <p className="font-medium mb-0.5 break-words">
                                    <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                                    {doc.file_name || 'Nombre no disponible'}
                                </p>
                                <p className="text-muted-foreground text-[11px] mb-1.5 break-all">
                                   ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                                </p>
                                {doc.score != null && (
                                    <p className="font-medium text-muted-foreground text-[11px]">
                                        Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                                    </p>
                                )}
                                {doc.content_preview && (
                                    <p className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                                        Vista previa:
                                        <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview}</span>
                                    </p>
                                )}
                            </TooltipContent>
                        </Tooltip>
                   </TooltipProvider>
                 ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5" title={`Score: ${score.toFixed(3)}`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              className={cn(
                "h-3 w-3",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400" 
                  : "text-gray-300 fill-gray-300 dark:text-gray-600 dark:fill-gray-600" 
              )}
            />
          ))}
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col border-l bg-muted/10 dark:bg-muted/20">
            <CardHeader className="sticky top-0 z-10 border-b bg-background p-4 shadow-sm">
                <CardTitle className="text-base font-semibold flex items-center gap-2">
                    <FileText className="h-5 w-5 text-primary" /> Fuentes Relevantes
                </CardTitle>
                <CardDescription className="text-xs mt-1">
                    Documentos utilizados para generar la respuesta.
                </CardDescription>
            </CardHeader>

            <ScrollArea className="flex-1">
                <div className="p-3 space-y-2">
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card",
                                    "border border-border hover:border-primary/40 hover:shadow-md focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || 'documento'}`}
                            >
                                <CardContent className="p-3 space-y-1 text-sm">
                                    <div className="flex justify-between items-start gap-2">
                                        <p className="font-medium text-foreground/95 truncate flex-1 flex items-center gap-1.5">
                                            <span className="flex-shrink-0 h-5 w-5 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border">
                                                {index + 1}
                                            </span>
                                            <span className="truncate" title={doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                        </p>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed pl-7">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                     <div className="text-[10px] text-muted-foreground/70 pt-1.5 flex justify-between items-center font-mono pl-7">
                                        <span>ID: {doc.document_id?.substring(0, 8) ?? doc.id.substring(0, 8)}...</span>
                                        <Eye className="h-3 w-3" />
                                    </div>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id?.substring(0,12) || 'N/D'}...</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {selectedDoc.file_name ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React, { useState, useMemo } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument, BulkDeleteResponse } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);
  const allIds = useMemo(() => documents.map(d => d.document_id), [documents]);
  const isAllSelected = selectedIds.length > 0 && selectedIds.length === allIds.length;
  const isIndeterminate = selectedIds.length > 0 && selectedIds.length < allIds.length;

  const handleSelectAll = () => {
    if (isAllSelected) setSelectedIds([]);
    else setSelectedIds(allIds);
  };
  const handleSelectOne = (id: string) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };
  const clearSelection = () => setSelectedIds([]);
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };


  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]">
        <Info className="h-8 w-8 mb-3 opacity-50"/>
        <p className="text-sm font-medium mb-1">Sin Documentos</p>
        <p className="text-xs">A√∫n no se han subido documentos.</p>
      </div>
    );
  }

  // Bulk actions bar
  const selectedDocs = documents.filter(d => selectedIds.includes(d.document_id));
  const canBulkRetry = selectedDocs.some(d => d.status === 'error');
  const canBulkRefresh = selectedDocs.length > 0;
  const canBulkDelete = selectedDocs.length > 0;

  // --- Bulk Delete Handler ---
  const [isBulkDeleting, setIsBulkDeleting] = useState(false);
  const [bulkDeleteResult, setBulkDeleteResult] = useState<BulkDeleteResponse | null>(null);

  // Fix for implicit any in map
  type BulkDeleteFail = { id: string; error: string };

  const handleBulkDelete = async () => {
    if (!authHeaders || selectedIds.length === 0 || isBulkDeleting) return;
    setIsBulkDeleting(true);
    setBulkDeleteResult(null);
    const toastId = toast.loading(`Eliminando ${selectedIds.length} documentos...`);
    try {
      // Llama al nuevo endpoint bulk
      const { deleteIngestDocumentsBulk } = await import('@/lib/api');
      const result = await deleteIngestDocumentsBulk(selectedIds, authHeaders);
      setBulkDeleteResult(result);
      // Elimina de la UI los eliminados
      for (const id of result.deleted) {
        onDeleteSuccess(id);
      }
      toast.success('Borrado masivo completado', { id: toastId, description: `${result.deleted.length} eliminados, ${result.failed.length} fallidos.` });
      setBulkDeleteOpen(false);
      clearSelection();
    } catch (e: any) {
      toast.error('Error en borrado masivo', { id: toastId, description: e?.message || 'Error desconocido' });
    } finally {
      setIsBulkDeleting(false);
    }
  };

  return (
    <TooltipProvider>
      <div className="border rounded-lg overflow-hidden shadow-sm bg-card relative h-full min-h-0 flex flex-col w-full max-w-none">
        {/* Bulk actions toolbar - Mejorado para no sobreponerse y ser sticky */}
        {selectedIds.length > 0 && (
          <div
            className="sticky z-[50] top-0 left-0 right-0 bg-white dark:bg-zinc-900 border-b-2 border-primary px-2 md:px-4 py-2 flex flex-row flex-wrap items-center gap-1 md:gap-2 animate-in fade-in shadow-2xl"
            style={{ minHeight: 44, maxWidth: '100vw', overflowX: 'auto' }}
          >
            <span className="font-medium text-xs md:text-sm mr-2">
              {selectedIds.length} seleccionado{selectedIds.length > 1 ? 's' : ''}
            </span>
            {canBulkRetry && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs.filter(d => d.status === 'error')) {
                  await handleRetry(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[80px] md:min-w-[100px]">
                <RefreshCw className="h-4 w-4 mr-1" /> Reintentar
              </Button>
            )}
            {canBulkRefresh && (
              <Button variant="outline" size="sm" onClick={async () => {
                for (const doc of selectedDocs) {
                  await handleRefresh(doc.document_id, doc.file_name);
                }
                clearSelection();
              }} className="min-w-[100px] md:min-w-[120px]">
                <Loader2 className="h-4 w-4 mr-1" /> Actualizar
              </Button>
            )}
            <Button
              variant="destructive"
              size="sm"
              onClick={() => setBulkDeleteOpen(true)}
              className="min-w-[80px] md:min-w-[100px]"
              style={{ display: canBulkDelete ? 'inline-flex' : 'none' }}
            >
              <Trash2 className="h-4 w-4 mr-1" /> Eliminar
            </Button>
            <Button variant="ghost" size="sm" onClick={clearSelection} className="min-w-[60px] md:min-w-[80px]">Cancelar</Button>
          </div>
        )}

        {/* Bulk delete confirmation dialog */}
        <AlertDialog open={bulkDeleteOpen} onOpenChange={setBulkDeleteOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øEliminar {selectedIds.length} documento{selectedIds.length > 1 ? 's' : ''}?
              </AlertDialogTitle>
              <AlertDialogDescription>
                Esta acci√≥n no se puede deshacer. Se eliminar√°n permanentemente los documentos seleccionados y todos sus datos asociados.
                <ul className="mt-2 text-xs max-h-32 overflow-y-auto list-disc pl-5">
                  {selectedDocs.map(doc => (
                    <li key={doc.document_id} className="break-all">{doc.file_name || doc.document_id}</li>
                  ))}
                </ul>
                {bulkDeleteResult && (
                  <div className="mt-3">
                    <div className="text-green-700 dark:text-green-400 text-xs font-medium mb-1">{bulkDeleteResult.deleted.length} eliminados correctamente.</div>
                    {bulkDeleteResult.failed.length > 0 && (
                      <div className="text-red-700 dark:text-red-400 text-xs font-medium">
                        {bulkDeleteResult.failed.length} fallidos:
                        <ul className="list-disc pl-5">
                          {bulkDeleteResult.failed.map(f => (
                            <li key={f.id}>{f.id}: {f.error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setBulkDeleteOpen(false)} disabled={isBulkDeleting}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleBulkDelete}
                disabled={isBulkDeleting}
                className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}
              >
                {isBulkDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}Eliminar Permanentemente
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <div className="flex-1 min-h-0 overflow-y-auto w-full max-w-none">
          {/* Forzar tabla a ancho m√≠nimo para evitar colapso en pantallas peque√±as */}
          <Table className='w-full text-sm'>
            <TableHeader className="sticky top-0 z-30 bg-muted/70 backdrop-blur-md">
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-8 pl-2 pr-1 py-2">
                  <input
                    type="checkbox"
                    aria-label="Seleccionar todos"
                    checked={isAllSelected}
                    ref={el => { if (el) el.indeterminate = isIndeterminate; }}
                    onChange={handleSelectAll}
                    className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                  />
                </TableHead>
                <TableHead className="w-[40%] pl-1 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
            {documents.map((doc) => {
              if (!doc || !doc.document_id) {
                if (process.env.NODE_ENV === 'development') {
                  console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                }
                return null;
              }
              const statusInfo = statusMap[doc.status] || statusMap.default;
              const Icon = statusInfo.icon;
              const isCurrentlyRetrying = isRetrying === doc.document_id;
              const isCurrentlyRefreshing = isRefreshing === doc.document_id;
              const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;
              const dateToShow = doc.last_updated;
              const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
              const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
              const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';
              const isChecked = selectedIds.includes(doc.document_id);
              return (
                <TableRow key={doc.document_id} className={cn("group hover:bg-accent/30 data-[state=selected]:bg-accent", isChecked && "bg-accent/40") }>
                  <TableCell className="pl-2 pr-1 py-1.5">
                    <input
                      type="checkbox"
                      aria-label={`Seleccionar ${displayFileName}`}
                      checked={isChecked}
                      onChange={() => handleSelectOne(doc.document_id)}
                      className="accent-primary h-4 w-4 rounded border-muted-foreground/40"
                    />
                  </TableCell>
                  <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-1 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                  <TableCell className="px-2 py-1.5">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                          <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                          {statusInfo.text}
                        </Badge>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                        <p>{statusInfo.description}</p>
                        {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                      </TooltipContent>
                    </Tooltip>
                  </TableCell>
                  <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                  <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                  <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                    </Tooltip>
                    {doc.status === 'error' && (
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                      </Tooltip>
                    )}
                    <Tooltip delayDuration={100}>
                      <TooltipTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                      </TooltipTrigger>
                      <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                    </Tooltip>
                    <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                      <Tooltip delayDuration={100}>
                        <TooltipTrigger asChild>
                          <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </AlertDialogTrigger>
                        </TooltipTrigger>
                        <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                      </Tooltip>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                          </AlertDialogTitle>
                          <AlertDialogDescription>
                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                          <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                            Eliminar Permanentemente
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
        </div>
      {hasMore && (
        <div className="pt-6 text-center">
          <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}>
            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos
          </Button>
        </div>
      )}
      </div>
    </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (scrollable, sticky button) */}
      {files.length > 0 && !isUploading && (
        <div className="relative">
          <div className="max-h-56 overflow-y-auto space-y-2 pr-1">
            {files.map(file => (
              <div key={file.name} className="p-3 border rounded-lg flex items-center justify-between space-x-3 bg-muted/40 shadow-sm">
                <div className="flex items-center space-x-3 overflow-hidden flex-1 min-w-0">
                  <FileIcon className="h-5 w-5 flex-shrink-0 text-primary" />
                  <div className='flex flex-col min-w-0'>
                    <span className="text-sm font-medium truncate" title={file.name}>{file.name}</span>
                    <span className="text-xs text-muted-foreground">
                      ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                      <Badge variant="outline" className='ml-1.5 py-0 px-1.5 text-[10px]'>{file.type || 'desconocido'}</Badge>
                    </span>
                  </div>
                </div>
                <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
          {/* Bot√≥n sticky al fondo del uploader */}
          <div className="sticky bottom-0 left-0 right-0 z-10 bg-background pt-3 pb-1 flex justify-end">
            <Button
              onClick={async () => {
                for (const file of files) {
                  await onUploadFile(file, authHeaders);
                }
                setFiles([]);
              }}
              disabled={isUploading}
              className="w-full"
            >
              {isUploading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Subiendo...
                </>
              ) : 'Subir y Procesar Archivos'}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <div className="flex-1 min-h-0 bg-muted/40 rounded-lg shadow-sm p-2">
              <ChatHistory />
            </div>
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; // BrainCircuit quitado si no se usa
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); // Para ScrollArea de mensajes
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); // Asegurar que el panel se oculte en un nuevo chat sin ID
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); // A√±adido isSourcesPanelVisible para re-evaluar si se abre externamente
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            const viewport = scrollAreaRef.current?.viewport as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else { 
                const scrollElement = scrollAreaRef.current as HTMLElement; 
                if (scrollElement?.scrollTo) { 
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100); 
                    return () => clearTimeout(timeoutId); 
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        <div className="flex flex-col h-full bg-background p-4 sm:p-6 lg:p-8">
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}>
                    <div className="flex h-full flex-col relative overflow-hidden">
                         <div className="absolute top-1 right-1 z-20"> 
                             <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                             </Button>
                        </div>
                        <ScrollArea className="flex-1" ref={scrollAreaRef}>
                             <div className="px-3 py-4 sm:px-4 sm:py-5">
                                {renderChatContent()}
                             </div>
                        </ScrollArea>
                        <div className="border-t border-border/60 px-3 py-3 sm:px-4 sm:py-4 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                             <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* El ResizablePanel que contiene las fuentes ahora tiene h-full y overflow-hidden */}
                        {/* Esto asegura que el panel tenga una altura definida por el grupo y que su contenido */}
                        {/* (RetrievedDocumentsPanel) use su propio scroll interno si es necesario, sin */}
                        {/* afectar las dimensiones de este panel ni del panel de chat. */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  const authHeadersForChildren: AuthHeaders | null = user?.userId && user?.companyId ? {
    'X-User-ID': user.userId,
    'X-Company-ID': user.companyId,
  } : null;

  if (isAuthLoading) {
    return (
        <div className="p-6 lg:p-8 space-y-8"> {/* Padding aqu√≠ */}
          <Skeleton className="h-10 w-1/3 mb-6" />
          <Skeleton className="h-64 rounded-xl mb-8" />
          <Skeleton className="h-10 w-1/4 mb-4" />
          <Skeleton className="h-80 rounded-xl" />
        </div>
    );
  }

  return (
    <div className="p-6 lg:p-8 space-y-8"> {/* Padding principal de la p√°gina */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <h1 className="text-2xl md:text-3xl font-bold tracking-tight text-foreground flex items-center gap-2">
                 <FileText className="h-7 w-7" />
                 Base de Conocimiento
            </h1>
            {authHeadersForChildren && (
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => fetchDocuments(true)}
                    disabled={isLoadingDocuments}
                    className="w-full sm:w-auto"
                >
                    <Loader2 className={cn("mr-2 h-4 w-4", isLoadingDocuments ? "animate-spin" : "hidden")} />
                    Refrescar Documentos
                </Button>
            )}
        </div>

        <Card className="shadow-md border">
            <CardHeader>
                <CardTitle className="text-xl flex items-center gap-2">
                    <UploadCloud className="h-5 w-5 text-primary" /> Subir Nuevo Documento
                </CardTitle>
                <CardDescription>A√±ade archivos a tu base de conocimiento.</CardDescription>
            </CardHeader>
            <CardContent>
            {authHeadersForChildren ? (
                <FileUploader
                    authHeaders={authHeadersForChildren}
                    onUploadFile={uploadFile}
                    isUploading={isUploading}
                    uploadError={uploadError}
                    clearUploadStatus={clearUploadStatus}
                />
            ) : (
                <Alert variant="default" className="bg-muted/50">
                     <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                    <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                    <AlertDescription className="text-xs text-muted-foreground">
                        Inicia sesi√≥n para poder subir nuevos documentos.
                    </AlertDescription>
                </Alert>
            )}
            </CardContent>
        </Card>

        <Separator />

        <div className='space-y-4'>
             <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
                 <List className="h-6 w-6" /> Documentos Gestionados
            </h2>
             {documentsError && (
                <Alert variant="destructive">
                     <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Error al Cargar Documentos</AlertTitle>
                    <AlertDescription>
                        {documentsError}
                        <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
                    </AlertDescription>
                </Alert>
             )}
             {isLoadingDocuments && documents.length === 0 && !documentsError && (
                <div className="space-y-2 pt-2 border rounded-lg p-4">
                    <Skeleton className="h-12 w-full rounded-md" />
                    <Skeleton className="h-12 w-full rounded-md" />
                    <Skeleton className="h-12 w-full rounded-md" />
                </div>
             )}
             {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
                <DocumentStatusList
                    documents={documents}
                    authHeaders={authHeadersForChildren}
                    onRetrySuccess={handleRetrySuccess}
                    fetchMore={fetchMore}
                    hasMore={hasMore}
                    refreshDocument={refreshDocument}
                    onDeleteSuccess={handleDeleteSuccess}
                    isLoading={isLoadingDocuments}
                />
             )}
             {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
                <div className="text-center py-10 border-2 border-dashed rounded-lg bg-muted/30">
                     <p className="text-muted-foreground text-sm">Inicia sesi√≥n para ver tus documentos.</p>
                </div>
             )}
        </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      <Header />
                      {/* Main debe tener overflow:hidden y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-hidden"> {/* CONFIRMADO: overflow-hidden */}
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */
.skeleton-thinking {
  display: flex;
  align-items: flex-start; /* Cambiado a flex-start para alinear √≠cono y texto */
  gap: 0.75rem; /* Equivalente a space-x-3 */
  width: 100%;
  padding-right: 2.5rem; /* Equivalente a pr-10 */
  padding-top: 1rem; /* Equivalente a pt-4 */
}

.skeleton-thinking-avatar {
  height: 2rem; /* h-8 */
  width: 2rem; /* w-8 */
  border-radius: 9999px; /* rounded-full */
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1); /* bg-primary/10 */
}

.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem; /* pt-1.5 */
  display: flex;
  flex-direction: column;
  gap: 0.5rem; /* space-y-2 */
}

.skeleton-thinking-line {
  height: 0.875rem; /* h-3.5 */
  border-radius: 0.375rem; /* rounded */
  background-color: hsl(var(--accent)); /* Fondo del Skeleton */
}

.skeleton-thinking-line-short {
  width: 4rem; /* w-16 */
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-6">
                    <History className="h-8 w-8 mb-3 opacity-50"/>
                    <p className="text-sm font-medium mb-1">Sin chats anteriores</p>
                    <p className="text-xs">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                </div>
            );
        }

        return chats.map((chat) => {
            const isActive = pathname === `/chat/${chat.id}`;
            const displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
            const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }); // Formato espa√±ol

            return (
                <div key={chat.id} className="relative group w-full"> {/* Quitamos pr-8 */}
                    <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                        <a
                            className={cn(
                                buttonVariants({ variant: "ghost", size: "default" }), // Usamos ghost
                                "w-full justify-start h-auto py-2.5 px-3 overflow-hidden text-left rounded-md text-sm", // Padding y altura ajustados
                                isActive
                                ? "bg-primary/10 dark:bg-primary/20 text-primary font-medium" // Estado activo mejorado
                                : "text-foreground/70 hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30" // Estado inactivo
                            )}
                            title={displayTitle}
                        >
                            {/* Icono principal */}
                            <MessageSquareText className="h-4 w-4 mr-2.5 flex-shrink-0 opacity-80" />
                            {/* Contenedor para t√≠tulo y fecha */}
                            <div className="flex flex-col flex-1 min-w-0">
                                <span className="truncate font-medium text-foreground group-hover:text-foreground">{displayTitle}</span>
                                <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                            </div>
                        </a>
                    </Link>
                    {/* Bot√≥n Eliminar aparece en hover */}
                    <AlertDialogTrigger asChild>
                        <Button
                            variant="ghost" size="icon"
                            className={cn(
                                "absolute right-1.5 top-1/2 -translate-y-1/2 h-7 w-7 p-0 rounded-md",
                                "opacity-0 group-hover:opacity-60 focus-visible:opacity-100 hover:!opacity-100", // Control de opacidad
                                "transition-opacity duration-150 flex-shrink-0",
                                "hover:bg-destructive/10 hover:text-destructive", // Estilo hover
                                isDeleting && chatToDelete?.id === chat.id ? "opacity-50 cursor-not-allowed" : ""
                            )}
                            onClick={(e) => openDeleteConfirmation(chat, e)}
                            aria-label={`Eliminar chat: ${displayTitle}`}
                            disabled={isDeleting && chatToDelete?.id === chat.id}
                        >
                            {isDeleting && chatToDelete?.id === chat.id ? (
                                <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                            ) : (
                                <Trash2 className="h-4 w-4" />
                            )}
                        </Button>
                    </AlertDialogTrigger>
                </div>
            );
        });
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                 {/* Header del historial */}
                 <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1">
                     <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                         Historial
                     </h3>
                     <Button
                         variant="ghost"
                         size="icon" // Cambiado a icon
                         className="h-7 w-7 text-muted-foreground hover:text-foreground" // Tama√±o y color ajustados
                         onClick={() => fetchChatHistory(true)}
                         disabled={isLoading || isAuthLoading}
                         title="Actualizar historial"
                     >
                         <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                         <span className="sr-only">Actualizar Historial</span>
                     </Button>
                 </div>
                 {/* ScrollArea para el contenido */}
                 <ScrollArea className="flex-1 -mx-2"> {/* Padding negativo para compensar el padding del contenedor padre */}
                     <div className="flex flex-col gap-1 p-2"> {/* Padding interno y gap */}
                         {renderContent()}
                     </div>
                 </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{chatToDelete?.title || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx (REFACTORIZADO - Fuentes mejoradas)
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, BrainCircuit, AlertTriangle, FileText, CircleDot } from 'lucide-react'; // A√±adido CircleDot
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"
// import { Badge } from '@/components/ui/badge'; // Badge ya no se usa para fuentes

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <BrainCircuit className="h-5 w-5" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Contenido Markdown */}
         {/* Asegurar que prose tenga los estilos correctos definidos en tailwind.config y globals.css */}
         {/* FLAG_LLM: Aplicar prose al div exterior, no al componente Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {/* Secci√≥n de Fuentes (REDISE√ëADA) */}
         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40">
                <p className="text-xs font-medium text-muted-foreground mb-2">Fuentes:</p>
                {/* Usar flex-wrap para las fuentes */}
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5"> {/* Ajuste de gap */}
                 {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}`} delayDuration={150}>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                {/* Bot√≥n peque√±o con n√∫mero */}
                                <Button
                                    variant="outline"
                                    size="sm" // Bot√≥n m√°s peque√±o
                                    className="h-6 w-6 px-1 py-0 rounded-full border-dashed hover:border-solid hover:bg-accent/50 cursor-default flex items-center justify-center focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                    onClick={(e) => {e.preventDefault();}} // No hacer nada en click, solo tooltip
                                    tabIndex={0} // Make it focusable
                                    aria-label={`Fuente ${index + 1}: ${doc.file_name || 'Detalles'}`}
                                >
                                    {/* N√∫mero de fuente */}
                                    <span className="text-xs font-mono text-muted-foreground">{index + 1}</span>
                                </Button>
                            </TooltipTrigger>
                            {/* Tooltip mejorado con fondo popover */}
                            <TooltipContent
                                side="bottom"
                                className="max-w-xs text-xs p-2 shadow-lg bg-popover text-popover-foreground" // Asegura fondo popover
                                sideOffset={4}
                            >
                                <p className="font-medium mb-0.5 break-words">
                                    <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                                    {doc.file_name || 'Nombre no disponible'}
                                </p>
                                <p className="text-muted-foreground text-[11px] mb-1.5 break-all">
                                   ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                                </p>
                                {doc.score != null && (
                                    <p className="font-medium text-muted-foreground text-[11px]">
                                        Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                                    </p>
                                )}
                                {doc.content_preview && (
                                    <p className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                                        Vista previa:
                                        <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview}</span>
                                    </p>
                                )}
                            </TooltipContent>
                        </Tooltip>
                   </TooltipProvider>
                 ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react';
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5" title={`Score: ${score.toFixed(3)}`}>
          {[...Array(5)].map((_, i) => (
            <Star
              key={i}
              // FLAG_LLM: Clases corregidas para el color de las estrellas
              className={cn(
                "h-3 w-3",
                i < numStars
                  ? "text-yellow-400 fill-yellow-400" // Estrella activa
                  : "text-gray-300 fill-gray-300 dark:text-gray-600 dark:fill-gray-600" // Estrella inactiva
              )}
            />
          ))}
        </div>
      );
    };

  return (
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col border-l bg-muted/10 dark:bg-muted/20">
            <CardHeader className="sticky top-0 z-10 border-b bg-background p-4 shadow-sm">
                <CardTitle className="text-base font-semibold flex items-center gap-2">
                    <FileText className="h-5 w-5 text-primary" /> Fuentes Relevantes
                </CardTitle>
                <CardDescription className="text-xs mt-1">
                    Documentos utilizados para generar la respuesta.
                </CardDescription>
            </CardHeader>

            <ScrollArea className="flex-1">
                <div className="p-3 space-y-2">
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {documents.map((doc, index) => (
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card",
                                    "border border-border hover:border-primary/40 hover:shadow-md focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || 'documento'}`}
                            >
                                <CardContent className="p-3 space-y-1 text-sm">
                                    <div className="flex justify-between items-start gap-2">
                                        <p className="font-medium text-foreground/95 truncate flex-1 flex items-center gap-1.5">
                                            <span className="flex-shrink-0 h-5 w-5 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border">
                                                {index + 1}
                                            </span>
                                            <span className="truncate" title={doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                        </p>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed pl-7">
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                     <div className="text-[10px] text-muted-foreground/70 pt-1.5 flex justify-between items-center font-mono pl-7">
                                        <span>ID: {doc.document_id?.substring(0, 8) ?? doc.id.substring(0, 8)}...</span>
                                        <Eye className="h-3 w-3" />
                                    </div>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0">
                    <DialogHeader className="px-6 pt-6 pb-4 border-b">
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || 'Detalles del Documento'}
                        </DialogTitle>
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id?.substring(0,12) || 'N/D'}...</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]">
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words">
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name}>
                            <Download className="mr-2 h-4 w-4" />Descargar Original {selectedDoc.file_name ? '' : '(N/D)'}
                        </Button>
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };

  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return ( <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]"> <Info className="h-8 w-8 mb-3 opacity-50"/> <p className="text-sm font-medium mb-1">Sin Documentos</p> <p className="text-xs">A√∫n no se han subido documentos.</p> </div> );
  }

  return (
      <TooltipProvider>
        <div className="border rounded-lg overflow-hidden shadow-sm bg-card">
          <Table className='w-full text-sm'>
            <TableHeader>
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-[40%] pl-3 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {documents.map((doc) => {
                 // FLAG_LLM: Comprobar document_id que es el esperado por el frontend
                if (!doc || !doc.document_id) {
                    // No mostrar el warning en producci√≥n, solo omitir
                    if (process.env.NODE_ENV === 'development') {
                         console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                    }
                    return null;
                }

                const statusInfo = statusMap[doc.status] || statusMap.default;
                const Icon = statusInfo.icon;
                const isCurrentlyRetrying = isRetrying === doc.document_id;
                const isCurrentlyRefreshing = isRefreshing === doc.document_id;
                const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;

                const dateToShow = doc.last_updated; // Usar last_updated que viene mapeado
                const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
                const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
                const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';

                return (
                    // FLAG_LLM: Usar doc.document_id como key
                    <TableRow key={doc.document_id} className="group hover:bg-accent/30 data-[state=selected]:bg-accent">
                        <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-3 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                        <TableCell className="px-2 py-1.5">
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                    <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                                        <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                                        {statusInfo.text}
                                    </Badge>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                                    <p>{statusInfo.description}</p>
                                    {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                                </TooltipContent>
                            </Tooltip>
                        </TableCell>
                        <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                        <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                        <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                    <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                            </Tooltip>
                            {doc.status === 'error' && (
                                <Tooltip delayDuration={100}>
                                    <TooltipTrigger asChild>
                                        {/* FLAG_LLM: Pasar doc.document_id */}
                                        <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                                    </TooltipTrigger>
                                    <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                                </Tooltip>
                            )}
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                     {/* FLAG_LLM: Pasar doc.document_id */}
                                    <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                            </Tooltip>
                            <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                                <Tooltip delayDuration={100}>
                                    <TooltipTrigger asChild>
                                         <AlertDialogTrigger asChild>
                                             {/* FLAG_LLM: Pasar doc.document_id */}
                                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                         </AlertDialogTrigger>
                                    </TooltipTrigger>
                                    <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                                </Tooltip>
                                <AlertDialogContent>
                                    <AlertDialogHeader>
                                        <AlertDialogTitle className="flex items-center gap-2">
                                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                                        </AlertDialogTitle>
                                        <AlertDialogDescription>
                                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                                        </AlertDialogDescription>
                                    </AlertDialogHeader>
                                    <AlertDialogFooter>
                                        <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                                        <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                                            Eliminar Permanentemente
                                        </AlertDialogAction>
                                    </AlertDialogFooter>
                                </AlertDialogContent>
                            </AlertDialog>
                        </TableCell>
                    </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </div>
        {hasMore && ( <div className="pt-6 text-center"> <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}> {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos </Button> </div> )}
      </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (si existe y no est√° subiendo/completado) */}
      {files.length > 0 && !isUploading && (
        <div className="space-y-2">
          {files.map(file => (
            <div key={file.name} className="p-3 border rounded-lg flex items-center justify-between space-x-3 bg-muted/40 shadow-sm">
              <div className="flex items-center space-x-3 overflow-hidden flex-1 min-w-0">
                <FileIcon className="h-5 w-5 flex-shrink-0 text-primary" />
                <div className='flex flex-col min-w-0'>
                  <span className="text-sm font-medium truncate" title={file.name}>{file.name}</span>
                  <span className="text-xs text-muted-foreground">
                    ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                    <Badge variant="outline" className='ml-1.5 py-0 px-1.5 text-[10px]'>{file.type || 'desconocido'}</Badge>
                  </span>
                </div>
              </div>
              <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                <X className="h-4 w-4" />
              </Button>
            </div>
          ))}
        </div>
      )}

      {/* Bot√≥n de Subida (visible solo si hay archivo y no se complet√≥ la subida) */}
      {files.length > 0 && (
        <Button
          onClick={async () => {
            for (const file of files) {
              await onUploadFile(file, authHeaders);
            }
            setFiles([]);
          }}
          disabled={isUploading}
          className="w-full"
        >
          {isUploading ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              Subiendo...
            </>
          ) : 'Subir y Procesar Archivos'}
        </Button>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <ChatHistory />
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ full_codebase.md
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; // BrainCircuit quitado si no se usa
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); // Para ScrollArea de mensajes
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); // Asegurar que el panel se oculte en un nuevo chat sin ID
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); // A√±adido isSourcesPanelVisible para re-evaluar si se abre externamente
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            const viewport = scrollAreaRef.current?.viewport as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else { 
                const scrollElement = scrollAreaRef.current as HTMLElement; 
                if (scrollElement?.scrollTo) { 
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100); 
                    return () => clearTimeout(timeoutId); 
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        <div className="flex flex-col h-full bg-background p-4 sm:p-6 lg:p-8">
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden">
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}>
                    <div className="flex h-full flex-col relative overflow-hidden">
                         <div className="absolute top-1 right-1 z-20"> 
                             <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                             </Button>
                        </div>
                        <ScrollArea className="flex-1" ref={scrollAreaRef}>
                             <div className="px-3 py-4 sm:px-4 sm:py-5">
                                {renderChatContent()}
                             </div>
                        </ScrollArea>
                        <div className="border-t border-border/60 px-3 py-3 sm:px-4 sm:py-4 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                             <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        {/* El ResizablePanel que contiene las fuentes ahora tiene h-full y overflow-hidden */}
                        {/* Esto asegura que el panel tenga una altura definida por el grupo y que su contenido */}
                        {/* (RetrievedDocumentsPanel) use su propio scroll interno si es necesario, sin */}
                        {/* afectar las dimensiones de este panel ni del panel de chat. */}
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45} className="h-full overflow-hidden">
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  const authHeadersForChildren: AuthHeaders | null = user?.userId && user?.companyId ? {
    'X-User-ID': user.userId,
    'X-Company-ID': user.companyId,
  } : null;

  if (isAuthLoading) {
    return (
        <div className="p-6 lg:p-8 space-y-8"> {/* Padding aqu√≠ */}
          <Skeleton className="h-10 w-1/3 mb-6" />
          <Skeleton className="h-64 rounded-xl mb-8" />
          <Skeleton className="h-10 w-1/4 mb-4" />
          <Skeleton className="h-80 rounded-xl" />
        </div>
    );
  }

  return (
    <div className="p-6 lg:p-8 space-y-8"> {/* Padding principal de la p√°gina */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <h1 className="text-2xl md:text-3xl font-bold tracking-tight text-foreground flex items-center gap-2">
                 <FileText className="h-7 w-7" />
                 Base de Conocimiento
            </h1>
            {authHeadersForChildren && (
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => fetchDocuments(true)}
                    disabled={isLoadingDocuments}
                    className="w-full sm:w-auto"
                >
                    <Loader2 className={cn("mr-2 h-4 w-4", isLoadingDocuments ? "animate-spin" : "hidden")} />
                    Refrescar Documentos
                </Button>
            )}
        </div>

        <Card className="shadow-md border">
            <CardHeader>
                <CardTitle className="text-xl flex items-center gap-2">
                    <UploadCloud className="h-5 w-5 text-primary" /> Subir Nuevo Documento
                </CardTitle>
                <CardDescription>A√±ade archivos a tu base de conocimiento.</CardDescription>
            </CardHeader>
            <CardContent>
            {authHeadersForChildren ? (
                <FileUploader
                    authHeaders={authHeadersForChildren}
                    onUploadFile={uploadFile}
                    isUploading={isUploading}
                    uploadError={uploadError}
                    clearUploadStatus={clearUploadStatus}
                />
            ) : (
                <Alert variant="default" className="bg-muted/50">
                     <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                    <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                    <AlertDescription className="text-xs text-muted-foreground">
                        Inicia sesi√≥n para poder subir nuevos documentos.
                    </AlertDescription>
                </Alert>
            )}
            </CardContent>
        </Card>

        <Separator />

        <div className='space-y-4'>
             <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
                 <List className="h-6 w-6" /> Documentos Gestionados
            </h2>
             {documentsError && (
                <Alert variant="destructive">
                     <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Error al Cargar Documentos</AlertTitle>
                    <AlertDescription>
                        {documentsError}
                        <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
                    </AlertDescription>
                </Alert>
             )}
             {isLoadingDocuments && documents.length === 0 && !documentsError && (
                <div className="space-y-2 pt-2 border rounded-lg p-4">
                    <Skeleton className="h-12 w-full rounded-md" />
                    <Skeleton className="h-12 w-full rounded-md" />
                    <Skeleton className="h-12 w-full rounded-md" />
                </div>
             )}
             {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
                <DocumentStatusList
                    documents={documents}
                    authHeaders={authHeadersForChildren}
                    onRetrySuccess={handleRetrySuccess}
                    fetchMore={fetchMore}
                    hasMore={hasMore}
                    refreshDocument={refreshDocument}
                    onDeleteSuccess={handleDeleteSuccess}
                    isLoading={isLoadingDocuments}
                />
             )}
             {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
                <div className="text-center py-10 border-2 border-dashed rounded-lg bg-muted/30">
                     <p className="text-muted-foreground text-sm">Inicia sesi√≥n para ver tus documentos.</p>
                </div>
             )}
        </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      <Header />
                      {/* Main debe tener overflow:hidden y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-hidden"> {/* MODIFICADO: overflow-y-auto a overflow-hidden */}
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */
.skeleton-thinking {
  display: flex;
  align-items: flex-start; /* Cambiado a flex-start para alinear √≠cono y texto */
  gap: 0.75rem; /* Equivalente a space-x-3 */
  width: 100%;
  padding-right: 2.5rem; /* Equivalente a pr-10 */
  padding-top: 1rem; /* Equivalente a pt-4 */
}

.skeleton-thinking-avatar {
  height: 2rem; /* h-8 */
  width: 2rem; /* w-8 */
  border-radius: 9999px; /* rounded-full */
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1); /* bg-primary/10 */
}

.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem; /* pt-1.5 */
  display: flex;
  flex-direction: column;
  gap: 0.5rem; /* space-y-2 */
}

.skeleton-thinking-line {
  height: 0.875rem; /* h-3.5 */
  border-radius: 0.375rem; /* rounded */
  background-color: hsl(var(--accent)); /* Fondo del Skeleton */
}

.skeleton-thinking-line-short {
  width: 4rem; /* w-16 */
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-6">
                    <History className="h-8 w-8 mb-3 opacity-50"/>
                    <p className="text-sm font-medium mb-1">Sin chats anteriores</p>
                    <p className="text-xs">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                </div>
            );
        }

        return chats.map((chat) => {
            const isActive = pathname === `/chat/${chat.id}`;
            const displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
            const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }); // Formato espa√±ol

            return (
                <div key={chat.id} className="relative group w-full"> {/* Quitamos pr-8 */}
                    <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                        <a
                            className={cn(
                                buttonVariants({ variant: "ghost", size: "default" }), // Usamos ghost
                                "w-full justify-start h-auto py-2.5 px-3 overflow-hidden text-left rounded-md text-sm", // Padding y altura ajustados
                                isActive
                                ? "bg-primary/10 dark:bg-primary/20 text-primary font-medium" // Estado activo mejorado
                                : "text-foreground/70 hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30" // Estado inactivo
                            )}
                            title={displayTitle}
                        >
                            {/* Icono principal */}
                            <MessageSquareText className="h-4 w-4 mr-2.5 flex-shrink-0 opacity-80" />
                            {/* Contenedor para t√≠tulo y fecha */}
                            <div className="flex flex-col flex-1 min-w-0">
                                <span className="truncate font-medium text-foreground group-hover:text-foreground">{displayTitle}</span>
                                <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                            </div>
                        </a>
                    </Link>
                    {/* Bot√≥n Eliminar aparece en hover */}
                    <AlertDialogTrigger asChild>
                        <Button
                            variant="ghost" size="icon"
                            className={cn(
                                "absolute right-1.5 top-1/2 -translate-y-1/2 h-7 w-7 p-0 rounded-md",
                                "opacity-0 group-hover:opacity-60 focus-visible:opacity-100 hover:!opacity-100", // Control de opacidad
                                "transition-opacity duration-150 flex-shrink-0",
                                "hover:bg-destructive/10 hover:text-destructive", // Estilo hover
                                isDeleting && chatToDelete?.id === chat.id ? "opacity-50 cursor-not-allowed" : ""
                            )}
                            onClick={(e) => openDeleteConfirmation(chat, e)}
                            aria-label={`Eliminar chat: ${displayTitle}`}
                            disabled={isDeleting && chatToDelete?.id === chat.id}
                        >
                            {isDeleting && chatToDelete?.id === chat.id ? (
                                <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                            ) : (
                                <Trash2 className="h-4 w-4" />
                            )}
                        </Button>
                    </AlertDialogTrigger>
                </div>
            );
        });
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                 {/* Header del historial */}
                 <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1">
                     <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                         Historial
                     </h3>
                     <Button
                         variant="ghost"
                         size="icon" // Cambiado a icon
                         className="h-7 w-7 text-muted-foreground hover:text-foreground" // Tama√±o y color ajustados
                         onClick={() => fetchChatHistory(true)}
                         disabled={isLoading || isAuthLoading}
                         title="Actualizar historial"
                     >
                         <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                         <span className="sr-only">Actualizar Historial</span>
                     </Button>
                 </div>
                 {/* ScrollArea para el contenido */}
                 <ScrollArea className="flex-1 -mx-2"> {/* Padding negativo para compensar el padding del contenedor padre */}
                     <div className="flex flex-col gap-1 p-2"> {/* Padding interno y gap */}
                         {renderContent()}
                     </div>
                 </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{chatToDelete?.title || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx (REFACTORIZADO - Fuentes mejoradas)
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, BrainCircuit, AlertTriangle, FileText, CircleDot } from 'lucide-react'; // A√±adido CircleDot
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"
// import { Badge } from '@/components/ui/badge'; // Badge ya no se usa para fuentes

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <BrainCircuit className="h-5 w-5" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Contenido Markdown */}
         {/* Asegurar que prose tenga los estilos correctos definidos en tailwind.config y globals.css */}
         {/* FLAG_LLM: Aplicar prose al div exterior, no al componente Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {/* Secci√≥n de Fuentes (REDISE√ëADA) */}
         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40">
                <p className="text-xs font-medium text-muted-foreground mb-2">Fuentes:</p>
                {/* Usar flex-wrap para las fuentes */}
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5"> {/* Ajuste de gap */}
                 {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}`} delayDuration={150}>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                {/* Bot√≥n peque√±o con n√∫mero */}
                                <Button
                                    variant="outline"
                                    size="sm" // Bot√≥n m√°s peque√±o
                                    className="h-6 w-6 px-1 py-0 rounded-full border-dashed hover:border-solid hover:bg-accent/50 cursor-default flex items-center justify-center focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                    onClick={(e) => {e.preventDefault();}} // No hacer nada en click, solo tooltip
                                    tabIndex={0} // Make it focusable
                                    aria-label={`Fuente ${index + 1}: ${doc.file_name || 'Detalles'}`}
                                >
                                    {/* N√∫mero de fuente */}
                                    <span className="text-xs font-mono text-muted-foreground">{index + 1}</span>
                                </Button>
                            </TooltipTrigger>
                            {/* Tooltip mejorado con fondo popover */}
                            <TooltipContent
                                side="bottom"
                                className="max-w-xs text-xs p-2 shadow-lg bg-popover text-popover-foreground" // Asegura fondo popover
                                sideOffset={4}
                            >
                                <p className="font-medium mb-0.5 break-words">
                                    <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                                    {doc.file_name || 'Nombre no disponible'}
                                </p>
                                <p className="text-muted-foreground text-[11px] mb-1.5 break-all">
                                   ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                                </p>
                                {doc.score != null && (
                                    <p className="font-medium text-muted-foreground text-[11px]">
                                        Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                                    </p>
                                )}
                                {doc.content_preview && (
                                    <p className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                                        Vista previa:
                                        <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview}</span>
                                    </p>
                                )}
                            </TooltipContent>
                        </Tooltip>
                   </TooltipProvider>
                 ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx (REFACTORIZADO - Mejor dise√±o y Modal m√°s grande)
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react'; // Iconos a√±adidos y X para cerrar modal
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose // Importar DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    // Componente para renderizar estrellas de score
    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5" title={`Score: ${score.toFixed(3)}`}>
          {[...Array(5)].map((_, i) => (
            <Star key={i} className={cn("h-3 w-3", i < numStars ? "fill-yellow-400 text-yellow-500" : "fill-muted text-muted-foreground/50")} />
          ))}
        </div>
      );
    };

  return (
    // FLAG_LLM: Usar Dialog, no AlertDialog. Se controla con isDialogOpen state.
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col border-l bg-muted/10 dark:bg-muted/20">
            {/* Header del panel */}
            <CardHeader className="sticky top-0 z-10 border-b bg-background p-4 shadow-sm">
                <CardTitle className="text-base font-semibold flex items-center gap-2">
                    <FileText className="h-5 w-5 text-primary" /> Fuentes Relevantes
                </CardTitle>
                <CardDescription className="text-xs mt-1">
                    Documentos utilizados para generar la respuesta.
                </CardDescription>
            </CardHeader>

            {/* Contenedor scrollable */}
            <ScrollArea className="flex-1">
                <div className="p-3 space-y-2">
                    {/* Estado de Carga con Skeleton */}
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {/* Estado Vac√≠o */}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {/* Lista de Documentos */}
                    {documents.map((doc, index) => (
                        // FLAG_LLM: El Card ahora es el DialogTrigger
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card",
                                    "border border-border hover:border-primary/40 hover:shadow-md focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || 'documento'}`}
                            >
                                <CardContent className="p-3 space-y-1 text-sm">
                                    {/* Header: Nombre archivo y Score */}
                                    <div className="flex justify-between items-start gap-2">
                                        <p className="font-medium text-foreground/95 truncate flex-1 flex items-center gap-1.5">
                                             {/* N√∫mero √≠ndice */}
                                            <span className="flex-shrink-0 h-5 w-5 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border">
                                                {index + 1}
                                            </span>
                                            <span className="truncate" title={doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                        </p>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    {/* Preview */}
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed pl-7"> {/* Indentado */}
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                    {/* Footer: IDs y Bot√≥n View */}
                                     <div className="text-[10px] text-muted-foreground/70 pt-1.5 flex justify-between items-center font-mono pl-7"> {/* Indentado */}
                                        <span>ID: {doc.document_id?.substring(0, 8) ?? doc.id.substring(0, 8)}...</span>
                                        <Eye className="h-3 w-3" />
                                    </div>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {/* FLAG_LLM: Contenido del Dialog (Modal) m√°s grande y con m√°s info */}
            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0"> {/* Tama√±o aumentado y sin padding inicial */}
                    <DialogHeader className="px-6 pt-6 pb-4 border-b"> {/* Padding y borde */}
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || 'Detalles del Documento'}
                        </DialogTitle>
                        {/* Metadatos resumidos bajo el t√≠tulo */}
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id?.substring(0,12) || 'N/D'}...</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    {/* Contenido Scrolleable */}
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]"> {/* Altura m√°xima calculada */}
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words"> {/* Blockquote estilizado y pre-wrap */}
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {/* Metadatos si existen */}
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30"> {/* Padding y borde */}
                        {/* Bot√≥n Descarga */}
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name}> {/* Deshabilitado si no hay nombre */}
                            <Download className="mr-2 h-4 w-4" />Descargar Original {selectedDoc.file_name ? '' : '(N/D)'}
                        </Button>
                        {/* Bot√≥n Cerrar expl√≠cito */}
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        {/* Estilos para scrollbar bonito (opcional, a√±adir a globals.css si se quiere) */}
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };

  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return ( <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]"> <Info className="h-8 w-8 mb-3 opacity-50"/> <p className="text-sm font-medium mb-1">Sin Documentos</p> <p className="text-xs">A√∫n no se han subido documentos.</p> </div> );
  }

  return (
      <TooltipProvider>
        <div className="border rounded-lg overflow-hidden shadow-sm bg-card">
          <Table className='w-full text-sm'>
            <TableHeader>
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-[40%] pl-3 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {documents.map((doc) => {
                 // FLAG_LLM: Comprobar document_id que es el esperado por el frontend
                if (!doc || !doc.document_id) {
                    // No mostrar el warning en producci√≥n, solo omitir
                    if (process.env.NODE_ENV === 'development') {
                         console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                    }
                    return null;
                }

                const statusInfo = statusMap[doc.status] || statusMap.default;
                const Icon = statusInfo.icon;
                const isCurrentlyRetrying = isRetrying === doc.document_id;
                const isCurrentlyRefreshing = isRefreshing === doc.document_id;
                const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;

                const dateToShow = doc.last_updated; // Usar last_updated que viene mapeado
                const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
                const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
                const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';

                return (
                    // FLAG_LLM: Usar doc.document_id como key
                    <TableRow key={doc.document_id} className="group hover:bg-accent/30 data-[state=selected]:bg-accent">
                        <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-3 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                        <TableCell className="px-2 py-1.5">
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                    <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                                        <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                                        {statusInfo.text}
                                    </Badge>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                                    <p>{statusInfo.description}</p>
                                    {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                                </TooltipContent>
                            </Tooltip>
                        </TableCell>
                        <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                        <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                        <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                    <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                            </Tooltip>
                            {doc.status === 'error' && (
                                <Tooltip delayDuration={100}>
                                    <TooltipTrigger asChild>
                                        {/* FLAG_LLM: Pasar doc.document_id */}
                                        <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                                    </TooltipTrigger>
                                    <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                                </Tooltip>
                            )}
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                     {/* FLAG_LLM: Pasar doc.document_id */}
                                    <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                            </Tooltip>
                            <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                                <Tooltip delayDuration={100}>
                                    <TooltipTrigger asChild>
                                         <AlertDialogTrigger asChild>
                                             {/* FLAG_LLM: Pasar doc.document_id */}
                                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                         </AlertDialogTrigger>
                                    </TooltipTrigger>
                                    <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                                </Tooltip>
                                <AlertDialogContent>
                                    <AlertDialogHeader>
                                        <AlertDialogTitle className="flex items-center gap-2">
                                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                                        </AlertDialogTitle>
                                        <AlertDialogDescription>
                                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                                        </AlertDialogDescription>
                                    </AlertDialogHeader>
                                    <AlertDialogFooter>
                                        <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                                        <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                                            Eliminar Permanentemente
                                        </AlertDialogAction>
                                    </AlertDialogFooter>
                                </AlertDialogContent>
                            </AlertDialog>
                        </TableCell>
                    </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </div>
        {hasMore && ( <div className="pt-6 text-center"> <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}> {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos </Button> </div> )}
      </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (si existe y no est√° subiendo/completado) */}
      {files.length > 0 && !isUploading && (
        <div className="space-y-2">
          {files.map(file => (
            <div key={file.name} className="p-3 border rounded-lg flex items-center justify-between space-x-3 bg-muted/40 shadow-sm">
              <div className="flex items-center space-x-3 overflow-hidden flex-1 min-w-0">
                <FileIcon className="h-5 w-5 flex-shrink-0 text-primary" />
                <div className='flex flex-col min-w-0'>
                  <span className="text-sm font-medium truncate" title={file.name}>{file.name}</span>
                  <span className="text-xs text-muted-foreground">
                    ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                    <Badge variant="outline" className='ml-1.5 py-0 px-1.5 text-[10px]'>{file.type || 'desconocido'}</Badge>
                  </span>
                </div>
              </div>
              <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                <X className="h-4 w-4" />
              </Button>
            </div>
          ))}
        </div>
      )}

      {/* Bot√≥n de Subida (visible solo si hay archivo y no se complet√≥ la subida) */}
      {files.length > 0 && (
        <Button
          onClick={async () => {
            for (const file of files) {
              await onUploadFile(file, authHeaders);
            }
            setFiles([]);
          }}
          disabled={isUploading}
          className="w-full"
        >
          {isUploading ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              Subiendo...
            </>
          ) : 'Subir y Procesar Archivos'}
        </Button>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <ChatHistory />
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `full_codebase.md`
```md
# Project Structure

```
atenex-frontend/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ (app)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [[...chatId]]
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (auth)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ privacy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ terms
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ animations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ snakeanimation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-interface.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retrieved-documents-panel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ atenex-logo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document-status-list.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-uploader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminLayout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-palette-button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ theme-toggle.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ alert-dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ       ‚îú‚îÄ‚îÄ avatar.tsx
‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx
‚îÇ       ‚îú‚îÄ‚îÄ checkbox.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ       ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ       ‚îú‚îÄ‚îÄ label.tsx
‚îÇ       ‚îú‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îú‚îÄ‚îÄ resizable.tsx
‚îÇ       ‚îú‚îÄ‚îÄ scroll-area.tsx
‚îÇ       ‚îú‚îÄ‚îÄ select.tsx
‚îÇ       ‚îú‚îÄ‚îÄ separator.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ sonner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ table.tsx
‚îÇ       ‚îú‚îÄ‚îÄ textarea.tsx
‚îÇ       ‚îî‚îÄ‚îÄ tooltip.tsx
‚îú‚îÄ‚îÄ components.json
‚îú‚îÄ‚îÄ export-codebase.py
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDocumentStatuses.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUploadDocument.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next.config.mjs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ icons
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json
```

# Full Codebase

## File: `next.config.mjs`
```mjs
// File: next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
    // reactStrictMode: true is the default in Next.js 14 and generally recommended
    transpilePackages: ['@radix-ui/react-dialog'],
    reactStrictMode: true,
  
  };
  
  export default nextConfig;
```

## File: `package.json`
```json
{
  "name": "atenex-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@react-three/drei": "^10.0.6",
    "@react-three/fiber": "^9.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.486.0",
    "next": "^15.2.4",
    "next-themes": "^0.4.6",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-dropzone": "^14.3.8",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.5.0",
    "react-markdown": "^10.1.0",
    "react-resizable-panels": "^2.1.7",
    "remark-gfm": "^4.0.1",
    "sonner": "^2.0.2",
    "tailwind-merge": "^3.1.0",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.175.0",
    "tw-animate-css": "^1.2.5",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/jest": "^29.5.14",
    "@types/node": "^22.13.14",
    "@types/react": "^19.0.12",
    "@types/react-dom": "^19.0.4",
    "@types/react-dropzone": "^4.2.2",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.23.0",
    "eslint-config-next": "^15.2.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.0.17",
    "ts-jest": "^29.3.2",
    "typescript": "^5.8.2"
  }
}
```

## File: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true, 
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: `tailwind.config.js`
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx,mdx}',
    './src/**/*.{ts,tsx,mdx}', // Si usas src/
    './components/theme-palette-button.tsx',
    ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
       fontFamily: {
         sans: ["var(--font-sans)", "system-ui", "sans-serif"],
       },
      
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
       // Add prose styles for markdown rendering
       typography: (theme) => ({
        DEFAULT: {
          css: {
            '--tw-prose-body': 'var(--foreground)',
            '--tw-prose-headings': 'var(--foreground)',
            '--tw-prose-lead': 'var(--muted-foreground)',
            '--tw-prose-links': 'var(--primary)',
            '--tw-prose-bold': 'var(--foreground)',
            '--tw-prose-counters': 'var(--muted-foreground)',
            '--tw-prose-bullets': 'var(--muted-foreground)',
            '--tw-prose-hr': 'var(--border)',
            '--tw-prose-quotes': 'var(--foreground)',
            '--tw-prose-quote-borders': 'var(--border)',
            '--tw-prose-captions': 'var(--muted-foreground)',
            '--tw-prose-code': 'var(--foreground)',
            '--tw-prose-pre-code': 'var(--foreground)',
            '--tw-prose-pre-bg': 'var(--muted)',
            '--tw-prose-th-borders': 'var(--border)',
            '--tw-prose-td-borders': 'var(--border)',
            '--tw-prose-invert-body': 'var(--foreground)', // Assuming foreground is light in dark mode
            '--tw-prose-invert-headings': 'var(--foreground)',
            '--tw-prose-invert-lead': 'var(--muted-foreground)',
            '--tw-prose-invert-links': 'var(--primary)',
            '--tw-prose-invert-bold': 'var(--foreground)',
            '--tw-prose-invert-counters': 'var(--muted-foreground)',
            '--tw-prose-invert-bullets': 'var(--muted-foreground)',
            '--tw-prose-invert-hr': 'var(--border)',
            '--tw-prose-invert-quotes': 'var(--foreground)',
            '--tw-prose-invert-quote-borders': 'var(--border)',
            '--tw-prose-invert-captions': 'var(--muted-foreground)',
            '--tw-prose-invert-code': 'var(--foreground)',
            '--tw-prose-invert-pre-code': 'var(--foreground)',
            '--tw-prose-invert-pre-bg': 'var(--muted)',
            '--tw-prose-invert-th-borders': 'var(--border)',
            '--tw-prose-invert-td-borders': 'var(--border)',
            // Customizations
            code: {
                padding: '0.2em 0.4em',
                margin: '0',
                fontSize: '85%',
                backgroundColor: 'hsl(var(--muted))',
                borderRadius: '0.25rem',
                fontWeight: '400', // Ensure code block text isn't bold by default
                color: 'inherit' // Inherit color
            },
            'code::before': { content: 'none' }, // Remove default quotes around inline code
            'code::after': { content: 'none' },
            pre: {
                 fontWeight: '400', // Ensure pre block text isn't bold
                 color: 'inherit', // Inherit color
                 backgroundColor: 'hsl(var(--muted))', // Match inline code bg
                 padding: theme('padding.4'),
                 borderRadius: theme('borderRadius.sm'),
                 overflowX: 'auto',
            },
            'pre code': { // Style code specifically inside pre blocks
                 backgroundColor: 'transparent', // No background for code inside pre
                 padding: '0',
                 margin: '0',
                 fontSize: 'inherit', // Inherit font size from pre
                 color: 'inherit', // Inherit color from pre
                 fontWeight: 'inherit', // Inherit font weight
             },
            'pre code::before': { content: 'none' }, // Remove quotes for code inside pre
            'pre code::after': { content: 'none' },
          },
        },
      }),
    },
  },
  plugins: [require("tailwindcss-animate"), require('@tailwindcss/typography')],
}
```

## File: `postcss.config.js`
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

## File: `.env.local`
```local
# Environment variables for local development

# Base URL of your API Gateway (expuesto con ngrok o similar)
NEXT_PUBLIC_API_GATEWAY_URL=https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app # <-- ¬°REEMPLAZA ESTO!

# Supabase Credentials (Required for Supabase JS Client)
NEXT_PUBLIC_SUPABASE_URL=https://ymsilkrhstwxikjiqqog.supabase.co # <-- Tu URL de Supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inltc2lsa3Joc3R3eGlramlxcW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NDAzOTIsImV4cCI6MjA1ODUxNjM5Mn0.s-RgS3tBAHl5UIZqoiPc8bGy2Kz3cktbDpjJkdvz0Jk # <-- Tu Anon Key de Supabase

# Opcional: Para saltar la verificaci√≥n de autenticaci√≥n durante el desarrollo
# Poner a 'true' para bypass, cualquier otro valor o ausente para requerir auth.
NEXT_PUBLIC_BYPASS_AUTH=false

# JWT_SECRET=... # <-- YA NO ES NECESARIO AQU√ç
```

## File: `.gitignore`
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js build output
/.next/
/out/

# Production build files
/build

# Static export files
/export

# Miscellaneous
.DS_Store
*.pem

# Nodejs dependency updates
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local environment variables
.env.local
.env.development.local
.env.test.local
.env.production.local

# Operating System Files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db
*.stackdump

# IDE config files
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Typescript cache
*.tsbuildinfo

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Turbo Repo
.turbo

# Drizzle Migration files (optional)
# drizzle/*
# !drizzle/meta/_journal

# Output of sensitive data extraction tool (e.g., git-secrets)
*.secret.*

# Optional VS Code files for debugging etc.
.history/
```

## File: `app\(app)\admin\page.tsx`
```tsx
// File: app/(app)/admin/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import React, { Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import AdminStats from '@/components/admin/AdminStats';
import AdminManagement from '@/components/admin/AdminManagement';
import { useAuth } from '@/lib/hooks/useAuth';
import { Loader2 } from 'lucide-react';

function AdminDashboardContent() {
  const searchParams = useSearchParams();
  const view = searchParams.get('view') || 'stats';

  return (
    // FLAG_LLM: A√±adido padding aqu√≠ (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-6">
      {view === 'stats' && <AdminStats />}
      {view === 'management' && <AdminManagement />}
    </div>
  );
}

export default function AdminDashboardPage() {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  if (isLoading) {
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> );
  }

  if (!user || !user.isAdmin) {
    React.useEffect(() => { router.replace('/chat'); }, [router]);
    return ( <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> <p className="ml-2">Redirigiendo...</p> </div> );
  }

  return (
    <Suspense fallback={ <div className="flex items-center justify-center h-full"> <Loader2 className="h-8 w-8 animate-spin text-primary" /> </div> }>
      <AdminDashboardContent />
    </Suspense>
  );
}
```

## File: `app\(app)\chat\[[...chatId]]\page.tsx`
```tsx
// File: app/(app)/chat/[[...chatId]]/page.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from '@/components/chat/chat-input';
import { ChatMessage, Message } from '@/components/chat/chat-message';
import { RetrievedDocumentsPanel } from '@/components/chat/retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import {
    postQuery,
    getChatMessages,
    deleteChat,
    RetrievedDoc,
    ApiError,
    mapApiMessageToFrontend,
    mapApiSourcesToFrontend,
    ChatSummary,
    ChatMessageApi,
    QueryApiResponse
} from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, AlertCircle, RefreshCw } from 'lucide-react'; // BrainCircuit quitado si no se usa
import { Skeleton } from '@/components/ui/skeleton';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn, isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

const welcomeMessage: Message = {
    id: 'initial-welcome',
    role: 'assistant',
    content: '¬°Hola! Soy Atenex. Preg√∫ntame cualquier cosa sobre tus documentos.',
    created_at: new Date().toISOString(),
};

export default function ChatPage() {
    const params = useParams();
    const router = useRouter();
    const pathname = usePathname();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const chatIdParam = params.chatId ? (Array.isArray(params.chatId) ? params.chatId[0] : params.chatId) : undefined;
    const [chatId, setChatId] = useState<string | undefined>(chatIdParam);

    const [messages, setMessages] = useState<Message[]>([welcomeMessage]);
    const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
    const lastDocsRef = useRef<RetrievedDoc[]>([]);
    const [isSending, setIsSending] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [historyError, setHistoryError] = useState<string | null>(null);
    const [isSourcesPanelVisible, setIsSourcesPanelVisible] = useState(false);

    const scrollAreaRef = useRef<any>(null); // Para ScrollArea de mensajes
    const fetchedChatIdRef = useRef<string | 'welcome' | undefined>(undefined);

    useEffect(() => { if (chatIdParam !== chatId) { setChatId(chatIdParam); fetchedChatIdRef.current = undefined; } }, [chatIdParam, chatId]);
    
    useEffect(() => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const currentFetchTarget = chatId || 'welcome';

        if (!bypassAuth && isAuthLoading) { setIsLoadingHistory(true); setMessages([]); return; }
        if (!bypassAuth && !user) { setMessages([welcomeMessage]); setIsLoadingHistory(false); fetchedChatIdRef.current = 'welcome'; return; }
        if (fetchedChatIdRef.current === currentFetchTarget && !isLoadingHistory) return;
        
        setIsLoadingHistory(true); setHistoryError(null); setMessages([]);
        fetchedChatIdRef.current = currentFetchTarget;

        if (chatId) {
            getChatMessages(chatId)
                .then((apiMessages: ChatMessageApi[]) => {
                    const sortedMessages = [...apiMessages].sort((a, b) => (new Date(a.created_at || 0)).getTime() - (new Date(b.created_at || 0)).getTime());
                    const mappedMessages = sortedMessages.map(mapApiMessageToFrontend);
                    let lastWithDocs: RetrievedDoc[] = [];
                    for (let i = sortedMessages.length - 1; i >= 0; i--) { if (sortedMessages[i].sources?.length) { lastWithDocs = mapApiSourcesToFrontend(sortedMessages[i].sources) || []; break; } }
                    setRetrievedDocs(lastWithDocs); lastDocsRef.current = lastWithDocs;
                    setMessages(mappedMessages.length > 0 ? mappedMessages : [welcomeMessage]);
                    if (lastWithDocs.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
                })
                .catch(error => { setHistoryError("Fallo al cargar el historial."); setMessages([welcomeMessage]); fetchedChatIdRef.current = undefined; })
                .finally(() => setIsLoadingHistory(false));
        } else { 
            setMessages([welcomeMessage]); setRetrievedDocs([]); setIsLoadingHistory(false); 
            setIsSourcesPanelVisible(false); // Asegurar que el panel se oculte en un nuevo chat sin ID
            fetchedChatIdRef.current = 'welcome'; 
        }
    }, [chatId, user, isAuthLoading, isSourcesPanelVisible]); // A√±adido isSourcesPanelVisible para re-evaluar si se abre externamente
    
    useEffect(() => {
        if (scrollAreaRef.current && !isLoadingHistory && messages.length > 0) {
            const viewport = scrollAreaRef.current?.viewport as HTMLElement | null;
            if (viewport) { 
                const timeoutId = setTimeout(() => { viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' }); }, 100); 
                return () => clearTimeout(timeoutId); 
            } else { 
                const scrollElement = scrollAreaRef.current as HTMLElement; 
                if (scrollElement?.scrollTo) { 
                    const timeoutId = setTimeout(() => { scrollElement.scrollTo({ top: scrollElement.scrollHeight, behavior: 'smooth' }); }, 100); 
                    return () => clearTimeout(timeoutId); 
                }
            }
        }
    }, [messages, isSending, isLoadingHistory]);

    const handleSendMessage = useCallback(async (query: string) => {
        const text = query.trim();
        if (!text) { toast.warning("No se puede enviar un mensaje vac√≠o."); return; }
        const userMessage: Message = { id: `client-user-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() };
        setMessages(prev => prev.length === 1 && prev[0].id === 'initial-welcome' ? [userMessage] : [...prev.filter(m => m.id !== 'initial-welcome'), userMessage]);
        if (isGreeting(text)) { setMessages(prev => [...prev, { id: `assistant-greet-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?', created_at: new Date().toISOString() }]); return; }
        if (isMetaQuery(text)) { setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse(), created_at: new Date().toISOString() }]); return; }
        
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true'; const isAuthenticated = !!user || bypassAuth;
        if (!isAuthenticated) { toast.error("No Autenticado", { description: "Por favor, inicia sesi√≥n para enviar mensajes."}); signOut(); return; }
        if (isSending) return;

        setIsSending(true); const currentChatIdForApi = chatId || null;
        try {
            const response: QueryApiResponse = await postQuery({ query: text, chat_id: currentChatIdForApi });
            const mappedSources = mapApiSourcesToFrontend(response.retrieved_documents as any);
            const assistantMessage: Message = { id: `client-assistant-${Date.now()}`, role: 'assistant', content: response.answer, sources: mappedSources, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, assistantMessage]);
            setRetrievedDocs(mappedSources || []); lastDocsRef.current = mappedSources || [];
            if (!currentChatIdForApi && response.chat_id) { setChatId(response.chat_id); fetchedChatIdRef.current = response.chat_id; router.replace(`/chat/${response.chat_id}`, { scroll: false }); }
            if (mappedSources && mappedSources.length > 0 && !isSourcesPanelVisible) { setIsSourcesPanelVisible(true); }
        } catch (error) { 
            const errorMsgObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: "Error al procesar tu solicitud.", isError: true, created_at: new Date().toISOString() }; 
            setMessages(prev => [...prev, errorMsgObj]); 
            toast.error("Error", { description: error instanceof Error ? error.message : "Ocurri√≥ un error inesperado." });
        } finally { 
            setIsSending(false); 
        }
    }, [chatId, isSending, user, router, signOut, isSourcesPanelVisible]);

    const handlePanelToggle = () => setIsSourcesPanelVisible(!isSourcesPanelVisible);
    
    // handleNewChat no se necesita aqu√≠ si el Header lo maneja globalmente con router.push('/chat')
    // La l√≥gica de reseteo ya est√° en el useEffect que depende de `chatId`.

    const renderChatContent = (): React.ReactNode => {
        if (isLoadingHistory && messages.length <= 1) {
             return ( <div className="space-y-6 p-4"> <div className="flex items-start space-x-3"> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> <div className="flex-1 space-y-2"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> </div> <div className="flex items-start space-x-3 justify-end"> <div className="flex-1 space-y-2 items-end flex flex-col"><Skeleton className="h-4 w-3/4 rounded" /><Skeleton className="h-4 w-1/2 rounded" /></div> <Skeleton className="h-8 w-8 rounded-full flex-shrink-0" /> </div> </div> );
        }
        if (historyError) {
            return ( <div className="flex flex-col items-center justify-center h-full text-center p-6"> <AlertCircle className="h-12 w-12 text-destructive mb-4" /> <p>{historyError}</p> <Button variant="outline" size="sm" onClick={() => window.location.reload()} className="mt-4"><RefreshCw className="mr-2 h-4 w-4" /> Reintentar</Button> </div> );
        }
        // El padding se aplica al div que envuelve a renderChatContent
        return ( <div className="space-y-6"> {messages.map((message) => ( <ChatMessage key={message.id} message={message} /> ))} {isSending && ( <div className="skeleton-thinking"> <div className="skeleton-thinking-avatar"></div> <div className="skeleton-thinking-text"> <div className="skeleton-thinking-line skeleton-thinking-line-short"></div> </div> </div> )} </div> );
    };

    return (
        <div className="flex flex-col h-full bg-background p-4 sm:p-6 lg:p-8"> {/* Padding ajustado */}
            <ResizablePanelGroup direction="horizontal" className="flex-1 overflow-hidden"> {/* overflow-hidden es importante */}
                <ResizablePanel defaultSize={isSourcesPanelVisible ? 65 : 100} minSize={30} maxSize={100}>
                    {/* Contenedor del panel de chat. Se a√±ade overflow-hidden aqu√≠. */}
                    <div className="flex h-full flex-col relative overflow-hidden">
                         {/* Bot√≥n toggle en la esquina, ajustado para no ser afectado por padding interno de ScrollArea */}
                         <div className="absolute top-1 right-1 z-20"> 
                             <Button onClick={handlePanelToggle} variant="ghost" size="icon" className="h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 data-[state=open]:bg-accent data-[state=open]:text-accent-foreground" data-state={isSourcesPanelVisible ? "open" : "closed"} aria-label={isSourcesPanelVisible ? 'Cerrar Panel de Fuentes' : 'Abrir Panel de Fuentes'}>
                                {isSourcesPanelVisible ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                             </Button>
                        </div>
                        {/* ScrollArea para los mensajes. El padding se mueve a un div interno. */}
                        <ScrollArea className="flex-1" ref={scrollAreaRef}>
                             <div className="px-3 py-4 sm:px-4 sm:py-5"> {/* Padding interno para mensajes */}
                                {renderChatContent()}
                             </div>
                        </ScrollArea>
                        {/* Contenedor del ChatInput con padding y estilos */}
                        <div className="border-t border-border/60 px-3 py-3 sm:px-4 sm:py-4 bg-background/95 backdrop-blur-sm shadow-sm shrink-0">
                             <ChatInput onSendMessage={handleSendMessage} isLoading={isSending || isAuthLoading || isLoadingHistory} />
                        </div>
                    </div>
                </ResizablePanel>
                {isSourcesPanelVisible && (
                    <>
                        <ResizableHandle withHandle />
                        <ResizablePanel defaultSize={35} minSize={20} maxSize={45}> {/* MaxSize ajustado */}
                            <RetrievedDocumentsPanel documents={retrievedDocs.length > 0 ? retrievedDocs : lastDocsRef.current} isLoading={isSending} />
                        </ResizablePanel>
                    </>
                )}
            </ResizablePanelGroup>
        </div>
    );
}
```

## File: `app\(app)\knowledge\page.tsx`
```tsx
// File: app/(app)/knowledge/page.tsx (CONFIRMADO CON PADDING)
'use client';
import React, { useCallback, useEffect } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Loader2, AlertTriangle, UploadCloud, FileText, List } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useDocumentStatuses } from '@/lib/hooks/useDocumentStatuses';
import { useUploadDocument } from '@/lib/hooks/useUploadDocument';
import { DocumentStatusList } from '@/components/knowledge/document-status-list';
import { FileUploader } from '@/components/knowledge/file-uploader';
import { AuthHeaders } from '@/lib/api';
import { cn } from '@/lib/utils';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';

export default function KnowledgePage() {
  const { user, isLoading: isAuthLoading } = useAuth();

  const {
    documents,
    isLoading: isLoadingDocuments,
    error: documentsError,
    fetchDocuments,
    fetchMore,
    hasMore,
    retryLocalUpdate,
    refreshDocument,
    deleteLocalDocument,
  } = useDocumentStatuses();

  const {
    isUploading,
    uploadError,
    uploadResponse,
    uploadFile,
    clearUploadStatus
  } = useUploadDocument();

  useEffect(() => {
    if (uploadResponse?.document_id) {
       const refreshDelay = 1500;
       const timer = setTimeout(() => { fetchDocuments(true); }, refreshDelay);
       return () => clearTimeout(timer);
    }
  }, [uploadResponse, fetchDocuments]);

  const handleRetrySuccess = useCallback((documentId: string) => {
    retryLocalUpdate(documentId);
    refreshDocument(documentId);
  }, [retryLocalUpdate, refreshDocument]);

  const handleDeleteSuccess = useCallback((documentId: string) => {
    deleteLocalDocument(documentId);
  }, [deleteLocalDocument]);

  const authHeadersForChildren: AuthHeaders | null = user?.userId && user?.companyId ? {
    'X-User-ID': user.userId,
    'X-Company-ID': user.companyId,
  } : null;

  if (isAuthLoading) {
    return (
        <div className="p-6 lg:p-8 space-y-8"> {/* Padding aqu√≠ */}
          <Skeleton className="h-10 w-1/3 mb-6" />
          <Skeleton className="h-64 rounded-xl mb-8" />
          <Skeleton className="h-10 w-1/4 mb-4" />
          <Skeleton className="h-80 rounded-xl" />
        </div>
    );
  }

  return (
    <div className="p-6 lg:p-8 space-y-8"> {/* Padding principal de la p√°gina */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <h1 className="text-2xl md:text-3xl font-bold tracking-tight text-foreground flex items-center gap-2">
                 <FileText className="h-7 w-7" />
                 Base de Conocimiento
            </h1>
            {authHeadersForChildren && (
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => fetchDocuments(true)}
                    disabled={isLoadingDocuments}
                    className="w-full sm:w-auto"
                >
                    <Loader2 className={cn("mr-2 h-4 w-4", isLoadingDocuments ? "animate-spin" : "hidden")} />
                    Refrescar Documentos
                </Button>
            )}
        </div>

        <Card className="shadow-md border">
            <CardHeader>
                <CardTitle className="text-xl flex items-center gap-2">
                    <UploadCloud className="h-5 w-5 text-primary" /> Subir Nuevo Documento
                </CardTitle>
                <CardDescription>A√±ade archivos a tu base de conocimiento.</CardDescription>
            </CardHeader>
            <CardContent>
            {authHeadersForChildren ? (
                <FileUploader
                    authHeaders={authHeadersForChildren}
                    onUploadFile={uploadFile}
                    isUploading={isUploading}
                    uploadError={uploadError}
                    clearUploadStatus={clearUploadStatus}
                />
            ) : (
                <Alert variant="default" className="bg-muted/50">
                     <AlertTriangle className="h-4 w-4 text-muted-foreground" />
                    <AlertTitle className="text-sm font-medium">Autenticaci√≥n Requerida</AlertTitle>
                    <AlertDescription className="text-xs text-muted-foreground">
                        Inicia sesi√≥n para poder subir nuevos documentos.
                    </AlertDescription>
                </Alert>
            )}
            </CardContent>
        </Card>

        <Separator />

        <div className='space-y-4'>
             <h2 className="text-xl md:text-2xl font-semibold tracking-tight text-foreground flex items-center gap-2">
                 <List className="h-6 w-6" /> Documentos Gestionados
            </h2>
             {documentsError && (
                <Alert variant="destructive">
                     <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Error al Cargar Documentos</AlertTitle>
                    <AlertDescription>
                        {documentsError}
                        <Button variant="link" size="sm" onClick={() => fetchDocuments(true)} className="p-0 h-auto ml-2 text-destructive underline">Reintentar</Button>
                    </AlertDescription>
                </Alert>
             )}
             {isLoadingDocuments && documents.length === 0 && !documentsError && (
                <div className="space-y-2 pt-2 border rounded-lg p-4">
                    <Skeleton className="h-12 w-full rounded-md" />
                    <Skeleton className="h-12 w-full rounded-md" />
                    <Skeleton className="h-12 w-full rounded-md" />
                </div>
             )}
             {!isLoadingDocuments && documentsError == null && authHeadersForChildren && (
                <DocumentStatusList
                    documents={documents}
                    authHeaders={authHeadersForChildren}
                    onRetrySuccess={handleRetrySuccess}
                    fetchMore={fetchMore}
                    hasMore={hasMore}
                    refreshDocument={refreshDocument}
                    onDeleteSuccess={handleDeleteSuccess}
                    isLoading={isLoadingDocuments}
                />
             )}
             {!isLoadingDocuments && !authHeadersForChildren && !documentsError && (
                <div className="text-center py-10 border-2 border-dashed rounded-lg bg-muted/30">
                     <p className="text-muted-foreground text-sm">Inicia sesi√≥n para ver tus documentos.</p>
                </div>
             )}
        </div>
    </div>
  );
}
```

## File: `app\(app)\layout.tsx`
```tsx
// File: app/(app)/layout.tsx (CORREGIDO y CONFIRMADO)
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { AdminLayout } from '@/components/layout/AdminLayout';
import { useAuth } from '@/lib/hooks/useAuth';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading, signOut } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
  const incompleteSetupWarningShown = useRef(false);

  useEffect(() => {
    incompleteSetupWarningShown.current = false;
  }, [user?.userId]);

  useEffect(() => {
    if (bypassAuth) {
      console.warn("AppLayout: Auth check SKIPPED (Bypass).");
      return;
    }
    if (isLoading) {
      console.log("AppLayout: Waiting for auth state...");
      return;
    }
    if (!user) {
      console.log("AppLayout: No user found after loading, redirecting to /");
      router.replace('/');
      return;
    }

    if (user.isAdmin && !pathname.startsWith('/admin')) {
        console.log("AppLayout: Admin user detected outside /admin, redirecting to /admin");
        router.replace('/admin');
        return; 
    }
    if (!user.isAdmin && pathname.startsWith('/admin')) {
        console.log("AppLayout: Non-admin user detected in /admin, redirecting to /chat");
        router.replace('/chat'); 
        return; 
    }

    if (!user.isAdmin && !user.companyId) {
       if (!incompleteSetupWarningShown.current) {
          console.error(`AppLayout: User data is incomplete (CompanyID: ${user?.companyId}). Showing warning.`);
          toast.error("Configuraci√≥n de cuenta incompleta", { 
            description: "Falta el ID de la compa√±√≠a. Por favor, contacta al administrador.",
            duration: 10000, // Mantener el toast m√°s tiempo
           });
          incompleteSetupWarningShown.current = true;
       }
    } else if (user.companyId || user.isAdmin) { // Resetear si los datos son correctos
        incompleteSetupWarningShown.current = false;
    }

    console.log("AppLayout: Auth check passed for current route.");

  }, [isLoading, user, bypassAuth, router, pathname, signOut]);

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Cargando sesi√≥n...</p>
      </div>
    );
  }

   if (!user && !bypassAuth) {
        return (
          <div className="flex h-screen items-center justify-center bg-background">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="mt-4 text-muted-foreground">Redirigiendo...</p>
          </div>
        );
   }

  if (user?.isAdmin) {
      return <AdminLayout>{children}</AdminLayout>;
  }
  else if (user) {
      return (
         <div className="flex h-screen bg-secondary/30 dark:bg-muted/30 overflow-hidden">
          <ResizablePanelGroup direction="horizontal" className="h-full items-stretch">
              <ResizablePanel
                  collapsible collapsedSize={4} minSize={15} maxSize={25} defaultSize={18}
                  onCollapse={() => setIsSidebarCollapsed(true)} onExpand={() => setIsSidebarCollapsed(false)}
                  className={cn(
                      "transition-all duration-300 ease-in-out bg-background dark:bg-card",
                      isSidebarCollapsed ? "min-w-[60px] max-w-[60px]" : "min-w-[220px]"
                  )}
                  order={1}
              >
                  <Sidebar isCollapsed={isSidebarCollapsed} />
              </ResizablePanel>
              <ResizableHandle withHandle />
              <ResizablePanel defaultSize={82} minSize={30} order={2}>
                  <div className="flex h-full flex-col"> {/* Contenedor flex para Header y Main */}
                      <Header />
                      {/* Main debe tener overflow-y-auto y flex-1 */}
                      {/* El padding se aplica en las p√°ginas hijas (chat, knowledge, settings) */}
                      <main className="flex-1 bg-background overflow-y-auto">
                          {children}
                      </main>
                  </div>
              </ResizablePanel>
          </ResizablePanelGroup>
        </div>
      );
  }

  return null;
}
```

## File: `app\(app)\settings\page.tsx`
```tsx
// File: app/(app)/settings/page.tsx (CORREGIDO - A√±adido padding)
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/lib/hooks/useAuth';
import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { Loader2, Check } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';

export default function SettingsPage() {
    const { user, isLoading: isAuthLoading } = useAuth();
    const [name, setName] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const [hasChanged, setHasChanged] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        if (user) {
            setName(user.name || '');
            setHasChanged(false);
            setSaveSuccess(false);
        }
    }, [user]);

    const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        const newName = event.target.value;
        setName(newName);
        setHasChanged(newName !== (user?.name || ''));
        setSaveSuccess(false);
    };

    const handleSave = async () => {
        if (!hasChanged || !user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        console.log('Guardando cambios (simulado):', { name });
        try {
          await new Promise(resolve => setTimeout(resolve, 1200));
          toast.success("Perfil Actualizado", { description: "Tu nombre ha sido guardado." });
          setHasChanged(false); setSaveSuccess(true);
          // TODO: Actualizar user en AuthContext
        } catch (error) {
          console.error("Error al guardar perfil:", error);
          toast.error("Error al Guardar", { description: "No se pudo actualizar el perfil." });
          setSaveSuccess(false);
        } finally {
           setIsSaving(false);
        }
    };

    if (isAuthLoading) {
        return (
            // FLAG_LLM: A√±adir padding tambi√©n al skeleton wrapper
            <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
                 <Skeleton className="h-10 w-1/4 mb-6" />
                 <Skeleton className="h-64 w-full rounded-xl" />
                 <Skeleton className="h-48 w-full rounded-xl" />
            </div>
        )
    }

  return (
    // FLAG_LLM: A√±adido padding al contenedor principal (p-6 lg:p-8)
    <div className="p-6 lg:p-8 space-y-8 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold tracking-tight">Configuraci√≥n</h1>

      {/* Card para Perfil */}
      <Card>
        <CardHeader>
          <CardTitle>Perfil de Usuario</CardTitle>
          <CardDescription>Administra la informaci√≥n de tu cuenta personal.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
            <div className="grid sm:grid-cols-3 items-center gap-4">
                 <Label htmlFor="name" className="sm:text-right sm:mt-2">Nombre</Label>
                 <Input id="name" value={name} onChange={handleNameChange} disabled={isSaving} className="sm:col-span-2" placeholder="Tu nombre completo" />
            </div>
             <div className="grid sm:grid-cols-3 items-start gap-4">
                 <Label htmlFor="email" className="sm:text-right sm:mt-2">Correo electr√≥nico</Label>
                 <div className="sm:col-span-2 space-y-1">
                     <Input id="email" type="email" value={user?.email || ''} disabled />
                     <p className="text-xs text-muted-foreground">El correo electr√≥nico no se puede cambiar.</p>
                 </div>
            </div>
        </CardContent>
        <CardFooter className="border-t pt-6 justify-end">
            <Button onClick={handleSave} disabled={isSaving || !hasChanged || saveSuccess}>
                {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {saveSuccess && <Check className="mr-2 h-4 w-4" />}
                {isSaving ? "Guardando..." : saveSuccess ? "Guardado" : "Guardar Cambios"}
             </Button>
        </CardFooter>
      </Card>

      {/* Card para Configuraci√≥n de Empresa */}
       <Card>
        <CardHeader>
          <CardTitle>Configuraci√≥n de la Empresa</CardTitle>
          <CardDescription>Informaci√≥n relacionada con tu organizaci√≥n.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
            {user?.companyId ? (
                 <div className="grid sm:grid-cols-3 items-center gap-4">
                    <Label htmlFor="companyId" className="sm:text-right">ID de Empresa</Label>
                    <Input id="companyId" value={user.companyId} readOnly disabled className="sm:col-span-2 font-mono text-xs"/>
                 </div>
             ) : (
                <p className="text-sm text-muted-foreground italic">No hay informaci√≥n de empresa asociada a tu cuenta.</p>
             )}
             <p className="text-sm text-muted-foreground pt-4 border-t">
                Otras configuraciones de la empresa aparecer√°n aqu√≠ en futuras versiones.
             </p>
        </CardContent>
      </Card>

    </div>
  );
}
```

## File: `app\(auth)\layout.tsx`
```tsx
// File: app/(auth)/layout.tsx (MODIFICADO - Iteraci√≥n 5.3)
import React from 'react';
import Image from 'next/image';
import { APP_NAME } from '@/lib/constants';
import { BookOpen } from 'lucide-react'; // Usar el mismo icono que en landing

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Fondo gradiente m√°s sutil
    <div className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/30 p-4">
       {/* Logo consistente con landing */}
       <div className="mb-8 flex items-center space-x-2 text-primary">
         <BookOpen className="h-7 w-7" />
         <span className="text-3xl font-bold">{APP_NAME}</span>
       </div>
      {children}
    </div>
  );
}
```

## File: `app\(auth)\login\page.tsx`
```tsx
// File: app/(auth)/login/page.tsx (MODIFICADO - Iteraci√≥n 5.3)
import { LoginForm } from "@/components/auth/login-form";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { APP_NAME } from "@/lib/constants";
import Link from "next/link"; // Importar Link

export default function LoginPage() {
  return (
    // Card con sombra m√°s pronunciada y padding ajustado
    <Card className="w-full max-w-sm shadow-xl border-border/60">
      <CardHeader className="text-center space-y-1 pt-8 pb-6"> {/* Ajuste de padding */}
        <CardTitle className="text-2xl font-semibold tracking-tight">Iniciar Sesi√≥n</CardTitle> {/* Ajuste fuente */}
        <CardDescription>Accede a tu cuenta {APP_NAME}</CardDescription> {/* Nombre App */}
      </CardHeader>
      {/* Padding inferior en CardContent */}
      <CardContent className="pb-8 px-6"> {/* Padding horizontal tambi√©n */}
        <LoginForm />
         {/* Separador y enlace (si se a√±ade registro) */}
         {/* <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">
                      O continuar con
                  </span>
              </div>
          </div> */}
         {/* Placeholder para botones de SSO si se a√±aden */}
         {/* <div className="grid gap-2"> ... </div> */}

        {/* Enlace a Registro (si existe) */}
        {/* <p className="mt-6 text-center text-sm text-muted-foreground">
            ¬øNo tienes cuenta?{' '}
            <Link href="/register" className="font-medium text-primary hover:underline underline-offset-4">
                Reg√≠strate aqu√≠
            </Link>
        </p> */}
      </CardContent>
    </Card>
  );
}
```

## File: `app\about\page.tsx`
```tsx
// File: app/about/tsx (MODIFICADO - Iteraci√≥n 2: Reestructuraci√≥n y Contenido)
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { ArrowLeft, Building, Users, Target, Eye, HeartHandshake, Zap, Lightbulb, Linkedin } from 'lucide-react'; // Importar iconos
import Link from 'next/link';
import { cn } from '@/lib/utils';

// Informaci√≥n del Fundador
const founder = {
    name: "Mark Romero",
    alias: "MarkDev",
    role: "Fundador y Desarrollador Principal",
    bio: "Apasionado por la inteligencia artificial y la optimizaci√≥n de procesos empresariales. Con experiencia en desarrollo de software full-stack y soluciones de IA, Mark cre√≥ Atenex para resolver el desaf√≠o del acceso al conocimiento fragmentado en las organizaciones.",
    imageUrl: null, // Reemplazar con URL si hay foto profesional
    linkedinUrl: null, // Reemplazar con URL de LinkedIn si existe
};

// Valores de la empresa
const coreValues = [
    { icon: HeartHandshake, title: "Integridad", description: "Mantenemos los m√°s altos est√°ndares √©ticos en todo lo que hacemos." },
    { icon: Lightbulb, title: "Innovaci√≥n", description: "Buscamos continuamente nuevas y mejores formas de resolver problemas." },
    { icon: Zap, title: "√âxito del Cliente", description: "Estamos dedicados a ayudar a nuestros clientes a alcanzar sus objetivos." },
    { icon: Users, title: "Colaboraci√≥n", description: "Creemos en el poder de trabajar juntos para lograr resultados excepcionales." },
];

export default function AboutPage() {
    const router = useRouter();

    // Header consistente con otras p√°ginas p√∫blicas (Asumiendo que existe /layout.tsx global para estas)
    // Si no, se replicar√≠a aqu√≠ como en contact.tsx

  return (
    // Contenedor principal con padding y layout de una columna
    <div className="bg-gradient-to-b from-background via-background to-muted/10 min-h-screen">
        {/* Contenido de la p√°gina */}
        <div className="container mx-auto max-w-4xl px-4 py-12 md:py-20 space-y-12 md:space-y-16">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>

             {/* --- Hero Section --- */}
            <section className="text-center border-b pb-12 md:pb-16">
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-foreground mb-4">
                    Nuestra Pasi√≥n: Conectar Empresas con su Propio Conocimiento
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
                    En {APP_NAME}, creemos que el activo m√°s valioso de una organizaci√≥n es su conocimiento colectivo. Nuestra misi√≥n es hacerlo accesible, √∫til e instant√°neo para todos.
                </p>
                 {/* Placeholder para imagen hero */}
                 {/* <div className="mt-8 h-48 bg-muted rounded-lg flex items-center justify-center text-muted-foreground italic">
                    [Imagen Representativa: Innovaci√≥n / Equipo / Conexi√≥n]
                 </div> */}
            </section>
            {/* --- FIN Hero Section --- */}


            {/* --- Historia / Origen --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-8">El Nacimiento de {APP_NAME}</h2>
                <div className="prose prose-lg dark:prose-invert max-w-none mx-auto text-foreground/90 leading-relaxed text-center">
                    <p>
                        Fundada por <span className='font-semibold'>{founder.name} ({founder.alias})</span>, {APP_NAME} naci√≥ de la frustraci√≥n com√∫n en muchas empresas: informaci√≥n vital dispersa en documentos, correos y sistemas inconexos, haciendo casi imposible encontrar respuestas r√°pidas y fiables.
                    </p>
                    <p>
                        Viendo el potencial transformador de la inteligencia artificial, la visi√≥n fue clara: crear una herramienta intuitiva que permitiera a cualquier miembro del equipo 'conversar' con la base de conocimiento de su organizaci√≥n, obteniendo informaci√≥n precisa y contextualizada al instante. As√≠ naci√≥ Atenex.
                    </p>
                </div>
            </section>
            {/* --- FIN Historia --- */}

            <Separator className="my-8 md:my-12" />

             {/* --- Misi√≥n y Visi√≥n --- */}
             <section className="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div className="text-center md:text-left">
                    <Target className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Misi√≥n</h3>
                    <p className="text-muted-foreground">
                        Empoderar a las organizaciones con acceso fluido a su conocimiento colectivo, optimizando la gesti√≥n de la informaci√≥n, facilitando decisiones informadas y mejorando la productividad del equipo a trav√©s de soluciones innovadoras de IA.
                    </p>
                </div>
                 <div className="text-center md:text-left">
                    <Eye className="h-10 w-10 text-primary mx-auto md:mx-0 mb-3" />
                    <h3 className="text-2xl font-semibold mb-2">Nuestra Visi√≥n</h3>
                    <p className="text-muted-foreground">
                        Ser la plataforma l√≠der de consulta de conocimiento inteligente, transformando c√≥mo las empresas aprovechan su experiencia interna y fomentando una cultura de aprendizaje y crecimiento continuos.
                    </p>
                </div>
            </section>
            {/* --- FIN Misi√≥n y Visi√≥n --- */}

            <Separator className="my-8 md:my-12" />

            {/* --- Valores --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Nuestros Valores Fundamentales</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                    {coreValues.map((value) => (
                        <div key={value.title} className="flex flex-col items-center text-center p-4 border rounded-lg bg-card/50 shadow-sm">
                            <value.icon className="h-8 w-8 text-primary mb-3" />
                            <h4 className="text-md font-semibold mb-1">{value.title}</h4>
                            <p className="text-sm text-muted-foreground">{value.description}</p>
                        </div>
                    ))}
                </div>
            </section>
            {/* --- FIN Valores --- */}

             <Separator className="my-8 md:my-12" />

            {/* --- Equipo --- */}
            <section>
                <h2 className="text-3xl font-bold tracking-tight text-center mb-10">Conoce al Fundador</h2>
                <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 bg-card p-8 rounded-lg border shadow-sm">
                    <Avatar className="h-32 w-32 border-4 border-primary/20">
                        {founder.imageUrl ? (
                            <AvatarImage src={founder.imageUrl} alt={founder.name} />
                        ) : (
                            <AvatarFallback className='text-4xl bg-muted'>{founder.name.charAt(0)}</AvatarFallback>
                        )}
                    </Avatar>
                    <div className="text-center md:text-left">
                        <h3 className="text-2xl font-semibold text-foreground">{founder.name}</h3>
                        <p className="text-md text-primary font-medium mb-2">{founder.role}</p>
                        <p className="text-muted-foreground mb-4 max-w-xl">{founder.bio}</p>
                        {founder.linkedinUrl && (
                             <a href={founder.linkedinUrl} target="_blank" rel="noopener noreferrer" className={cn(buttonVariants({ variant: 'outline', size: 'sm' }), "mt-2")}>
                                <Linkedin className="mr-2 h-4 w-4" /> Conectar en LinkedIn
                             </a>
                        )}
                    </div>
                </div>
                 {/* Placeholder para m√°s miembros / CTA de unirse */}
                {/*
                <div className="mt-12 text-center">
                     <p className="text-muted-foreground">¬°Estamos creciendo! Buscamos talento apasionado.</p>
                     <Button variant="link" className="mt-2">Ver Oportunidades</Button>
                </div>
                */}
            </section>
            {/* --- FIN Equipo --- */}

        </div>
        {/* Footer Consistente (Asumiendo que est√° en el Root Layout) */}
    </div>
  );
}
```

## File: `app\contact\page.tsx`
```tsx
// File: app/contact/page.tsx (MODIFICADO - Iteraci√≥n 3: Formulario y Estilo)
"use client";

import React, { useState } from 'react';
import { Button, buttonVariants } from '@/components/ui/button'; // Importar buttonVariants
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Mail, Phone, Linkedin, Loader2, Building, MapPin, Send, Info, Check } from 'lucide-react'; // A√±adidos Send, Info, Check
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import Link from 'next/link';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // Importar Select
import { Checkbox } from "@/components/ui/checkbox"; // Importar Checkbox
import AtenexLogoIcon from '@/components/icons/atenex-logo'; // Importar logo

// Opciones para el dropdown de motivo
const contactReasons = [
    "Solicitar una Demo",
    "Informaci√≥n de Precios",
    "Consulta T√©cnica",
    "Soporte",
    "Colaboraci√≥n / Partnership",
    "Otro",
];

export default function ContactPage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Header consistente con otras p√°ginas p√∫blicas
  const renderHeader = () => (
    <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        <div className="container flex items-center justify-between h-16 px-4 md:px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm"
            aria-label={`${APP_NAME} - Inicio`}
          >
             {/* Usar AtenexLogoIcon aqu√≠ tambi√©n */}
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/">Inicio</LinkButton>
            <LinkButton href="/about">Nosotros</LinkButton>
            <LinkButton href="/contact" isActive={true}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? (
                    <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button>
                ) : isAuthenticated ? (
                    <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button>
                ) : (
                    <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px]"> Acceder </Button>
                )}
            </div>
          </nav>
        </div>
    </header>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-muted/10 dark:to-muted/10">
      {renderHeader()}

      {/* Main Content Area */}
      <main className="container mx-auto px-4 py-12 md:py-20 flex-1">
        {/* T√≠tulo y descripci√≥n Actualizados */}
        <section className="text-center mb-12 md:mb-16">
          <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold tracking-tight text-foreground mb-4">
            Hablemos
          </h1>
          <p className="text-lg sm:text-xl text-muted-foreground max-w-2xl mx-auto">
            Completa el formulario o utiliza nuestros datos de contacto. Estamos listos para ayudarte a implementar Atenex en tu organizaci√≥n.
          </p>
        </section>

        {/* Grid para Formulario e Informaci√≥n */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start max-w-6xl mx-auto">

          {/* Columna Izquierda: Formulario Actualizado */}
          <Card className="lg:col-span-3 shadow-lg border border-border/60"> {/* Sombra m√°s pronunciada */}
            <CardHeader>
              <CardTitle>Env√≠anos tu Consulta</CardTitle>
              <CardDescription>
                Nos pondremos en contacto contigo lo antes posible.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {/* Componente de formulario mejorado */}
              <ContactForm />
            </CardContent>
          </Card>

          {/* Columna Derecha: Informaci√≥n Adicional Actualizada */}
          <div className="lg:col-span-2 space-y-6">
            <Card className="shadow-md border">
              <CardHeader>
                <CardTitle className="text-lg">Informaci√≥n Directa</CardTitle>
                 <CardDescription>Otras formas de contactarnos.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4"> {/* Aumentar espaciado */}
                 {/* Email Actualizado */}
                 <ContactInfoItem Icon={Mail} label="Email Principal:" href="mailto:mark.romero.dev@gmail.com" text="mark.romero.dev@gmail.com" />
                 {/* LinkedIn Placeholder */}
                 <ContactInfoItem Icon={Linkedin} label="LinkedIn:" href="#" text="MarkDev (Pr√≥ximamente)" isPlaceholder={true} />
                 {/* Tel√©fono Placeholder */}
                 {/* <ContactInfoItem Icon={Phone} label="Tel√©fono:" href="tel:+15551234567" text="+1 (555) 123-4567" /> */}
                 {/* WhatsApp Placeholder */}
                 {/* <ContactInfoItem Icon={MessageCircle} label="WhatsApp:" href="https://wa.me/15551234567" text="Chatea por WhatsApp" targetBlank={true}/> */}
                 <Separator className='my-4'/>
                 {/* Oficina Placeholder */}
                 <ContactInfoItem Icon={MapPin} label="Ubicaci√≥n:" text="Desarrollo Remoto" />
                 <Separator className='my-4'/>
                 {/* Nota sobre tiempo de respuesta */}
                 <div className="flex items-center gap-2 text-xs text-muted-foreground pt-2">
                    <Info className="h-3.5 w-3.5 flex-shrink-0" />
                    <span>Normalmente respondemos en 24 horas h√°biles.</span>
                 </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>

       {/* Footer Consistente */}
       <footer className="bg-muted/20 border-t border-border/60 py-6 mt-16">
         <div className="container text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
           <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
               <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
               <span className="hidden sm:inline-block opacity-50">|</span>
               <span className='opacity-80'>Desarrollado por MarkDev</span>
           </div>
           <div className="flex gap-3">
              <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
              <span className='opacity-50'>|</span>
              <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
           </div>
         </div>
       </footer>
    </div>
  );
}

// Componente LinkButton (Header Navigation)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return (
    <Link
        href={href}
        className={cn(
            buttonVariants({ variant: 'ghost' }),
            "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
            isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground"
        )}
     >
       {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />}
      {children}
    </Link>
  );
}


// Formulario de contacto Actualizado
function ContactForm() {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  // Aqu√≠ ir√≠a la integraci√≥n con react-hook-form y zod para validaci√≥n real

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      setIsSubmitting(true);
      setSubmitSuccess(false);
      console.log("Simulando env√≠o de formulario...");

      // Simular llamada API
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Simular √©xito
      toast.success("Consulta Enviada", { description: "Gracias por contactarnos. Te responderemos pronto."});
      setSubmitSuccess(true);
      // Aqu√≠ se resetear√≠a el formulario con react-hook-form form.reset()

      // Simular fallo (descomentar para probar)
      // toast.error("Error al Enviar", { description: "Hubo un problema al enviar tu consulta. Int√©ntalo de nuevo." });

      setIsSubmitting(false);

      // Opcional: Resetear el estado de √©xito despu√©s de un tiempo
      // setTimeout(() => setSubmitSuccess(false), 4000);
  }

  return (
      <form onSubmit={handleSubmit} className="space-y-5"> {/* Aumentar espaciado */}
         {/* Fila Nombre y Correo */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nombre Completo <span className="text-destructive">*</span></Label>
              <Input id="name" required placeholder="Tu Nombre" disabled={isSubmitting} />
              {/* Aqu√≠ ir√≠an los mensajes de error de validaci√≥n */}
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="email">Correo Electr√≥nico <span className="text-destructive">*</span></Label>
              <Input id="email" type="email" required placeholder="tu@empresa.com" disabled={isSubmitting} />
            </div>
        </div>
         {/* Fila Empresa y Tel√©fono */}
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Empresa</Label>
                <Input id="companyName" placeholder="Nombre de tu Organizaci√≥n" disabled={isSubmitting} />
            </div>
            <div className="space-y-1.5">
                <Label htmlFor="phone">Tel√©fono (Opcional)</Label>
                <Input id="phone" type="tel" placeholder="+1 (555) 123-4567" disabled={isSubmitting} />
            </div>
        </div>
         {/* Motivo de Contacto */}
        <div className="space-y-1.5">
          <Label htmlFor="reason">Motivo de Contacto <span className="text-destructive">*</span></Label>
          <Select name="reason" required disabled={isSubmitting}>
              <SelectTrigger id="reason" className="w-full">
                <SelectValue placeholder="Selecciona un motivo..." />
              </SelectTrigger>
              <SelectContent>
                {contactReasons.map(reason => (
                     <SelectItem key={reason} value={reason}>{reason}</SelectItem>
                ))}
              </SelectContent>
          </Select>
        </div>
         {/* Mensaje */}
        <div className="space-y-1.5">
          <Label htmlFor="message">Mensaje <span className="text-destructive">*</span></Label>
          <Textarea
            id="message"
            required
            placeholder="Cu√©ntanos c√≥mo podemos ayudarte..."
            className="min-h-[120px]"
            disabled={isSubmitting}
          />
        </div>
         {/* Checkbox Privacidad */}
         <div className="flex items-center space-x-2">
            <Checkbox id="privacy" required disabled={isSubmitting} />
            <Label htmlFor="privacy" className="text-xs text-muted-foreground font-normal">
                 He le√≠do y acepto la <Link href="/privacy" className="underline hover:text-primary" target="_blank">Pol√≠tica de Privacidad</Link>. <span className="text-destructive">*</span>
            </Label>
         </div>
         {/* Bot√≥n Enviar */}
        <Button type="submit" className="w-full sm:w-auto" disabled={isSubmitting || submitSuccess}>
           {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
           {submitSuccess && <Check className="mr-2 h-4 w-4" />}
           {isSubmitting ? 'Enviando...' : submitSuccess ? 'Enviado Correctamente' : 'Enviar Consulta'}
        </Button>
      </form>
  );
}

// Componente ContactInfoItem Actualizado
function ContactInfoItem({ Icon, label, href, text, targetBlank = false, isPlaceholder = false }: {
    Icon: React.ComponentType<{ className?: string }>,
    label: string,
    href?: string,
    text: string,
    targetBlank?: boolean,
    isPlaceholder?: boolean // Prop para indicar si es placeholder
}) {
    const content = (
        <>
            <Icon className={cn("h-4 w-4 flex-shrink-0", isPlaceholder ? "text-muted-foreground/60" : "text-primary")} />
            <div className="flex flex-col flex-1 min-w-0">
                <span className={cn("font-medium", isPlaceholder ? "text-muted-foreground/80" : "text-foreground/90")}>{label}</span>
                 <span className={cn("text-muted-foreground break-words", isPlaceholder && "italic")}>{text}</span>
             </div>
        </>
    );
    const containerClasses = cn("flex items-start space-x-3 text-sm", isPlaceholder && "opacity-70"); // Usa items-start y gap
    const linkClasses = "inline-flex items-start gap-3 group hover:opacity-80 transition-opacity w-full";

    return (
        <div className={containerClasses}>
            {href && !isPlaceholder ? (
                 <a
                    href={href}
                    className={cn(linkClasses)}
                    target={targetBlank ? "_blank" : undefined}
                    rel={targetBlank ? "noopener noreferrer" : undefined}
                >
                    {content}
                 </a>
            ) : (
                <div className="inline-flex items-start gap-3 w-full">{content}</div>
            )}
        </div>
    );
}
```

## File: `app\globals.css`
```css
/* File: atenex-frontend/app/globals.css */

/* 1. Importa Tailwind v4 */
@import "tailwindcss";

/* 2. Define variables base FUERA del @theme */
/* Variables para el tema claro (:root) - Profesional Blanco */
:root {
    --radius: 0.6rem;
    /* Blanco casi puro con ligera tonalidad fr√≠a */
    --background: oklch(0.995 0.005 240);
    /* Negro/gris muy oscuro para texto principal */
    --foreground: oklch(0.15 0.015 240);
    /* Blanco puro para tarjetas */
    --card: oklch(1 0 0);
    --card-foreground: var(--foreground);
    /* Popover usa fondo de tarjeta */
    --popover: var(--card);
    --popover-foreground: var(--card-foreground);
    /* Azul corporativo principal (ej. un azul medio/oscuro) */
    --primary: oklch(0.5 0.18 255); /* Ajustado a un azul m√°s est√°ndar */
    /* Blanco para texto sobre primario */
    --primary-foreground: oklch(0.99 0.01 255);
    /* Gris muy claro para secundario */
    --secondary: oklch(0.97 0.01 240);
    /* Gris medio para texto secundario */
    --secondary-foreground: oklch(0.30 0.02 240);
    /* Muted usa secundario */
    --muted: var(--secondary);
    /* Gris m√°s claro para texto muted */
    --muted-foreground: oklch(0.50 0.015 240);
    /* Gris a√∫n m√°s claro para acento */
    --accent: oklch(0.95 0.015 240);
    /* Texto oscuro para acento */
    --accent-foreground: oklch(0.20 0.02 240);
    /* Rojo est√°ndar para destructivo */
    --destructive: oklch(0.6 0.2 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Gris claro para bordes */
    --border: oklch(0.92 0.01 240);
    /* Gris un poco m√°s oscuro para inputs */
    --input: oklch(0.94 0.01 240);
    /* Anillo con color primario semi-transparente */
    --ring: oklch(0.5 0.18 255 / 0.5);
    /* Charts - Pueden mantenerse o simplificarse si no se usan */
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    /* Sidebar */
    --sidebar: var(--card);
    --sidebar-foreground: var(--foreground);
    --sidebar-primary: var(--primary);
    --sidebar-primary-foreground: var(--primary-foreground);
    --sidebar-accent: var(--accent);
    --sidebar-accent-foreground: var(--accent-foreground);
    --sidebar-border: var(--border);
    --sidebar-ring: var(--ring);
}

/* Variables para el tema oscuro (.dark) - Azul Oscuro Elegante */
.dark {
    /* Fondo azul muy oscuro, casi negro */
    --background: oklch(0.12 0.02 235);
    /* Texto gris muy claro, ligeramente azulado */
    --foreground: oklch(0.94 0.008 235);
    /* Tarjeta un poco m√°s clara que el fondo */
    --card: oklch(0.16 0.018 235);
    --card-foreground: var(--foreground);
    /* Popover m√°s oscuro que la tarjeta */
    --popover: oklch(0.10 0.015 235);
    --popover-foreground: var(--foreground);
    /* Primario: Azul brillante pero no ne√≥n */
    --primary: oklch(0.75 0.12 225);
    /* Texto oscuro para contraste sobre primario */
    --primary-foreground: oklch(0.08 0.03 225);
    /* Secundario: Gris azulado oscuro */
    --secondary: oklch(0.22 0.02 235);
    /* Texto claro para secundario */
    --secondary-foreground: oklch(0.85 0.01 235);
    --muted: var(--secondary);
    /* Muted foreground m√°s sutil */
    --muted-foreground: oklch(0.60 0.015 235);
    /* Accent m√°s oscuro */
    --accent: oklch(0.28 0.025 235);
    /* Texto muy claro para accent */
    --accent-foreground: oklch(0.98 0.008 235);
    /* Destructive: Rojo/Naranja oscuro */
    --destructive: oklch(0.65 0.18 15);
    --destructive-foreground: oklch(0.99 0.01 15);
    /* Borde oscuro sutil */
    --border: oklch(0.25 0.02 235);
    /* Input oscuro */
    --input: oklch(0.26 0.022 235);
    /* Anillo azul primario semi-transparente */
    --ring: oklch(0.75 0.12 225 / 0.5);
    /* Charts */
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    /* Sidebar */
     --sidebar: oklch(0.15 0.015 235); /* Sidebar ligeramente diferente */
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}


/* --- TEMA: Zinc (Perla / Gris Oscuro) --- */
.zinc {
    /* Fondo: Gris Zinc muy oscuro */
    --background: oklch(0.15 0.01 220);
    /* Texto: Gris muy claro */
    --foreground: oklch(0.95 0.005 220);
    /* Tarjeta: Ligeramente m√°s clara */
    --card: oklch(0.19 0.012 220);
    --card-foreground: var(--foreground);
    /* Popover: M√°s oscuro */
    --popover: oklch(0.12 0.008 220);
    --popover-foreground: var(--foreground);
    /* Primario: Azul gris√°ceo claro */
    --primary: oklch(0.75 0.06 220);
    /* Texto primario: Oscuro */
    --primary-foreground: oklch(0.1 0.01 220);
    /* Secundario: Gris zinc medio */
    --secondary: oklch(0.25 0.015 220);
    /* Texto secundario: Claro */
    --secondary-foreground: oklch(0.88 0.006 220);
    --muted: var(--secondary);
    --muted-foreground: oklch(0.6 0.01 220);
    /* Accent: M√°s oscuro */
    --accent: oklch(0.3 0.02 220);
    --accent-foreground: oklch(0.98 0.005 220);
    /* Destructive: Rojo */
    --destructive: oklch(0.6 0.15 20);
    --destructive-foreground: oklch(0.99 0.01 20);
    /* Borde: Sutil */
    --border: oklch(0.25 0.015 220);
    /* Input: Un poco m√°s claro */
    --input: oklch(0.27 0.018 220);
    /* Ring: Azul gris√°ceo */
    --ring: oklch(0.75 0.06 220 / 0.5);
    /* Sidebar */
     --sidebar: oklch(0.17 0.011 220);
     --sidebar-foreground: var(--foreground);
     --sidebar-primary: var(--primary);
     --sidebar-primary-foreground: var(--primary-foreground);
     --sidebar-accent: var(--accent);
     --sidebar-accent-foreground: var(--accent-foreground);
     --sidebar-border: var(--border);
     --sidebar-ring: var(--ring);
}
/* --- FIN TEMAS MANTENIDOS --- */

/* 4. Aplica overrides m√≠nimos en la capa base */
@layer base {
    body {
        background-color: var(--background);
        color: var(--foreground);
        /* Aplicar antialiasing para mejor legibilidad */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* Asegurar que los elementos deshabilitados tengan cursor not-allowed */
    [disabled] {
        cursor: not-allowed !important;
    }

    /* Mejoras espec√≠ficas para Tooltip Content para evitar solapamientos */
    [data-slot="tooltip-content"] {
        /* z-index: 60 !important; ya no es necesario con la nueva estructura */
    }

    /* Keyframes para animaci√≥n fade-in */
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
      /* Permite retraso opcional con una variable CSS */
      animation-delay: var(--animation-delay, 0s);
    }

}

/* Estilo para que ScrollArea funcione correctamente en flexbox */
[data-radix-scroll-area-viewport] > div {
  min-width: 100%;
  display: block; /* MODIFICADO: de table a block */
}

/* Estilo para el esqueleto de mensaje de asistente */
.skeleton-thinking {
  display: flex;
  align-items: flex-start; /* Cambiado a flex-start para alinear √≠cono y texto */
  gap: 0.75rem; /* Equivalente a space-x-3 */
  width: 100%;
  padding-right: 2.5rem; /* Equivalente a pr-10 */
  padding-top: 1rem; /* Equivalente a pt-4 */
}

.skeleton-thinking-avatar {
  height: 2rem; /* h-8 */
  width: 2rem; /* w-8 */
  border-radius: 9999px; /* rounded-full */
  flex-shrink: 0;
  background-color: hsl(var(--primary) / 0.1); /* bg-primary/10 */
}

.skeleton-thinking-text {
  flex: 1;
  padding-top: 0.375rem; /* pt-1.5 */
  display: flex;
  flex-direction: column;
  gap: 0.5rem; /* space-y-2 */
}

.skeleton-thinking-line {
  height: 0.875rem; /* h-3.5 */
  border-radius: 0.375rem; /* rounded */
  background-color: hsl(var(--accent)); /* Fondo del Skeleton */
}

.skeleton-thinking-line-short {
  width: 4rem; /* w-16 */
}
```

## File: `app\help\page.tsx`
```tsx
// File: app/help/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, BookText, Mail, Phone } from 'lucide-react'; // Iconos

export default function HelpPage() {
  const router = useRouter();

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-8 space-y-8">
       {/* Bot√≥n volver mejorado */}
        <Button variant="ghost" onClick={() => router.push('/chat')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la Aplicaci√≥n
        </Button>
      {/* T√≠tulo principal */}
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-foreground">Ayuda y Soporte</h1>

      <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <BookText className="h-5 w-5 text-primary"/> Documentaci√≥n
          </CardTitle>
          <CardDescription>Recursos y gu√≠as para usar Atenex.</CardDescription>
        </CardHeader>
        <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
          <p>
            Encuentra gu√≠as detalladas y respuestas a preguntas frecuentes sobre c√≥mo utilizar {APP_NAME}.
            Visita nuestra <a href="https://docs.atenex.com" target="_blank" rel="noopener noreferrer" className="font-medium text-primary underline hover:text-primary/80">documentaci√≥n oficial</a> para m√°s informaci√≥n.
          </p>
        </CardContent>
      </Card>

       <Card className="border shadow-sm">
        <CardHeader>
          <CardTitle className='flex items-center gap-2'>
             <Mail className="h-5 w-5 text-primary"/> Contactar con Soporte
          </CardTitle>
           <CardDescription>Si necesitas asistencia adicional.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3 text-sm"> {/* Tama√±o de texto base */}
           <div className="flex items-center gap-2">
              <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Email:</span>
              <a href="mailto:soporte@atenex.com" className="text-primary underline hover:text-primary/80">soporte@atenex.com</a>
           </div>
           <div className="flex items-center gap-2">
              <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <span className='font-medium'>Tel√©fono:</span>
               <a href="tel:+34123456789" className="text-primary underline hover:text-primary/80">+34 123 456 789</a>
           </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Definici√≥n local de APP_NAME si no est√° importado globalmente
const APP_NAME = "Atenex";
```

## File: `app\layout.tsx`
```tsx
// File: app/layout.tsx (CORREGIDO - Sin cabecera duplicada)
// Purpose: Root layout, sets up global providers (Theme, Auth) and Toaster.
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // Import global styles
// Quitamos import de AtenexLogo aqu√≠
import { cn } from "@/lib/utils";
import { ThemeProvider } from "@/components/theme-provider";
import { AuthProvider } from "@/lib/hooks/useAuth";
import { Toaster } from "@/components/ui/sonner";

// Setup Inter font
const inter = Inter({ subsets: ["latin"], variable: "--font-sans" });

// Metadata for the application
export const metadata: Metadata = {
  title: "Atenex - AI Knowledge Assistant",
  description: "Query your enterprise knowledge base using natural language with Atenex.",
  // A√±adir icono usando el logo SVG (requiere ponerlo en /public o /app)
  // icons: {
  //   icon: '/favicon.svg', // O la ruta a tu logo SVG
  // },
};

// Quitamos APP_NAME si no se usa aqu√≠ directamente
// const APP_NAME = "Atenex";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased",
          inter.variable
        )}
      >
        <AuthProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* ELIMINADA la <header> de aqu√≠ */}
            {/* Renderiza directamente el contenido de la p√°gina/layout anidado */}
            {children}
            {/* Toaster global */}
            <Toaster richColors position="top-right" closeButton />
          </ThemeProvider>
        </AuthProvider>
      </body>
    </html>
  );
}
```

## File: `app\page.tsx`
```tsx
// File: app/page.tsx
"use client";

import React from 'react';
import { Button, buttonVariants } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { APP_NAME } from '@/lib/constants';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils';
import {
    Loader2, Home as HomeIcon, Info, Mail, Search, Library, Zap, ChevronRight,
    UploadCloud, BrainCircuit, MessageSquare, CheckCircle, GraduationCap, HelpCircle, TrendingUp, // C√≥mo Funciona
    Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale // Casos Uso y Seguridad
} from 'lucide-react';
import Link from 'next/link';
import AtenexLogoIcon from '@/components/icons/atenex-logo';
import { Separator } from '@/components/ui/separator'; // Importar Separator

// Mapeo de iconos extendido
const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  Search, Library, Zap, HomeIcon, Info, Mail, UploadCloud, BrainCircuit, MessageSquare,
  CheckCircle, GraduationCap, HelpCircle, TrendingUp, Briefcase, FileLock, ShieldCheck, Settings, Lightbulb, Scale
};

// Empresas Placeholder para Social Proof
const trustedLogos = [
    { name: "Empresas Innovadoras", logo: null }, // Usaremos texto como placeholder
    { name: "Consultora Global", logo: null },
    { name: "Startup Tecnol√≥gica", logo: null },
    { name: "Sector Financiero", logo: null },
    { name: "Manufactura Avanzada", logo: null },
];

// Pasos C√≥mo Funciona
const howItWorksSteps = [
    { icon: UploadCloud, title: "1. Carga Segura", description: "Sube documentos y datos de m√∫ltiples formatos de forma segura." },
    { icon: BrainCircuit, title: "2. Procesamiento IA", description: "Atenex indexa y comprende sem√°nticamente el contenido." },
    { icon: MessageSquare, title: "3. Consulta Natural", description: "Haz preguntas como hablar√≠as con un experto humano." },
    { icon: CheckCircle, title: "4. Respuesta Precisa", description: "Recibe respuestas directas con las fuentes originales verificadas." },
];

// Casos de Uso
const useCases = [
  { icon: GraduationCap, title: "Onboarding y Formaci√≥n", description: "Acelera la integraci√≥n de nuevos empleados d√°ndoles acceso instant√°neo a pol√≠ticas, gu√≠as y documentaci√≥n relevante." },
  { icon: HelpCircle, title: "Soporte Interno (TI/RRHH)", description: "Responde preguntas frecuentes de forma autom√°tica sobre procesos internos, beneficios o soporte t√©cnico." },
  { icon: TrendingUp, title: "Ventas y Marketing", description: "Accede r√°pidamente a informaci√≥n de producto, estudios de caso y argumentarios de venta actualizados." },
  { icon: Lightbulb, title: "I+D y Producto", description: "Encuentra investigaciones pasadas, especificaciones t√©cnicas y feedback de usuarios para innovar m√°s r√°pido." },
  { icon: Scale, title: "Cumplimiento y Legal", description: "Localiza f√°cilmente pol√≠ticas, regulaciones y documentaci√≥n contractual espec√≠fica." },
];

// Puntos de Seguridad
const securityPoints = [
    { icon: ShieldCheck, title: "Seguridad de Datos", description: "Protegemos tu informaci√≥n con encriptaci√≥n en tr√°nsito y en reposo, y las mejores pr√°cticas de seguridad cloud." },
    { icon: FileLock, title: "Privacidad Garantizada", description: "Tu conocimiento es tuyo. Nunca usamos tus datos para entrenar modelos de IA p√∫blicos." },
    // { icon: Settings, title: "Control de Acceso", description: "Gestiona permisos para asegurar que solo el personal autorizado acceda a informaci√≥n sensible (Pr√≥ximamente)." },
];


export default function HomePage() {
  const router = useRouter();
  const { user, isLoading: isAuthLoading } = useAuth();
  const isAuthenticated = !isAuthLoading && !!user;

  // Decide el texto y la acci√≥n del CTA principal (Mantenemos "Comenzar Ahora" por simplicidad, podr√≠a ser "Solicitar Demo")
  const mainCtaText = isAuthenticated ? 'Ir a la App' : 'Comenzar Ahora';
  const mainCtaAction = () => {
    if (isAuthenticated) {
        router.push('/chat');
    } else {
        router.push('/login');
    }
  };


  return (
    <div className="relative flex flex-col min-h-screen bg-gradient-to-b from-background via-background to-secondary/10 dark:to-muted/10">
      {/* --- Header --- */}
      <header className="sticky top-0 z-50 w-full bg-background/90 backdrop-blur-lg border-b border-border/60">
        {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el header */}
        <div className="container mx-auto flex items-center justify-between h-16 px-4 md:px-6">
          <Link href="/" className="flex items-center gap-2 text-xl font-semibold text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm" aria-label={`${APP_NAME} - Inicio`}>
             <AtenexLogoIcon className="h-7 w-auto" />
            <span className='font-bold'>{APP_NAME}</span>
          </Link>
          <nav className="flex items-center space-x-1 sm:space-x-2">
            <LinkButton href="/" Icon={HomeIcon} isActive={true}>Inicio</LinkButton>
            <LinkButton href="/about" Icon={Info}>Nosotros</LinkButton>
            <LinkButton href="/contact" Icon={Mail}>Contacto</LinkButton>
            <div className="pl-2 sm:pl-4">
                {isAuthLoading ? ( <Button variant="ghost" disabled={true} size="sm" className="w-[95px]"> <Loader2 className="h-4 w-4 animate-spin" /> </Button> )
                 : isAuthenticated ? ( <Button variant="default" onClick={() => router.push('/chat')} size="sm" className="w-[95px] shadow-sm"> Ir a la App </Button> )
                 : ( <Button variant="outline" onClick={() => router.push('/login')} size="sm" className="w-[95px] transition-colors duration-150 hover:bg-accent hover:text-accent-foreground focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"> Acceder </Button> )}
            </div>
          </nav>
        </div>
      </header>

      {/* --- Contenido Principal --- */}
      <main className="flex-1 flex flex-col items-center text-center animate-fade-in opacity-0 [--animation-delay:200ms]" style={{animationFillMode: 'forwards'}}>

         {/* --- Hero Section --- */}
         <section className="w-full pt-16 pb-16 md:pt-24 md:pb-20 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido hero */}
            <div className="container mx-auto max-w-4xl">
                <div className="mb-8 flex justify-center">
                    <AtenexLogoIcon className="h-24 w-auto text-primary drop-shadow-lg" />
                </div>
                <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tighter text-foreground mb-6 leading-tight">
                    Desbloquea el Conocimiento Oculto en tu Empresa con <span className="text-primary">{APP_NAME}</span>
                </h1>
                <h2 className="text-xl sm:text-2xl text-muted-foreground mb-10 max-w-3xl mx-auto">
                    La IA que conecta a tu equipo con la informaci√≥n crucial de tus documentos, al instante.
                </h2>
                <p className="text-lg sm:text-xl text-muted-foreground mb-10 max-w-2xl mx-auto">
                    Haz preguntas en lenguaje natural. Obt√©n respuestas precisas al instante, directamente desde los documentos y datos de tu organizaci√≥n.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                    {isAuthLoading ? ( <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>)
                     : ( <Button size="lg" onClick={mainCtaAction} className={cn("w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg")}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button> )}
                </div>
                {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-6"> ¬øYa tienes cuenta?{' '} <Link href="/login" className="font-medium text-primary hover:underline underline-offset-4"> Inicia Sesi√≥n </Link> </p> )}
            </div>
         </section>
         {/* --- FIN Hero Section --- */}

         {/* --- Social Proof Section --- */}
         <section className="w-full py-12 md:py-16 bg-gradient-to-b from-background to-muted/20 dark:to-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de social proof */}
            <div className="container mx-auto max-w-5xl px-4">
                 <h3 className="text-center text-lg font-semibold text-muted-foreground tracking-wider uppercase mb-8">
                    Impulsando Empresas Como la Tuya
                 </h3>
                 <div className="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 opacity-70">
                    {trustedLogos.map(logo => (
                        <span key={logo.name} className="text-sm font-medium text-muted-foreground italic" title={logo.name}>
                            {logo.name}
                        </span>
                    ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Social Proof --- */}


         {/* --- C√≥mo Funciona Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el contenido de c√≥mo funciona */}
             <div className="container mx-auto max-w-4xl text-center">
                <h2 className="text-3xl font-bold tracking-tight mb-4">Atenex en Acci√≥n</h2>
                <p className="text-lg text-muted-foreground mb-12">De documentos dispersos a decisiones informadas en 4 simples pasos.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
                    {howItWorksSteps.map((step) => (
                        <div key={step.title} className="flex flex-col items-center text-center">
                            <div className="mb-4 flex items-center justify-center h-14 w-14 rounded-full bg-primary/10 text-primary">
                                <step.icon className="h-7 w-7" />
                            </div>
                            <h4 className="text-md font-semibold mb-1.5">{step.title}</h4>
                            <p className="text-sm text-muted-foreground">{step.description}</p>
                        </div>
                    ))}
                </div>
             </div>
         </section>
         {/* --- FIN C√≥mo Funciona --- */}


         {/* --- Features Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar las features */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-12">Potencia Tu Inteligencia Empresarial</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <FeatureCard title="B√∫squeda Inteligente" description="Encuentra informaci√≥n exacta al instante usando lenguaje natural, ahorrando horas de b√∫squeda manual y frustraci√≥n." icon="Search"/>
                    <FeatureCard title="Conocimiento Centralizado" description="Rompe los silos de informaci√≥n accediendo al conocimiento colectivo en un solo lugar seguro, eliminando la duplicidad de esfuerzos." icon="Library"/>
                    <FeatureCard title="Productividad Mejorada" description="Empodera a tu equipo con acceso r√°pido a datos relevantes, acelerando la incorporaci√≥n y permitiendo decisiones m√°s r√°pidas." icon="Zap"/>
                </div>
            </div>
         </section>
         {/* --- FIN Features Section --- */}


         {/* --- Casos de Uso Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar los casos de uso */}
             <div className="container mx-auto max-w-6xl">
                 <h2 className="text-3xl font-bold tracking-tight text-center mb-4">Ideal Para Cada Departamento</h2>
                 <p className="text-lg text-muted-foreground text-center mb-12 max-w-2xl mx-auto">Desde RRHH hasta I+D, Atenex se adapta a las necesidades espec√≠ficas de tu equipo.</p>
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                     {useCases.map((useCase) => (
                         <UseCaseCard key={useCase.title} {...useCase} />
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Casos de Uso --- */}


         {/* --- Seguridad Section --- */}
         <section className="w-full py-16 md:py-24 px-4 bg-muted/20 dark:bg-muted/10 border-y">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar la secci√≥n de seguridad */}
             <div className="container mx-auto max-w-4xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">Seguridad y Confianza en el N√∫cleo</h2>
                 <p className="text-lg text-muted-foreground mb-12">Tu informaci√≥n es tu activo m√°s valioso. La protegemos como si fuera nuestra.</p>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                     {securityPoints.map((point) => (
                         <div key={point.title} className="flex items-start gap-4 p-4 rounded-lg bg-background/50 border">
                            <point.icon className="h-8 w-8 text-primary mt-1 flex-shrink-0" />
                            <div>
                                <h4 className="text-md font-semibold mb-1">{point.title}</h4>
                                <p className="text-sm text-muted-foreground">{point.description}</p>
                            </div>
                         </div>
                     ))}
                 </div>
            </div>
         </section>
         {/* --- FIN Seguridad --- */}


         {/* --- CTA Final Section --- */}
         <section className="w-full py-16 md:py-24 px-4">
             {/* FLAG_LLM: A√±adido container y mx-auto para centrar el CTA final */}
            <div className="container mx-auto max-w-3xl text-center">
                 <h2 className="text-3xl font-bold tracking-tight mb-4">¬øListo para Potenciar tu Conocimiento Interno?</h2>
                 <p className="text-lg text-muted-foreground mb-8">Descubre c√≥mo Atenex puede transformar el acceso a la informaci√≥n en tu empresa.</p>
                  {/* Repetir CTA Principal */}
                  {isAuthLoading ? (
                     <Button size="lg" disabled={true} className="w-full sm:w-auto px-8 shadow-md"> <Loader2 className="mr-2 h-5 w-5 animate-spin" /> Cargando... </Button>
                  ) : (
                  <Button size="lg" onClick={mainCtaAction} className={cn( "w-full sm:w-auto px-8 transition-transform duration-150 ease-in-out transform hover:scale-[1.03]", "focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus:outline-none shadow-lg" )}> {mainCtaText} <ChevronRight className='ml-1 h-5 w-5'/> </Button>
                 )}
                 {!isAuthenticated && !isAuthLoading && ( <p className="text-xs text-muted-foreground mt-4"> O <Link href="/contact" className="font-medium text-primary hover:underline underline-offset-4"> contacta con ventas </Link> para una demo personalizada. </p> )}
            </div>
         </section>
         {/* --- FIN CTA Final --- */}

      </main>
      {/* --- FIN Contenido Principal --- */}


      {/* --- Footer --- */}
      <footer className="bg-muted/20 border-t border-border/60 py-6 mt-auto">
         {/* FLAG_LLM: A√±adido container y mx-auto al div interior para centrar el footer */}
        <div className="container mx-auto text-center text-muted-foreground text-xs sm:text-sm flex flex-col sm:flex-row justify-between items-center gap-2">
          <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
              <span>¬© {new Date().getFullYear()} {APP_NAME}. Todos los derechos reservados.</span>
              <span className="hidden sm:inline-block opacity-50">|</span>
              <span className='opacity-80'>Desarrollado por MarkDev</span>
          </div>
          <div className="flex gap-3">
             <Link href="/privacy" className="hover:text-primary hover:underline underline-offset-4 transition-colors">Pol√≠tica de Privacidad</Link>
             <span className='opacity-50'>|</span>
             <Link href="/terms" className="hover:text-primary hover:underline underline-offset-4 transition-colors">T√©rminos de Servicio</Link>
          </div>
        </div>
      </footer>
      {/* --- FIN Footer --- */}
    </div>
  );
}

// --- Componentes Auxiliares ---

// LinkButton (sin cambios)
function LinkButton({ href, children, Icon, isActive = false }: { href: string; children: React.ReactNode; Icon?: React.ComponentType<{ className?: string }>; isActive?: boolean }) {
  return ( <Link href={href} className={cn( buttonVariants({ variant: 'ghost' }), "text-sm px-2 sm:px-3 py-1 h-8 rounded-md focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring", isActive ? "text-primary font-semibold bg-primary/10" : "text-muted-foreground" )}> {Icon && <Icon className="h-4 w-4 mr-1.5 hidden sm:inline-block flex-shrink-0" />} {children} </Link> );
}

// FeatureCard (sin cambios estructurales, texto refinado arriba)
function FeatureCard({ title, description, icon }: { title: string; description: string; icon: string }) {
   const IconComponent = iconMap[icon] || Info;
  return ( <div className={cn( "p-6 rounded-xl bg-card/60 backdrop-blur-sm border border-border/60", "hover:bg-card/90 hover:shadow-lg hover:-translate-y-1", "transition-all duration-200 ease-in-out text-left" )}> <IconComponent className="w-8 h-8 mb-4 text-primary" /> <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3> <p className="text-sm text-muted-foreground leading-relaxed">{description}</p> </div> );
}

// UseCaseCard (NUEVO)
function UseCaseCard({ title, description, icon: Icon }: { title: string; description: string; icon: React.ComponentType<{ className?: string }> }) {
    return (
      <div className="p-6 rounded-lg border bg-card/80 text-left h-full flex flex-col shadow-sm hover:shadow-md transition-shadow">
        <Icon className="w-7 h-7 mb-3 text-primary flex-shrink-0" />
        <h3 className="text-md font-semibold text-foreground mb-1.5">{title}</h3>
        <p className="text-sm text-muted-foreground leading-snug flex-grow">{description}</p>
      </div>
    );
}
```

## File: `app\privacy\page.tsx`
```tsx
// File: app/privacy/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function PrivacyPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
            {/* Bot√≥n volver */}
            <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Volver al Inicio
            </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">Pol√≠tica de Privacidad</CardTitle>
                <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <p>
                    {APP_NAME} ("nosotros", "nos", o "nuestro") opera la aplicaci√≥n {APP_NAME} (el "Servicio"). Esta p√°gina le informa de nuestras pol√≠ticas relativas a la recopilaci√≥n, uso y divulgaci√≥n de datos personales cuando utiliza nuestro Servicio y las opciones que tiene asociadas a esos datos.
                </p>

                <h2>1. Recopilaci√≥n y Uso de Informaci√≥n</h2>
                <p>
                    Recopilamos diferentes tipos de informaci√≥n para diversos fines para proporcionar y mejorar nuestro Servicio para usted.
                </p>
                <ul>
                    <li><strong>Datos Personales:</strong> Al utilizar nuestro Servicio, podemos pedirle que nos proporcione cierta informaci√≥n de identificaci√≥n personal que puede utilizarse para contactarle o identificarle ("Datos Personales"). La informaci√≥n de identificaci√≥n personal puede incluir, entre otros: Direcci√≥n de correo electr√≥nico, Nombre, Informaci√≥n de la empresa (si aplica).</li>
                    <li><strong>Datos de Uso:</strong> Tambi√©n podemos recopilar informaci√≥n sobre c√≥mo se accede y utiliza el Servicio ("Datos de Uso"). Estos Datos de Uso pueden incluir informaci√≥n como la direcci√≥n de Protocolo de Internet de su ordenador (por ejemplo, direcci√≥n IP), tipo de navegador, versi√≥n del navegador, las p√°ginas de nuestro Servicio que visita, la hora y fecha de su visita, el tiempo dedicado a esas p√°ginas, identificadores √∫nicos de dispositivos y otros datos de diagn√≥stico.</li>
                    <li><strong>Contenido del Usuario:</strong> Procesamos los documentos y datos que usted carga ("Contenido del Usuario") √∫nicamente con el fin de proporcionar las funciones del Servicio, como la indexaci√≥n y la consulta. Tratamos su Contenido de Usuario como confidencial.</li>
                </ul>

                <h2>2. Uso de Datos</h2>
                <p>{APP_NAME} utiliza los datos recopilados para diversos fines:</p>
                 <ul>
                    <li>Para proporcionar y mantener el Servicio</li>
                    <li>Para notificarle cambios en nuestro Servicio</li>
                    <li>Para permitirle participar en funciones interactivas de nuestro Servicio cuando decida hacerlo</li>
                    <li>Para proporcionar atenci√≥n y soporte al cliente</li>
                    <li>Para proporcionar an√°lisis o informaci√≥n valiosa para que podamos mejorar el Servicio</li>
                    <li>Para supervisar el uso del Servicio</li>
                    <li>Para detectar, prevenir y abordar problemas t√©cnicos</li>
                 </ul>

                <h2>3. Almacenamiento y Seguridad de los Datos</h2>
                <p>
                    El Contenido del Usuario se almacena de forma segura utilizando proveedores de almacenamiento en la nube est√°ndar de la industria [Especificar si es posible, ej., AWS S3, Google Cloud Storage, MinIO]. Implementamos medidas de seguridad dise√±adas para proteger su informaci√≥n contra el acceso, divulgaci√≥n, alteraci√≥n y destrucci√≥n no autorizados. Sin embargo, ninguna transmisi√≥n por Internet o almacenamiento electr√≥nico es 100% seguro.
                </p>

                 <h2>4. Proveedores de Servicios</h2>
                 <p>
                    Podemos emplear a empresas e individuos terceros para facilitar nuestro Servicio ("Proveedores de Servicios"), para proporcionar el Servicio en nuestro nombre, para realizar servicios relacionados con el Servicio o para ayudarnos a analizar c√≥mo se utiliza nuestro Servicio. Estos terceros tienen acceso a sus Datos Personales s√≥lo para realizar estas tareas en nuestro nombre y est√°n obligados a no divulgarlos ni utilizarlos para ning√∫n otro fin. Ejemplos incluyen: [Listar categor√≠as, ej., Alojamiento en la nube (AWS/GCP/Azure), Proveedores LLM (OpenAI/Google), Autenticaci√≥n (Supabase)].
                 </p>

                 <h2>5. Sus Derechos sobre los Datos</h2>
                 <p>
                    Dependiendo de su jurisdicci√≥n, puede tener ciertos derechos con respecto a sus Datos Personales, como el derecho a acceder, corregir, eliminar o restringir su procesamiento. P√≥ngase en contacto con nosotros para ejercer estos derechos.
                 </p>

                 <h2>6. Privacidad de los Ni√±os</h2>
                 <p>
                    Nuestro Servicio no se dirige a menores de 18 a√±os ("Ni√±os"). No recopilamos conscientemente informaci√≥n de identificaci√≥n personal de menores de 18 a√±os.
                 </p>

                 <h2>7. Cambios a esta Pol√≠tica de Privacidad</h2>
                 <p>
                    Podemos actualizar nuestra Pol√≠tica de Privacidad de vez en cuando. Le notificaremos cualquier cambio publicando la nueva Pol√≠tica de Privacidad en esta p√°gina. Se le aconseja revisar esta Pol√≠tica de Privacidad peri√≥dicamente para cualquier cambio.
                 </p>

                 <h2>8. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre esta Pol√≠tica de Privacidad, por favor cont√°ctenos: [Su Correo/Enlace de Contacto]
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `app\terms\page.tsx`
```tsx
// File: app/terms/page.tsx (MODIFICADO - Iteraci√≥n 5.2)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'; // A√±adido CardDescription
import { APP_NAME } from '@/lib/constants';
import { ArrowLeft } from 'lucide-react'; // Icono volver

export default function TermsPage() {
    const router = useRouter();

  return (
    <div className="min-h-screen bg-background text-foreground">
        <div className="container mx-auto max-w-4xl p-4 md:p-8 space-y-6">
             {/* Bot√≥n volver */}
             <Button variant="ghost" onClick={() => router.push('/')} className="text-sm text-muted-foreground hover:text-foreground mb-4 -ml-4">
               <ArrowLeft className="mr-2 h-4 w-4" />
               Volver al Inicio
             </Button>
            {/* Card principal */}
            <Card className="shadow-sm border">
                <CardHeader>
                <CardTitle className="text-2xl md:text-3xl font-bold">T√©rminos de Servicio</CardTitle>
                 <CardDescription>√öltima Actualizaci√≥n: [Insertar Fecha]</CardDescription> {/* Fecha aqu√≠ */}
                </CardHeader>
                <CardContent className="prose prose-sm sm:prose-base dark:prose-invert max-w-none pt-0"> {/* prose para estilos de texto */}
                <h2>1. Aceptaci√≥n de los T√©rminos</h2>
                <p>
                    Al acceder o utilizar el servicio {APP_NAME} ("Servicio"), usted acepta estar sujeto a estos T√©rminos de Servicio ("T√©rminos"). Si no est√° de acuerdo con alguna parte de los t√©rminos, no podr√° acceder al Servicio.
                </p>

                <h2>2. Descripci√≥n del Servicio</h2>
                <p>
                    {APP_NAME} proporciona una plataforma para consultar bases de conocimiento empresariales utilizando procesamiento de lenguaje natural. Las caracter√≠sticas incluyen carga, procesamiento, indexaci√≥n de documentos y consulta en lenguaje natural.
                </p>

                <h2>3. Cuentas de Usuario</h2>
                <p>
                    Usted es responsable de salvaguardar sus credenciales de cuenta y de cualquier actividad o acci√≥n bajo su cuenta. Debe notificarnos inmediatamente al tener conocimiento de cualquier violaci√≥n de seguridad o uso no autorizado de su cuenta.
                </p>

                <h2>4. Contenido del Usuario</h2>
                <p>
                    Usted conserva la propiedad de cualquier documento o dato que cargue en el Servicio ("Contenido del Usuario"). Al cargar Contenido del Usuario, usted otorga a {APP_NAME} una licencia mundial, no exclusiva y libre de regal√≠as para usar, procesar, almacenar y mostrar su Contenido del Usuario √∫nicamente con el prop√≥sito de proporcionarle el Servicio.
                </p>

                <h2>5. Uso Aceptable</h2>
                <p>
                    Usted acepta no hacer un mal uso del Servicio. Las actividades prohibidas incluyen, entre otras: [Listar actividades prohibidas, ej., cargar contenido ilegal, intentar violar la seguridad, sobrecargar el sistema].
                </p>

                <h2>6. Terminaci√≥n</h2>
                <p>
                    Podemos terminar o suspender su acceso al Servicio inmediatamente, sin previo aviso ni responsabilidad, por cualquier motivo, incluido, entre otros, si incumple los T√©rminos.
                </p>

                <h2>7. Exclusi√≥n de Garant√≠as</h2>
                <p>
                    El Servicio se proporciona "TAL CUAL" y "SEG√öN DISPONIBILIDAD". {APP_NAME} no ofrece garant√≠as, expresas o impl√≠citas, y por la presente renuncia a todas las dem√°s garant√≠as, incluidas, entre otras, las garant√≠as impl√≠citas de comerciabilidad, idoneidad para un prop√≥sito particular o no infracci√≥n.
                </p>

                 <h2>8. Limitaci√≥n de Responsabilidad</h2>
                 <p>
                    En ning√∫n caso {APP_NAME}, ni sus directores, empleados, socios, agentes, proveedores o afiliados, ser√°n responsables de ning√∫n da√±o indirecto, incidental, especial, consecuente o punitivo, incluidos, entre otros, la p√©rdida de beneficios, datos, uso, fondo de comercio u otras p√©rdidas intangibles, resultantes de su acceso o uso o incapacidad para acceder o usar el Servicio.
                 </p>

                 <h2>9. Ley Aplicable</h2>
                 <p>
                    Estos T√©rminos se regir√°n e interpretar√°n de acuerdo con las leyes de [Su Jurisdicci√≥n], sin tener en cuenta sus disposiciones sobre conflicto de leyes.
                 </p>

                 <h2>10. Cambios a los T√©rminos</h2>
                 <p>
                    Nos reservamos el derecho, a nuestra entera discreci√≥n, de modificar o reemplazar estos T√©rminos en cualquier momento. Le notificaremos cualquier cambio publicando los nuevos T√©rminos en esta p√°gina.
                 </p>

                 <h2>11. Cont√°ctenos</h2>
                 <p>
                    Si tiene alguna pregunta sobre estos T√©rminos, cont√°ctenos en [Su Correo/Enlace de Contacto].
                 </p>
                </CardContent>
            </Card>
        </div>
    </div>
  );
}
```

## File: `components\admin\AdminManagement.tsx`
```tsx
// File: components/admin/AdminManagement.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from '@/components/ui/separator';
import { Loader2, Building, UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listCompaniesForSelect, createCompany, createUser, CompanySelectItem, ApiError } from '@/lib/api'; // Necesitar√°s definir esto
import { useAuth } from '@/lib/hooks/useAuth';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

// Esquemas de Validaci√≥n
const createCompanySchema = z.object({
  companyName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
});
type CreateCompanyValues = z.infer<typeof createCompanySchema>;

const createUserSchema = z.object({
  userName: z.string().min(2, { message: "El nombre debe tener al menos 2 caracteres." }),
  userEmail: z.string().email({ message: "Introduce un correo electr√≥nico v√°lido." }),
  userPassword: z.string().min(8, { message: "La contrase√±a debe tener al menos 8 caracteres." }),
  companyId: z.string().uuid({ message: "Selecciona una empresa v√°lida." }),
});
type CreateUserValues = z.infer<typeof createUserSchema>;

export default function AdminManagement() {
  const { token } = useAuth();
  const [companies, setCompanies] = useState<CompanySelectItem[]>([]);
  const [isLoadingCompanies, setIsLoadingCompanies] = useState(true);
  const [companyError, setCompanyError] = useState<string | null>(null);
  const [userError, setUserError] = useState<string | null>(null);

  // Formularios
  const companyForm = useForm<CreateCompanyValues>({
    resolver: zodResolver(createCompanySchema),
    defaultValues: { companyName: '' },
  });
  const userForm = useForm<CreateUserValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: { userName: '', userEmail: '', userPassword: '', companyId: '' },
  });

  // Cargar lista de compa√±√≠as para el selector
  useEffect(() => {
    const fetchCompanies = async () => {
      if (!token) return;
      setIsLoadingCompanies(true);
      try {
        const data = await listCompaniesForSelect(); // Llamada API (usar√° mock por ahora)
        setCompanies(data);
      } catch (err: any) {
        console.error("Error fetching companies for select:", err);
        toast.error("Error al cargar empresas", { description: err.message || "Error desconocido" });
      } finally {
        setIsLoadingCompanies(false);
      }
    };
    fetchCompanies();
  }, [token]);

  // Handlers de env√≠o
  const onCompanySubmit = async (data: CreateCompanyValues) => {
    setCompanyError(null);
    const toastId = toast.loading("Creando compa√±√≠a...");
    try {
        const newCompany = await createCompany({ name: data.companyName }); // Llamada API (usar√° mock por ahora)
        toast.success("Compa√±√≠a Creada", { id: toastId, description: `"${newCompany.name}" creada con ID: ${newCompany.id.substring(0, 8)}...` });
        companyForm.reset();
        // Actualizar la lista de compa√±√≠as para el selector
        setCompanies(prev => [...prev, { id: newCompany.id, name: newCompany.name }].sort((a, b) => a.name.localeCompare(b.name))); // A√±adir y ordenar
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear la compa√±√≠a.";
        setCompanyError(message);
        toast.error("Error al crear compa√±√≠a", { id: toastId, description: message });
    }
  };

  const onUserSubmit = async (data: CreateUserValues) => {
    setUserError(null);
    const toastId = toast.loading("Creando usuario...");
    try {
        await createUser({ // Llamada API (usar√° mock por ahora)
            name: data.userName,
            email: data.userEmail,
            password: data.userPassword,
            company_id: data.companyId,
            roles: ['user'] // Asignar rol 'user' por defecto
        });
        toast.success("Usuario Creado", { id: toastId, description: `Usuario ${data.userEmail} creado y asociado.` });
        userForm.reset();
    } catch (err: any) {
        const message = err instanceof ApiError ? err.message : "No se pudo crear el usuario.";
        setUserError(message);
        toast.error("Error al crear usuario", { id: toastId, description: message });
    }
  };

  return (
    <div className="space-y-8">
      <h1 className="text-2xl font-bold tracking-tight">Gesti√≥n de Entidades</h1>

      {/* Grid para formularios */}
      <div className="grid gap-8 lg:grid-cols-2">

        {/* Crear Compa√±√≠a */}
        <Card className="flex flex-col"> {/* Flex col para que footer se alinee abajo */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building className="h-5 w-5 text-primary" /> Crear Compa√±√≠a
            </CardTitle>
            <CardDescription>A√±ade una nueva organizaci√≥n.</CardDescription>
          </CardHeader>
          <form onSubmit={companyForm.handleSubmit(onCompanySubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow"> {/* flex-grow para empujar footer */}
              {companyError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{companyError}</AlertDescription></Alert>
              )}
              <div className="space-y-1.5">
                <Label htmlFor="companyName">Nombre de la Compa√±√≠a</Label>
                <Input
                  id="companyName"
                  placeholder="Ej: Acme Corporation"
                  disabled={companyForm.formState.isSubmitting}
                  {...companyForm.register("companyName")}
                  aria-invalid={!!companyForm.formState.errors.companyName}
                />
                {companyForm.formState.errors.companyName && (
                  <p className="text-xs text-destructive pt-1">{companyForm.formState.errors.companyName.message}</p>
                )}
              </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto"> {/* mt-auto para empujar al fondo */}
              <Button type="submit" disabled={companyForm.formState.isSubmitting}>
                {companyForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Compa√±√≠a
              </Button>
            </CardFooter>
          </form>
        </Card>

        {/* Crear Usuario */}
        <Card className="flex flex-col"> {/* Flex col */}
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" /> Crear Usuario
            </CardTitle>
            <CardDescription>A√±ade un usuario a una compa√±√≠a.</CardDescription>
          </CardHeader>
          <form onSubmit={userForm.handleSubmit(onUserSubmit)} className="flex flex-col flex-grow">
            <CardContent className="space-y-4 flex-grow">
               {userError && (
                  <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error</AlertTitle><AlertDescription>{userError}</AlertDescription></Alert>
               )}
               {/* Campos Nombre y Email */}
               <div className="grid sm:grid-cols-2 gap-4">
                 <div className="space-y-1.5">
                   <Label htmlFor="userName">Nombre Completo</Label>
                   <Input id="userName" placeholder="Ej: Juan P√©rez" disabled={userForm.formState.isSubmitting} {...userForm.register("userName")} aria-invalid={!!userForm.formState.errors.userName}/>
                   {userForm.formState.errors.userName && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userName.message}</p>}
                 </div>
                 <div className="space-y-1.5">
                   <Label htmlFor="userEmail">Correo Electr√≥nico</Label>
                   <Input id="userEmail" type="email" placeholder="ej: juan.perez@empresa.com" disabled={userForm.formState.isSubmitting} {...userForm.register("userEmail")} aria-invalid={!!userForm.formState.errors.userEmail}/>
                   {userForm.formState.errors.userEmail && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userEmail.message}</p>}
                 </div>
               </div>
               {/* Campo Contrase√±a */}
               <div className="space-y-1.5">
                 <Label htmlFor="userPassword">Contrase√±a</Label>
                 <Input id="userPassword" type="password" placeholder="M√≠nimo 8 caracteres" disabled={userForm.formState.isSubmitting} {...userForm.register("userPassword")} aria-invalid={!!userForm.formState.errors.userPassword}/>
                 {userForm.formState.errors.userPassword && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.userPassword.message}</p>}
               </div>
               {/* Selector Compa√±√≠a */}
               <div className="space-y-1.5">
                 <Label htmlFor="companyId">Asignar a Compa√±√≠a</Label>
                 <Select
                     disabled={isLoadingCompanies || userForm.formState.isSubmitting}
                     onValueChange={(value) => userForm.setValue('companyId', value, { shouldValidate: true })}
                     value={userForm.watch('companyId')}
                 >
                   <SelectTrigger id="companyId" className="w-full" aria-invalid={!!userForm.formState.errors.companyId}>
                     <SelectValue placeholder={isLoadingCompanies ? "Cargando compa√±√≠as..." : "Selecciona una compa√±√≠a..."} />
                   </SelectTrigger>
                   <SelectContent>
                     {isLoadingCompanies ? (
                        <SelectItem value="loading" disabled>Cargando...</SelectItem>
                     ) : companies.length > 0 ? (
                       companies.map((company) => (
                         <SelectItem key={company.id} value={company.id}>
                           {company.name} ({company.id.substring(0, 6)}...)
                         </SelectItem>
                       ))
                     ) : (
                        <SelectItem value="no-companies" disabled>No hay compa√±√≠as creadas</SelectItem>
                     )}
                   </SelectContent>
                 </Select>
                 {userForm.formState.errors.companyId && <p className="text-xs text-destructive pt-1">{userForm.formState.errors.companyId.message}</p>}
               </div>
            </CardContent>
            <CardFooter className="border-t pt-6 mt-auto">
              <Button type="submit" disabled={userForm.formState.isSubmitting || isLoadingCompanies || !userForm.formState.isValid}>
                {userForm.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear Usuario
              </Button>
            </CardFooter>
          </form>
        </Card>

      </div>
    </div>
  );
}
```

## File: `components\admin\AdminStats.tsx`
```tsx
// File: components/admin/AdminStats.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, Users, Building, Loader2 } from 'lucide-react';
import { getAdminStats, AdminStatsResponse } from '@/lib/api'; // Necesitar√°s definir esto en api.ts
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminStats() {
  const { token } = useAuth(); // Necesario para las llamadas API (impl√≠cito en request)
  const [stats, setStats] = useState<AdminStatsResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchStats = async () => {
      if (!token) {
        // No establecer error aqu√≠, simplemente no hacer la llamada si no hay token
        // El componente padre (layout/page) deber√≠a manejar la redirecci√≥n
        console.warn("AdminStats: No token available, skipping fetch.");
        setIsLoading(false); // Marcar como no cargando
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        const data = await getAdminStats(); // Llamada API (usar√° mock por ahora)
        setStats(data);
      } catch (err: any) {
        console.error("Error fetching admin stats:", err);
        const message = err.message || "No se pudieron cargar las estad√≠sticas.";
        setError(message);
        toast.error("Error al cargar estad√≠sticas", { description: message });
      } finally {
        setIsLoading(false);
      }
    };

    fetchStats();
  }, [token]); // Depende del token para re-fetch si cambia

  // Calcula el total de usuarios sumando los user_count de cada compa√±√≠a
  const totalUsers = React.useMemo(() => {
    return stats?.users_per_company?.reduce((sum, company) => sum + company.user_count, 0);
  }, [stats]);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h1>

      {/* Tarjetas de Resumen */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Tarjeta Empresas */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Empresas Totales</CardTitle>
            <Building className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{stats?.company_count ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Organizaciones registradas.
            </p>
          </CardContent>
        </Card>
        {/* Tarjeta Usuarios */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Usuarios Totales</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <Skeleton className="h-8 w-16" />
            ) : error ? (
              <span className="text-sm text-destructive">-</span>
            ) : (
              <div className="text-2xl font-bold">{totalUsers ?? '-'}</div>
            )}
            <p className="text-xs text-muted-foreground pt-1">
              Usuarios activos en todas las empresas.
            </p>
          </CardContent>
        </Card>
        {/* Puedes a√±adir m√°s tarjetas aqu√≠ */}
      </div>

      {/* Tabla de Usuarios por Empresa */}
      <Card>
        <CardHeader>
          <CardTitle>Usuarios por Empresa</CardTitle>
          <CardDescription>Desglose del n√∫mero de usuarios activos por cada empresa.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && !isLoading && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-[50%]">Nombre Empresa</TableHead>
                <TableHead className="hidden sm:table-cell">ID Empresa</TableHead>
                <TableHead className="text-right">Usuarios</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                [...Array(5)].map((_, i) => (
                  <TableRow key={`skel-row-${i}`}>
                    <TableCell><Skeleton className="h-4 w-3/4" /></TableCell>
                    <TableCell className="hidden sm:table-cell"><Skeleton className="h-4 w-24" /></TableCell>
                    <TableCell className="text-right"><Skeleton className="h-4 w-8 ml-auto" /></TableCell>
                  </TableRow>
                ))
              ) : stats?.users_per_company && stats.users_per_company.length > 0 ? (
                stats.users_per_company.map((company) => (
                  <TableRow key={company.company_id}>
                    <TableCell className="font-medium">{company.name || `Empresa ${company.company_id.substring(0, 6)}`}</TableCell>
                    <TableCell className="text-muted-foreground text-xs font-mono hidden sm:table-cell">{company.company_id}</TableCell>
                    <TableCell className="text-right font-medium">{company.user_count}</TableCell>
                  </TableRow>
                ))
              ) : !error ? (
                <TableRow>
                  <TableCell colSpan={3} className="h-24 text-center text-muted-foreground">
                    No hay datos de empresas disponibles.
                  </TableCell>
                </TableRow>
              ) : null}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
```

## File: `components\animations\snakeanimation.tsx`
```tsx
// File: components/animations/snakeanimation.tsx (CORREGIDO - Error R3F Hook)
'use client';

import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrthographicCamera, Text } from '@react-three/drei';
import { useRef, useState, useEffect, useMemo, useCallback } from 'react';
import * as THREE from 'three';

// --- Constantes (sin cambios) ---
const WORDS_TO_EAT = [
  { id: 'Inicio', pos: new THREE.Vector3(1, 5.5, 0) },
  { id: 'Nosotros', pos: new THREE.Vector3(4, 5.5, 0) },
  { id: 'Contacto', pos: new THREE.Vector3(7, 5.5, 0) },
];
const A_SHAPE_POINTS_INITIAL = [
  new THREE.Vector3(-1.5, -1.5, 0), new THREE.Vector3(-1.5, -0.5, 0),
  new THREE.Vector3(-0.5, 1.5, 0),  new THREE.Vector3(0.5, 1.5, 0),
  new THREE.Vector3(1.5, -0.5, 0), new THREE.Vector3(1.5, -1.5, 0),
  new THREE.Vector3(0.75, 0, 0), new THREE.Vector3(-0.75, 0, 0),
];
const A_CURVE = new THREE.CatmullRomCurve3([
  new THREE.Vector3(-10, -2, 0), new THREE.Vector3(-4, 3, 0),
  new THREE.Vector3(0, -3, 0), new THREE.Vector3(4, 3, 0),
  new THREE.Vector3(10, -2, 0), A_SHAPE_POINTS_INITIAL[0],
  ...A_SHAPE_POINTS_INITIAL
], false, 'catmullrom', 0.5);
const FINAL_A_POINTS = A_CURVE.getPoints(200);

type AnimationPhase = 'roaming' | 'eating' | 'movingToA' | 'drawingA' | 'final';

// --- Componente Snake (sin cambios estructurales) ---
interface SnakeProps {
  eatenWords: Set<string>;
  onWordEaten: (id: string) => void;
  animationPhase: AnimationPhase;
  onPhaseChange: (phase: AnimationPhase) => void;
}

function Snake({ eatenWords, onWordEaten, animationPhase, onPhaseChange }: SnakeProps) {
  const snakeSegments = useRef<THREE.Vector3[]>([]);
  const snakeCurve = useRef<THREE.CatmullRomCurve3 | null>(null);
  const snakeMeshRef = useRef<THREE.Mesh>(null!);
  const headPosition = useRef(new THREE.Vector3(-15, 0, 0));
  const animationProgress = useRef(0);

  const snakeLength = useMemo(() => 50 + eatenWords.size * 10, [eatenWords.size]);

   if (snakeSegments.current.length === 0) {
      snakeSegments.current = Array.from({ length: snakeLength }).map(
          (_, i) => new THREE.Vector3(-15 + i * 0.2, Math.sin(i * 0.5) * 0.5, 0)
      );
      snakeCurve.current = new THREE.CatmullRomCurve3(snakeSegments.current);
      headPosition.current = snakeSegments.current[0].clone();
   }

  useFrame(({ clock }) => {
    if (!snakeMeshRef.current || !snakeCurve.current) return;

    let targetPosition: THREE.Vector3 | null = null;
    let currentPhase = animationPhase;

    // --- Phase Logic (sin cambios) ---
    switch (currentPhase) {
        case 'roaming':
        case 'eating':
            const t = clock.getElapsedTime() * 0.5;
            targetPosition = new THREE.Vector3(
                Math.cos(t * 0.7) * 9 + Math.sin(t * 0.4) * 2,
                Math.sin(t * 0.9) * 5 + Math.cos(t * 0.3) * 1.5,
                Math.sin(t * 1.1) * 0.5
            );
            headPosition.current.lerp(targetPosition, 0.06);

            WORDS_TO_EAT.forEach(word => {
                if (!eatenWords.has(word.id) && headPosition.current.distanceTo(word.pos) < 1.0) {
                    onWordEaten(word.id);
                    if (eatenWords.size + 1 === WORDS_TO_EAT.length) {
                        currentPhase = 'movingToA';
                        onPhaseChange(currentPhase);
                        animationProgress.current = 0;
                    }
                }
            });
            break;
        case 'movingToA':
            targetPosition = A_CURVE.getPointAt(0);
            headPosition.current.lerp(targetPosition, 0.04);
            if (headPosition.current.distanceTo(targetPosition) < 0.1) {
                currentPhase = 'drawingA';
                onPhaseChange(currentPhase);
                animationProgress.current = 0;
            }
            break;
        case 'drawingA':
            animationProgress.current += 0.003;
            if (animationProgress.current >= 1) {
                animationProgress.current = 1;
                currentPhase = 'final';
                onPhaseChange(currentPhase);
            }
            const pointOnACurve = A_CURVE.getPointAt(animationProgress.current);
            headPosition.current.copy(pointOnACurve);
            break;
        case 'final':
             if (snakeSegments.current.length !== FINAL_A_POINTS.length) {
                 snakeSegments.current = FINAL_A_POINTS;
                 snakeCurve.current.points = snakeSegments.current;
             }
             targetPosition = headPosition.current;
            break;
    }

    // --- Update Snake Geometry (sin cambios) ---
    if (currentPhase !== 'final') {
        snakeSegments.current.unshift(headPosition.current.clone());
        while (snakeSegments.current.length > snakeLength) {
            snakeSegments.current.pop();
        }
        snakeCurve.current.points = snakeSegments.current;
    }

    const tubeRadius = 0.12 + 0.02 * Math.sin(clock.getElapsedTime() * 5);
    const tubeGeometry = new THREE.TubeGeometry(
      snakeCurve.current,
      Math.max(10, snakeSegments.current.length * 2),
      tubeRadius, 8, false
    );

    if (snakeMeshRef.current.geometry) {
        snakeMeshRef.current.geometry.dispose();
    }
    snakeMeshRef.current.geometry = tubeGeometry;
    snakeMeshRef.current.geometry.computeVertexNormals();
  });

  return (
    <mesh ref={snakeMeshRef}>
      <meshStandardMaterial color="#FFFFFF" roughness={0.5} metalness={0.2} side={THREE.DoubleSide} />
      <bufferGeometry attach="geometry" />
    </mesh>
  );
}

// --- NUEVO: Componente interno para el contenido de la escena ---
interface SceneContentProps extends SnakeProps {
    showFinalText: boolean;
}

function SceneContent({ eatenWords, onWordEaten, animationPhase, onPhaseChange, showFinalText }: SceneContentProps) {
    // *** ¬°El hook useThree se mueve aqu√≠ dentro! ***
    const { size } = useThree(); // Get canvas size for aspect ratio

    // Calculate camera properties based on canvas size
    const aspect = size.width / size.height;
    const frustumSize = 14; // Adjust this to control zoom level
    const cameraProps = {
      makeDefault: true, // Make this the default camera
      left: frustumSize * aspect / -2,
      right: frustumSize * aspect / 2,
      top: frustumSize / 2,
      bottom: frustumSize / -2,
      near: 0.1,
      far: 100,
      position: [0, 0, 10] as [number, number, number], // Camera position Z
    };

    return (
        <>
            {/* Camera setup now uses calculated props */}
            <OrthographicCamera {...cameraProps} />

            {/* Lighting (sin cambios) */}
            <ambientLight intensity={0.8} />
            <directionalLight position={[5, 5, 8]} intensity={1.5} />
            <directionalLight position={[-3, -2, 5]} intensity={0.5} color="#AAAAFF" />

            {/* Render the Snake (pasando props) */}
            <Snake
                eatenWords={eatenWords}
                onWordEaten={onWordEaten}
                animationPhase={animationPhase}
                onPhaseChange={onPhaseChange}
            />

            {/* Render Words to Eat (pasando props) */}
            {animationPhase !== 'final' && WORDS_TO_EAT.map((word) =>
                !eatenWords.has(word.id) ? (
                <Text
                    key={word.id}
                    position={word.pos}
                    fontSize={0.8}
                    color="#D1D5DB"
                    anchorX="center"
                    anchorY="middle"
                    outlineWidth={0.05}
                    outlineColor="#374151"
                >
                    {word.id}
                </Text>
                ) : null
            )}

             {/* Render Final Atenex Text (pasando props) */}
             {showFinalText && (
                <Text
                    position={[0, -2.5, 1]}
                    fontSize={1.8}
                    color="#FFFFFF"
                    anchorX="center"
                    anchorY="middle"
                    font="/fonts/Inter-Bold.woff"
                    outlineWidth={0.08}
                    outlineColor="#000000"
                >
                    Atenex
                </Text>
             )}
        </>
    );
}


// --- Componente Principal SnakeAnimation (ahora m√°s simple) ---
export default function SnakeAnimation() {
  const [eatenWords, setEatenWords] = useState<Set<string>>(new Set());
  const [phase, setPhase] = useState<AnimationPhase>('roaming');
  const [showFinalText, setShowFinalText] = useState(false);
  // const allWordsEaten = useMemo(() => eatenWords.size === WORDS_TO_EAT.length, [eatenWords]); // Ya no se necesita aqu√≠ directamente

  const handleWordEaten = useCallback((id: string) => {
    setEatenWords(prev => new Set(prev).add(id));
  }, []);

   const handlePhaseChange = useCallback((newPhase: AnimationPhase) => {
       console.log("Animation Phase Change:", newPhase);
       setPhase(newPhase);
       if (newPhase === 'final') {
           setTimeout(() => setShowFinalText(true), 500);
       }
   }, []);

  return (
    <Canvas
      style={{
        position: 'absolute', top: 0, left: 0, width: '100vw',
        height: '100vh', zIndex: 0, pointerEvents: 'none', background: 'transparent',
      }}
      // No necesitamos la c√°mara aqu√≠, se define dentro de SceneContent
    >
        {/* Renderiza el componente interno que contiene la escena */}
        <SceneContent
            eatenWords={eatenWords}
            onWordEaten={handleWordEaten}
            animationPhase={phase}
            onPhaseChange={handlePhaseChange}
            showFinalText={showFinalText}
        />
    </Canvas>
  );
}
```

## File: `components\auth\login-form.tsx`
```tsx
// File: components/auth/login-form.tsx (MODIFICADO - Iteraci√≥n 5.3, solo estilo)
"use client";

import React, { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Loader2 } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { cn } from '@/lib/utils'; // Importar cn
import Link from 'next/link'; // Para enlace "Olvidaste contrase√±a"

// Esquema Zod (sin cambios)
const loginSchema = z.object({
  email: z.string().email({ message: 'Por favor, introduce una direcci√≥n de correo v√°lida.' }),
  password: z.string().min(6, { message: 'La contrase√±a debe tener al menos 6 caracteres.' }),
});

type LoginFormValues = z.infer<typeof loginSchema>;

export function LoginForm() {
  const { signIn, isLoading } = useAuth();
  const [error, setError] = useState<string | null>(null);

  const form = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: { email: '', password: '' },
    mode: 'onChange', // Validar al cambiar
  });

  const onSubmit = async (data: LoginFormValues) => {
    setError(null);
    try {
      await signIn(data.email, data.password);
    } catch (err: any) {
      setError(err.message || 'Inicio de sesi√≥n fallido. Revisa tus credenciales e int√©ntalo de nuevo.');
    }
  };

  return (
    // Aumentar espaciado entre elementos del formulario
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
      {/* Alerta de Error */}
      {error && (
        <Alert variant="destructive" role="alert" aria-live="assertive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error de Inicio de Sesi√≥n</AlertTitle> {/* T√≠tulo m√°s gen√©rico */}
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      {/* Campo Email */}
      <div className="space-y-1.5"> {/* Ajuste espaciado label/input */}
        <Label htmlFor="email">Correo Electr√≥nico</Label>
        <Input
          id="email"
          type="email"
          placeholder="nombre@ejemplo.com"
          autoComplete="email"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('email')}
          aria-invalid={form.formState.errors.email ? 'true' : 'false'}
          className={cn(form.formState.errors.email && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.email && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.email.message}</p> // Texto m√°s peque√±o
        )}
      </div>
      {/* Campo Contrase√±a */}
      <div className="space-y-1.5">
        <div className="flex items-center justify-between">
             <Label htmlFor="password">Contrase√±a</Label>
             {/* Enlace "¬øOlvidaste tu contrase√±a?" */}
             {/* <Link href="#" className="text-xs text-muted-foreground hover:text-primary underline underline-offset-2">
                 ¬øOlvidaste tu contrase√±a?
             </Link> */}
        </div>
        <Input
          id="password"
          type="password"
          autoComplete="current-password"
          required
          disabled={isLoading}
          aria-required="true"
          {...form.register('password')}
          aria-invalid={form.formState.errors.password ? 'true' : 'false'}
           className={cn(form.formState.errors.password && "border-destructive focus-visible:ring-destructive/50")} // Highlight error
        />
        {form.formState.errors.password && (
          <p className="text-xs text-destructive pt-1" role="alert">{form.formState.errors.password.message}</p>
        )}
      </div>
      {/* Bot√≥n de Env√≠o */}
      <Button type="submit" className="w-full" disabled={isLoading || !form.formState.isDirty || !form.formState.isValid}>
        {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
        {isLoading ? 'Iniciando Sesi√≥n...' : 'Iniciar Sesi√≥n'}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-history.tsx`
```tsx
// File: components/chat/chat-history.tsx (MODIFICADO - Iteraci√≥n 2)
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { Button, buttonVariants } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageSquareText, Trash2, Loader2, AlertCircle, RefreshCw, History } from 'lucide-react'; // A√±adido History icon
import { cn } from '@/lib/utils';
import { getChats, deleteChat, ChatSummary, ApiError } from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

export function ChatHistory() {
    const pathname = usePathname();
    const router = useRouter();
    const { user, isLoading: isAuthLoading, signOut } = useAuth();

    const [chats, setChats] = useState<ChatSummary[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [chatToDelete, setChatToDelete] = useState<ChatSummary | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);

    const fetchChatHistory = useCallback(async (showToast = false) => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (!isAuthLoading && !isAuthenticated) {
            setChats([]);
            setError(null);
            setIsLoading(false);
            return;
        }

        if (!bypassAuth && isAuthLoading) {
            setIsLoading(true);
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const fetchedChats = await getChats();
            fetchedChats.sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime());
            setChats(fetchedChats);
            if (showToast) toast.success("Historial de chats actualizado");
        } catch (err) {
            let message = "No se pudo cargar el historial de chats.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) { message = "Sesi√≥n expirada o inv√°lida. Por favor, inicia sesi√≥n de nuevo."; signOut(); }
                else if (err.status === 422) { message = `Fallo al procesar la solicitud: ${err.message}`; }
            } else if (err instanceof Error) { message = err.message; }
            setError(message);
            setChats([]);
            if (showToast) toast.error("Error al Cargar Chats", { description: message });
        } finally {
            setIsLoading(false);
        }
    }, [user, isAuthLoading, signOut]);

    useEffect(() => {
        fetchChatHistory(false);
    }, [fetchChatHistory]);

    const openDeleteConfirmation = (chat: ChatSummary, event: React.MouseEvent) => {
        event.stopPropagation();
        event.preventDefault();
        setChatToDelete(chat);
        setIsAlertOpen(true);
    };

    const handleDeleteConfirmed = async () => {
        if (!chatToDelete) return;
        setIsDeleting(true);
        try {
            await deleteChat(chatToDelete.id);
            setChats(prev => prev.filter(chat => chat.id !== chatToDelete.id));
            toast.success("Chat Eliminado", { description: `Chat "${chatToDelete.title || chatToDelete.id.substring(0, 8)}" eliminado.` });
            const currentChatId = pathname.split('/').pop();
            if (currentChatId === chatToDelete.id) {
                router.push('/chat');
            }
        } catch (err) {
            let message = "No se pudo eliminar el chat.";
            if (err instanceof ApiError) {
                message = err.message || message;
                if (err.status === 401 || err.status === 403) signOut();
            } else if (err instanceof Error) { message = err.message; }
            toast.error("Fallo al Eliminar", { description: message });
        } finally {
            setIsDeleting(false);
            setIsAlertOpen(false);
            setChatToDelete(null);
        }
    };

    const renderContent = () => {
        const bypassAuth = process.env.NEXT_PUBLIC_BYPASS_AUTH === 'true';
        const isAuthenticated = !!user || bypassAuth;

        if (isLoading || (!bypassAuth && isAuthLoading)) {
            // Skeleton m√°s representativo
            return (
                <div className="space-y-2 p-2">
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                    <Skeleton className="h-10 w-full rounded-md" />
                </div>
            );
        }

        if (!isAuthenticated) {
            return (
                <div className="px-2 py-6 text-center text-muted-foreground">
                    <p className="text-xs mb-2">Inicia sesi√≥n para ver el historial.</p>
                </div>
            );
        }

        if (error) {
            return (
                <div className="px-3 py-6 text-center text-destructive-foreground bg-destructive/10 rounded-md m-2">
                    <AlertCircle className="mx-auto h-6 w-6 mb-2 text-destructive" />
                    <p className="text-sm font-medium mb-1">Error al Cargar</p>
                    <p className="text-xs mb-3">{error}</p>
                    <Button variant="destructive" size="sm" onClick={() => fetchChatHistory(true)} className="bg-destructive/80 hover:bg-destructive">
                        <RefreshCw className="mr-1.5 h-3.5 w-3.5"/> Reintentar
                    </Button>
                </div>
            );
        }

        if (chats.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center text-center text-muted-foreground p-6">
                    <History className="h-8 w-8 mb-3 opacity-50"/>
                    <p className="text-sm font-medium mb-1">Sin chats anteriores</p>
                    <p className="text-xs">Inicia una nueva conversaci√≥n para verla aqu√≠.</p>
                </div>
            );
        }

        return chats.map((chat) => {
            const isActive = pathname === `/chat/${chat.id}`;
            const displayTitle = chat.title || `Chat ${chat.id.substring(0, 8)}...`;
            const displayDate = new Date(chat.updated_at).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }); // Formato espa√±ol

            return (
                <div key={chat.id} className="relative group w-full"> {/* Quitamos pr-8 */}
                    <Link href={`/chat/${chat.id}`} passHref legacyBehavior>
                        <a
                            className={cn(
                                buttonVariants({ variant: "ghost", size: "default" }), // Usamos ghost
                                "w-full justify-start h-auto py-2.5 px-3 overflow-hidden text-left rounded-md text-sm", // Padding y altura ajustados
                                isActive
                                ? "bg-primary/10 dark:bg-primary/20 text-primary font-medium" // Estado activo mejorado
                                : "text-foreground/70 hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30" // Estado inactivo
                            )}
                            title={displayTitle}
                        >
                            {/* Icono principal */}
                            <MessageSquareText className="h-4 w-4 mr-2.5 flex-shrink-0 opacity-80" />
                            {/* Contenedor para t√≠tulo y fecha */}
                            <div className="flex flex-col flex-1 min-w-0">
                                <span className="truncate font-medium text-foreground group-hover:text-foreground">{displayTitle}</span>
                                <span className="text-xs text-muted-foreground/80">{displayDate}</span>
                            </div>
                        </a>
                    </Link>
                    {/* Bot√≥n Eliminar aparece en hover */}
                    <AlertDialogTrigger asChild>
                        <Button
                            variant="ghost" size="icon"
                            className={cn(
                                "absolute right-1.5 top-1/2 -translate-y-1/2 h-7 w-7 p-0 rounded-md",
                                "opacity-0 group-hover:opacity-60 focus-visible:opacity-100 hover:!opacity-100", // Control de opacidad
                                "transition-opacity duration-150 flex-shrink-0",
                                "hover:bg-destructive/10 hover:text-destructive", // Estilo hover
                                isDeleting && chatToDelete?.id === chat.id ? "opacity-50 cursor-not-allowed" : ""
                            )}
                            onClick={(e) => openDeleteConfirmation(chat, e)}
                            aria-label={`Eliminar chat: ${displayTitle}`}
                            disabled={isDeleting && chatToDelete?.id === chat.id}
                        >
                            {isDeleting && chatToDelete?.id === chat.id ? (
                                <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                            ) : (
                                <Trash2 className="h-4 w-4" />
                            )}
                        </Button>
                    </AlertDialogTrigger>
                </div>
            );
        });
    };

    return (
        <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
            <div className="flex flex-col h-full">
                 {/* Header del historial */}
                 <div className="flex justify-between items-center px-2 pt-1 pb-2 border-b shrink-0 mb-1">
                     <h3 className="text-xs font-semibold uppercase text-muted-foreground tracking-wide">
                         Historial
                     </h3>
                     <Button
                         variant="ghost"
                         size="icon" // Cambiado a icon
                         className="h-7 w-7 text-muted-foreground hover:text-foreground" // Tama√±o y color ajustados
                         onClick={() => fetchChatHistory(true)}
                         disabled={isLoading || isAuthLoading}
                         title="Actualizar historial"
                     >
                         <RefreshCw className={cn("h-4 w-4", (isLoading || isAuthLoading) && "animate-spin")} />
                         <span className="sr-only">Actualizar Historial</span>
                     </Button>
                 </div>
                 {/* ScrollArea para el contenido */}
                 <ScrollArea className="flex-1 -mx-2"> {/* Padding negativo para compensar el padding del contenedor padre */}
                     <div className="flex flex-col gap-1 p-2"> {/* Padding interno y gap */}
                         {renderContent()}
                     </div>
                 </ScrollArea>
            </div>

            {/* AlertDialog se mantiene igual */}
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>¬øEst√°s absolutamente seguro?</AlertDialogTitle>
                    <AlertDialogDescription>
                        Esta acci√≥n no se puede deshacer. Esto eliminar√° permanentemente el chat
                        <span className="font-medium"> "{chatToDelete?.title || chatToDelete?.id?.substring(0, 8)}"</span> y todos sus mensajes.
                    </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleDeleteConfirmed}
                        disabled={isDeleting}
                        className={buttonVariants({ variant: "destructive" })}
                    >
                        {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
                        Eliminar Permanentemente
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}
```

## File: `components\chat\chat-input.tsx`
```tsx
// File: components/chat/chat-input.tsx (MODIFICADO - Iteraci√≥n 3.4)
"use client";

import React, { useState, useRef, KeyboardEvent, useEffect } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { SendHorizonal, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  onSendMessage: (message: string) => void;
  isLoading: boolean;
}

export function ChatInput({ onSendMessage, isLoading }: ChatInputProps) {
  const [inputValue, setInputValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleInputChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    setInputValue(event.target.value);
  };

  // Auto-resize logic in useEffect to handle external value changes too (e.g., clearing)
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto'; // Reset height first
      // Set height based on scroll height, but enforce max-height via CSS
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 160)}px`; // 160px = 10rem (max-h-40)
    }
  }, [inputValue]); // Re-run when input value changes

  const handleSubmit = (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    const trimmedValue = inputValue.trim();
    if (trimmedValue && !isLoading) {
      onSendMessage(trimmedValue);
      setInputValue(''); // Clear input after sending
    }
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey && !isLoading) {
      event.preventDefault(); // Prevent newline on Enter
      handleSubmit();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="relative flex items-end space-x-2">
      <Textarea
        ref={textareaRef}
        value={inputValue}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder="Preg√∫ntale a Atenex..."
        className={cn(
            "flex-1 resize-none min-h-[40px] max-h-40", // min/max height
            "py-2 pr-12 pl-3", // Ajuste de padding (m√°s a la derecha para bot√≥n)
            "rounded-lg border border-input", // Estilo de borde
            "text-sm shadow-sm placeholder:text-muted-foreground",
            "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-ring", // Estilo focus
            "disabled:cursor-not-allowed disabled:opacity-50" // Estilo disabled
        )}
        rows={1} // Empezar con una sola fila
        disabled={isLoading}
        aria-label="Entrada de chat"
      />
      {/* Bot√≥n posicionado absolutamente dentro del form */}
      <Button
        type="submit"
        size="icon"
        className={cn(
            "absolute right-2 bottom-2 h-8 w-8 flex-shrink-0 rounded-lg", // Posici√≥n y tama√±o
            "transition-colors duration-150"
        )}
        disabled={isLoading || !inputValue.trim()}
        aria-label="Enviar mensaje"
      >
        {isLoading ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </form>
  );
}
```

## File: `components\chat\chat-interface.tsx`
```tsx
// File: components/chat/chat-interface.tsx
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ChatInput } from './chat-input';
import { ChatMessage, Message } from './chat-message';
import { RetrievedDocumentsPanel } from './retrieved-documents-panel';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { postQuery, RetrievedDoc, ApiError } from '@/lib/api';
import { toast } from "sonner";
import { PanelRightClose, PanelRightOpen, BrainCircuit, FileText } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import { isGreeting, isMetaQuery, getMetaResponse } from '@/lib/utils';

interface ChatInterfaceProps {
  chatId?: string; // Receive chatId from the page
}

const initialMessages: Message[] = [
  { id: 'initial-1', role: 'assistant', content: 'Hello! How can I help you query your knowledge base today?' },
];

export function ChatInterface({ chatId }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [retrievedDocs, setRetrievedDocs] = useState<RetrievedDoc[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPanelOpen, setIsPanelOpen] = useState(false); // Oculta panel por defecto
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  // Load chat history based on chatId (placeholder)
  useEffect(() => {
    // Reset state for new/different chat
    setMessages(initialMessages);
    setRetrievedDocs([]);
    setIsLoading(false);

    if (chatId) {
      console.log(`Loading history for chat: ${chatId}`);
      // Load messages from local storage
      const storedMessages = localStorage.getItem(`chat-${chatId}`);
      if (storedMessages) {
        try {
          const parsedMessages = JSON.parse(storedMessages);
          setMessages(parsedMessages);
        } catch (error) {
          console.error("Error parsing chat history from local storage:", error);
          // Handle error (e.g., clear local storage or show an error message)
        }
      } else {
          setMessages([ // Dummy loading
            { id: 'initial-1', role: 'assistant', content: `Welcome back to chat ${chatId}. Ask me anything!` }
          ]);
      }
    } else {
      // New chat
      setMessages(initialMessages);
    }
  }, [chatId]);

  // Save chat history to localStorage
  useEffect(() => {
    if (chatId) {
      try {
        localStorage.setItem(`chat-${chatId}`, JSON.stringify(messages));
      } catch (error) {
        console.error("Error saving chat history to local storage:", error);
        // Handle error (e.g., show an error message)
      }
    }
  }, [chatId, messages]);

  // Scroll to bottom when messages change
  useEffect(() => {
    if (scrollAreaRef.current) {
        // Added timeout to ensure DOM updates are flushed before scrolling
        setTimeout(() => {
            if (scrollAreaRef.current) {
                scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }
  }, [messages]);

  const handleSendMessage = useCallback(async (query: string) => {
    const text = query.trim();
    if (!text || isLoading) return;

    // Local greeting
    if (isGreeting(text)) {
      setMessages(prev => [...prev, { id: `assistant-${Date.now()}`, role: 'assistant', content: '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?' } as Message]);
      return;
    }

    // Local meta query
    if (isMetaQuery(text)) {
      setMessages(prev => [...prev, { id: `assistant-meta-${Date.now()}`, role: 'assistant', content: getMetaResponse() } as Message]);
      return;
    }

    const userMessage: Message = { id: `user-${Date.now()}`, role: 'user', content: text };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setRetrievedDocs([]); // Clear previous docs

    try {
      const response = await postQuery({ query: text });
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: 'assistant',
        content: response.answer,
        sources: response.retrieved_documents, // Attach sources to the message
      };
      setMessages(prev => [...prev, assistantMessage]);
      setRetrievedDocs(response.retrieved_documents || []);
      if (response.retrieved_documents && response.retrieved_documents.length > 0 && !isPanelOpen) {
         setIsPanelOpen(true); // Auto-open panel if closed and docs were retrieved
      }
    } catch (error) {
      console.error("Query failed:", error);
      let errorMessage = "Sorry, I encountered an error trying to answer your question.";
       if (error instanceof ApiError && error.message) {
           errorMessage = `Error: ${error.message}`;
       } else if (error instanceof Error && error.message) {
           errorMessage = `Error: ${error.message}`;
       }

      const errorMessageObj: Message = { id: `error-${Date.now()}`, role: 'assistant', content: errorMessage, isError: true };
      setMessages(prev => [...prev, errorMessageObj]);

      toast.error("Query Failed", {
        description: errorMessage,
      });

    } finally {
      setIsLoading(false);
    }
  }, [isLoading, isPanelOpen]); // Add isPanelOpen dependency

  const handlePanelToggle = () => {
        setIsPanelOpen(!isPanelOpen);
    };

  return (
     <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-theme(space.16))] transition-all duration-300 ease-in-out"> {/* Adjust height based on header */}
            <ResizablePanel defaultSize={isPanelOpen ? 70 : 100} minSize={50} className="transition-all duration-300 ease-in-out">
                <div className="flex h-full flex-col">
                    {/* Button to toggle panel */}
                    <div className="absolute top-2 right-2 z-10">
                        <Button onClick={handlePanelToggle} variant="ghost" size="icon">
                            {isPanelOpen ? <PanelRightClose className="h-5 w-5" /> : <PanelRightOpen className="h-5 w-5" />}
                            <span className="sr-only">{isPanelOpen ? 'Close Sources Panel' : 'Open Sources Panel'}</span>
                        </Button>
                    </div>

                    <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
                        <div className="space-y-4 pr-4"> {/* Add padding right */}
                            {messages.map(message => (
                                <ChatMessage key={message.id} message={message} />
                            ))}
                            {isLoading && messages[messages.length - 1]?.role === 'user' && (
                                <div className="flex items-start space-x-3">
                                     <Skeleton className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                          <BrainCircuit className="h-5 w-5 text-primary"/>
                                     </Skeleton>
                                    <div className="space-y-2 flex-1">
                                        <Skeleton className="h-4 w-3/4" />
                                        <Skeleton className="h-4 w-1/2" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </ScrollArea>

                    <div className="border-t p-4 bg-muted/30">
                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            </ResizablePanel>

            {isPanelOpen && (
                <>
                    <ResizableHandle withHandle />
                    <ResizablePanel defaultSize={30} minSize={20} maxSize={40} className="transition-all duration-300 ease-in-out">
                        <RetrievedDocumentsPanel documents={retrievedDocs} isLoading={isLoading && messages[messages.length - 1]?.role === 'user'} />
                    </ResizablePanel>
                </>
            )}
        </ResizablePanelGroup>
  );
}
```

## File: `components\chat\chat-message.tsx`
```tsx
// File: components/chat/chat-message.tsx (REFACTORIZADO - Fuentes mejoradas)
import React from 'react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { User, BrainCircuit, AlertTriangle, FileText, CircleDot } from 'lucide-react'; // A√±adido CircleDot
import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import type { RetrievedDoc } from '@/lib/api';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from "@/components/ui/tooltip"
// import { Badge } from '@/components/ui/badge'; // Badge ya no se usa para fuentes

export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: RetrievedDoc[];
  isError?: boolean;
  created_at?: string;
}

interface ChatMessageProps {
  message: Message;
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.isError ?? false;

  return (
    <div className={cn(
        'flex w-full items-start gap-3',
        isUser ? 'justify-end pl-10 sm:pl-16' : 'pr-10 sm:pr-16'
    )}>
      {!isUser && (
        <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground">
                {isError ? <AlertTriangle className="h-5 w-5 text-destructive" /> : <BrainCircuit className="h-5 w-5" /> }
           </AvatarFallback>
        </Avatar>
      )}

      <div
        className={cn(
          'max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-lg'
            : isError
              ? 'bg-destructive/10 text-destructive-foreground border border-destructive/30 rounded-bl-lg'
              : 'bg-muted text-foreground rounded-bl-lg'
        )}
      >
         {/* Contenido Markdown */}
         {/* Asegurar que prose tenga los estilos correctos definidos en tailwind.config y globals.css */}
         {/* FLAG_LLM: Aplicar prose al div exterior, no al componente Markdown */}
         <div className="prose prose-sm dark:prose-invert max-w-none break-words prose-p:leading-relaxed prose-ul:my-2 prose-ol:my-2 prose-pre:my-2 prose-blockquote:my-2">
            <Markdown remarkPlugins={[remarkGfm]}>
                {message.content}
            </Markdown>
         </div>

         {/* Secci√≥n de Fuentes (REDISE√ëADA) */}
         {!isUser && !isError && message.sources && message.sources.length > 0 && (
            <div className="mt-3 pt-2.5 border-t border-border/40">
                <p className="text-xs font-medium text-muted-foreground mb-2">Fuentes:</p>
                {/* Usar flex-wrap para las fuentes */}
                <div className="flex flex-wrap items-center gap-x-2 gap-y-1.5"> {/* Ajuste de gap */}
                 {message.sources.map((doc, index) => (
                    <TooltipProvider key={doc.id || `source-${index}`} delayDuration={150}>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                {/* Bot√≥n peque√±o con n√∫mero */}
                                <Button
                                    variant="outline"
                                    size="sm" // Bot√≥n m√°s peque√±o
                                    className="h-6 w-6 px-1 py-0 rounded-full border-dashed hover:border-solid hover:bg-accent/50 cursor-default flex items-center justify-center focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                    onClick={(e) => {e.preventDefault();}} // No hacer nada en click, solo tooltip
                                    tabIndex={0} // Make it focusable
                                    aria-label={`Fuente ${index + 1}: ${doc.file_name || 'Detalles'}`}
                                >
                                    {/* N√∫mero de fuente */}
                                    <span className="text-xs font-mono text-muted-foreground">{index + 1}</span>
                                </Button>
                            </TooltipTrigger>
                            {/* Tooltip mejorado con fondo popover */}
                            <TooltipContent
                                side="bottom"
                                className="max-w-xs text-xs p-2 shadow-lg bg-popover text-popover-foreground" // Asegura fondo popover
                                sideOffset={4}
                            >
                                <p className="font-medium mb-0.5 break-words">
                                    <FileText className="inline-block h-3 w-3 mr-1 align-text-top" />
                                    {doc.file_name || 'Nombre no disponible'}
                                </p>
                                <p className="text-muted-foreground text-[11px] mb-1.5 break-all">
                                   ID Doc: {doc.document_id ? `${doc.document_id.substring(0, 8)}...` : 'N/D'} / Frag: {doc.id.substring(0, 8)}...
                                </p>
                                {doc.score != null && (
                                    <p className="font-medium text-muted-foreground text-[11px]">
                                        Score: <span className="font-normal">{doc.score.toFixed(4)}</span>
                                    </p>
                                )}
                                {doc.content_preview && (
                                    <p className="mt-1.5 pt-1.5 border-t border-border/50 font-medium text-[11px]">
                                        Vista previa:
                                        <span className="block font-normal text-muted-foreground line-clamp-3">{doc.content_preview}</span>
                                    </p>
                                )}
                            </TooltipContent>
                        </Tooltip>
                   </TooltipProvider>
                 ))}
                </div>
            </div>
         )}
      </div>

      {isUser && (
         <Avatar className="h-8 w-8 border flex-shrink-0 bg-card text-foreground">
           <AvatarFallback className="bg-transparent text-muted-foreground"><User className="h-5 w-5" /></AvatarFallback>
         </Avatar>
      )}
    </div>
  );
}
```

## File: `components\chat\retrieved-documents-panel.tsx`
```tsx
// File: components/chat/retrieved-documents-panel.tsx (REFACTORIZADO - Mejor dise√±o y Modal m√°s grande)
import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { FileText, Info, Star, Download, Loader2, Eye, X } from 'lucide-react'; // Iconos a√±adidos y X para cerrar modal
import { RetrievedDoc } from '@/lib/api';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
    DialogFooter,
    DialogClose // Importar DialogClose
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { cn } from '@/lib/utils';

interface RetrievedDocumentsPanelProps {
  documents: RetrievedDoc[];
  isLoading: boolean;
}

export function RetrievedDocumentsPanel({ documents, isLoading }: RetrievedDocumentsPanelProps) {
    const [selectedDoc, setSelectedDoc] = useState<RetrievedDoc | null>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);

    const handleViewDocument = (doc: RetrievedDoc) => {
        setSelectedDoc(doc);
        setIsDialogOpen(true);
    };

    const handleDownloadDocument = (doc: RetrievedDoc) => {
        const message = `Descarga solicitada para: ${doc.file_name || doc.id}`;
        console.log(message);
        toast.info("Descarga No Implementada", {
             description: `El endpoint de backend para descargar '${doc.file_name || doc.id}' a√∫n no est√° disponible.`,
             action: { label: "Cerrar", onClick: () => {} },
        });
    };

    // Componente para renderizar estrellas de score
    const ScoreStars = ({ score }: { score: number | null | undefined }) => {
      if (score == null || score < 0) return null;
      const numStars = Math.max(0, Math.min(5, Math.round(score * 5)));
      return (
        <div className="flex items-center gap-0.5" title={`Score: ${score.toFixed(3)}`}>
          {[...Array(5)].map((_, i) => (
            <Star key={i} className={cn("h-3 w-3", i < numStars ? "fill-yellow-400 text-yellow-500" : "fill-muted text-muted-foreground/50")} />
          ))}
        </div>
      );
    };

  return (
    // FLAG_LLM: Usar Dialog, no AlertDialog. Se controla con isDialogOpen state.
    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <div className="flex h-full flex-col border-l bg-muted/10 dark:bg-muted/20">
            {/* Header del panel */}
            <CardHeader className="sticky top-0 z-10 border-b bg-background p-4 shadow-sm">
                <CardTitle className="text-base font-semibold flex items-center gap-2">
                    <FileText className="h-5 w-5 text-primary" /> Fuentes Relevantes
                </CardTitle>
                <CardDescription className="text-xs mt-1">
                    Documentos utilizados para generar la respuesta.
                </CardDescription>
            </CardHeader>

            {/* Contenedor scrollable */}
            <ScrollArea className="flex-1">
                <div className="p-3 space-y-2">
                    {/* Estado de Carga con Skeleton */}
                    {isLoading && documents.length === 0 && (
                        <div className='space-y-2'>
                            {[...Array(3)].map((_, i) => (
                                <Card key={`skel-${i}`} className="p-3 border border-border/50 bg-card opacity-70">
                                    <div className="flex justify-between items-center mb-1.5">
                                        <Skeleton className="h-4 w-3/4 rounded" />
                                        <Skeleton className="h-3 w-8 rounded-sm" />
                                    </div>
                                    <Skeleton className="h-3 w-full rounded" />
                                    <Skeleton className="h-3 w-1/2 rounded mt-1" />
                                    <div className="flex justify-between items-center mt-2">
                                        <Skeleton className="h-2.5 w-16 rounded" />
                                        <Skeleton className="h-3 w-3 rounded" />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                    {/* Estado Vac√≠o */}
                    {!isLoading && documents.length === 0 && (
                        <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 min-h-[200px]">
                            <Info className="h-8 w-8 mb-3 opacity-50" />
                            <p className="text-sm font-medium mb-1">Sin Fuentes</p>
                            <p className="text-xs">No se encontraron fuentes espec√≠ficas para la √∫ltima consulta.</p>
                        </div>
                    )}
                    {/* Lista de Documentos */}
                    {documents.map((doc, index) => (
                        // FLAG_LLM: El Card ahora es el DialogTrigger
                        <DialogTrigger asChild key={doc.id || `doc-${index}`}>
                            <Card
                                className={cn(
                                    "cursor-pointer transition-all duration-150 bg-card",
                                    "border border-border hover:border-primary/40 hover:shadow-md focus-visible:ring-1 focus-visible:ring-ring focus-visible:border-primary/40"
                                )}
                                onClick={() => handleViewDocument(doc)}
                                onKeyDown={(e) => e.key === 'Enter' && handleViewDocument(doc)}
                                tabIndex={0}
                                title={`Ver detalles de: ${doc.file_name || 'documento'}`}
                            >
                                <CardContent className="p-3 space-y-1 text-sm">
                                    {/* Header: Nombre archivo y Score */}
                                    <div className="flex justify-between items-start gap-2">
                                        <p className="font-medium text-foreground/95 truncate flex-1 flex items-center gap-1.5">
                                             {/* N√∫mero √≠ndice */}
                                            <span className="flex-shrink-0 h-5 w-5 flex items-center justify-center text-xs font-mono bg-muted text-muted-foreground rounded-full border">
                                                {index + 1}
                                            </span>
                                            <span className="truncate" title={doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}>
                                                {doc.file_name || `Fragmento ${doc.id.substring(0, 8)}`}
                                            </span>
                                        </p>
                                        <ScoreStars score={doc.score} />
                                    </div>
                                    {/* Preview */}
                                    <p className="text-xs text-muted-foreground line-clamp-2 leading-relaxed pl-7"> {/* Indentado */}
                                        {doc.content_preview || <span className="italic opacity-70">Vista previa no disponible.</span>}
                                    </p>
                                    {/* Footer: IDs y Bot√≥n View */}
                                     <div className="text-[10px] text-muted-foreground/70 pt-1.5 flex justify-between items-center font-mono pl-7"> {/* Indentado */}
                                        <span>ID: {doc.document_id?.substring(0, 8) ?? doc.id.substring(0, 8)}...</span>
                                        <Eye className="h-3 w-3" />
                                    </div>
                                </CardContent>
                            </Card>
                        </DialogTrigger>
                    ))}
                </div>
            </ScrollArea>

            {/* FLAG_LLM: Contenido del Dialog (Modal) m√°s grande y con m√°s info */}
            {selectedDoc && (
                 <DialogContent className="sm:max-w-2xl lg:max-w-3xl grid-rows-[auto_minmax(0,1fr)_auto] max-h-[85vh] p-0"> {/* Tama√±o aumentado y sin padding inicial */}
                    <DialogHeader className="px-6 pt-6 pb-4 border-b"> {/* Padding y borde */}
                        <DialogTitle className="truncate text-lg flex items-center gap-2" title={selectedDoc.file_name || selectedDoc.document_id || 'Detalles del Documento'}>
                            <FileText className="inline-block h-5 w-5 align-text-bottom text-primary" />
                            {selectedDoc.file_name || 'Detalles del Documento'}
                        </DialogTitle>
                        {/* Metadatos resumidos bajo el t√≠tulo */}
                        <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground pt-1">
                            <span>ID Doc: <span className="font-mono text-[11px]">{selectedDoc.document_id?.substring(0,12) || 'N/D'}...</span></span>
                            <span>ID Frag: <span className="font-mono text-[11px]">{selectedDoc.id}</span></span>
                            <span>Score: <span className="font-medium">{selectedDoc.score?.toFixed(4) ?? 'N/D'}</span></span>
                        </div>
                    </DialogHeader>
                    {/* Contenido Scrolleable */}
                    <ScrollArea className="overflow-y-auto px-6 py-4 max-h-[calc(85vh-180px)]"> {/* Altura m√°xima calculada */}
                         <div className="space-y-4 text-sm">
                            <div>
                                <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Contenido Relevante (Vista Previa Completa):</Label>
                                <blockquote className="mt-1 border-l-4 pl-4 text-sm text-foreground/80 max-h-[300px] overflow-y-auto pretty-scrollbar whitespace-pre-wrap break-words"> {/* Blockquote estilizado y pre-wrap */}
                                    {selectedDoc.content || <span className="italic opacity-70">Contenido no disponible.</span>}
                                </blockquote>
                            </div>
                            {/* Metadatos si existen */}
                            {selectedDoc.metadata && Object.keys(selectedDoc.metadata).length > 0 && (
                                 <div>
                                    <Label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Metadatos:</Label>
                                    <pre className="mt-1 max-h-[150px] w-full overflow-auto rounded-md border bg-muted/30 p-3 text-[11px] font-mono whitespace-pre-wrap break-all pretty-scrollbar">
                                        {JSON.stringify(selectedDoc.metadata, null, 2)}
                                    </pre>
                                </div>
                            )}
                         </div>
                     </ScrollArea>
                    <DialogFooter className="sm:justify-between px-6 py-4 border-t bg-muted/30"> {/* Padding y borde */}
                        {/* Bot√≥n Descarga */}
                        <Button variant="outline" size="sm" onClick={() => handleDownloadDocument(selectedDoc)} disabled={!selectedDoc.file_name}> {/* Deshabilitado si no hay nombre */}
                            <Download className="mr-2 h-4 w-4" />Descargar Original {selectedDoc.file_name ? '' : '(N/D)'}
                        </Button>
                        {/* Bot√≥n Cerrar expl√≠cito */}
                        <DialogClose asChild><Button variant="secondary" size="sm">Cerrar</Button></DialogClose>
                    </DialogFooter>
                </DialogContent>
            )}
        </div>
        {/* Estilos para scrollbar bonito (opcional, a√±adir a globals.css si se quiere) */}
        <style jsx global>{`
            .pretty-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
            .pretty-scrollbar::-webkit-scrollbar-track { background: hsl(var(--muted) / 0.3); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 3px; }
            .pretty-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary) / 0.7); }
        `}</style>
    </Dialog>
  );
}

// Helper Label component (si no existe globalmente)
const Label = ({ className, children, ...props }: React.LabelHTMLAttributes<HTMLLabelElement>) => (
    <label className={cn("block text-sm font-medium text-foreground", className)} {...props}>
        {children}
    </label>
);
```

## File: `components\icons\atenex-logo.tsx`
```tsx
// File: components/icons/atenex-logo.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AtenexLogoIconProps extends React.SVGProps<SVGSVGElement> {
  // No necesita props adicionales por ahora, pero se pueden a√±adir si es necesario
}

// Renombrado a AtenexLogoIcon para diferenciarlo del componente wrapper si se creara
export default function AtenexLogoIcon({ className, ...props }: AtenexLogoIconProps) {
  // El SVG proporcionado no tiene fondo negro ni borde redondeado intr√≠nseco.
  // Se aplica fill="currentColor" para que herede el color del texto (ej. text-primary).
  // Eliminamos el style inline de background y border-radius.
  return (
    <svg
      // Tama√±o por defecto, puede ser sobrescrito por props o clases
      width="64"
      height="64"
      viewBox="0 0 1024 1024"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" // Hereda color del contexto (ej. text-primary)
      className={cn(className)} // Permite pasar clases personalizadas
      {...props} // Pasa cualquier otra prop SVG (width, height, etc.)
    >
      <g
        transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"
        // fill se establece en el SVG principal para heredar
        stroke="none"
      >
         {/* El path data del SVG original */}
         <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5638 3284 c31 -22 60 -82 132 -279 122 -333 876 -2402 1131 -3105 291 -802 374 -1020 466 -1230 186 -423 345 -594 602 -647 85 -17 121 -42 121 -83 0 -16 -11 -37 -26 -51 l-26 -24 -866 -3 c-609 -2 -882 0 -918 8 -63 13 -87 37 -82 81 3 32 4 33 75 45 137 23 224 78 270 172 26 53 28 65 27 182 0 109 -4 141 -33 250 -28 102 -310 887 -419 1164 -48 122 46 111 -910 111 -781 0 -829 -1 -864 -18 -42 -21 -35 -9 -98 -192 -27 -77 -105 -304 -174 -505 -194 -561 -237 -768 -186 -903 47 -124 143 -202 299 -244 116 -31 140 -66 82 -124 l-29 -29 -749 0 c-807 0 -775 -2 -803 51 -22 40 5 61 125 94 73 20 195 81 290 143 99 66 249 220 324 332 71 106 188 341 249 500 48 125 277 787 316 915 26 83 33 95 89 150 69 67 177 128 300 170 153 51 217 55 910 55 514 0 639 3 643 13 4 12 -123 378 -349 1002 -58 160 -137 380 -175 490 -100 285 -191 534 -202 556 -22 40 -37 19 -74 -98 -203 -646 -480 -1431 -568 -1607 -36 -71 -103 -145 -180 -197 -31 -21 -137 -81 -235 -132 -203 -106 -258 -141 -326 -209 -93 -93 -126 -224 -98 -391 l13 -72 -50 -130 c-27 -71 -76 -203 -107 -292 -32 -90 -61 -163 -65 -163 -4 0 -49 42 -100 93 -203 202 -302 423 -303 672 -1 280 109 522 321 705 87 76 178 132 425 267 117 64 241 135 277 158 82 55 186 159 230 231 39 65 373 909 501 1269 104 292 132 410 127 540 -2 72 -8 100 -28 140 -22 44 -31 52 -72 65 -27 8 -48 21 -48 28 0 24 21 53 53 72 30 19 53 20 387 20 307 0 359 -2 378 -16z m-1103 -569 c50 -13 116 -35 149 -49 47 -21 57 -29 51 -43 -4 -10 -41 -113 -82 -229 l-75 -212 -36 10 c-65 19 -200 13 -267 -11 -93 -33 -122 -63 -192 -196 -89 -170 -115 -187 -378 -246 -96 -21 -189 -45 -207 -52 -18 -8 -66 -42 -107 -76 -122 -102 -188 -127 -372 -138 l-96 -6 -27 -43 c-56 -88 -157 -153 -243 -157 -48 -2 -103 17 -103 35 0 5 22 6 49 2 86 -11 181 37 242 121 20 28 40 45 53 45 13 0 5 8 -24 23 -59 29 -94 91 -94 163 0 55 8 68 135 219 33 39 77 113 124 210 46 95 86 163 109 186 21 21 102 70 189 115 84 43 231 124 328 180 97 55 196 108 219 118 159 64 466 78 655 31z m65 -3330 c455 -100 559 -132 688 -209 187 -111 320 -249 399 -411 58 -122 77 -219 70 -360 -14 -264 -88 -429 -281 -620 -133 -132 -223 -188 -501 -309 -366 -161 -479 -258 -479 -416 -1 -155 93 -222 310 -222 112 1 229 27 419 94 203 72 324 98 485 105 173 7 268 -10 395 -72 78 -37 183 -111 173 -121 -2 -1 -44 11 -93 29 -87 30 -96 31 -250 31 -233 0 -264 -10 -643 -209 -278 -146 -547 -190 -772 -125 -166 48 -332 168 -405 294 -84 145 -85 344 -2 500 40 76 156 199 266 282 46 34 161 106 255 160 302 172 397 247 454 360 77 152 63 294 -39 391 -140 133 -479 227 -851 234 -54 2 -98 5 -98 8 0 10 207 629 214 640 4 6 12 8 19 6 7 -2 127 -29 267 -60z"/>
         <path d="M3340 7268 c0 -12 -21 -64 -46 -116 -32 -67 -54 -98 -75 -110 -67 -39 -14 -39 133 0 63 16 84 27 108 55 28 32 95 152 88 158 -8 6 -154 35 -179 35 -23 0 -29 -4 -29 -22z"/>
      </g>
    </svg>
  );
}
```

## File: `components\knowledge\document-status-list.tsx`
```tsx
// File: components/knowledge/document-status-list.tsx (CORREGIDO - Usa document_id consistentemente)
"use client";

import React from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button, buttonVariants } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import {
    AlertCircle, Loader2, RefreshCw, Trash2, Info,
    FileClock, FileCheck2, FileX2, FileQuestion, Download, AlertTriangle // Iconos
} from 'lucide-react';
// FLAG_LLM: Importa la interfaz correcta con document_id
import { DocumentStatusResponse, AuthHeaders, deleteIngestDocument, retryIngestDocument } from '@/lib/api';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
    AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
    AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
    AlertDialogTrigger
} from "@/components/ui/alert-dialog";
import { Skeleton } from '@/components/ui/skeleton';

// Mapeo de estado (sin cambios)
const statusMap: { [key: string]: { icon: React.ComponentType<{ className?: string }>, text: string, className: string, animate: boolean, description: string } } = {
    uploaded:   { icon: FileClock, text: 'En Cola', className: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-300 dark:bg-blue-900/30 dark:border-blue-700', animate: true, description: "Esperando para ser procesado." },
    processing: { icon: Loader2, text: 'Procesando', className: 'text-orange-600 bg-orange-100 border-orange-200 dark:text-orange-300 dark:bg-orange-900/30 dark:border-orange-700', animate: true, description: "Extrayendo texto y generando vectores..." },
    processed:  { icon: FileCheck2, text: 'Procesado', className: 'text-green-600 bg-green-100 border-green-200 dark:text-green-300 dark:bg-green-900/30 dark:border-green-700', animate: false, description: "Listo para ser consultado." },
    error:      { icon: FileX2, text: 'Error', className: 'text-red-600 bg-red-100 border-red-200 dark:text-red-300 dark:bg-red-900/30 dark:border-red-700', animate: false, description: "Hubo un problema durante el procesamiento." },
    default:    { icon: FileQuestion, text: 'Desconocido', className: 'text-gray-600 bg-gray-100 border-gray-200 dark:text-gray-400 dark:bg-gray-700/30 dark:border-gray-600', animate: false, description: "Estado no reconocido." }
};

// FLAG_LLM: Renombrado para claridad, usa la interfaz de frontend
type DocumentStatus = DocumentStatusResponse;

export interface DocumentStatusListProps {
  documents: DocumentStatus[];
  authHeaders: AuthHeaders;
  onRetrySuccess: (documentId: string) => void;
  fetchMore: () => void;
  hasMore: boolean;
  refreshDocument: (documentId: string) => void;
  onDeleteSuccess: (documentId: string) => void;
  isLoading: boolean;
}

export function DocumentStatusList({
    documents,
    authHeaders,
    onRetrySuccess,
    fetchMore,
    hasMore,
    refreshDocument,
    onDeleteSuccess,
    isLoading
}: DocumentStatusListProps) {
  const [deletingDocId, setDeletingDocId] = React.useState<string | null>(null);
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [isRetrying, setIsRetrying] = React.useState<string | null>(null);
  const [isRefreshing, setIsRefreshing] = React.useState<string | null>(null);

  // --- Handlers (con validaciones, usan document_id) ---
  const handleRetry = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para reintento:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (!authHeaders || isRetrying) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRetrying(documentId);
    const toastId = toast.loading(`Reintentando ingesta para "${displayId}"...`);
    try { await retryIngestDocument(documentId, authHeaders); toast.success("Reintento Iniciado", { id: toastId, description: `El documento "${displayId}" se est√° procesando de nuevo.` }); onRetrySuccess(documentId); }
    catch (error: any) { const errorMsg = error instanceof Error ? error.message : 'Error desconocido'; toast.error("Error al Reintentar", { id: toastId, description: `No se pudo reintentar la ingesta para "${displayId}": ${errorMsg}` }); }
    finally { setIsRetrying(null); }
  };

  const handleRefresh = async (documentId: string, fileName?: string | null) => {
    if (!documentId || typeof documentId !== 'string') { console.error("Error: ID de documento inv√°lido para refrescar:", documentId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
    if (isRefreshing) return;
    const displayId = fileName || documentId.substring(0, 8) + "..."; setIsRefreshing(documentId);
    const toastId = toast.info(`Actualizando estado de "${displayId}"...`); // Usar toastId para actualizar
    try { await refreshDocument(documentId); toast.success("Estado Actualizado", { id: toastId, description: `Se actualiz√≥ el estado de "${displayId}".` }); } // Actualizar toast
    catch (error) { toast.error("Error al Actualizar", { id: toastId, description: `No se pudo actualizar el estado de "${displayId}".` }); } // Actualizar toast en error
    finally { setIsRefreshing(null); }
  };

    const handleDownload = (doc: DocumentStatus) => {
        if (!doc || !doc.document_id) { console.error("Error: datos de documento inv√°lidos para descarga:", doc); toast.error("Error Interno", { description: "Informaci√≥n del documento incompleta." }); return; }
        toast.info("Descarga No Implementada", { description: `La funcionalidad para descargar "${doc.file_name || doc.document_id}" a√∫n no est√° disponible.` });
        console.log("Download requested for:", doc.document_id);
    };

  const openDeleteConfirmation = (docId: string) => {
       if (!docId || typeof docId !== 'string') { console.error("Error: ID inv√°lido para confirmaci√≥n de eliminaci√≥n:", docId); toast.error("Error Interno", { description: "ID de documento faltante." }); return; }
       setDeletingDocId(docId);
    };
  const closeDeleteConfirmation = () => { if (!isDeleting) setDeletingDocId(null); };

  const handleDeleteConfirmed = async () => {
    if (!deletingDocId || !authHeaders || isDeleting) return;
    // FLAG_LLM: Buscar usando document_id
    const docToDelete = documents.find(d => d.document_id === deletingDocId);
    const display = docToDelete?.file_name || deletingDocId.substring(0, 8) + '...';
    // --- LOG DETALLADO DE ORIGEN DE BORRADO ---
    const now = new Date().toISOString();
    let userInfo = '';
    try {
      // Si tienes acceso a usuario en contexto/props, incl√∫yelo aqu√≠
      if (authHeaders && (authHeaders['X-User-ID'] || authHeaders['X-Company-ID'])) {
        userInfo = `UserID: ${authHeaders['X-User-ID'] || ''}, CompanyID: ${authHeaders['X-Company-ID'] || ''}`;
      }
    } catch {}
    // Stack trace
    const stack = (new Error('StackTrace (origen handleDeleteConfirmed)')).stack;
    // Log en consola
    console.error('[AUDIT][DELETE_DOCUMENT]', {
      timestamp: now,
      user: userInfo,
      document_id: deletingDocId,
      file_name: docToDelete?.file_name,
      status: docToDelete?.status,
      location: 'components/knowledge/document-status-list.tsx:handleDeleteConfirmed',
      stack,
      context: {
        docToDelete,
        authHeaders,
      }
    });
    setIsDeleting(true);
    const toastId = toast.loading(`Eliminando "${display}"...`);
    try {
      await deleteIngestDocument(deletingDocId, authHeaders);
      onDeleteSuccess(deletingDocId);
      toast.success('Documento Eliminado', { id: toastId, description: `"${display}" ha sido eliminado.` });
      closeDeleteConfirmation();
    } catch (e: any) {
      const errorMsg = e instanceof Error ? e.message : 'Error desconocido';
      toast.error('Error al Eliminar', { id: toastId, description: `No se pudo eliminar "${display}": ${errorMsg}` });
    } finally {
      setIsDeleting(false);
    }
  };

  // --- Renderizado ---
  if (!isLoading && documents.length === 0) {
    return ( <div className="flex flex-col items-center justify-center text-center text-muted-foreground py-10 px-4 border-2 border-dashed rounded-lg bg-muted/30 mt-4 min-h-[150px]"> <Info className="h-8 w-8 mb-3 opacity-50"/> <p className="text-sm font-medium mb-1">Sin Documentos</p> <p className="text-xs">A√∫n no se han subido documentos.</p> </div> );
  }

  return (
      <TooltipProvider>
        <div className="border rounded-lg overflow-hidden shadow-sm bg-card">
          <Table className='w-full text-sm'>
            <TableHeader>
              <TableRow className="border-b bg-muted/50 hover:bg-muted/50">
                <TableHead className="w-[40%] pl-3 pr-2 py-2">Nombre Archivo</TableHead>
                <TableHead className="w-[15%] px-2 py-2">Estado</TableHead>
                <TableHead className="w-[10%] text-center px-2 py-2 hidden sm:table-cell">Chunks</TableHead>
                <TableHead className="w-[15%] px-2 py-2 hidden md:table-cell">Actualizaci√≥n</TableHead>
                <TableHead className="w-[20%] text-right pr-3 pl-2 py-2">Acciones</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {documents.map((doc) => {
                 // FLAG_LLM: Comprobar document_id que es el esperado por el frontend
                if (!doc || !doc.document_id) {
                    // No mostrar el warning en producci√≥n, solo omitir
                    if (process.env.NODE_ENV === 'development') {
                         console.warn("Documento inv√°lido (sin document_id) omitido:", doc);
                    }
                    return null;
                }

                const statusInfo = statusMap[doc.status] || statusMap.default;
                const Icon = statusInfo.icon;
                const isCurrentlyRetrying = isRetrying === doc.document_id;
                const isCurrentlyRefreshing = isRefreshing === doc.document_id;
                const isActionDisabled = isCurrentlyRetrying || isCurrentlyRefreshing;

                const dateToShow = doc.last_updated; // Usar last_updated que viene mapeado
                const displayDate = dateToShow ? new Date(dateToShow).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short'}) : 'N/D';
                const displayFileName = doc.file_name || `ID: ${doc.document_id.substring(0, 12)}...`;
                const displayChunks = doc.milvus_chunk_count ?? doc.chunk_count ?? '-';

                return (
                    // FLAG_LLM: Usar doc.document_id como key
                    <TableRow key={doc.document_id} className="group hover:bg-accent/30 data-[state=selected]:bg-accent">
                        <TableCell className="font-medium text-foreground/90 max-w-[150px] sm:max-w-xs lg:max-w-sm xl:max-w-md truncate pl-3 pr-2 py-1.5" title={displayFileName}>{displayFileName}</TableCell>
                        <TableCell className="px-2 py-1.5">
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                    <Badge variant='outline' className={cn("border text-[11px] font-medium whitespace-nowrap py-0.5 px-1.5 cursor-default", statusInfo.className)}>
                                        <Icon className={cn("h-3 w-3 mr-1", statusInfo.animate && "animate-spin")} />
                                        {statusInfo.text}
                                    </Badge>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={5} className="max-w-xs break-words p-2 text-xs shadow-lg">
                                    <p>{statusInfo.description}</p>
                                    {doc.status === 'error' && doc.error_message && <p className='mt-1 pt-1 border-t text-destructive'>Error: {doc.error_message}</p>}
                                </TooltipContent>
                            </Tooltip>
                        </TableCell>
                        <TableCell className="text-center text-muted-foreground text-xs px-2 py-1.5 hidden sm:table-cell">{displayChunks}</TableCell>
                        <TableCell className="text-muted-foreground text-xs px-2 py-1.5 hidden md:table-cell">{displayDate}</TableCell>
                        <TableCell className="text-right space-x-1 pr-3 pl-2 py-1">
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                    <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleDownload(doc)} aria-label="Descargar documento original" disabled={isActionDisabled || !doc.minio_exists}> <Download className="h-4 w-4" /> </Button>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={6}><p>Descargar (N/D)</p></TooltipContent>
                            </Tooltip>
                            {doc.status === 'error' && (
                                <Tooltip delayDuration={100}>
                                    <TooltipTrigger asChild>
                                        {/* FLAG_LLM: Pasar doc.document_id */}
                                        <Button variant="ghost" size="icon" className="h-7 w-7 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30" onClick={() => handleRetry(doc.document_id, doc.file_name)} aria-label="Reintentar ingesta" disabled={isActionDisabled}> {isCurrentlyRetrying ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                                    </TooltipTrigger>
                                    <TooltipContent side="top" sideOffset={6}><p>Reintentar</p></TooltipContent>
                                </Tooltip>
                            )}
                            <Tooltip delayDuration={100}>
                                <TooltipTrigger asChild>
                                     {/* FLAG_LLM: Pasar doc.document_id */}
                                    <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:bg-accent" onClick={() => handleRefresh(doc.document_id, doc.file_name)} aria-label="Actualizar estado" disabled={isActionDisabled}> {isCurrentlyRefreshing ? <Loader2 className="h-4 w-4 animate-spin"/> : <RefreshCw className="h-4 w-4" />} </Button>
                                </TooltipTrigger>
                                <TooltipContent side="top" sideOffset={6}><p>Actualizar Estado</p></TooltipContent>
                            </Tooltip>
                            <AlertDialog open={deletingDocId === doc.document_id} onOpenChange={(open) => !open && closeDeleteConfirmation()}>
                                <Tooltip delayDuration={100}>
                                    <TooltipTrigger asChild>
                                         <AlertDialogTrigger asChild>
                                             {/* FLAG_LLM: Pasar doc.document_id */}
                                            <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive/80 hover:text-destructive hover:bg-destructive/10" onClick={(e) => { e.stopPropagation(); openDeleteConfirmation(doc.document_id); }} aria-label="Eliminar documento" disabled={isActionDisabled}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                         </AlertDialogTrigger>
                                    </TooltipTrigger>
                                    <TooltipContent side="top" sideOffset={6}><p>Eliminar</p></TooltipContent>
                                </Tooltip>
                                <AlertDialogContent>
                                    <AlertDialogHeader>
                                        <AlertDialogTitle className="flex items-center gap-2">
                                            <AlertTriangle className="h-5 w-5 text-destructive"/> ¬øConfirmar Eliminaci√≥n?
                                        </AlertDialogTitle>
                                        <AlertDialogDescription>
                                            Esta acci√≥n no se puede deshacer. Se eliminar√° permanentemente el documento y todos sus datos asociados: <br />
                                            <span className="font-semibold text-foreground mt-2 block break-all">"{doc.file_name || doc.document_id}"</span>
                                        </AlertDialogDescription>
                                    </AlertDialogHeader>
                                    <AlertDialogFooter>
                                        <AlertDialogCancel onClick={closeDeleteConfirmation} disabled={isDeleting}>Cancelar</AlertDialogCancel>
                                        <AlertDialogAction onClick={handleDeleteConfirmed} disabled={isDeleting} className={cn(buttonVariants({ variant: "destructive" }), "min-w-[150px]")}>
                                            {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                                            Eliminar Permanentemente
                                        </AlertDialogAction>
                                    </AlertDialogFooter>
                                </AlertDialogContent>
                            </AlertDialog>
                        </TableCell>
                    </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </div>
        {hasMore && ( <div className="pt-6 text-center"> <Button variant="outline" size="sm" onClick={fetchMore} disabled={isLoading || isDeleting}> {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null} Cargar m√°s documentos </Button> </div> )}
      </TooltipProvider>
  );
}
```

## File: `components\knowledge\file-uploader.tsx`
```tsx
// File: components/knowledge/file-uploader.tsx (MODIFICADO - Iteraci√≥n 4.1 -> Refinado Feedback Visual)
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone, FileRejection } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { UploadCloud, File as FileIcon, X, Loader2, CheckCircle2, AlertTriangle, FileUp } from 'lucide-react'; // FileUp para icono inicial
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge'; // Para mostrar tipo archivo

// Tipos de archivo aceptados (tomados del README Ingest)
const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'text/plain': ['.txt'],
  'text/markdown': ['.md', '.markdown'], // A√±adido .markdown
  'text/html': ['.html', '.htm'],
  // Faltaban en la definici√≥n anterior pero mencionados en el video/README
  // 'application/vnd.oasis.opendocument.text': ['.odt'], // Si se soportan
  // 'application/epub+zip': ['.epub'], // Si se soportan
};
const allowedExtensions = Object.values(acceptedFileTypes).flat().map(ext => ext.substring(1).toUpperCase()).join(', ');
const MAX_FILE_SIZE_MB = 50; // Definir un l√≠mite (ej. 50MB) - AJUSTAR SEG√öN NECESIDAD
const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

interface FileUploaderProps {
  authHeaders: import('@/lib/api').AuthHeaders;
  onUploadFile: (file: File, authHeaders: import('@/lib/api').AuthHeaders) => Promise<boolean>;
  isUploading: boolean; // Estado de carga del hook padre
  uploadError: string | null; // Error del hook padre
  clearUploadStatus: () => void; // Funci√≥n para limpiar error/√©xito del padre
}

export function FileUploader({
    authHeaders,
    onUploadFile,
    isUploading,
    uploadError,
    clearUploadStatus
}: FileUploaderProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dropzoneError, setDropzoneError] = useState<string | null>(null);
  const [localUploadSuccess, setLocalUploadSuccess] = useState<boolean | null>(null);

  // Efecto para limpiar errores/√©xito visual si el archivo cambia o se deselecciona
  useEffect(() => {
    if (files.length === 0) {
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      // No limpiar uploadError aqu√≠, podr√≠a ser un error persistente del √∫ltimo intento
    } else {
      // Si se selecciona un NUEVO archivo, limpiar estados visuales y error del padre
      setDropzoneError(null);
      setLocalUploadSuccess(null);
      clearUploadStatus();
    }
  }, [files, clearUploadStatus]);

  // Manejador del Dropzone
  const onDrop = useCallback((acceptedFiles: File[], fileRejections: FileRejection[]) => {
    // Siempre limpiar estados al soltar nuevos archivos
    setDropzoneError(null);
    setLocalUploadSuccess(null);
    clearUploadStatus();
    // setFile(null); // Eliminar referencia obsoleta

    if (fileRejections.length > 0) {
        const rejection = fileRejections[0];
        let msg = rejection.errors.map(e => e.message).join(', ');
        if (rejection.errors.some(e => e.code === 'file-invalid-type')) {
            msg = `Tipo de archivo no v√°lido. Permitidos: ${allowedExtensions}.`;
        } else if (rejection.errors.some(e => e.code === 'file-too-large')) {
            msg = `El archivo supera el l√≠mite de ${MAX_FILE_SIZE_MB} MB.`;
        }
        setDropzoneError(msg);
        toast.error("Archivo Rechazado", { description: msg });
        return;
    }

    if (acceptedFiles.length > 0) {
      setFiles(acceptedFiles);
    }
  }, [clearUploadStatus]);

  const { getRootProps, getInputProps, isDragActive, isFocused } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: MAX_FILE_SIZE_BYTES,
    multiple: true,
    disabled: isUploading, // Deshabilitar dropzone mientras se sube
  });

  // Manejador del click del bot√≥n de subida
  // El bot√≥n de subir ahora sube todos los archivos, as√≠ que esta funci√≥n ya no se usa

  // Quitar el archivo seleccionado
  const removeFile = () => {
    // setFile(null); // Eliminar referencia obsoleta
  }

  // Determinar el error a mostrar (prioridad al error de subida si existe)
  const displayError = uploadError || dropzoneError;
  // Determinar si el estado visual es de √©xito (solo si la subida termin√≥ y fue exitosa)
  const displaySuccess = !isUploading && localUploadSuccess === true;
  // Determinar si el estado visual es de fallo (solo si la subida termin√≥ y fall√≥, y no hay error de dropzone)
  const displayFailure = !isUploading && localUploadSuccess === false && !dropzoneError;

  return (
    <div className="space-y-4">
      {/* √Årea del Dropzone */}
      <div
        {...getRootProps()}
        className={cn(
            `relative flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg text-center transition-all duration-200 ease-in-out min-h-[180px] outline-none`, // Aumentar padding y altura m√≠nima
            // Estilos interactivos (no mientras sube)
            !isUploading && 'cursor-pointer hover:border-primary/50 hover:bg-accent/50 dark:hover:bg-accent/10',
            !isUploading && (isDragActive || isFocused) && 'border-primary bg-primary/10 border-solid ring-2 ring-primary/30',
            // Estilos de estado (deshabilitado, error, √©xito, fallo)
            isUploading && 'cursor-not-allowed bg-muted/30 border-muted/50 text-muted-foreground',
            displayError && 'border-destructive bg-destructive/5 border-solid text-destructive',
            displaySuccess && 'border-green-500 bg-green-500/10 border-solid text-green-700 dark:text-green-400',
            displayFailure && 'border-destructive bg-destructive/5 border-solid text-destructive' // Mismo estilo que error para fallo
        )}
      >
        <input {...getInputProps()} />

        {/* Icono Central Din√°mico */}
        <div className="mb-3 transform transition-transform duration-200 ease-in-out motion-safe:hover:scale-105">
            {isUploading && <Loader2 className="h-10 w-10 animate-spin" />}
            {displaySuccess && <CheckCircle2 className="h-10 w-10" />}
            {(displayError || displayFailure) && <AlertTriangle className="h-10 w-10" />}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                 <FileUp className={cn("h-10 w-10", isDragActive ? "text-primary" : "text-muted-foreground/60")} />
            )}
        </div>

        {/* Texto del Dropzone Din√°mico */}
        <div className="text-sm max-w-xs">
             {isUploading && <p className="font-medium">Subiendo archivo...</p>}
             {displaySuccess && <p className="font-medium">Archivo puesto en cola exitosamente.</p>}
             {displayError && <p className="font-medium">{displayError}</p>}
             {displayFailure && <p className="font-medium">Fallo la subida del archivo.</p>}

             {/* Texto por defecto / arrastre */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                isDragActive ? (
                <p className="font-medium text-primary">Suelta el archivo aqu√≠...</p>
                ) : (
                <p className={cn("text-foreground/90")}>
                    Arrastra y suelta un archivo, o{' '}
                    <span className="font-medium text-primary underline underline-offset-2">haz clic para seleccionar</span>
                </p>
                )
            )}
            {/* Siempre mostrar extensiones permitidas y l√≠mite (si no hay error/√©xito/subida) */}
            {!isUploading && !displaySuccess && !displayError && !displayFailure && (
                <p className="mt-1.5 text-xs text-muted-foreground">
                    (Permitidos: {allowedExtensions}. M√°x: {MAX_FILE_SIZE_MB}MB)
                </p>
            )}
        </div>
      </div>

      {/* Preview del Archivo Seleccionado (si existe y no est√° subiendo/completado) */}
      {files.length > 0 && !isUploading && (
        <div className="space-y-2">
          {files.map(file => (
            <div key={file.name} className="p-3 border rounded-lg flex items-center justify-between space-x-3 bg-muted/40 shadow-sm">
              <div className="flex items-center space-x-3 overflow-hidden flex-1 min-w-0">
                <FileIcon className="h-5 w-5 flex-shrink-0 text-primary" />
                <div className='flex flex-col min-w-0'>
                  <span className="text-sm font-medium truncate" title={file.name}>{file.name}</span>
                  <span className="text-xs text-muted-foreground">
                    ({(file.size / 1024 / 1024).toFixed(2)} MB) -
                    <Badge variant="outline" className='ml-1.5 py-0 px-1.5 text-[10px]'>{file.type || 'desconocido'}</Badge>
                  </span>
                </div>
              </div>
              <Button variant="ghost" size="icon" className="h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10 flex-shrink-0" onClick={() => setFiles(files.filter(f => f.name !== file.name))} aria-label="Quitar archivo" disabled={isUploading}>
                <X className="h-4 w-4" />
              </Button>
            </div>
          ))}
        </div>
      )}

      {/* Bot√≥n de Subida (visible solo si hay archivo y no se complet√≥ la subida) */}
      {files.length > 0 && (
        <Button
          onClick={async () => {
            for (const file of files) {
              await onUploadFile(file, authHeaders);
            }
            setFiles([]);
          }}
          disabled={isUploading}
          className="w-full"
        >
          {isUploading ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              Subiendo...
            </>
          ) : 'Subir y Procesar Archivos'}
        </Button>
      )}
    </div>
  );
}
```

## File: `components\layout\AdminLayout.tsx`
```tsx
// File: components/layout/AdminLayout.tsx
"use client";

import React, { useState } from 'react';
import { Header } from './header'; // Reutilizamos el header general
import { AdminSidebar } from './AdminSidebar'; // Sidebar espec√≠fico para admin
import { cn } from '@/lib/utils';

export function AdminLayout({ children }: { children: React.ReactNode }) {
  // El estado de colapso podr√≠a ser √∫til si el AdminSidebar lo soporta
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

  return (
    <div className="flex h-screen bg-muted/30 overflow-hidden">
      {/* Admin Sidebar */}
      <AdminSidebar
          isCollapsed={isSidebarCollapsed}
          setIsCollapsed={setIsSidebarCollapsed}
      />

      {/* Contenido Principal Admin */}
      <div className="flex h-full flex-1 flex-col">
        <Header /> {/* Reutilizar header si es apropiado */}
        <main className="flex-1 overflow-y-auto bg-background p-6 lg:p-8">
          {children} {/* Aqu√≠ se renderizar√° el contenido de /admin/page.tsx */}
        </main>
      </div>
    </div>
  );
}
```

## File: `components\layout\AdminSidebar.tsx`
```tsx
// File: components/layout/AdminSidebar.tsx (MODIFICADO - A√±adido Footer con UserMenu y Logout)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation'; // Importar useRouter
import { cn } from '@/lib/utils';
import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    BarChartBig, Users, Building, PanelLeftClose, PanelLeftOpen, Settings, Wrench,
    LogOut, // Importar icono Logout
    HelpCircle // Importar icono HelpCircle
} from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import AtenexLogo from '@/components/icons/atenex-logo';
import { useAuth } from '@/lib/hooks/useAuth'; // Importar useAuth
import {
    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel,
    DropdownMenuSeparator, DropdownMenuTrigger
} from "@/components/ui/dropdown-menu"; // Importar DropdownMenu
import { Avatar, AvatarFallback } from "@/components/ui/avatar"; // Importar Avatar
import { Skeleton } from "@/components/ui/skeleton"; // Importar Skeleton
import { ThemePaletteButton } from '@/components/theme-palette-button'; // Importar ThemePaletteButton


interface AdminSidebarProps {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
}

// Items de navegaci√≥n del Admin
const adminNavItems = [
  { href: '/admin?view=stats', label: 'Estad√≠sticas', icon: BarChartBig, view: 'stats' },
  { href: '/admin?view=management', label: 'Gesti√≥n', icon: Wrench, view: 'management' },
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function AdminSidebar({ isCollapsed, setIsCollapsed }: AdminSidebarProps) {
  const pathname = usePathname();
  const router = useRouter(); // A√±adir router para navegaci√≥n
  const { user, signOut, isLoading: isAuthLoading } = useAuth(); // Obtener datos de usuario y funci√≥n signOut

  // Leer el par√°metro 'view' para determinar la secci√≥n activa
  const searchParams = React.useMemo(() => {
    if (typeof window !== 'undefined') { // Asegurar que se ejecuta en el cliente
        return new URLSearchParams(window.location.search);
    }
    return new URLSearchParams(); // Devolver vac√≠o en SSR
  }, [pathname]); // Re-calcular si pathname cambia
  const currentView = searchParams.get('view') || 'stats'; // Default a 'stats'

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
      try {
          await signOut();
          // Redirecci√≥n ya se maneja dentro de signOut en useAuth
      } catch (error) {
          // Opcional: manejar error si es necesario
      }
  };


  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          "flex h-full flex-col border-r bg-card transition-all duration-300 ease-in-out",
          isCollapsed ? "w-[60px] items-center px-2 py-4" : "w-64 p-4"
        )}
      >
        {/* Secci√≥n Superior: Logo y Toggle */}
        <div
          className={cn(
            "flex items-center mb-6 relative",
            isCollapsed ? "h-10 justify-center" : "h-12 justify-between"
          )}
        >
          <Link
            href="/admin"
            className={cn(
              "flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm",
              isCollapsed ? 'justify-center w-full' : ''
            )}
            aria-label={`${APP_NAME} - Admin Dashboard`}
          >
            <AtenexLogo className={cn("h-8 w-auto text-primary", isCollapsed ? "h-7" : "")} />
            {!isCollapsed && (
              <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME} Admin</span>
            )}
          </Link>
           {!isCollapsed && (
             <Button
               variant="ghost"
               size="icon"
               className="h-8 w-8 lg:absolute lg:-right-10 lg:top-2 bg-background border shadow-sm hover:bg-accent"
               onClick={() => setIsCollapsed(true)}
               aria-label="Colapsar sidebar"
             >
               <PanelLeftClose className="h-4 w-4" />
             </Button>
           )}
        </div>

         {isCollapsed && (
           <Button
             variant="ghost"
             size="icon"
             className="h-8 w-8 mb-4"
             onClick={() => setIsCollapsed(false)}
             aria-label="Expandir sidebar"
           >
             <PanelLeftOpen className="h-4 w-4" />
           </Button>
         )}

        {/* Navegaci√≥n Admin (Ocupa espacio restante) */}
        <nav className={cn("flex flex-col gap-1 flex-grow", isCollapsed ? "items-center mt-4" : "mt-2")}>
          {adminNavItems.map((item) => {
             const isActive = item.href === '/settings'
               ? pathname === item.href
               : item.view === currentView;

            return (
              <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      buttonVariants({ variant: 'ghost', size: isCollapsed ? "icon" : "default" }),
                      "w-full transition-colors duration-150 ease-in-out relative group",
                      isCollapsed ? "h-10 w-10 rounded-lg" : "justify-start pl-3 py-2 text-sm h-10",
                      isActive
                        ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                        : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                    )}
                    aria-label={item.label}
                  >
                    {isActive && !isCollapsed && (
                      <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md"></span>
                    )}
                    <item.icon
                      className={cn(
                        "h-5 w-5 transition-colors",
                        isCollapsed ? "" : "mr-3",
                        isActive ? "text-primary" : "text-muted-foreground group-hover:text-foreground"
                      )}
                    />
                    {!isCollapsed && <span className="truncate">{item.label}</span>}
                  </Link>
                </TooltipTrigger>
                {isCollapsed && (
                  <TooltipContent side="right" sideOffset={5}>
                    {item.label}
                  </TooltipContent>
                )}
              </Tooltip>
            );
          })}
        </nav>

         {/* Footer: Botones y Men√∫ Usuario */}
         <div className={cn(
             "flex items-center border-t mt-auto shrink-0", // mt-auto empuja al fondo
             isCollapsed ? "flex-col gap-2 pt-3" : "flex-row gap-2 pt-3 -mx-4 px-4 h-[57px]" // Altura fija y padding cuando expandido
           )}>
             <ThemePaletteButton />
             {/* Bot√≥n Ayuda */}
             <Tooltip disableHoverableContent={!isCollapsed}>
                 <TooltipTrigger asChild>
                     <Button
                         variant="ghost"
                         size="icon"
                         className="h-9 w-9 text-muted-foreground hover:text-foreground"
                         onClick={() => router.push('/help')}
                         aria-label="Ayuda y Soporte"
                     >
                         <HelpCircle className="h-5 w-5" />
                     </Button>
                 </TooltipTrigger>
                 {isCollapsed && (
                     <TooltipContent side="right" sideOffset={5}>Ayuda</TooltipContent>
                 )}
             </Tooltip>

             {/* User Menu Dropdown */}
              <div className={cn(isCollapsed ? "w-full mt-auto" : "ml-auto")}> {/* ml-auto para alinear a la derecha si expandido */}
                {isAuthLoading ? (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                ) : user ? (
                    <DropdownMenu>
                        <Tooltip disableHoverableContent={!isCollapsed}>
                            <TooltipTrigger asChild>
                                <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" className={cn(
                                        "relative rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
                                        isCollapsed ? "h-9 w-9 p-0" : "h-9 w-9"
                                    )}>
                                        <Avatar className="h-9 w-9 border">
                                            <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                                                {getInitials(user.name)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <span className="sr-only">Abrir men√∫ de usuario</span>
                                    </Button>
                                </DropdownMenuTrigger>
                            </TooltipTrigger>
                            {isCollapsed && (
                                <TooltipContent side="right" sideOffset={5} className="flex flex-col items-start">
                                    <span className="font-medium">{user.name || 'Usuario'}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </TooltipContent>
                            )}
                        </Tooltip>
                        <DropdownMenuContent className="w-60" align="end" forceMount>
                        <DropdownMenuLabel className="font-normal p-2">
                        <div className="flex flex-col space-y-1.5">
                            <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                                {user.name || 'Usuario'}
                            </p>
                            <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                                {user.email}
                            </p>
                             {/* Mostrar Rol Admin */}
                            {user.isAdmin && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`Rol: Admin`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                        <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                                    </svg>
                                    <span>Rol: Administrador</span>
                                </div>
                            )}
                            {/* Info Empresa (si aplica a admin) */}
                            {user.companyId && (
                                <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                                    <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                                </svg>
                                <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                                </div>
                            )}
                        </div>
                        </DropdownMenuLabel>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                            <Settings className="mr-2 h-4 w-4" />
                            <span>Configuraci√≥n</span>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                            <LogOut className="mr-2 h-4 w-4" />
                            <span>Cerrar sesi√≥n</span>
                        </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                ) : (
                    <Skeleton className={cn("rounded-full", isCollapsed ? "h-9 w-9" : "h-9 w-9")}/>
                )}
             </div>
         </div>

      </aside>
    </TooltipProvider>
  );
}
```

## File: `components\layout\header.tsx`
```tsx
// File: components/layout/header.tsx
"use client";

import React from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { PlusCircle, MessageSquare } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { cn } from '@/lib/utils';

export function Header() {
  const pathname = usePathname();
  const router = useRouter();

  const getTitle = () => {
    if (pathname.startsWith('/chat')) return "Chat";
    if (pathname.startsWith('/knowledge')) return "Base de Conocimiento";
    if (pathname.startsWith('/settings')) return "Configuraci√≥n";
    if (pathname.startsWith('/admin')) return "Panel de Administraci√≥n";
    return APP_NAME; // Fallback
  };

  const handleNewChat = () => {
    // Si ya estamos en /chat o /chat/[id], la l√≥gica de ChatPage se encargar√° de resetear.
    // Si estamos en otra p√°gina, simplemente navegamos.
    router.push('/chat');
  };

  const showNewChatButton = pathname.startsWith('/chat');

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-background/95 px-4 backdrop-blur-sm md:px-6 shrink-0">
      <div className="flex items-center gap-3">
        {/* <MessageSquare className="h-6 w-6 text-primary" /> // Icono opcional para el t√≠tulo */}
        <h1 className="text-lg font-semibold text-foreground">{getTitle()}</h1>
      </div>
      
      {showNewChatButton && (
        <Button variant="outline" size="sm" onClick={handleNewChat}>
          <PlusCircle className="mr-2 h-4 w-4" />
          Nuevo Chat
        </Button>
      )}
    </header>
  );
}
```

## File: `components\layout\sidebar.tsx`
```tsx
// File: components/layout/sidebar.tsx (REFACTORIZADO - Logo y Navegaci√≥n v2)
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // Quitar useRouter si no se usa aqu√≠
import { cn } from '@/lib/utils';

import { Button, buttonVariants } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { BotMessageSquare, Database, Settings, HelpCircle } from 'lucide-react';
import { APP_NAME } from '@/lib/constants';
import { ChatHistory } from '@/components/chat/chat-history';
import { Separator } from '@/components/ui/separator';
import AtenexLogo from '@/components/icons/atenex-logo';
import { ThemePaletteButton } from '@/components/theme-palette-button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu';
import { LogOut } from 'lucide-react';
import { useAuth } from '@/lib/hooks/useAuth';
import { useRouter } from 'next/navigation';

interface SidebarProps {
  isCollapsed: boolean;
}

// Items de navegaci√≥n actualizados
const navItems = [
  // { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard }, // Ejemplo
  { href: '/chat', label: 'Chat', icon: BotMessageSquare },
  { href: '/knowledge', label: 'Conocimiento', icon: Database }, // Texto m√°s corto
  { href: '/settings', label: 'Configuraci√≥n', icon: Settings },
];

export function Sidebar({ isCollapsed }: SidebarProps) {
  const pathname = usePathname();
  const { user, signOut, isLoading: isAuthLoading } = useAuth();
  const router = useRouter();

  // Helper for user initials
  const getInitials = (name?: string | null): string => {
    if (!name) return '?';
    const parts = name.split(' ').filter(Boolean);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  };

  const handleLogout = async () => {
    try {
      await signOut();
    } catch (error) {
      // Optionally handle error
    }
  };

  return (
    <aside className={cn(
      'flex h-full flex-col border-r bg-card',
      isCollapsed ? 'w-[60px] items-center px-2 py-4' : 'w-full p-4'
    )}>
      {/* Header: Logo */}
      <div className={cn('flex items-center mb-6', isCollapsed ? 'h-10 justify-center' : 'h-12 justify-start')}>
        <Link
          href="/chat"
          className={cn(
            'flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm',
            isCollapsed ? 'justify-center w-full' : ''
          )}
          aria-label={`${APP_NAME} - Inicio`}
        >
          <AtenexLogo className={cn('h-8 w-auto text-primary', isCollapsed ? 'h-7' : '')} />
          {!isCollapsed && (
            <span className="text-xl font-bold text-foreground tracking-tight">{APP_NAME}</span>
          )}
        </Link>
      </div>

      {/* Main: Navigation + Chat History (chat history is main scrollable area) */}
      <div className={cn('flex flex-col flex-1 min-h-0', isCollapsed ? 'w-full' : '')}>
        {/* Navigation */}
        <nav className={cn(
          'flex flex-col gap-1',
          isCollapsed ? 'items-center mt-4' : 'mt-2'
        )}>
          <TooltipProvider delayDuration={0}>
            {navItems.map((item) => {
              const isChatActive = item.href === '/chat' && (pathname === '/chat' || pathname.startsWith('/chat/'));
              const isActive = isChatActive || (item.href !== '/chat' && pathname.startsWith(item.href));
              return (
                <Tooltip key={item.href} disableHoverableContent={!isCollapsed}>
                  <TooltipTrigger asChild>
                    <Link
                      href={item.href}
                      className={cn(
                        buttonVariants({ variant: 'ghost', size: isCollapsed ? 'icon' : 'default' }),
                        'w-full transition-colors duration-150 ease-in-out relative group',
                        isCollapsed ? 'h-10 w-10 rounded-lg' : 'justify-start pl-3 py-2 text-sm h-10',
                        isActive
                          ? 'font-semibold text-primary bg-primary/10 dark:bg-primary/20'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50 dark:hover:bg-accent/30'
                      )}
                      aria-label={item.label}
                    >
                      {isActive && !isCollapsed && (
                        <span className="absolute left-0 top-1/2 -translate-y-1/2 h-5 w-1 bg-primary rounded-r-md transition-all duration-200"></span>
                      )}
                      <item.icon
                        className={cn(
                          'h-5 w-5 transition-colors',
                          isCollapsed ? '' : 'mr-3',
                          isActive ? 'text-primary' : 'text-muted-foreground group-hover:text-foreground'
                        )}
                      />
                      {!isCollapsed && <span className="truncate">{item.label}</span>}
                    </Link>
                  </TooltipTrigger>
                  {isCollapsed && (
                    <TooltipContent side="right" sideOffset={5}>
                      {item.label}
                    </TooltipContent>
                  )}
                </Tooltip>
              );
            })}
          </TooltipProvider>
        </nav>
        {/* Chat History: always visible, scrollable, flex-1 */}
        {!isCollapsed && (
          <div className="flex-1 flex flex-col min-h-0 mt-4 border-t pt-3 -mx-4 px-4">
            <ChatHistory />
          </div>
        )}
      </div>

      {/* Footer: Settings, Theme, Help, User menu */}
      {!isCollapsed && (
        <div className="flex flex-row items-end gap-2 border-t pt-3 mt-3 -mx-4 px-4 min-h-[56px]">
          {/* Theme button */}
          <ThemePaletteButton />
          {/* Help button */}
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9"
            onClick={() => router.push('/help')}
            aria-label="Ayuda y Soporte"
          >
            <HelpCircle className="h-5 w-5" />
          </Button>
          {/* User menu */}
          {user ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-9 w-9 rounded-full focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  <Avatar className="h-9 w-9 border">
                    <AvatarFallback className="bg-secondary text-secondary-foreground font-medium text-xs">
                      {getInitials(user.name)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="sr-only">Abrir men√∫ de usuario</span>
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-60" align="end" forceMount>
                <DropdownMenuLabel className="font-normal p-2">
                  <div className="flex flex-col space-y-1.5">
                    <p className="text-sm font-medium leading-none truncate" title={user.name || 'Usuario'}>
                      {user.name || 'Usuario'}
                    </p>
                    <p className="text-xs leading-none text-muted-foreground truncate" title={user.email}>
                      {user.email}
                    </p>
                    {user.companyId && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80 pt-1" title={`ID Empresa: ${user.companyId}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M4 1.75A2.25 2.25 0 0 0 1.75 4v1.5a.75.75 0 0 0 1.5 0V4c0-.414.336-.75.75-.75h8.5c.414 0 .75.336.75.75v1.5a.75.75 0 0 0 1.5 0V4A2.25 2.25 0 0 0 12 1.75H4ZM1.75 8.5A.75.75 0 0 0 1 9.25v2.25A2.25 2.25 0 0 0 3.25 14h9.5A2.25 2.25 0 0 0 15 11.5V9.25a.75.75 0 0 0-1.5 0v2.25c0 .414-.336.75-.75.75h-9.5c-.414 0-.75-.336-.75-.75V9.25a.75.75 0 0 0-.75-.75Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Empresa: {user.companyId.substring(0, 8)}...</span>
                      </div>
                    )}
                    {user.roles && user.roles.length > 0 && (
                      <div className="flex items-center gap-1.5 text-xs text-muted-foreground/80" title={`Roles: ${user.roles.join(', ')}`}> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" className="w-3.5 h-3.5 flex-shrink-0">
                          <path fillRule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V3h3.75A1.75 1.75 0 0 1 14.25 4.75v3.51a.75.75 0 0 1-1.5 0V5.76L8 8.41l-4.75-2.65v6.01c0 .17.02.338.059.497l1.49-.497a.75.75 0 1 1 .502 1.414l-2.08 1.04A2.25 2.25 0 0 1 3.25 11H.75a.75.75 0 0 1 0-1.5h1.77a.75.75 0 0 0 .75-.75V4.75A1.75 1.75 0 0 1 5 3h3V1.75A.75.75 0 0 1 8 1Z" clipRule="evenodd" />
                        </svg>
                        <span className="truncate">Rol(es): {user.roles.join(', ')}</span>
                      </div>
                    )}
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={() => router.push('/settings')} className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  <span>Configuraci√≥n</span>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10 dark:focus:bg-destructive/20">
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Cerrar sesi√≥n</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <Skeleton className="h-9 w-9 rounded-full" />
          )}
        </div>
      )}
    </aside>
  );
}
```

## File: `components\theme-palette-button.tsx`
```tsx
// File: components/theme-palette-button.tsx (REFACTORIZADO - Temas Reducidos)
"use client";

import * as React from "react";
import { Palette, Check } from "lucide-react"; // Importar Check
import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel, // Importar Label
  DropdownMenuSeparator, // Importar Separator
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { cn } from "@/lib/utils";

// Definici√≥n de temas B2B disponibles (REDUCIDOS)
const themes = [
    { value: 'system', label: 'Autom√°tico (Sistema)' },
    { value: 'light', label: 'Claro Profesional' }, // Tema Blanco
    { value: 'dark', label: 'Oscuro Elegante' },   // Tema Azul Oscuro
    { value: 'zinc', label: 'Zinc (Perla)' },     // Tema Perla/Gris Oscuro
];

export function ThemePaletteButton() {
  const { setTheme, theme: activeTheme, resolvedTheme } = useTheme();

  // El tema resuelto (light o dark) si activeTheme es 'system'
  const currentResolvedTheme = resolvedTheme;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
           <Button variant="ghost" size="icon" className="h-9 w-9" aria-label="Cambiar tema">
               <Palette className="h-5 w-5"/>
            </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-52"> {/* Ancho ajustado */}
           <DropdownMenuLabel className="px-2 py-1.5 text-xs font-semibold">Apariencia</DropdownMenuLabel>
           <DropdownMenuSeparator />
           {themes.map((theme) => {
               // Determinar si este item es el activo (considerando 'system')
               const isActive = activeTheme === theme.value;
               // Si el tema activo es 'system', debemos ver si el 'resolvedTheme' coincide con 'light' o 'dark'
               // Esto es principalmente para la l√≥gica de la marca de verificaci√≥n, pero no cambia qu√© se muestra como "activo" en la lista.
               const isEffectivelyActive = activeTheme === theme.value || (activeTheme === 'system' && resolvedTheme === theme.value);

               return (
                 <DropdownMenuItem
                    key={theme.value}
                    onClick={() => setTheme(theme.value)}
                    className={cn(
                        "flex items-center justify-between cursor-pointer text-sm px-2 py-1.5 rounded-sm",
                        isActive // Marca el item del dropdown si es el seleccionado directamente
                          ? "font-semibold text-primary bg-accent dark:bg-accent/50"
                          : "hover:bg-accent/50 dark:hover:bg-accent/20"
                    )}
                 >
                    <span>{theme.label}</span>
                    {/* Mostrar check si este tema es el que est√° efectivamente activo */}
                    {isEffectivelyActive && ( <Check className="h-4 w-4" /> )}
                 </DropdownMenuItem>
               );
           })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

## File: `components\theme-provider.tsx`
```tsx
// File: components/theme-provider.tsx
"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

## File: `components\theme-toggle.tsx`
```tsx

```

## File: `components\ui\alert-dialog.tsx`
```tsx
// File: components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm", // Fondo m√°s oscuro y blur
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({ className, ...props }: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-background est√© presente para el fondo opaco
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200",
          "rounded-lg", // Asegurar redondeo
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

// --- El resto de componentes (Header, Footer, Title, etc.) sin cambios ---
function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
```

## File: `components\ui\alert.tsx`
```tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

```

## File: `components\ui\avatar.tsx`
```tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

## File: `components\ui\badge.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

```

## File: `components\ui\button.tsx`
```tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

```

## File: `components\ui\card.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

```

## File: `components\ui\checkbox.tsx`
```tsx
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "border-primary ring-offset-background focus-visible:ring-ring data-[state=checked]:bg-primary data-[state=checked]:text-white peer size-4 shrink-0 rounded-sm border focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator className="flex items-center justify-center text-current">
        <CheckIcon className="size-4" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
```

## File: `components\ui\dialog.tsx`
```tsx
// File: components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/60", // Oscurecido un poco m√°s
        "backdrop-blur-sm", // A√±adir blur al fondo
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          // FLAG_LLM: Asegurar que bg-popover (o bg-background) est√© presente y sea opaco
          "bg-popover", // Usar popover como fondo est√°ndar para modales/popups
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200", // Mantiene padding y borde
          // Las clases de tama√±o (como max-w-lg) se aplicar√°n donde se use el componente
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-sm opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

// --- El resto de componentes (DialogHeader, Footer, Title, Description) sin cambios ---
function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
```

## File: `components\ui\dropdown-menu.tsx`
```tsx
// File: components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

// --- DropdownMenu, Portal, Trigger, Group, Label, Separator, Shortcut, Sub, RadioGroup sin cambios ---
function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
}
function DropdownMenuTrigger({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" className="focus:outline-none" {...props} />
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

// --- DropdownMenuContent y SubContent (Asegurar fondo opaco) ---
function DropdownMenuContent({ className, sideOffset = 4, ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props} // Mantener style override si existe
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        // FLAG_LLM: Asegurar fondo opaco con bg-popover
        "z-50 min-w-[8rem] origin-[--radix-dropdown-menu-content-transform-origin] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg backdrop-blur-sm", // A√±adido bg-popover
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} // Mantener style override si existe
    />
  )
}

// --- DropdownMenuItem, CheckboxItem, RadioItem, SubTrigger sin cambios ---
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
```

## File: `components\ui\input.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

```

## File: `components\ui\label.tsx`
```tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

```

## File: `components\ui\progress.tsx`
```tsx
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

```

## File: `components\ui\resizable.tsx`
```tsx
// File: components/ui/resizable.tsx (MODIFICADO)
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        // M√°s sutil: opacidad baja, aumenta en hover/focus
        "relative flex w-px items-center justify-center bg-border", // Mantiene la l√≠nea de 1px
        "opacity-40 transition-all duration-200 ease-in-out hover:opacity-100 hover:bg-primary/20", // Aumenta opacidad y muestra √°rea sutil en hover
        "focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:outline-none focus-visible:opacity-100 focus-visible:bg-primary/10", // Resalta en focus
        "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
        // Estilos para el after (l√≠nea visual) - Se puede quitar si se prefiere sin l√≠nea extra
        // "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0",
        // Estilos para el div del handle si withHandle es true
        "[&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        // M√°s sutil: sin fondo expl√≠cito, solo el icono sobre el √°rea resaltada en hover/focus
        <div className="z-10 flex h-5 w-2.5 items-center justify-center rounded-sm">
          {/* Icono m√°s peque√±o y con color muted */}
          <GripVerticalIcon className="h-3 w-3 text-muted-foreground" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

## File: `components\ui\scroll-area.tsx`
```tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

```

## File: `components\ui\select.tsx`
```tsx
// File: components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      className={cn(
        "border-input ring-offset-background placeholder:text-muted-foreground focus:ring-ring flex h-9 w-full items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] focus:ring-2 focus:ring-offset-2 focus:outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm [&>span]:line-clamp-1",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="text-muted-foreground size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        position={position}
        className={cn(
          "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md backdrop-blur-sm",
          "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        style={{ backgroundColor: 'var(--popover, #fff)', ...props.style }}
        {...props}
      >
        <SelectPrimitive.Viewport
          data-slot="select-viewport"
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("py-1.5 pr-2 pl-8 text-sm font-medium", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex w-full cursor-default items-center rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-muted -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

import { CheckIcon } from "lucide-react" // Asegurar importaci√≥n local o global

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}
```

## File: `components\ui\separator.tsx`
```tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

```

## File: `components\ui\skeleton.tsx`
```tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

```

## File: `components\ui\sonner.tsx`
```tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

```

## File: `components\ui\table.tsx`
```tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

```

## File: `components\ui\textarea.tsx`
```tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

```

## File: `components\ui\tooltip.tsx`
```tsx
// File: components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({ delayDuration = 0, ...props }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return <TooltipPrimitive.Provider data-slot="tooltip-provider" delayDuration={delayDuration} {...props} />
}

function Tooltip({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return <TooltipPrimitive.Root data-slot="tooltip" {...props} />
}

function TooltipTrigger({ ...props }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({ className, sideOffset = 4, children, ...props }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          // FLAG_LLM: Asegurar fondo opaco con bg-popover
          "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md backdrop-blur-sm", // A√±adido bg-popover
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "text-balance",
          className
        )}
        {...props} // Mantener el style override si existe, pero bg-popover tiene prioridad base
      >
        {children}
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

## File: `components.json`
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

## File: `export-codebase.py`
```py
from pathlib import Path

# Directories to exclude from the export
EXCLUDED_DIRS = {'.git', '__pycache__', '.venv', '.idea', '.mypy_cache', '.vscode', '.github', 'node_modules', 
                '.next', 'out', 'dist', 'coverage', 'README.md','package-lock.json'}

# Important files to include even at the root level
IMPORTANT_CONFIG_FILES = [
    'next.config.mjs', 'next.config.js', 'package.json', 'tsconfig.json', 
    'tailwind.config.js', 'postcss.config.js', '.env.example', '.eslintrc.json'#,
    #'README.md'
]

def build_tree(directory: Path, prefix: str = "") -> list:
    """
    Generates a tree representation of directory structure and files,
    excluding the directories specified in EXCLUDED_DIRS.
    """
    # Filter and sort directory entries
    entries = sorted(
        [entry for entry in directory.iterdir() if entry.name not in EXCLUDED_DIRS],
        key=lambda e: e.name
    )
    tree_lines = []
    for index, entry in enumerate(entries):
        connector = "‚îî‚îÄ‚îÄ " if index == len(entries) - 1 else "‚îú‚îÄ‚îÄ "
        tree_lines.append(prefix + connector + entry.name)
        if entry.is_dir():
            extension = "    " if index == len(entries) - 1 else "‚îÇ   "
            tree_lines.extend(build_tree(entry, prefix + extension))
    return tree_lines

def generate_codebase_markdown(base_path: str = ".", output_file: str = "full_codebase.md"):
    base = Path(base_path).resolve()
    
    lines = []

    # Add directory structure to the beginning of the Markdown file
    lines.append("# Project Structure")
    lines.append("")
    lines.append("```")
    # Start with the project root name
    lines.append(f"{base.name}/")
    tree_lines = build_tree(base)
    lines.extend(tree_lines)
    lines.append("```")
    lines.append("")

    # Add the codebase content in Markdown
    lines.append("# Full Codebase")
    lines.append("")

    # Process all important files at the root level first
    for filename in IMPORTANT_CONFIG_FILES:
        file_path = base / filename
        if file_path.exists() and file_path.is_file():
            rel_path = file_path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = file_path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = file_path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    # Process all files in project directories (excluding those in EXCLUDED_DIRS)
    for path in sorted(base.glob("**/*")):
        # Skip excluded directories
        if any(excluded in path.parts for excluded in EXCLUDED_DIRS):
            continue
        
        # Skip already processed root config files
        if path.parent == base and path.name in IMPORTANT_CONFIG_FILES:
            continue
            
        if path.is_file():
            rel_path = path.relative_to(base)
            lines.append(f"## File: `{rel_path}`")
            try:
                content = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
                lines.append("_[Skipped: binary or non-UTF8 file]_")
                continue
            except Exception as e:
                lines.append(f"_[Error reading file: {e}]_")
                continue
            ext = path.suffix.lstrip('.')
            lang = ext if ext else ""
            lines.append(f"```{lang}")
            lines.append(content)
            lines.append("```")
            lines.append("")

    output_path = base / output_file
    try:
        output_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"‚úÖ Code exported to Markdown at: {output_path}")
    except Exception as e:
        print(f"‚ùå Error writing output file: {e}")

# If the script is run directly 
if __name__ == "__main__":
    generate_codebase_markdown()
```

## File: `lib\api.ts`
```ts
// File: lib/api.ts (CORREGIDO - Implementada la llamada API real para createUser)
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error (sin cambios) ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request (sin cambios estructurales) ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    // Permitir endpoints /admin y /docs, /openapi.json
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         // No advertir para endpoints admin si el token no est√° (la API lo rechazar√° si es necesario)
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio (Existentes) ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }
export interface RetrievedDocApi { id: string; document_id: string; file_name: string | null; content: string; content_preview: string; metadata: Record<string, any> | null; score: number; }
export type RetrievedDoc = RetrievedDocApi;
export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface ChatMessageApi { id: string; chat_id: string; role: 'user' | 'assistant'; content: string; sources: Array<{ chunk_id: string; document_id: string; file_name: string | null; score: number; preview: string; }> | null; created_at: string; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }

// --- NUEVO: Tipos para Admin API ---
export interface AdminStatsResponse {
    company_count: number;
    users_per_company: Array<{
        company_id: string;
        name: string | null; // Nombre de la compa√±√≠a
        user_count: number;
    }>;
}
export interface CompanySelectItem {
    id: string;
    name: string;
}
export interface CreateCompanyPayload {
    name: string;
}
export interface CompanyResponse {
    id: string;
    name: string;
    created_at?: string;
}
export interface CreateUserPayload {
    email: string;
    password: string;
    name: string;
    company_id: string;
    roles?: string[];
}
export interface UserResponse {
    id: string;
    email: string;
    name: string | null;
    company_id: string | null;
    is_active?: boolean;
    created_at?: string;
}

// --- Funciones API Espec√≠ficas (Existentes - Cuerpo Restaurado) ---

// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};

// ** HELPERS **
export const mapApiSourcesToFrontend = (apiSources: ChatMessageApi['sources']): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;
    return apiSources.map(source => ({
        id: typeof source.chunk_id === 'string' ? source.chunk_id : '',
        document_id: typeof source.document_id === 'string' ? source.document_id : '',
        file_name: typeof source.file_name === 'string' ? source.file_name : '',
        content: typeof source.preview === 'string' ? source.preview : '',
        content_preview: typeof source.preview === 'string' ? source.preview : '',
        metadata: null,
        score: typeof source.score === 'number' ? source.score : 0,
    }));
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};

// --- Admin API Functions (Existentes) ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}

// --- createUser CORREGIDO ---
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload); // Log antes de la llamada real
     // Llamada API real usando la funci√≥n request gen√©rica
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
         // Los headers (Content-Type, Authorization) son gestionados por la funci√≥n `request`
     });
}
// --- FIN CORRECCI√ìN ---
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// File: lib/api.ts (CORREGIDO - Implementada la llamada API real para createUser)
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error (sin cambios) ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request (sin cambios estructurales) ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    // Permitir endpoints /admin y /docs, /openapi.json
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         // No advertir para endpoints admin si el token no est√° (la API lo rechazar√° si es necesario)
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio (Existentes) ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }
export interface RetrievedDocApi { id: string; document_id: string; file_name: string | null; content: string; content_preview: string; metadata: Record<string, any> | null; score: number; }
export type RetrievedDoc = RetrievedDocApi;
export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface ChatMessageApi { id: string; chat_id: string; role: 'user' | 'assistant'; content: string; sources: Array<{ chunk_id: string; document_id: string; file_name: string | null; score: number; preview: string; }> | null; created_at: string; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }

// --- NUEVO: Tipos para Admin API ---
export interface AdminStatsResponse {
    company_count: number;
    users_per_company: Array<{
        company_id: string;
        name: string | null; // Nombre de la compa√±√≠a
        user_count: number;
    }>;
}
export interface CompanySelectItem {
    id: string;
    name: string;
}
export interface CreateCompanyPayload {
    name: string;
}
export interface CompanyResponse {
    id: string;
    name: string;
    created_at?: string;
}
export interface CreateUserPayload {
    email: string;
    password: string;
    name: string;
    company_id: string;
    roles?: string[];
}
export interface UserResponse {
    id: string;
    email: string;
    name: string | null;
    company_id: string | null;
    is_active?: boolean;
    created_at?: string;
}

// --- Funciones API Espec√≠ficas (Existentes - Cuerpo Restaurado) ---

// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};

// ** HELPERS **
export const mapApiSourcesToFrontend = (apiSources: ChatMessageApi['sources']): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;
    return apiSources.map(source => ({
        id: typeof source.chunk_id === 'string' ? source.chunk_id : '',
        document_id: typeof source.document_id === 'string' ? source.document_id : '',
        file_name: typeof source.file_name === 'string' ? source.file_name : '',
        content: typeof source.preview === 'string' ? source.preview : '',
        content_preview: typeof source.preview === 'string' ? source.preview : '',
        metadata: null,
        score: typeof source.score === 'number' ? source.score : 0,
    }));
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};

// --- Admin API Functions (Existentes) ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}

// --- createUser CORREGIDO ---
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload); // Log antes de la llamada real
     // Llamada API real usando la funci√≥n request gen√©rica
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
         // Los headers (Content-Type, Authorization) son gestionados por la funci√≥n `request`
     });
}
// --- FIN CORRECCI√ìN ---
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// File: lib/api.ts (CORREGIDO - Implementada la llamada API real para createUser)
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error (sin cambios) ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request (sin cambios estructurales) ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    // Permitir endpoints /admin y /docs, /openapi.json
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         // No advertir para endpoints admin si el token no est√° (la API lo rechazar√° si es necesario)
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio (Existentes) ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }
export interface RetrievedDocApi { id: string; document_id: string; file_name: string | null; content: string; content_preview: string; metadata: Record<string, any> | null; score: number; }
export type RetrievedDoc = RetrievedDocApi;
export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface ChatMessageApi { id: string; chat_id: string; role: 'user' | 'assistant'; content: string; sources: Array<{ chunk_id: string; document_id: string; file_name: string | null; score: number; preview: string; }> | null; created_at: string; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }

// --- NUEVO: Tipos para Admin API ---
export interface AdminStatsResponse {
    company_count: number;
    users_per_company: Array<{
        company_id: string;
        name: string | null; // Nombre de la compa√±√≠a
        user_count: number;
    }>;
}
export interface CompanySelectItem {
    id: string;
    name: string;
}
export interface CreateCompanyPayload {
    name: string;
}
export interface CompanyResponse {
    id: string;
    name: string;
    created_at?: string;
}
export interface CreateUserPayload {
    email: string;
    password: string;
    name: string;
    company_id: string;
    roles?: string[];
}
export interface UserResponse {
    id: string;
    email: string;
    name: string | null;
    company_id: string | null;
    is_active?: boolean;
    created_at?: string;
}

// --- Funciones API Espec√≠ficas (Existentes - Cuerpo Restaurado) ---

// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};

// ** HELPERS **
export const mapApiSourcesToFrontend = (apiSources: ChatMessageApi['sources']): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;
    return apiSources.map(source => ({
        id: typeof source.chunk_id === 'string' ? source.chunk_id : '',
        document_id: typeof source.document_id === 'string' ? source.document_id : '',
        file_name: typeof source.file_name === 'string' ? source.file_name : '',
        content: typeof source.preview === 'string' ? source.preview : '',
        content_preview: typeof source.preview === 'string' ? source.preview : '',
        metadata: null,
        score: typeof source.score === 'number' ? source.score : 0,
    }));
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};

// --- Admin API Functions (Existentes) ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}

// --- createUser CORREGIDO ---
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload); // Log antes de la llamada real
     // Llamada API real usando la funci√≥n request gen√©rica
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
         // Los headers (Content-Type, Authorization) son gestionados por la funci√≥n `request`
     });
}
// --- FIN CORRECCI√ìN ---
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// Bulk delete documents
export interface BulkDeleteResponse {
  deleted: string[];
  failed: { id: string; error: string }[];
}

/**
 * Borra m√∫ltiples documentos en una sola petici√≥n.
 * @param documentIds IDs de los documentos a borrar
 * @param auth Cabeceras de autenticaci√≥n
 */
export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>(
    '/api/v1/ingest/bulk',
    {
      method: 'DELETE',
      headers: { ...auth } as Record<string, string>,
      body: JSON.stringify({ document_ids: documentIds })
    }
  );
}
// File: lib/api.ts (CORREGIDO - Implementada la llamada API real para createUser)
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error (sin cambios) ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request (sin cambios estructurales) ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    // Permitir endpoints /admin y /docs, /openapi.json
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         // No advertir para endpoints admin si el token no est√° (la API lo rechazar√° si es necesario)
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio (Existentes) ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }
export interface RetrievedDocApi { id: string; document_id: string; file_name: string | null; content: string; content_preview: string; metadata: Record<string, any> | null; score: number; }
export type RetrievedDoc = RetrievedDocApi;
export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface ChatMessageApi { id: string; chat_id: string; role: 'user' | 'assistant'; content: string; sources: Array<{ chunk_id: string; document_id: string; file_name: string | null; score: number; preview: string; }> | null; created_at: string; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }

// --- NUEVO: Tipos para Admin API ---
export interface AdminStatsResponse {
    company_count: number;
    users_per_company: Array<{
        company_id: string;
        name: string | null; // Nombre de la compa√±√≠a
        user_count: number;
    }>;
}
export interface CompanySelectItem {
    id: string;
    name: string;
}
export interface CreateCompanyPayload {
    name: string;
}
export interface CompanyResponse {
    id: string;
    name: string;
    created_at?: string;
}
export interface CreateUserPayload {
    email: string;
    password: string;
    name: string;
    company_id: string;
    roles?: string[];
}
export interface UserResponse {
    id: string;
    email: string;
    name: string | null;
    company_id: string | null;
    is_active?: boolean;
    created_at?: string;
}

// --- Funciones API Espec√≠ficas (Existentes - Cuerpo Restaurado) ---

// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};

// ** HELPERS **
export const mapApiSourcesToFrontend = (apiSources: ChatMessageApi['sources']): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;
    return apiSources.map(source => ({
        id: typeof source.chunk_id === 'string' ? source.chunk_id : '',
        document_id: typeof source.document_id === 'string' ? source.document_id : '',
        file_name: typeof source.file_name === 'string' ? source.file_name : '',
        content: typeof source.preview === 'string' ? source.preview : '',
        content_preview: typeof source.preview === 'string' ? source.preview : '',
        metadata: null,
        score: typeof source.score === 'number' ? source.score : 0,
    }));
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};

// --- Admin API Functions (Existentes) ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}

// --- createUser CORREGIDO ---
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload); // Log antes de la llamada real
     // Llamada API real usando la funci√≥n request gen√©rica
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
         // Los headers (Content-Type, Authorization) son gestionados por la funci√≥n `request`
     });
}
// --- FIN CORRECCI√ìN ---
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// Bulk delete documents
export interface BulkDeleteResponse {
  deleted: string[];
  failed: { id: string; error: string }[];
}

/**
 * Borra m√∫ltiples documentos en una sola petici√≥n.
 * @param documentIds IDs de los documentos a borrar
 * @param auth Cabeceras de autenticaci√≥n
 */
export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>(
    '/api/v1/ingest/bulk',
    {
      method: 'DELETE',
      headers: { ...auth } as Record<string, string>,
      body: JSON.stringify({ document_ids: documentIds })
    }
  );
}
// File: lib/api.ts (CORREGIDO - Implementada la llamada API real para createUser)
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error (sin cambios) ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request (sin cambios estructurales) ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    // Permitir endpoints /admin y /docs, /openapi.json
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         // No advertir para endpoints admin si el token no est√° (la API lo rechazar√° si es necesario)
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio (Existentes) ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }
export interface RetrievedDocApi { id: string; document_id: string; file_name: string | null; content: string; content_preview: string; metadata: Record<string, any> | null; score: number; }
export type RetrievedDoc = RetrievedDocApi;
export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface ChatMessageApi { id: string; chat_id: string; role: 'user' | 'assistant'; content: string; sources: Array<{ chunk_id: string; document_id: string; file_name: string | null; score: number; preview: string; }> | null; created_at: string; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }

// --- NUEVO: Tipos para Admin API ---
export interface AdminStatsResponse {
    company_count: number;
    users_per_company: Array<{
        company_id: string;
        name: string | null; // Nombre de la compa√±√≠a
        user_count: number;
    }>;
}
export interface CompanySelectItem {
    id: string;
    name: string;
}
export interface CreateCompanyPayload {
    name: string;
}
export interface CompanyResponse {
    id: string;
    name: string;
    created_at?: string;
}
export interface CreateUserPayload {
    email: string;
    password: string;
    name: string;
    company_id: string;
    roles?: string[];
}
export interface UserResponse {
    id: string;
    email: string;
    name: string | null;
    company_id: string | null;
    is_active?: boolean;
    created_at?: string;
}

// --- Funciones API Espec√≠ficas (Existentes - Cuerpo Restaurado) ---

// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};

// ** HELPERS **
export const mapApiSourcesToFrontend = (apiSources: ChatMessageApi['sources']): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;
    return apiSources.map(source => ({
        id: typeof source.chunk_id === 'string' ? source.chunk_id : '',
        document_id: typeof source.document_id === 'string' ? source.document_id : '',
        file_name: typeof source.file_name === 'string' ? source.file_name : '',
        content: typeof source.preview === 'string' ? source.preview : '',
        content_preview: typeof source.preview === 'string' ? source.preview : '',
        metadata: null,
        score: typeof source.score === 'number' ? source.score : 0,
    }));
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};

// --- Admin API Functions (Existentes) ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}

// --- createUser CORREGIDO ---
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload); // Log antes de la llamada real
     // Llamada API real usando la funci√≥n request gen√©rica
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
         // Los headers (Content-Type, Authorization) son gestionados por la funci√≥n `request`
     });
}
// --- FIN CORRECCI√ìN ---
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// --- Document Stats API ---
export interface DocumentStatsResponse {
  total_documents: number;
  total_chunks: number;
  by_status: Record<string, number>;
  by_type: Record<string, number>;
  by_user: Array<{ user_id: string; name: string; count: number }>;
  recent_activity: Array<{ date: string; uploaded: number; processed: number; error: number }>;
  oldest_document_date: string | null;
  newest_document_date: string | null;
}

/**
 * Obtiene estad√≠sticas agregadas de documentos desde el backend.
 * @param authHeaders Cabeceras de autenticaci√≥n (X-User-ID, X-Company-ID)
 * @param params Par√°metros opcionales: from_date, to_date, status, group_by
 */
export async function getDocumentStats(
  authHeaders: AuthHeaders,
  params?: { from_date?: string; to_date?: string; status?: string; group_by?: string }
): Promise<DocumentStatsResponse> {
  let query = '';
  if (params) {
    const q = Object.entries(params)
      .filter(([_, v]) => v)
      .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v!)}`)
      .join('&');
    if (q) query = `?${q}`;
  }
  return request<DocumentStatsResponse>(
    `/api/v1/documents/stats${query}`,
    { method: 'GET', headers: { ...authHeaders } as Record<string, string> }
  );
}
// Bulk delete documents
export interface BulkDeleteResponse {
  deleted: string[];
  failed: { id: string; error: string }[];
}

/**
 * Borra m√∫ltiples documentos en una sola petici√≥n.
 * @param documentIds IDs de los documentos a borrar
 * @param auth Cabeceras de autenticaci√≥n
 */
export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>(
    '/api/v1/ingest/bulk',
    {
      method: 'DELETE',
      headers: { ...auth } as Record<string, string>,
      body: JSON.stringify({ document_ids: documentIds })
    }
  );
}
// File: lib/api.ts (CORREGIDO - Implementada la llamada API real para createUser)
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error (sin cambios) ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request (sin cambios estructurales) ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    // Permitir endpoints /admin y /docs, /openapi.json
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         // No advertir para endpoints admin si el token no est√° (la API lo rechazar√° si es necesario)
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio (Existentes) ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }
export interface RetrievedDocApi { id: string; document_id: string; file_name: string | null; content: string; content_preview: string; metadata: Record<string, any> | null; score: number; }
export type RetrievedDoc = RetrievedDocApi;
export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface ChatMessageApi { id: string; chat_id: string; role: 'user' | 'assistant'; content: string; sources: Array<{ chunk_id: string; document_id: string; file_name: string | null; score: number; preview: string; }> | null; created_at: string; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }

// --- NUEVO: Tipos para Admin API ---
export interface AdminStatsResponse {
    company_count: number;
    users_per_company: Array<{
        company_id: string;
        name: string | null; // Nombre de la compa√±√≠a
        user_count: number;
    }>;
}
export interface CompanySelectItem {
    id: string;
    name: string;
}
export interface CreateCompanyPayload {
    name: string;
}
export interface CompanyResponse {
    id: string;
    name: string;
    created_at?: string;
}
export interface CreateUserPayload {
    email: string;
    password: string;
    name: string;
    company_id: string;
    roles?: string[];
}
export interface UserResponse {
    id: string;
    email: string;
    name: string | null;
    company_id: string | null;
    is_active?: boolean;
    created_at?: string;
}

// --- Funciones API Espec√≠ficas (Existentes - Cuerpo Restaurado) ---

// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};

// ** HELPERS **
export const mapApiSourcesToFrontend = (apiSources: ChatMessageApi['sources']): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;
    return apiSources.map(source => ({
        id: typeof source.chunk_id === 'string' ? source.chunk_id : '',
        document_id: typeof source.document_id === 'string' ? source.document_id : '',
        file_name: typeof source.file_name === 'string' ? source.file_name : '',
        content: typeof source.preview === 'string' ? source.preview : '',
        content_preview: typeof source.preview === 'string' ? source.preview : '',
        metadata: null,
        score: typeof source.score === 'number' ? source.score : 0,
    }));
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};

// --- Admin API Functions (Existentes) ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}

// --- createUser CORREGIDO ---
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload); // Log antes de la llamada real
     // Llamada API real usando la funci√≥n request gen√©rica
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
         // Los headers (Content-Type, Authorization) son gestionados por la funci√≥n `request`
     });
}
// --- FIN CORRECCI√ìN ---
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// File: lib/api.ts
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }

// Estructura de un documento/fragmento recuperado por la API de /ask
export interface RetrievedDocApi {
  id: string; // ID del chunk/fragmento
  document_id: string; // ID del documento padre
  file_name: string | null;
  content: string; // Contenido completo del chunk
  content_preview: string; // Vista previa del chunk
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; // Opcional, si el backend lo empieza a enviar para /ask
}

// Estructura de una fuente tal como viene en el historial de mensajes del backend
interface ChatMessageSourceFromHistory {
    score: number;
    pagina?: string;
    cita_tag: string;
    id_documento: string; // Generalmente es el ID del chunk, a veces compuesto (docId_chunkId)
    nombre_archivo: string; // A menudo "None"
    // Campos que faltan en el historial y est√°n en RetrievedDocApi: preview (content/content_preview), metadata, document_id (padre expl√≠cito si id_documento es solo chunk)
}

// Estructura de un mensaje de chat de la API (para historial)
export interface ChatMessageApi {
    id: string;
    chat_id: string;
    role: 'user' | 'assistant';
    content: string;
    sources: ChatMessageSourceFromHistory[] | null; // Usa la nueva interfaz
    created_at: string;
}

// Interfaz unificada para el frontend (usada en panel de fuentes, etc.)
export type RetrievedDoc = {
  id: string; // ID del chunk/fragmento
  document_id: string; // ID del documento padre
  file_name: string | null;
  content?: string; // Contenido completo (puede no estar disponible para historial)
  content_preview?: string; // Vista previa (puede no estar disponible para historial)
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; // Para mostrar "Doc 1", etc.
};

export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }
export interface AdminStatsResponse { company_count: number; users_per_company: Array<{ company_id: string; name: string | null; user_count: number; }>; }
export interface CompanySelectItem { id: string; name: string; }
export interface CreateCompanyPayload { name: string; }
export interface CompanyResponse { id: string; name: string; created_at?: string; }
export interface CreateUserPayload { email: string; password: string; name: string; company_id: string; roles?: string[]; }
export interface UserResponse { id: string; email: string; name: string | null; company_id: string | null; is_active?: boolean; created_at?: string; }
export interface BulkDeleteResponse { deleted: string[]; failed: { id: string; error: string }[]; }
export interface DocumentStatsResponse { total_documents: number; total_chunks: number; by_status: Record<string, number>; by_type: Record<string, number>; by_user: Array<{ user_id: string; name: string; count: number }>; recent_activity: Array<{ date: string; uploaded: number; processed: number; error: number }>; oldest_document_date: string | null; newest_document_date: string | null; }


// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>( '/api/v1/ingest/bulk', { method: 'DELETE', headers: { ...auth } as Record<string, string>, body: JSON.stringify({ document_ids: documentIds }) } );
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};


// ** HELPERS **
export const mapApiSourcesToFrontend = (
    apiSources: Array<RetrievedDocApi | ChatMessageSourceFromHistory> | null | undefined
): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;

    return apiSources.map((source: any) => {
        if ('id_documento' in source && !('document_id' in source)) { // Es ChatMessageSourceFromHistory (del historial)
            const historySource = source as ChatMessageSourceFromHistory;
            const parts = historySource.id_documento.split('_');
            const docId = parts.length > 1 ? parts.slice(0, -1).join('_') : historySource.id_documento;
            
            return {
                id: historySource.id_documento, // ID completo del chunk/fragmento (e.g., "docABC_1")
                document_id: docId, // ID del documento padre (e.g., "docABC")
                file_name: historySource.nombre_archivo === "None" ? null : historySource.nombre_archivo,
                content: undefined, // No disponible en historial
                content_preview: undefined, // No disponible en historial
                metadata: null,
                score: historySource.score,
                cita_tag: historySource.cita_tag
            };
        } else { // Es RetrievedDocApi (de /ask o un tipo ya compatible)
            const askSource = source as RetrievedDocApi;
            return {
                id: askSource.id,
                document_id: askSource.document_id,
                file_name: askSource.file_name,
                content: askSource.content,
                content_preview: askSource.content_preview,
                metadata: askSource.metadata,
                score: askSource.score,
                cita_tag: askSource.cita_tag // Propagar si existe
            };
        }
    });
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};


// --- Admin API Functions ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload);
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
     });
}

// --- Document Stats API ---
export async function getDocumentStats(
  authHeaders: AuthHeaders,
  params?: { from_date?: string; to_date?: string; status?: string; group_by?: string }
): Promise<DocumentStatsResponse> {
  let query = '';
  if (params) {
    const q = Object.entries(params)
      .filter(([_, v]) => v)
      .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v!)}`)
      .join('&');
    if (q) query = `?${q}`;
  }
  return request<DocumentStatsResponse>(
    `/api/v1/documents/stats${query}`,
    { method: 'GET', headers: { ...authHeaders } as Record<string, string> }
  );
}
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// File: lib/api.ts
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }

// Estructura de un documento/fragmento recuperado por la API de /ask
export interface RetrievedDocApi {
  id: string; // ID del chunk/fragmento
  document_id: string | null; // ID del documento padre, PUEDE SER NULL
  file_name: string | null;
  content: string; // Contenido completo del chunk
  content_preview: string; // Vista previa del chunk
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; // Opcional, si el backend lo empieza a enviar para /ask
}

// Estructura de una fuente tal como viene en el historial de mensajes del backend
interface ChatMessageSourceFromHistory {
    score: number;
    pagina?: string;
    cita_tag: string;
    id_documento: string; 
    nombre_archivo: string; 
}

// Estructura de un mensaje de chat de la API (para historial)
export interface ChatMessageApi {
    id: string;
    chat_id: string;
    role: 'user' | 'assistant';
    content: string;
    sources: ChatMessageSourceFromHistory[] | null;
    created_at: string;
}

// Interfaz unificada para el frontend (usada en panel de fuentes, etc.)
export type RetrievedDoc = {
  id: string; 
  document_id: string | null; // Puede ser null
  file_name: string | null;
  content?: string; // Contenido completo (puede no estar disponible para historial)
  content_preview?: string; // Vista previa (puede no estar disponible para historial)
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; 
};

export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }
export interface AdminStatsResponse { company_count: number; users_per_company: Array<{ company_id: string; name: string | null; user_count: number; }>; }
export interface CompanySelectItem { id: string; name: string; }
export interface CreateCompanyPayload { name: string; }
export interface CompanyResponse { id: string; name: string; created_at?: string; }
export interface CreateUserPayload { email: string; password: string; name: string; company_id: string; roles?: string[]; }
export interface UserResponse { id: string; email: string; name: string | null; company_id: string | null; is_active?: boolean; created_at?: string; }
export interface BulkDeleteResponse { deleted: string[]; failed: { id: string; error: string }[]; }
export interface DocumentStatsResponse { total_documents: number; total_chunks: number; by_status: Record<string, number>; by_type: Record<string, number>; by_user: Array<{ user_id: string; name: string; count: number }>; recent_activity: Array<{ date: string; uploaded: number; processed: number; error: number }>; oldest_document_date: string | null; newest_document_date: string | null; }


// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>( '/api/v1/ingest/bulk', { method: 'DELETE', headers: { ...auth } as Record<string, string>, body: JSON.stringify({ document_ids: documentIds }) } );
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};


// ** HELPERS **
export const mapApiSourcesToFrontend = (
    apiSources: Array<RetrievedDocApi | ChatMessageSourceFromHistory> | null | undefined
): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;

    return apiSources.map((source: any) => {
        if ('id_documento' in source && !('document_id' in source)) { 
            const historySource = source as ChatMessageSourceFromHistory;
            const parts = historySource.id_documento.split('_');
            const docId = parts.length > 1 ? parts.slice(0, -1).join('_') : historySource.id_documento;
            
            return {
                id: historySource.id_documento,
                document_id: docId, 
                file_name: historySource.nombre_archivo === "None" ? null : historySource.nombre_archivo,
                content: undefined, 
                content_preview: undefined, 
                metadata: null,
                score: historySource.score,
                cita_tag: historySource.cita_tag
            };
        } else { 
            const askSource = source as RetrievedDocApi;
            return {
                id: askSource.id,
                document_id: askSource.document_id, 
                file_name: askSource.file_name,
                content: askSource.content, 
                content_preview: askSource.content_preview, 
                metadata: askSource.metadata,
                score: askSource.score,
                cita_tag: askSource.cita_tag
            };
        }
    });
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};


// --- Admin API Functions ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload);
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
     });
}

// --- Document Stats API ---
export async function getDocumentStats(
  authHeaders: AuthHeaders,
  params?: { from_date?: string; to_date?: string; status?: string; group_by?: string }
): Promise<DocumentStatsResponse> {
  let query = '';
  if (params) {
    const q = Object.entries(params)
      .filter(([_, v]) => v)
      .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v!)}`)
      .join('&');
    if (q) query = `?${q}`;
  }
  return request<DocumentStatsResponse>(
    `/api/v1/documents/stats${query}`,
    { method: 'GET', headers: { ...authHeaders } as Record<string, string> }
  );
}
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// File: lib/api.ts
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }

// Estructura de un documento/fragmento recuperado por la API de /ask
export interface RetrievedDocApi {
  id: string; // ID del chunk/fragmento
  document_id: string | null; // ID del documento padre, PUEDE SER NULL
  file_name: string | null;
  content: string; // Contenido completo del chunk
  content_preview: string; // Vista previa del chunk
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; // Opcional, si el backend lo empieza a enviar para /ask
}

// Estructura de una fuente tal como viene en el historial de mensajes del backend
interface ChatMessageSourceFromHistory {
    score: number;
    pagina?: string;
    cita_tag: string;
    id_documento: string; 
    nombre_archivo: string; 
}

// Estructura de un mensaje de chat de la API (para historial)
export interface ChatMessageApi {
    id: string;
    chat_id: string;
    role: 'user' | 'assistant';
    content: string;
    sources: ChatMessageSourceFromHistory[] | null;
    created_at: string;
}

// Interfaz unificada para el frontend (usada en panel de fuentes, etc.)
export type RetrievedDoc = {
  id: string; 
  document_id: string | null; // Puede ser null
  file_name: string | null;
  content?: string; // Contenido completo (puede no estar disponible para historial)
  content_preview?: string; // Vista previa (puede no estar disponible para historial)
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; 
};

export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }
export interface AdminStatsResponse { company_count: number; users_per_company: Array<{ company_id: string; name: string | null; user_count: number; }>; }
export interface CompanySelectItem { id: string; name: string; }
export interface CreateCompanyPayload { name: string; }
export interface CompanyResponse { id: string; name: string; created_at?: string; }
export interface CreateUserPayload { email: string; password: string; name: string; company_id: string; roles?: string[]; }
export interface UserResponse { id: string; email: string; name: string | null; company_id: string | null; is_active?: boolean; created_at?: string; }
export interface BulkDeleteResponse { deleted: string[]; failed: { id: string; error: string }[]; }
export interface DocumentStatsResponse { total_documents: number; total_chunks: number; by_status: Record<string, number>; by_type: Record<string, number>; by_user: Array<{ user_id: string; name: string; count: number }>; recent_activity: Array<{ date: string; uploaded: number; processed: number; error: number }>; oldest_document_date: string | null; newest_document_date: string | null; }


// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>( '/api/v1/ingest/bulk', { method: 'DELETE', headers: { ...auth } as Record<string, string>, body: JSON.stringify({ document_ids: documentIds }) } );
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};


// ** HELPERS **
export const mapApiSourcesToFrontend = (
    apiSources: Array<RetrievedDocApi | ChatMessageSourceFromHistory> | null | undefined
): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;

    return apiSources.map((source: any) => {
        if ('id_documento' in source && !('document_id' in source)) { 
            const historySource = source as ChatMessageSourceFromHistory;
            const parts = historySource.id_documento.split('_');
            const docId = parts.length > 1 ? parts.slice(0, -1).join('_') : historySource.id_documento;
            
            return {
                id: historySource.id_documento,
                document_id: docId, 
                file_name: historySource.nombre_archivo === "None" ? null : historySource.nombre_archivo,
                content: undefined, 
                content_preview: undefined, 
                metadata: null,
                score: historySource.score,
                cita_tag: historySource.cita_tag
            };
        } else { 
            const askSource = source as RetrievedDocApi;
            return {
                id: askSource.id,
                document_id: askSource.document_id, 
                file_name: askSource.file_name,
                content: askSource.content, 
                content_preview: askSource.content_preview, 
                metadata: askSource.metadata,
                score: askSource.score,
                cita_tag: askSource.cita_tag
            };
        }
    });
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};


// --- Admin API Functions ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload);
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
     });
}

// --- Document Stats API ---
export async function getDocumentStats(
  authHeaders: AuthHeaders,
  params?: { from_date?: string; to_date?: string; status?: string; group_by?: string }
): Promise<DocumentStatsResponse> {
  let query = '';
  if (params) {
    const q = Object.entries(params)
      .filter(([_, v]) => v)
      .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v!)}`)
      .join('&');
    if (q) query = `?${q}`;
  }
  return request<DocumentStatsResponse>(
    `/api/v1/documents/stats${query}`,
    { method: 'GET', headers: { ...authHeaders } as Record<string, string> }
  );
}
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: payload.name || payload.full_name || null, // Intentar con full_name si name no existe
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```

```

## File: `lib\api.ts`
```ts
// File: lib/api.ts
import { getApiGatewayUrl } from './utils';
import type { Message } from '@/components/chat/chat-message';
import { AUTH_TOKEN_KEY } from './constants';

// --- Tipos de Error ---
interface ApiErrorDataDetail { msg: string; type: string; loc?: (string | number)[]; }
interface ApiErrorData { detail?: string | ApiErrorDataDetail[] | any; message?: string; }
export class ApiError extends Error {
    status: number; data?: ApiErrorData;
    constructor(message: string, status: number, data?: ApiErrorData) {
        super(message); this.name = 'ApiError'; this.status = status; this.data = data;
        Object.setPrototypeOf(this, ApiError.prototype);
    }
}

// --- Funci√≥n Gen√©rica de Request ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
     if (!cleanEndpoint.startsWith('/api/v1/') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
        console.error(`Invalid API endpoint format: ${cleanEndpoint}. Must start with /api/v1/`);
        throw new ApiError(`Invalid API endpoint format: ${cleanEndpoint}.`, 400);
    }
    let apiUrl: string;
    try { apiUrl = `${getApiGatewayUrl()}${cleanEndpoint}`; } catch (err) {
        const message = err instanceof Error ? err.message : "API Gateway URL configuration error.";
        console.error("API Request failed: Could not get API Gateway URL.", err); throw new ApiError(message, 500);
    }
    let token: string | null = null; if (typeof window !== 'undefined') { token = localStorage.getItem(AUTH_TOKEN_KEY); }
    const headers = new Headers(options.headers || {}); headers.set('Accept', 'application/json');
    if (apiUrl.includes("ngrok-free.app")) { headers.set('ngrok-skip-browser-warning', 'true'); }
    if (!(options.body instanceof FormData)) { if (!headers.has('Content-Type')) { headers.set('Content-Type', 'application/json'); } } else { headers.delete('Content-Type'); }
    if (token) { headers.set('Authorization', `Bearer ${token}`); }
    else if (!cleanEndpoint.includes('/api/v1/users/login') && cleanEndpoint !== '/api/v1/docs' && cleanEndpoint !== '/openapi.json') {
         if (!cleanEndpoint.startsWith('/api/v1/admin')) {
             console.warn(`API Request: Making request to protected endpoint ${cleanEndpoint} without Authorization header.`);
         }
    }
    const config: RequestInit = { ...options, headers };
    console.log(`API Request: ${options.method || 'GET'} ${apiUrl}`);
    try {
        const response = await fetch(apiUrl, config);
        if (!response.ok) {
            let errorData: ApiErrorData | null = null; let errorText = ''; const contentType = response.headers.get('content-type');
            try { if (contentType && contentType.includes('application/json')) { errorData = await response.json(); } else { errorText = await response.text(); } }
            catch (parseError) { console.warn(`API Request: Could not parse error response body for ${response.status} ${response.statusText} from ${apiUrl}`, parseError); try { errorText = await response.text(); } catch {}}
            let errorMessage = `API Error (${response.status})`;
            if (errorData) {
                if (typeof errorData.detail === 'string') { errorMessage = errorData.detail; }
                else if (Array.isArray(errorData.detail) && errorData.detail.length > 0 && typeof errorData.detail[0].msg === 'string') { errorMessage = errorData.detail.map(d => `${d.loc ? d.loc.join('.')+': ' : ''}${d.msg}`).join('; '); }
                else if (typeof errorData.message === 'string') { errorMessage = errorData.message; }
                else { errorMessage = JSON.stringify(errorData.detail).substring(0, 200); }
            } else if (errorText) { errorMessage = errorText.substring(0, 200); }
            else { errorMessage = response.statusText || `Request failed with status ${response.status}`; }
            console.error(`API Error Response: ${response.status} ${response.statusText} from ${apiUrl}`, { data: errorData, text: errorText });
            throw new ApiError(errorMessage, response.status, errorData || undefined);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') { return null as T; }
        try { const data: T = await response.json(); return data; }
        catch (jsonError) {
            const responseText = await response.text().catch(() => "Could not read response text.");
            console.error(`API Request: Invalid JSON response from ${apiUrl}. Status: ${response.status}. Response Text: ${responseText}`, jsonError);
            throw new ApiError(`Invalid JSON response received from server.`, response.status);
        }
    } catch (error) {
        if (error instanceof ApiError) { throw error; }
        else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
            const networkErrorMsg = 'Network error or API Gateway unreachable. Check connection and API URL.';
            console.error(`API Request Network Error: ${networkErrorMsg} (URL: ${apiUrl})`, error);
            throw new ApiError(networkErrorMsg, 0);
        } else {
            console.error(`API Request: Unexpected error during fetch to ${apiUrl}`, error);
            const message = error instanceof Error ? error.message : 'An unknown fetch error occurred.';
            throw new ApiError(`Unexpected fetch error: ${message}`, 500);
        }
    }
}

// --- Tipos Espec√≠ficos de Servicio ---
export interface IngestResponse { document_id: string; task_id: string; status: string; message: string; }
export interface AuthHeaders { 'X-Company-ID': string; 'X-User-ID': string; }
export interface DocumentStatusApiResponse { id: string; status: string; file_name?: string | null; file_type?: string | null; file_path?: string | null; company_id?: string; chunk_count?: number | null; error_message?: string | null; created_at?: string; uploaded_at?: string; last_updated?: string; minio_exists?: boolean; milvus_chunk_count?: number; message?: string; }
export interface DocumentStatusResponse { document_id: string; status: string; file_name?: string | null; file_type?: string | null; chunk_count?: number | null; error_message?: string | null; created_at?: string; last_updated?: string | null; minio_exists?: boolean; milvus_chunk_count?: number; }
export interface DetailedDocumentStatusResponse extends DocumentStatusResponse { minio_exists: boolean; milvus_chunk_count: number; message?: string; }

// Estructura de un documento/fragmento recuperado por la API de /ask
export interface RetrievedDocApi {
  id: string; // ID del chunk/fragmento
  document_id: string | null; // ID del documento padre, PUEDE SER NULL
  file_name: string | null;
  content: string; // Contenido completo del chunk
  content_preview: string; // Vista previa del chunk
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; // Opcional, si el backend lo empieza a enviar para /ask
}

// Estructura de una fuente tal como viene en el historial de mensajes del backend
interface ChatMessageSourceFromHistory {
    score: number;
    pagina?: string;
    cita_tag: string;
    id_documento: string; 
    nombre_archivo: string; 
}

// Estructura de un mensaje de chat de la API (para historial)
export interface ChatMessageApi {
    id: string;
    chat_id: string;
    role: 'user' | 'assistant';
    content: string;
    sources: ChatMessageSourceFromHistory[] | null;
    created_at: string;
}

// Interfaz unificada para el frontend (usada en panel de fuentes, etc.)
export type RetrievedDoc = {
  id: string; 
  document_id: string | null; // Puede ser null
  file_name: string | null;
  content?: string; // Contenido completo (puede no estar disponible para historial)
  content_preview?: string; // Vista previa (puede no estar disponible para historial)
  metadata: Record<string, any> | null;
  score: number;
  cita_tag?: string; 
};

export interface ChatSummary { id: string; title: string | null; created_at: string; updated_at: string; message_count: number; }
export interface QueryPayload { query: string; retriever_top_k?: number; chat_id?: string | null; }
export interface QueryApiResponse { answer: string; retrieved_documents: RetrievedDocApi[]; query_log_id: string | null; chat_id: string; }
export interface LoginResponse { access_token: string; token_type: string; user_id: string; email: string; full_name: string | null; role: string; company_id: string | null; }
export interface AdminStatsResponse { company_count: number; users_per_company: Array<{ company_id: string; name: string | null; user_count: number; }>; }
export interface CompanySelectItem { id: string; name: string; }
export interface CreateCompanyPayload { name: string; }
export interface CompanyResponse { id: string; name: string; created_at?: string; }
export interface CreateUserPayload { email: string; password: string; name: string; company_id: string; roles?: string[]; }
export interface UserResponse { id: string; email: string; name: string | null; company_id: string | null; is_active?: boolean; created_at?: string; }
export interface UserAdminResponse { 
  id: string; 
  email: string; 
  name: string | null; 
  company_id: string | null; 
  is_active?: boolean; 
  created_at?: string;
  roles?: string[];
}
export interface BulkDeleteResponse { deleted: string[]; failed: { id: string; error: string }[]; }
export interface DocumentStatsResponse { total_documents: number; total_chunks: number; by_status: Record<string, number>; by_type: Record<string, number>; by_user: Array<{ user_id: string; name: string; count: number }>; recent_activity: Array<{ date: string; uploaded: number; processed: number; error: number }>; oldest_document_date: string | null; newest_document_date: string | null; }


// ** INGEST SERVICE **
export async function uploadDocument(file: File, auth: AuthHeaders): Promise<IngestResponse> {
  const formData = new FormData(); formData.append('file', file);
  return request<IngestResponse>('/api/v1/ingest/upload', { method: 'POST', headers: { ...auth } as Record<string, string>, body: formData });
}

const mapApiResponseToFrontend = (apiDoc: DocumentStatusApiResponse): DocumentStatusResponse => {
    return {
        document_id: apiDoc.id, status: apiDoc.status, file_name: apiDoc.file_name,
        file_type: apiDoc.file_type, chunk_count: apiDoc.chunk_count,
        error_message: apiDoc.error_message, created_at: apiDoc.created_at || apiDoc.uploaded_at,
        last_updated: apiDoc.last_updated, minio_exists: apiDoc.minio_exists,
        milvus_chunk_count: apiDoc.milvus_chunk_count,
    };
};

export async function getDocumentStatusList(auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<DocumentStatusResponse[]> {
  const endpoint = `/api/v1/ingest/status?limit=${limit}&offset=${offset}`;
  const apiResponse = await request<DocumentStatusApiResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
  return (apiResponse || []).map(mapApiResponseToFrontend);
}

export const getDocumentStatus = async (documentId: string, auth: AuthHeaders): Promise<DetailedDocumentStatusResponse> => {
    if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido.", 400); }
    const apiDoc = await request<DocumentStatusApiResponse>(`/api/v1/ingest/status/${documentId}`, { method: 'GET', headers: { ...auth } as Record<string, string> });
    const frontendDoc = mapApiResponseToFrontend(apiDoc) as DetailedDocumentStatusResponse;
    frontendDoc.minio_exists = apiDoc.minio_exists ?? false;
    frontendDoc.milvus_chunk_count = apiDoc.milvus_chunk_count ?? -1;
    frontendDoc.message = apiDoc.message;
    return frontendDoc;
};

export async function retryIngestDocument(documentId: string, auth: AuthHeaders): Promise<IngestResponse> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para reintentar.", 400); }
  const endpoint = `/api/v1/ingest/retry/${documentId}`;
  return request<IngestResponse>(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth } as Record<string, string> });
}

export async function deleteIngestDocument(documentId: string, auth: AuthHeaders): Promise<void> {
  if (!documentId || typeof documentId !== 'string') { throw new ApiError("Se requiere un ID de documento v√°lido para eliminar.", 400); }
  await request<null>(`/api/v1/ingest/${documentId}`, { method: 'DELETE', headers: { ...auth } as Record<string, string> });
}

export async function deleteIngestDocumentsBulk(documentIds: string[], auth: AuthHeaders): Promise<BulkDeleteResponse> {
  if (!Array.isArray(documentIds) || documentIds.length === 0) throw new ApiError("Se requiere al menos un ID de documento para borrado masivo.", 400);
  return request<BulkDeleteResponse>( '/api/v1/ingest/bulk', { method: 'DELETE', headers: { ...auth } as Record<string, string>, body: JSON.stringify({ document_ids: documentIds }) } );
}

// ** QUERY SERVICE **
export const getChats = async (limit: number = 100, offset: number = 0): Promise<ChatSummary[]> => {
     const endpoint = `/api/v1/query/chats?limit=${limit}&offset=${offset}`;
     const response = await request<ChatSummary[]>(endpoint); return response || [];
};

export const getChatMessages = async (chatId: string, limit: number = 100, offset: number = 0): Promise<ChatMessageApi[]> => {
     if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido.", 400); }
     const endpoint = `/api/v1/query/chats/${chatId}/messages?limit=${limit}&offset=${offset}`;
     const response = await request<ChatMessageApi[]>(endpoint); return response || [];
};

export const postQuery = async (payload: QueryPayload): Promise<QueryApiResponse> => {
     const body = { ...payload, chat_id: payload.chat_id || null };
     return request<QueryApiResponse>('/api/v1/query/ask', { method: 'POST', body: JSON.stringify(body) });
};

export const deleteChat = async (chatId: string): Promise<void> => {
    if (!chatId || typeof chatId !== 'string') { throw new ApiError("Se requiere un ID de chat v√°lido para eliminar.", 400); }
    await request<null>(`/api/v1/query/chats/${chatId}`, { method: 'DELETE' });
};


// ** HELPERS **
export const mapApiSourcesToFrontend = (
    apiSources: Array<RetrievedDocApi | ChatMessageSourceFromHistory> | null | undefined
): RetrievedDoc[] | undefined => {
    if (!apiSources || apiSources.length === 0) return undefined;

    return apiSources.map((source: any) => {
        if ('id_documento' in source && !('document_id' in source)) { 
            const historySource = source as ChatMessageSourceFromHistory;
            const parts = historySource.id_documento.split('_');
            const docId = parts.length > 1 ? parts.slice(0, -1).join('_') : historySource.id_documento;
            
            return {
                id: historySource.id_documento,
                document_id: docId, 
                file_name: historySource.nombre_archivo === "None" ? null : historySource.nombre_archivo,
                content: undefined, 
                content_preview: undefined, 
                metadata: null,
                score: historySource.score,
                cita_tag: historySource.cita_tag
            };
        } else { 
            const askSource = source as RetrievedDocApi;
            return {
                id: askSource.id,
                document_id: askSource.document_id, 
                file_name: askSource.file_name,
                content: askSource.content, 
                content_preview: askSource.content_preview, 
                metadata: askSource.metadata,
                score: askSource.score,
                cita_tag: askSource.cita_tag
            };
        }
    });
};

export const mapApiMessageToFrontend = (apiMessage: ChatMessageApi): Message => {
    const mappedSources = mapApiSourcesToFrontend(apiMessage.sources);
    return { id: apiMessage.id, role: apiMessage.role, content: apiMessage.content, sources: mappedSources, isError: false, created_at: apiMessage.created_at, };
};


// --- Admin API Functions ---
export async function getAdminStats(): Promise<AdminStatsResponse> {
    return request<AdminStatsResponse>('/api/v1/admin/stats', { method: 'GET' });
}
export async function listCompaniesForSelect(): Promise<CompanySelectItem[]> {
    return request<CompanySelectItem[]>('/api/v1/admin/companies/select', { method: 'GET' });
}
export async function createCompany(payload: CreateCompanyPayload): Promise<CompanyResponse> {
    return request<CompanyResponse>('/api/v1/admin/companies', { method: 'POST', body: JSON.stringify(payload) });
}
export async function createUser(payload: CreateUserPayload): Promise<UserResponse> {
     console.log("API Call: Attempting createUser with payload:", payload);
     return request<UserResponse>('/api/v1/admin/users', {
         method: 'POST',
         body: JSON.stringify(payload),
     });
}

// --- Document Stats API ---
export async function getDocumentStats(
  authHeaders: AuthHeaders,
  params?: { from_date?: string; to_date?: string; status?: string; group_by?: string }
): Promise<DocumentStatsResponse> {
  let query = '';
  if (params) {
    const q = Object.entries(params)
      .filter(([_, v]) => v)
      .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v!)}`)
      .join('&');
    if (q) query = `?${q}`;
  }
  return request<DocumentStatsResponse>(
    `/api/v1/documents/stats${query}`,
    { method: 'GET', headers: { ...authHeaders } as Record<string, string> }
  );
}

// --- User API Functions ---
export async function getUsersByCompany(companyId: string, auth: AuthHeaders, limit: number = 50, offset: number = 0): Promise<UserAdminResponse[]> {
  if (!companyId || typeof companyId !== 'string') { throw new ApiError("Se requiere un ID de empresa v√°lido.", 400); }
  const endpoint = `/api/v1/admin/users/by_company/${companyId}?limit=${limit}&offset=${offset}`;
  return request<UserAdminResponse[]>(endpoint, { method: 'GET', headers: { ...auth } as Record<string, string> });
}
```

## File: `lib\auth\helpers.ts`
```ts
// File: lib/auth/helpers.ts
// Purpose: Define shared authentication types/interfaces.

// --- Frontend User Interface ---
// Defines the structure of the user object used within the frontend application.
export interface User {
  userId: string;    // Mapped from Supabase User ID (user.id)
  email?: string;    // Mapped from Supabase User Email (user.email)
  name?: string | null; // Mapped from Supabase User Metadata (user.user_metadata.full_name or name) - Allow null
  companyId?: string | null; // Mapped from Supabase App Metadata (user.app_metadata.company_id) - Allow null
  roles?: string[];  // Mapped from Supabase App Metadata (user.app_metadata.roles)
  isAdmin?: boolean; // NUEVO: Flag para identificar al administrador
}
```

## File: `lib\constants.ts`
```ts
export const APP_NAME = "Atenex";
export const AUTH_TOKEN_KEY = "atenex_auth_token";
```

## File: `lib\hooks\useAuth.tsx`
```tsx
// File: lib/hooks/useAuth.tsx
"use client";

import React, {
    createContext,
    useContext,
    useState,
    useEffect,
    useCallback,
    ReactNode,
} from 'react';
import { useRouter, usePathname } from 'next/navigation'; // Import usePathname
import { User as AppUser } from '@/lib/auth/helpers'; // Importa la interfaz actualizada
import { toast } from "sonner";
import { AUTH_TOKEN_KEY } from '@/lib/constants';
import { getApiGatewayUrl } from '@/lib/utils'; // cn no se usa aqu√≠

// --- CORRECCI√ìN: Usar el email correcto del admin seg√∫n los logs ---
const ADMIN_EMAIL = "admin@atenex.com"; // Antes era "atenex@gmail.com"

interface AuthContextType {
    user: AppUser | null;
    token: string | null;
    isLoading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
}

const defaultAuthContextValue: AuthContextType = {
    user: null,
    token: null,
    isLoading: true,
    signIn: async () => { throw new Error("AuthProvider no inicializado"); },
    signOut: async () => { throw new Error("AuthProvider no inicializado"); },
};

const AuthContext = createContext<AuthContextType>(defaultAuthContextValue);

interface AuthProviderProps { children: ReactNode; }

function decodeJwtPayload(token: string): any | null {
    try {
        const base64Url = token.split('.')[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Fallo al decodificar JWT:", error);
        return null;
    }
}

function getUserFromDecodedToken(payload: any): AppUser | null {
    if (!payload || !payload.sub) {
        return null;
    }
    // A√±adir la l√≥gica isAdmin comparando con la constante corregida
    const isAdmin = payload.email === ADMIN_EMAIL;
    let name = payload.name || payload.full_name || null;
    // Fallback defensivo: si name es null/undefined, usar la parte antes de @ del email
    if (!name && typeof payload.email === 'string') {
        name = payload.email.split('@')[0];
    }
    console.log(`getUserFromDecodedToken: Email=${payload.email}, IsAdmin=${isAdmin}, Name=${name}`); // Mantener log para verificaci√≥n
    return {
        userId: payload.sub,
        email: payload.email,
        name: name,
        companyId: payload.company_id || null,
        roles: payload.roles || [],
        isAdmin: isAdmin,
    };
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [token, setToken] = useState<string | null>(null);
    const [user, setUser] = useState<AppUser | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        console.log("AuthProvider: Inicializando...");
        if (typeof window !== 'undefined') {
            try {
                const storedToken = localStorage.getItem(AUTH_TOKEN_KEY);
                if (storedToken) {
                    const decodedPayload = decodeJwtPayload(storedToken);
                    const currentUser = getUserFromDecodedToken(decodedPayload);

                    if (currentUser) {
                        const isExpired = decodedPayload.exp && (decodedPayload.exp * 1000 < Date.now());
                        if (isExpired) {
                            console.warn("AuthProvider: Token expirado. Limpiando.");
                            localStorage.removeItem(AUTH_TOKEN_KEY);
                            setToken(null);
                            setUser(null);
                        } else {
                            console.log("AuthProvider: Token v√°lido encontrado.", currentUser);
                            setToken(storedToken);
                            setUser(currentUser);

                            // --- Redirecci√≥n inicial si es Admin ---
                            // SOLO redirige si estamos en una p√°gina NO admin
                            if (currentUser.isAdmin && !pathname?.startsWith('/admin')) {
                                console.log("AuthProvider: Admin detectado en inicializaci√≥n fuera de /admin, redirigiendo a /admin");
                                router.replace('/admin');
                            }
                            // --- Fin Redirecci√≥n inicial ---
                        }
                    } else {
                        console.warn("AuthProvider: Token inv√°lido encontrado. Limpiando.");
                        localStorage.removeItem(AUTH_TOKEN_KEY);
                        setToken(null);
                        setUser(null);
                    }
                } else {
                    console.log("AuthProvider: No se encontr√≥ token.");
                    setToken(null);
                    setUser(null);
                }
            } catch (error) {
                console.error("AuthProvider: Error en inicializaci√≥n:", error);
                try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
                setToken(null);
                setUser(null);
            } finally {
                setIsLoading(false);
                console.log("AuthProvider: Carga inicial completa.");
            }
        } else {
             setIsLoading(false);
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []); // Ejecutar solo una vez al montar

    const signIn = useCallback(async (email: string, password: string): Promise<void> => {
        console.log("AuthProvider: Intentando iniciar sesi√≥n...");
        setIsLoading(true);
        let gatewayUrl = '';
        try {
            gatewayUrl = getApiGatewayUrl();
            const loginEndpoint = `${gatewayUrl}/api/v1/users/login`;
            console.log(`AuthProvider: Llamando a: ${loginEndpoint}`);

            const response = await fetch(loginEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(gatewayUrl.includes("ngrok-free.app") && { 'ngrok-skip-browser-warning': 'true' }),
                },
                body: JSON.stringify({ email, password }),
            });

            const responseBody = await response.json();

            if (!response.ok) {
                const errorMessage = responseBody?.message || responseBody?.detail || `Fallo en login (${response.status})`;
                console.error("AuthProvider: Fallo API login.", { status: response.status, body: responseBody });
                throw new Error(errorMessage);
            }

            const receivedToken = responseBody?.access_token || responseBody?.token;
            if (!receivedToken || typeof receivedToken !== 'string') {
                console.error("AuthProvider: Token no v√°lido en respuesta.", responseBody);
                throw new Error("Login OK, pero no se recibi√≥ token.");
            }

            const decodedPayload = decodeJwtPayload(receivedToken);
            const loggedInUser = getUserFromDecodedToken(decodedPayload);

            if (!loggedInUser) {
                console.error("AuthProvider: Token recibido inv√°lido.", receivedToken);
                throw new Error("Login OK, pero token inv√°lido.");
            }

            localStorage.setItem(AUTH_TOKEN_KEY, receivedToken);
            setToken(receivedToken);
            setUser(loggedInUser); // ¬°Aqu√≠ se actualiza el estado `user`!
            console.log("AuthProvider: Inicio de sesi√≥n exitoso.", loggedInUser);
            toast.success("Inicio de Sesi√≥n Exitoso", { description: `¬°Bienvenido de nuevo, ${loggedInUser.name || loggedInUser.email}!` });

            // La redirecci√≥n ahora deber√≠a funcionar porque loggedInUser.isAdmin ser√° true
            if (loggedInUser.isAdmin) {
                console.log("AuthProvider: Redirigiendo admin a /admin...");
                router.replace('/admin');
            } else {
                 console.log("AuthProvider: Redirigiendo usuario a /chat...");
                router.replace('/chat');
            }

        } catch (err: any) {
            console.error("AuthProvider: Error en inicio de sesi√≥n:", err);
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            toast.error("Inicio de Sesi√≥n Fallido", { description: err.message || "Ocurri√≥ un error inesperado." });
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [router]);

    const signOut = useCallback(async (): Promise<void> => {
        console.log("AuthProvider: Cerrando sesi√≥n...");
        setIsLoading(true);
        try {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            setToken(null);
            setUser(null);
            console.log("AuthProvider: Estado limpiado.");
            toast.success("Sesi√≥n Cerrada", { description: "Has cerrado sesi√≥n correctamente." });

            router.replace('/login'); // Siempre redirigir a login al cerrar sesi√≥n

        } catch (error) {
             console.error("AuthProvider: Error durante cierre de sesi√≥n:", error);
             localStorage.removeItem(AUTH_TOKEN_KEY); // Asegurar limpieza
             setToken(null);
             setUser(null);
             toast.error("Problema al Cerrar Sesi√≥n", { description: "Ocurri√≥ un error." });
        } finally {
             setIsLoading(false);
        }
    }, [router]);

    const value: AuthContextType = {
        user,
        token,
        isLoading,
        signIn,
        signOut,
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};
```

## File: `lib\hooks\useDocumentStatuses.ts`
```ts
// File: lib/hooks/useDocumentStatuses.ts (CORREGIDO - Usa document_id internamente)
import { useState, useEffect, useCallback, useRef } from 'react';
import {
    getDocumentStatusList,
    DocumentStatusResponse, // <-- Usa la interfaz mapeada del frontend
    DetailedDocumentStatusResponse,
    AuthHeaders,
    ApiError,
    getDocumentStatus
} from '@/lib/api';
import { useAuth } from '@/lib/hooks/useAuth';
import { toast } from 'sonner';

const DEFAULT_LIMIT = 30;

interface UseDocumentStatusesReturn {
  documents: DocumentStatusResponse[]; // Lista de documentos con 'document_id'
  isLoading: boolean;
  error: string | null;
  fetchDocuments: (reset?: boolean) => Promise<void>;
  fetchMore: () => void;
  hasMore: boolean;
  retryLocalUpdate: (documentId: string) => void;
  refreshDocument: (documentId: string) => Promise<void>;
  deleteLocalDocument: (documentId: string) => void;
}

export function useDocumentStatuses(): UseDocumentStatusesReturn {
  const { user, isLoading: isAuthLoading } = useAuth();
  // FLAG_LLM: El estado interno usa la interfaz DocumentStatusResponse con 'document_id'
  const [documents, setDocuments] = useState<DocumentStatusResponse[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const offsetRef = useRef<number>(0);
  const [hasMore, setHasMore] = useState<boolean>(true);
  const isFetchingRef = useRef<boolean>(false);

  const fetchDocuments = useCallback(async (reset: boolean = false) => {
    if (isFetchingRef.current || isAuthLoading || !user?.userId || !user?.companyId) {
      if (!isAuthLoading && !user?.userId) {
        setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
      }
      return;
    }
    isFetchingRef.current = true; setIsLoading(true); setError(null);
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };

    try {
      const currentOffset = reset ? 0 : offsetRef.current;
      // FLAG_LLM: getDocumentStatusList ahora devuelve DocumentStatusResponse[] ya mapeado
      const data = await getDocumentStatusList(authHeaders, DEFAULT_LIMIT, currentOffset);
      setHasMore(data.length === DEFAULT_LIMIT);
      offsetRef.current = currentOffset + data.length;
      setDocuments(prev => reset ? data : [...prev, ...data]);
    } catch (err: any) {
      const errorMessage = err instanceof ApiError ? err.message : (err.message || 'Error al cargar la lista de documentos.');
      setError(errorMessage); setHasMore(false);
    } finally {
      setIsLoading(false); isFetchingRef.current = false;
    }
  }, [user, isAuthLoading]); // Dependencia correcta

  useEffect(() => {
    // Cargar solo si hay usuario, compa√±√≠a y la lista est√° vac√≠a o si el usuario/compa√±√≠a cambia
    if (user?.userId && user?.companyId) {
      fetchDocuments(true); // Siempre resetea al cambiar usuario/compa√±√≠a
    } else if (!isAuthLoading && !user?.userId) {
      setDocuments([]); setIsLoading(false); setError(null); setHasMore(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.userId, user?.companyId, isAuthLoading]); // Depender de IDs espec√≠ficos y auth

  const retryLocalUpdate = useCallback((documentId: string) => {
    setDocuments(prevDocs =>
      prevDocs.map(doc =>
        // FLAG_LLM: Comparar con document_id
        doc.document_id === documentId
          ? { ...doc, status: 'processing', error_message: null }
          : doc
      )
    );
  }, []);

  const fetchMore = useCallback(() => {
    if (!isLoading && hasMore && !isFetchingRef.current) {
      fetchDocuments(false);
    }
  }, [fetchDocuments, isLoading, hasMore]);

  const refreshDocument = useCallback(async (documentId: string) => {
    if (!user?.userId || !user?.companyId) {
        console.error("Cannot refresh document: user or company ID missing.");
        toast.error("Error de autenticaci√≥n", { description: "No se pudo verificar la sesi√≥n." }); return;
    }
    const authHeaders: AuthHeaders = { 'X-User-ID': user.userId, 'X-Company-ID': user.companyId };
    try {
      // FLAG_LLM: getDocumentStatus devuelve DetailedDocumentStatusResponse con document_id
      const updatedDoc = await getDocumentStatus(documentId, authHeaders);
      // FLAG_LLM: Actualizar usando document_id
      setDocuments(prev => prev.map(doc => doc.document_id === documentId ? updatedDoc : doc));
    } catch (error){
      console.error(`Failed to refresh status for document ${documentId}:`, error);
      toast.error("Error al refrescar estado", { description: error instanceof Error ? error.message : "Error desconocido" });
    }
  }, [user]);

  const deleteLocalDocument = useCallback((documentId: string) => {
    // FLAG_LLM: Filtrar usando document_id
    setDocuments(prev => prev.filter(doc => doc.document_id !== documentId));
  }, []);

  return { documents, isLoading, error, fetchDocuments, fetchMore, hasMore, retryLocalUpdate, refreshDocument, deleteLocalDocument };
}
```

## File: `lib\hooks\useUploadDocument.ts`
```ts
// File: lib/hooks/useUploadDocument.ts (NUEVO)
import { useState, useCallback } from 'react';
import { uploadDocument, IngestResponse, AuthHeaders, ApiError } from '@/lib/api';
import { toast } from 'sonner'; // Para notificaciones

interface UseUploadDocumentReturn {
  isUploading: boolean;
  uploadError: string | null;
  uploadResponse: IngestResponse | null;
  uploadFile: (file: File, authHeaders: AuthHeaders) => Promise<boolean>; // Devuelve boolean indicando √©xito
  clearUploadStatus: () => void; // Para limpiar el estado despu√©s de mostrar error/√©xito
}

/**
 * Hook personalizado para manejar la subida de documentos.
 * Encapsula la l√≥gica de llamada API, estado de carga, errores (incluido 409) y notificaciones.
 * @param onSuccess - Callback opcional a ejecutar tras una subida exitosa.
 * @returns Objeto con el estado y la funci√≥n de subida.
 */
export function useUploadDocument(onSuccess?: (response: IngestResponse) => void): UseUploadDocumentReturn {
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadResponse, setUploadResponse] = useState<IngestResponse | null>(null);

  const uploadFile = useCallback(async (file: File, authHeaders: AuthHeaders): Promise<boolean> => {
    setIsUploading(true);
    setUploadError(null);
    setUploadResponse(null);
    const toastId = toast.loading(`Subiendo archivo "${file.name}"...`); // Notificaci√≥n de carga

    try {
      const response = await uploadDocument(file, authHeaders);
      setUploadResponse(response);
      toast.success("Archivo Subido", {
        id: toastId,
        description: `"${file.name}" ha sido puesto en cola para procesamiento. Estado: ${response.status || 'recibido'}.`,
      });
      if (onSuccess) {
        onSuccess(response);
      }
      setIsUploading(false);
      return true; // Indica √©xito
    } catch (err: any) {
      let errorMessage = 'Error al subir el documento.';
      let errorTitle = "Error al Subir";

      if (err instanceof ApiError) {
        // Manejo espec√≠fico del error 409 (duplicado)
        if (err.status === 409) {
          errorTitle = "Archivo Duplicado";
          errorMessage = err.message || `Ya existe un documento llamado "${file.name}". No se ha subido de nuevo.`;
        } else {
          // Otros errores de API
          errorMessage = err.message || `Error API (${err.status})`;
        }
      } else if (err.message) {
        // Errores gen√©ricos
        errorMessage = err.message;
      }

      setUploadError(errorMessage);
      setUploadResponse(null);
      toast.error(errorTitle, {
        id: toastId,
        description: errorMessage,
      });
      setIsUploading(false);
      return false; // Indica fallo
    }
    // No necesitamos finally porque isUploading se setea en try/catch
  }, [onSuccess]);

  // Funci√≥n para limpiar el estado de error/respuesta (√∫til despu√©s de mostrar el error)
  const clearUploadStatus = useCallback(() => {
    setUploadError(null);
    setUploadResponse(null);
  }, []);

  return { isUploading, uploadError, uploadResponse, uploadFile, clearUploadStatus };
}
```

## File: `lib\utils.ts`
```ts
// File: lib/utils.ts (MODIFICADO)
// Purpose: General utility functions, including CN for classnames and API URL retrieval.
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Retrieves the API Gateway URL from environment variables.
 * Throws an error if the environment variable is not set during runtime in production/staging.
 * Provides a default and warning in development.
 * @returns {string} The API Gateway URL without a trailing slash.
 */
export function getApiGatewayUrl(): string {
    const apiUrl = process.env.NEXT_PUBLIC_API_GATEWAY_URL;

    console.log(`getApiGatewayUrl: NEXT_PUBLIC_API_GATEWAY_URL = ${apiUrl}`);

    if (!apiUrl) {
        const errorMessage = "CRITICAL: NEXT_PUBLIC_API_GATEWAY_URL environment variable is not set.";
        console.error(errorMessage);

        if (process.env.NODE_ENV === 'production') {
             console.error("API Gateway URL must be set in production environment variables.");
             throw new Error("API Gateway URL is not configured for production.");
        }

        const defaultDevUrl = "https://1942-2001-1388-53a1-a7c9-241c-4a44-2b12-938f.ngrok-free.app";
        console.warn(`‚ö†Ô∏è ${errorMessage} Using default development Ngrok URL: ${defaultDevUrl}. Make sure this matches your current ngrok tunnel!`);
        return defaultDevUrl;
    }

    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        console.error(`Invalid API Gateway URL format: ${apiUrl}. Must start with http:// or https://`);
        throw new Error(`Invalid API Gateway URL format: ${apiUrl}`);
    }

    return apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
}

// --- NUEVO: Helpers para manejo local de queries ---

/**
 * Detecta saludos comunes en espa√±ol o ingl√©s.
 * @param text - El texto de entrada.
 * @returns `true` si es un saludo, `false` en caso contrario.
 */
export function isGreeting(text: string): boolean {
  const msg = text.trim().toLowerCase();
  // Regex mejorada para cubrir m√°s variaciones y evitar falsos positivos
  return /^\s*(hola|hello|hi|hey|buen(os)?\s+(d[√≠i]as?|tardes?|noches?))\s*[!¬°?.]*\s*$/i.test(msg);
}

/**
 * Detecta preguntas sobre las capacidades o informaci√≥n del asistente.
 * @param text - El texto de entrada.
 * @returns `true` si es una consulta meta, `false` en caso contrario.
 */
export function isMetaQuery(text: string): boolean {
  const msg = text.trim().toLowerCase();
  const patterns = [
    /\b(qu[√©e] puedes hacer|cu[√°a]les son tus func|capacidades|capabilities)\b/i, // Qu√© puedes hacer, capacidades
    /\b(qui[√©e]n eres|what are you)\b/i, // Qui√©n eres
    /\b(qu[√©e] informaci[√≥o]n (tienes|posees)|what info)\b/i, // Qu√© informaci√≥n tienes
    /\b(ayuda|help|soporte|support)\b/i, // Ayuda/Soporte
  ];
  return patterns.some(pattern => pattern.test(msg));
}

/**
 * Genera una respuesta est√°ndar para consultas meta.
 * @returns Una cadena con la respuesta predefinida.
 */
export function getMetaResponse(): string {
  // Respuesta m√°s elaborada y √∫til
  return `Soy Atenex, tu asistente de inteligencia artificial dise√±ado para ayudarte a explorar y consultar la base de conocimiento de tu organizaci√≥n. Puedo:
- Buscar informaci√≥n espec√≠fica dentro de los documentos cargados.
- Responder preguntas basadas en el contenido de esos documentos.
- Mostrarte las fuentes de donde extraje la informaci√≥n.

Simplemente hazme una pregunta sobre el contenido que esperas encontrar.`;
}
// --- FIN Helpers ---
```

## File: `next-env.d.ts`
```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

```
